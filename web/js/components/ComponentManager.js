"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DocFormatFactory_1 = require("../docformat/DocFormatFactory");
const Logger_1 = require("polar-shared/src/logger/Logger");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const MutationState_1 = require("../proxies/MutationState");
const DocMetaListeners_1 = require("../datastore/sharing/db/DocMetaListeners");
const log = Logger_1.Logger.create();
class ComponentManager {
    constructor(type, model, containerProvider, createComponent, createDocMetaModel) {
        this.type = type;
        this.model = model;
        this.containers = {};
        this.components = {};
        this.containerProvider = containerProvider;
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
        this.createComponent = createComponent;
        this.createDocMetaModel = createDocMetaModel;
    }
    start() {
        this.model.registerListenerForDocumentLoaded((documentLoadedEvent) => this.onDocumentLoaded(documentLoadedEvent));
    }
    onDocumentLoaded(documentLoadedEvent) {
        log.debug("onDocumentLoaded: ", documentLoadedEvent.fingerprint);
        this.containers = this.containerProvider.getContainers();
        log.debug("Working with containers: ", this.containers);
        const { docMeta } = documentLoadedEvent;
        this.registerListenerForDocMeta(docMeta);
        this.registerListenerForSecondaryDocMetas(docMeta.docInfo.fingerprint);
    }
    registerListenerForDocMeta(docMeta) {
        const docMetaModel = this.createDocMetaModel();
        docMetaModel.registerListener(docMeta, annotationEvent => this.onAnnotationEvent(annotationEvent));
    }
    registerListenerForSecondaryDocMetas(fingerprint) {
        const docMetaHandler = (docMeta) => {
            this.registerListenerForDocMeta(docMeta);
        };
        const errHandler = (err) => {
            log.error("Failed to handle docMeta group group: ", err);
        };
        DocMetaListeners_1.DocMetaListeners.register(fingerprint, docMetaHandler, errHandler)
            .catch(err => errHandler(err));
    }
    onAnnotationEvent(annotationEvent) {
        log.debug("onComponentEvent: ", annotationEvent);
        const containerID = annotationEvent.pageMeta.pageInfo.num;
        Preconditions_1.Preconditions.assertNumber(containerID, "containerID");
        if (annotationEvent.mutationState === MutationState_1.MutationState.PRESENT) {
            log.debug("PRESENT");
            const container = this.containers[containerID];
            if (!container) {
                throw new Error("No container for containerID: " + containerID);
            }
            annotationEvent.container = container;
            const component = this.createComponent();
            component.init(annotationEvent);
            let initialized = true;
            const callback = (containerLifecycleState) => {
                if (containerLifecycleState.visible) {
                    if (!initialized) {
                        component.init(annotationEvent);
                        initialized = true;
                    }
                    setTimeout(() => {
                        component.render();
                    }, 1);
                }
                else {
                    component.destroy();
                    initialized = false;
                }
            };
            const containerLifecycleListener = this.containerProvider.createContainerLifecycleListener(container);
            containerLifecycleListener.register(callback);
            const containerState = containerLifecycleListener.getState();
            if (containerState && containerState.visible) {
                callback(containerState);
            }
            this.components[annotationEvent.id] = new ComponentEntry(containerLifecycleListener, component);
        }
        else if (annotationEvent.mutationState === MutationState_1.MutationState.ABSENT) {
            log.debug("ABSENT");
            const componentEntry = this.components[annotationEvent.id];
            if (componentEntry) {
                componentEntry.containerLifecycleListener.unregister();
                componentEntry.component.destroy();
                log.debug("Destroyed component: " + annotationEvent.id);
                delete this.components[annotationEvent.id];
            }
            else {
                log.warn("No component entry for: " + annotationEvent.id);
            }
        }
    }
}
exports.ComponentManager = ComponentManager;
class ComponentEntry {
    constructor(containerLifecycleListener, component) {
        this.containerLifecycleListener = containerLifecycleListener;
        this.component = component;
    }
}
exports.ComponentEntry = ComponentEntry;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tcG9uZW50TWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNvbXBvbmVudE1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvRUFBK0Q7QUFDL0QsMkRBQXNEO0FBTXRELGtFQUE2RDtBQUM3RCw0REFBdUQ7QUFLdkQsK0VBQTBFO0FBRzFFLE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFhLGdCQUFnQjtJQVN6QixZQUE2QixJQUFZLEVBQ1osS0FBWSxFQUM3QixpQkFBb0MsRUFDcEMsZUFBZ0MsRUFDaEMsa0JBQXNDO1FBSnJCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixVQUFLLEdBQUwsS0FBSyxDQUFPO1FBSmpDLGVBQVUsR0FBaUMsRUFBRSxDQUFDO1FBQzlDLGVBQVUsR0FBc0MsRUFBRSxDQUFDO1FBUXZELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztRQUUzQyxJQUFJLENBQUMsU0FBUyxHQUFHLG1DQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRWhELElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBRXZDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQztJQUVqRCxDQUFDO0lBRU0sS0FBSztRQUNSLElBQUksQ0FBQyxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztJQUN0SCxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsbUJBQXdDO1FBRTdELEdBQUcsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsbUJBQW1CLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFekQsR0FBRyxDQUFDLEtBQUssQ0FB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b2NGb3JtYXRGYWN0b3J5fSBmcm9tICcuLi9kb2Nmb3JtYXQvRG9jRm9ybWF0RmFjdG9yeSc7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7RG9jdW1lbnRMb2FkZWRFdmVudCwgTW9kZWx9IGZyb20gJy4uL21vZGVsL01vZGVsJztcbmltcG9ydCB7Q29udGFpbmVyUHJvdmlkZXJ9IGZyb20gJy4vY29udGFpbmVycy9wcm92aWRlcnMvQ29udGFpbmVyUHJvdmlkZXInO1xuaW1wb3J0IHtDb21wb25lbnR9IGZyb20gJy4vQ29tcG9uZW50JztcbmltcG9ydCB7RG9jTWV0YU1vZGVsfSBmcm9tICcuLi9tZXRhZGF0YS9Eb2NNZXRhTW9kZWwnO1xuaW1wb3J0IHtEb2NGb3JtYXR9IGZyb20gJy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXQnO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtNdXRhdGlvblN0YXRlfSBmcm9tICcuLi9wcm94aWVzL011dGF0aW9uU3RhdGUnO1xuaW1wb3J0IHtDb250YWluZXJ9IGZyb20gJy4vY29udGFpbmVycy9Db250YWluZXInO1xuaW1wb3J0IHtDb250YWluZXJMaWZlY3ljbGVTdGF0ZX0gZnJvbSAnLi9jb250YWluZXJzL2xpZmVjeWNsZS9Db250YWluZXJMaWZlY3ljbGVTdGF0ZSc7XG5pbXBvcnQge0NvbnRhaW5lckxpZmVjeWNsZUxpc3RlbmVyfSBmcm9tICcuL2NvbnRhaW5lcnMvbGlmZWN5Y2xlL0NvbnRhaW5lckxpZmVjeWNsZUxpc3RlbmVyJztcbmltcG9ydCB7QW5ub3RhdGlvbkV2ZW50fSBmcm9tICcuLi9hbm5vdGF0aW9ucy9jb21wb25lbnRzL0Fubm90YXRpb25FdmVudCc7XG5pbXBvcnQge0RvY01ldGFMaXN0ZW5lcnN9IGZyb20gXCIuLi9kYXRhc3RvcmUvc2hhcmluZy9kYi9Eb2NNZXRhTGlzdGVuZXJzXCI7XG5pbXBvcnQge0lEb2NNZXRhfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JRG9jTWV0YVwiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmV4cG9ydCBjbGFzcyBDb21wb25lbnRNYW5hZ2VyIHtcblxuICAgIHByaXZhdGUgY29udGFpbmVyUHJvdmlkZXI6IENvbnRhaW5lclByb3ZpZGVyO1xuICAgIHByaXZhdGUgZG9jRm9ybWF0OiBEb2NGb3JtYXQ7XG4gICAgcHJpdmF0ZSByZWFkb25seSBjcmVhdGVDb21wb25lbnQ6ICgpID0+IENvbXBvbmVudDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNyZWF0ZURvY01ldGFNb2RlbDogKCkgPT4gRG9jTWV0YU1vZGVsO1xuICAgIHByaXZhdGUgY29udGFpbmVyczogeyBba2V5OiBudW1iZXJdOiBDb250YWluZXIgfSA9IHt9O1xuICAgIHByaXZhdGUgY29tcG9uZW50czogeyBba2V5OiBzdHJpbmddOiBDb21wb25lbnRFbnRyeSB9ID0ge307XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHR5cGU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJlYWRvbmx5IG1vZGVsOiBNb2RlbCxcbiAgICAgICAgICAgICAgICBjb250YWluZXJQcm92aWRlcjogQ29udGFpbmVyUHJvdmlkZXIsXG4gICAgICAgICAgICAgICAgY3JlYXRlQ29tcG9uZW50OiAoKSA9PiBDb21wb25lbnQsXG4gICAgICAgICAgICAgICAgY3JlYXRlRG9jTWV0YU1vZGVsOiAoKSA9PiBEb2NNZXRhTW9kZWwpIHtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lclByb3ZpZGVyID0gY29udGFpbmVyUHJvdmlkZXI7XG5cbiAgICAgICAgdGhpcy5kb2NGb3JtYXQgPSBEb2NGb3JtYXRGYWN0b3J5LmdldEluc3RhbmNlKCk7XG5cbiAgICAgICAgdGhpcy5jcmVhdGVDb21wb25lbnQgPSBjcmVhdGVDb21wb25lbnQ7XG5cbiAgICAgICAgdGhpcy5jcmVhdGVEb2NNZXRhTW9kZWwgPSBjcmVhdGVEb2NNZXRhTW9kZWw7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMubW9kZWwucmVnaXN0ZXJMaXN0ZW5lckZvckRvY3VtZW50TG9hZGVkKChkb2N1bWVudExvYWRlZEV2ZW50KSA9PiB0aGlzLm9uRG9jdW1lbnRMb2FkZWQoZG9jdW1lbnRMb2FkZWRFdmVudCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Eb2N1bWVudExvYWRlZChkb2N1bWVudExvYWRlZEV2ZW50OiBEb2N1bWVudExvYWRlZEV2ZW50KSB7XG5cbiAgICAgICAgbG9nLmRlYnVnKFwib25Eb2N1bWVudExvYWRlZDogXCIsIGRvY3VtZW50TG9hZGVkRXZlbnQuZmluZ2VycHJpbnQpO1xuXG4gICAgICAgIHRoaXMuY29udGFpbmVycyA9IHRoaXMuY29udGFpbmVyUHJvdmlkZXIuZ2V0Q29udGFpbmVycygpO1xuXG4gICAgICAgIGxvZy5kZWJ1ZyhcIldvcmtpbmcgd2l0aCBjb250YWluZXJzOiBcIiwgdGhpcy5jb250YWluZXJzKTtcblxuICAgICAgICAvLyBMaXN0ZW4gZm9yIGNoYW5nZXMgZnJvbSB0aGUgbW9kZWwgYXMgb2JqZWN0cyBhcmUgUFJFU0VOVCBvciBBQlNFTlRcbiAgICAgICAgLy8gZm9yIHRoZSBzcGVjaWZpYyBvYmplY3RzIHdlJ3JlIGludGVyZXN0ZWQgaW4gYW5kIHRoZW4gY2FsbFxuICAgICAgICAvLyBvbkNvbXBvbmVudEV2ZW50IHNvIHRoYXQgd2UgY2FuIHJlbmRlci9kZXN0cm95IHRoZSBjb21wb25lbnQgYW5kXG4gICAgICAgIC8vIGFuZCBjaGFuZ2UgaXQgb24gcGFnZSBldmVudHMuXG5cbiAgICAgICAgY29uc3Qge2RvY01ldGF9ID0gZG9jdW1lbnRMb2FkZWRFdmVudDtcblxuICAgICAgICB0aGlzLnJlZ2lzdGVyTGlzdGVuZXJGb3JEb2NNZXRhKGRvY01ldGEpO1xuXG4gICAgICAgIC8vIFRPRE86IEkgdGhpbmsgdGhpcyBpcyB3cm9uZyBhbmQgdGhhdCB3ZSB3ZSBzaG91bGQgTk9UIGNhbGwgdGhpcyBoZXJlXG4gICAgICAgIC8vIGFuZCB0aGlzIGlzIGdvaW5nIHRvIHVwZGF0ZSB0b28gb2Z0ZW4uXG4gICAgICAgIHRoaXMucmVnaXN0ZXJMaXN0ZW5lckZvclNlY29uZGFyeURvY01ldGFzKGRvY01ldGEuZG9jSW5mby5maW5nZXJwcmludCk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlZ2lzdGVyTGlzdGVuZXJGb3JEb2NNZXRhKGRvY01ldGE6IElEb2NNZXRhKSB7XG4gICAgICAgIGNvbnN0IGRvY01ldGFNb2RlbCA9IHRoaXMuY3JlYXRlRG9jTWV0YU1vZGVsKCk7XG4gICAgICAgIGRvY01ldGFNb2RlbC5yZWdpc3Rlckxpc3RlbmVyKGRvY01ldGEsIGFubm90YXRpb25FdmVudCA9PiB0aGlzLm9uQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVnaXN0ZXJMaXN0ZW5lckZvclNlY29uZGFyeURvY01ldGFzKGZpbmdlcnByaW50OiBzdHJpbmcpIHtcblxuICAgICAgICBjb25zdCBkb2NNZXRhSGFuZGxlciA9IChkb2NNZXRhOiBJRG9jTWV0YSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWdpc3Rlckxpc3RlbmVyRm9yRG9jTWV0YShkb2NNZXRhKTtcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBlcnJIYW5kbGVyID0gKGVycjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgIGxvZy5lcnJvcihcIkZhaWxlZCB0byBoYW5kbGUgZG9jTWV0YSBncm91cCBncm91cDogXCIsIGVycik7XG4gICAgICAgIH07XG5cbiAgICAgICAgRG9jTWV0YUxpc3RlbmVycy5yZWdpc3RlcihmaW5nZXJwcmludCwgZG9jTWV0YUhhbmRsZXIsIGVyckhhbmRsZXIpXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IGVyckhhbmRsZXIoZXJyKSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudDogQW5ub3RhdGlvbkV2ZW50KSB7XG5cbiAgICAgICAgLy8gVE9ETzogSSB0aGluayBpdCB3b3VsZCBiZSBiZXR0ZXIgdG8gYnVpbGQgdXAgcGFnZU51bSBhbmQgcGFnZUVsZW1lbnRcbiAgICAgICAgLy8gd2l0aGluIEFubm90YXRpb25FdmVudCAtIG5vdCBoZXJlLiAgVGhpcyBzaG91bGQganVzdCBiZSBhIENvbXBvbmVudEV2ZW50XG4gICAgICAgIC8vIGFuZCBub3Qga25vdyBhbnl0aGluZyBhYm91dCBhbm5vdGF0aW9ucy5cblxuICAgICAgICBsb2cuZGVidWcoXCJvbkNvbXBvbmVudEV2ZW50OiBcIiwgYW5ub3RhdGlvbkV2ZW50KTtcblxuICAgICAgICBjb25zdCBjb250YWluZXJJRCA9IGFubm90YXRpb25FdmVudC5wYWdlTWV0YS5wYWdlSW5mby5udW07XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROdW1iZXIoY29udGFpbmVySUQsIFwiY29udGFpbmVySURcIik7XG5cbiAgICAgICAgaWYgKGFubm90YXRpb25FdmVudC5tdXRhdGlvblN0YXRlID09PSBNdXRhdGlvblN0YXRlLlBSRVNFTlQpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIlBSRVNFTlRcIik7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyc1tjb250YWluZXJJRF07XG5cbiAgICAgICAgICAgIGlmICghIGNvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIGNvbnRhaW5lciBmb3IgY29udGFpbmVySUQ6IFwiICsgY29udGFpbmVySUQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhbm5vdGF0aW9uRXZlbnQuY29udGFpbmVyID0gY29udGFpbmVyO1xuXG4gICAgICAgICAgICAvLyBsZXQgY29udGFpbmVyID0gdGhpcy5jb250XG5cbiAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgY29tcG9uZW50IGFuZCBjYWxsIHJlbmRlciBvbiBpdC4uLlxuXG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnQgPSB0aGlzLmNyZWF0ZUNvbXBvbmVudCgpO1xuXG4gICAgICAgICAgICBjb21wb25lbnQuaW5pdChhbm5vdGF0aW9uRXZlbnQpO1xuXG4gICAgICAgICAgICBsZXQgaW5pdGlhbGl6ZWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgICAgICAgICBjb25zdCBjYWxsYmFjayA9IChjb250YWluZXJMaWZlY3ljbGVTdGF0ZTogQ29udGFpbmVyTGlmZWN5Y2xlU3RhdGUpID0+IHtcblxuICAgICAgICAgICAgICAgIGlmIChjb250YWluZXJMaWZlY3ljbGVTdGF0ZS52aXNpYmxlKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCEgaW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBmaXJzdCB0aW1lIGl0J3MgdmlzaWJsZSB3ZSBuZWVkIHRvIGZpcmUgYW4gaW5pdCBhZ2Fpbi4uLlxuICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50LmluaXQoYW5ub3RhdGlvbkV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm93IHJlbmRlciB0aGUgY29tcG9uZW50IG9uIHNjcmVlbi5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5yZW5kZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMSk7XG5cblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgICAgIGluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCBjb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lclxuICAgICAgICAgICAgICAgID0gdGhpcy5jb250YWluZXJQcm92aWRlci5jcmVhdGVDb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcihjb250YWluZXIpO1xuXG4gICAgICAgICAgICBjb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lci5yZWdpc3RlcihjYWxsYmFjayk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lclN0YXRlID0gY29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIuZ2V0U3RhdGUoKTtcblxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lclN0YXRlICYmIGNvbnRhaW5lclN0YXRlLnZpc2libGUpIHtcbiAgICAgICAgICAgICAgICAvLyBkcmF3IGl0IG1hbnVhbGx5IHRoZSBmaXJzdCB0aW1lLlxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGNvbnRhaW5lclN0YXRlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRzW2Fubm90YXRpb25FdmVudC5pZF0gPSBuZXcgQ29tcG9uZW50RW50cnkoY29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIsIGNvbXBvbmVudCk7XG5cbiAgICAgICAgfSBlbHNlIGlmIChhbm5vdGF0aW9uRXZlbnQubXV0YXRpb25TdGF0ZSA9PT0gTXV0YXRpb25TdGF0ZS5BQlNFTlQpIHtcblxuICAgICAgICAgICAgbG9nLmRlYnVnKFwiQUJTRU5UXCIpO1xuXG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRFbnRyeSA9IHRoaXMuY29tcG9uZW50c1thbm5vdGF0aW9uRXZlbnQuaWRdO1xuXG4gICAgICAgICAgICBpZiAoY29tcG9uZW50RW50cnkpIHtcblxuICAgICAgICAgICAgICAgIGNvbXBvbmVudEVudHJ5LmNvbnRhaW5lckxpZmVjeWNsZUxpc3RlbmVyLnVucmVnaXN0ZXIoKTtcbiAgICAgICAgICAgICAgICBjb21wb25lbnRFbnRyeS5jb21wb25lbnQuZGVzdHJveSgpO1xuXG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKFwiRGVzdHJveWVkIGNvbXBvbmVudDogXCIgKyBhbm5vdGF0aW9uRXZlbnQuaWQpO1xuXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29tcG9uZW50c1thbm5vdGF0aW9uRXZlbnQuaWRdO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvZy53YXJuKFwiTm8gY29tcG9uZW50IGVudHJ5IGZvcjogXCIgKyBhbm5vdGF0aW9uRXZlbnQuaWQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgIH1cblxufVxuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50RW50cnkge1xuXG4gICAgcHVibGljIHJlYWRvbmx5IGNvbnRhaW5lckxpZmVjeWNsZUxpc3RlbmVyOiBDb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgY29tcG9uZW50OiBDb21wb25lbnQ7XG5cbiAgICAvKipcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcjogQ29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIsIGNvbXBvbmVudDogQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuY29udGFpbmVyTGlmZWN5Y2xlTGlzdGVuZXIgPSBjb250YWluZXJMaWZlY3ljbGVMaXN0ZW5lcjtcbiAgICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7XG4gICAgfVxuXG59XG4iXX0=