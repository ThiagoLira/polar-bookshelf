"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Rects_1 = require("../Rects");
const $ = require('jquery');
class Elements {
    static getRelativeOffsetRect(element, parentElement) {
        Preconditions_1.Preconditions.assertNotNull(element, "element");
        if (!parentElement) {
            parentElement = element.ownerDocument.documentElement;
        }
        const offsetRect = { left: 0, top: 0, width: 0, height: 0 };
        function toInt(value) {
            if (isNaN(value)) {
                return 0;
            }
            return value;
        }
        offsetRect.width = toInt(element.offsetWidth);
        offsetRect.height = toInt(element.offsetHeight);
        while (element !== null) {
            if (element === parentElement) {
                break;
            }
            offsetRect.left += toInt(element.offsetLeft);
            offsetRect.top += toInt(element.offsetTop);
            element = element.offsetParent;
        }
        return Rects_1.Rects.createFromBasicRect(offsetRect);
    }
    static createWrapperElementHTML(innerHTML) {
        const div = document.createElement("div");
        div.innerHTML = innerHTML;
        return div;
    }
    static createElementHTML(html, tagName = 'div') {
        const div = document.createElement(tagName);
        div.innerHTML = html;
        return div.firstChild;
    }
    static offset(element) {
        const result = {
            left: element.offsetLeft,
            top: element.offsetTop,
            width: element.offsetWidth,
            height: element.offsetHeight,
            right: 0,
            bottom: 0
        };
        result.right = result.left + result.width;
        result.bottom = result.top + result.height;
        return Rects_1.Rects.validate(Rects_1.Rects.createFromBasicRect(result));
    }
    static requireClass(element, clazz) {
        const classValue = element.getAttribute("class");
        if (!classValue || classValue.indexOf(clazz) === -1) {
            throw new Error("Element does not have the proper class: " + clazz);
        }
    }
    static untilRoot(element, selector) {
        if (!element) {
            throw new Error("element required");
        }
        if (!selector) {
            throw new Error("selector required");
        }
        if (element.matches(selector)) {
            return element;
        }
        if (element.parentElement == null) {
            return null;
        }
        return Elements.untilRoot(element.parentElement, selector);
    }
    static calculateVisibilityForDiv(div) {
        if (div == null) {
            throw Error("Not given a div");
        }
        const windowHeight = $(window).height();
        const docScroll = $(document).scrollTop();
        const divPosition = $(div).offset().top;
        const divHeight = $(div).height();
        const hiddenBefore = docScroll - divPosition;
        const hiddenAfter = (divPosition + divHeight) - (docScroll + windowHeight);
        if ((docScroll > divPosition + divHeight) || (divPosition > docScroll + windowHeight)) {
            return 0;
        }
        else {
            let result = 100;
            if (hiddenBefore > 0) {
                result -= (hiddenBefore * 100) / divHeight;
            }
            if (hiddenAfter > 0) {
                result -= (hiddenAfter * 100) / divHeight;
            }
            return result;
        }
    }
    static getScrollParent(element) {
        if (!element) {
            return undefined;
        }
        const scrollHeight = element.scrollHeight;
        const clientHeight = element.clientHeight;
        if (scrollHeight > clientHeight) {
            return element;
        }
        else {
            return this.getScrollParent(element.parentElement);
        }
    }
}
exports.Elements = Elements;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWxlbWVudHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJFbGVtZW50cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtFQUE2RDtBQUM3RCxvQ0FBK0I7QUFHL0IsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRTVCLE1BQWEsUUFBUTtJQWVWLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxPQUFvQixFQUFFLGFBQTJCO1FBRWpGLDZCQUFhLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUUsYUFBYSxFQUFFO1lBQ2pCLGFBQWEsR0FBRyxPQUFPLENBQUMsYUFBYyxDQUFDLGVBQWdCLENBQUM7U0FDM0Q7UUFFRCxNQUFNLFVBQVUsR0FBRyxFQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUMsQ0FBQztRQUUxRCxTQUFTLEtBQUssQ0FBQyxLQUFhO1lBQ3hCLElBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFHO2dCQUNoQixPQUFPLENBQUMsQ0FBQzthQUNaO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQztRQUVELFVBQVUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM5QyxVQUFVLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFaEQsT0FBTyxPQUFPLEtBQUssSUFBSSxFQUFFO1lBRXJCLElBQUksT0FBTyxLQUFLLGFBQWEsRUFBRTtnQkFDM0IsTUFBTTthQUNUO1lBRUQsVUFBVSxDQUFDLElBQUksSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzdDLFVBQVUsQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxT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QUVKO0FBM01ELDRCQTJNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UHJlY29uZGl0aW9uc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7UmVjdHN9IGZyb20gJy4uL1JlY3RzJztcbmltcG9ydCB7UmVjdH0gZnJvbSAnLi4vUmVjdCc7XG5cbmNvbnN0ICQgPSByZXF1aXJlKCdqcXVlcnknKTtcblxuZXhwb3J0IGNsYXNzIEVsZW1lbnRzIHtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQ29tcHV0ZSB0aGUgb2Zmc2V0IHJlbGF0aXZlIHRvIGFub3RoZXIgcGFyZW50IGVsZW1lbnQuICBUaGlzIGNhbiBiZSB1c2VkXG4gICAgICogdG8gY29tcHV0ZSB0aGUgYWJzb2x1dGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCBvbiBhIHBhZ2UuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZWxlbWVudFxuICAgICAqIEBwYXJhbSBbcGFyZW50RWxlbWVudF0ge0hUTUxFbGVtZW50fSByZWxhdGl2ZSB0byB0aGlzIHBhcmVudEVsZW1lbnQuXG4gICAgICogICAgICAgIEJ5IGRlZmF1bHQgd2UgYXJlIHJlbGF0aXZlIHRvIHRoZSBkb2N1bWVudCByb290IChkb2N1bWVudEVsZW1lbnQpLlxuICAgICAqIEByZXR1cm4ge1JlY3R9XG4gICAgICovXG5cbiAgICAvLyBGSVhNRTogdGhpcyBzaG91bGQgYmUgZ2V0UGFnZU9mZnNldFJlY3QgYW5kIGhhdmUgYVxuICAgIC8vIHJlbGF0aXZlVG9QYXJlbnRFbGVtZW50IHdoaWNoIGlzIG9wdGlvbmFsLlxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0UmVsYXRpdmVPZmZzZXRSZWN0KGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBwYXJlbnRFbGVtZW50PzogSFRNTEVsZW1lbnQpOiBSZWN0IHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwoZWxlbWVudCwgXCJlbGVtZW50XCIpO1xuXG4gICAgICAgIGlmICghIHBhcmVudEVsZW1lbnQpIHtcbiAgICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQhLmRvY3VtZW50RWxlbWVudCE7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBvZmZzZXRSZWN0ID0ge2xlZnQ6IDAsIHRvcDogMCwgd2lkdGg6IDAsIGhlaWdodDogMH07XG5cbiAgICAgICAgZnVuY3Rpb24gdG9JbnQodmFsdWU6IG51bWJlcikge1xuICAgICAgICAgICAgaWYgKCBpc05hTih2YWx1ZSkgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICBvZmZzZXRSZWN0LndpZHRoID0gdG9JbnQoZWxlbWVudC5vZmZzZXRXaWR0aCk7XG4gICAgICAgIG9mZnNldFJlY3QuaGVpZ2h0ID0gdG9JbnQoZWxlbWVudC5vZmZzZXRIZWlnaHQpO1xuXG4gICAgICAgIHdoaWxlIChlbGVtZW50ICE9PSBudWxsKSB7XG5cbiAgICAgICAgICAgIGlmIChlbGVtZW50ID09PSBwYXJlbnRFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG9mZnNldFJlY3QubGVmdCArPSB0b0ludChlbGVtZW50Lm9mZnNldExlZnQpO1xuICAgICAgICAgICAgb2Zmc2V0UmVjdC50b3AgKz0gdG9JbnQoZWxlbWVudC5vZmZzZXRUb3ApO1xuXG4gICAgICAgICAgICAvLyBUTzogRG8gSSBoYXZlIHRvIGZhY3RvciBpbiBzY3JvbGxUb3AgaGVyZS4uIHRoaXMgaXMgaW5zYW5lLlxuICAgICAgICAgICAgLy8gSSB0aGluayB0aGlzIGlzbid0IHRydWUuLi4gSSB0aGluayB0aGUgcHJvYmxlbSBpcyB0aGF0IHRoZSBwYWdlXG4gICAgICAgICAgICAvLyBwb3NpdGlvbiBjaGFuZ2VzIFdSVCBzY3JvbGxpbmcuXG5cbiAgICAgICAgICAgIC8vIG9mZnNldFJlY3QubGVmdCArPSB0b0ludChlbGVtZW50LnNjcm9sbExlZnQpO1xuICAgICAgICAgICAgLy8gb2Zmc2V0UmVjdC50b3AgKz0gdG9JbnQoZWxlbWVudC5zY3JvbGxUb3ApO1xuXG4gICAgICAgICAgICBlbGVtZW50ID0gPEhUTUxFbGVtZW50PiBlbGVtZW50Lm9mZnNldFBhcmVudDtcblxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qob2Zmc2V0UmVjdCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkaXYgZnJvbSB0aGUgZ2l2ZW4gaW5uZXJIVE1MIGFuZCByZXR1cm4gaXQgd2l0aCBhIHdyYXBwZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaW5uZXJIVE1MXG4gICAgICogQHJldHVybiB7SFRNTERpdkVsZW1lbnR9XG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGVXcmFwcGVyRWxlbWVudEhUTUwoaW5uZXJIVE1MOiBzdHJpbmcpIHtcblxuICAgICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICBkaXYuaW5uZXJIVE1MID0gaW5uZXJIVE1MO1xuXG4gICAgICAgIHJldHVybiBkaXY7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW4gZWxlbWVudCBmb3IgdGhlIGdpdmVuIEhUTUwgYW5kIHJldHVybiB0aGUgZWxlbWVudCBpbnN0YW5jZVxuICAgICAqXG4gICAgICogQHBhcmFtIGh0bWwgVGhlIEhUTUwgZWxlbWVudCB0byBjcmVhdGVcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZUVsZW1lbnRIVE1MKGh0bWw6IHN0cmluZywgdGFnTmFtZSA9ICdkaXYnICk6IEhUTUxFbGVtZW50IHtcblxuICAgICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpO1xuICAgICAgICBkaXYuaW5uZXJIVE1MID0gaHRtbDtcblxuICAgICAgICByZXR1cm4gPEhUTUxFbGVtZW50PiBkaXYuZmlyc3RDaGlsZCE7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIG9mZnNldChlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgICAgICAgIGxlZnQ6IGVsZW1lbnQub2Zmc2V0TGVmdCxcbiAgICAgICAgICAgIHRvcDogZWxlbWVudC5vZmZzZXRUb3AsXG4gICAgICAgICAgICB3aWR0aDogZWxlbWVudC5vZmZzZXRXaWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogZWxlbWVudC5vZmZzZXRIZWlnaHQsXG4gICAgICAgICAgICByaWdodDogMCxcbiAgICAgICAgICAgIGJvdHRvbTogMFxuICAgICAgICB9O1xuXG4gICAgICAgIHJlc3VsdC5yaWdodCA9IHJlc3VsdC5sZWZ0ICsgcmVzdWx0LndpZHRoO1xuICAgICAgICByZXN1bHQuYm90dG9tID0gcmVzdWx0LnRvcCArIHJlc3VsdC5oZWlnaHQ7XG5cbiAgICAgICAgcmV0dXJuIFJlY3RzLnZhbGlkYXRlKFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3QocmVzdWx0KSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXF1aXJlIHRoYXQgdGhlIGVsZW1lbnQgaGF2ZSB0aGUgZ2l2ZW4gY2xhc3NuYW1lLlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgcmVxdWlyZUNsYXNzKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBjbGF6ejogc3RyaW5nKSB7XG5cbiAgICAgICAgY29uc3QgY2xhc3NWYWx1ZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKFwiY2xhc3NcIik7XG5cbiAgICAgICAgaWYgKCAhIGNsYXNzVmFsdWUgfHwgY2xhc3NWYWx1ZS5pbmRleE9mKGNsYXp6KSA9PT0gLTEpIHtcblxuICAgICAgICAgICAgLy8gZWxlbWVudCBpc24ndCB0aGUgcHJvcGVyIGNsYXNzIHdlJ3JlIGV4cGVjdGluZy5cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVsZW1lbnQgZG9lcyBub3QgaGF2ZSB0aGUgcHJvcGVyIGNsYXNzOiBcIiArIGNsYXp6KTtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBLZWVwIHNlYXJjaGluZyBwYXJlbnQgbm90ZXMgdW50aWwgd2UgZmluZCBhbiBlbGVtZW50IG1hdGNoaW5nIHRoZVxuICAgICAqIHNlbGVjdG9yLCBvciByZXR1cm4gbnVsbCB3aGVuIG9uZSB3YXMgbm90IGZvdW5kLlxuICAgICAqXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyB1bnRpbFJvb3QoZWxlbWVudDogSFRNTEVsZW1lbnQsIHNlbGVjdG9yOiBzdHJpbmcpOiBhbnkge1xuXG4gICAgICAgIC8vIFRPRE86IHJlZmFjdG9yIHRoaXMgZm9yIHR5cGVzY3JpcHRcblxuICAgICAgICBpZiAoIWVsZW1lbnQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImVsZW1lbnQgcmVxdWlyZWRcIik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXNlbGVjdG9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJzZWxlY3RvciByZXF1aXJlZFwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlbGVtZW50Lm1hdGNoZXMoc2VsZWN0b3IpKSB7XG4gICAgICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlbGVtZW50LnBhcmVudEVsZW1lbnQgPT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gd2UgaGF2ZSBoaXQgdGhlIHJvb3QuXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBFbGVtZW50cy51bnRpbFJvb3QoZWxlbWVudC5wYXJlbnRFbGVtZW50LCBzZWxlY3Rvcik7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNhbGN1bGF0ZVZpc2liaWxpdHlGb3JEaXYoZGl2OiBIVE1MRWxlbWVudCk6IG51bWJlciB7XG5cbiAgICAgICAgaWYgKGRpdiA9PSBudWxsKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcihcIk5vdCBnaXZlbiBhIGRpdlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHdpbmRvd0hlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcbiAgICAgICAgY29uc3QgZG9jU2Nyb2xsID0gJChkb2N1bWVudCkuc2Nyb2xsVG9wKCk7XG4gICAgICAgIGNvbnN0IGRpdlBvc2l0aW9uID0gJChkaXYpLm9mZnNldCgpLnRvcDtcbiAgICAgICAgY29uc3QgZGl2SGVpZ2h0ID0gJChkaXYpLmhlaWdodCgpO1xuXG4gICAgICAgIGNvbnN0IGhpZGRlbkJlZm9yZSA9IGRvY1Njcm9sbCAtIGRpdlBvc2l0aW9uO1xuICAgICAgICBjb25zdCBoaWRkZW5BZnRlciA9IChkaXZQb3NpdGlvbiArIGRpdkhlaWdodCkgLSAoZG9jU2Nyb2xsICsgd2luZG93SGVpZ2h0KTtcblxuICAgICAgICBpZiAoKGRvY1Njcm9sbCA+IGRpdlBvc2l0aW9uICsgZGl2SGVpZ2h0KSB8fCAoZGl2UG9zaXRpb24gPiBkb2NTY3JvbGwgKyB3aW5kb3dIZWlnaHQpKSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSAxMDA7XG5cbiAgICAgICAgICAgIGlmIChoaWRkZW5CZWZvcmUgPiAwKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0IC09IChoaWRkZW5CZWZvcmUgKiAxMDApIC8gZGl2SGVpZ2h0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaGlkZGVuQWZ0ZXIgPiAwKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0IC09IChoaWRkZW5BZnRlciAqIDEwMCkgLyBkaXZIZWlnaHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0U2Nyb2xsUGFyZW50KGVsZW1lbnQ6IEVsZW1lbnQgfCBudWxsIHwgdW5kZWZpbmVkKTogRWxlbWVudCB8IHVuZGVmaW5lZCB7XG5cbiAgICAgICAgaWYgKCFlbGVtZW50KSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsSGVpZ2h0ID0gZWxlbWVudC5zY3JvbGxIZWlnaHQ7XG4gICAgICAgIGNvbnN0IGNsaWVudEhlaWdodCA9IGVsZW1lbnQuY2xpZW50SGVpZ2h0O1xuXG4gICAgICAgIGlmIChzY3JvbGxIZWlnaHQgPiBjbGllbnRIZWlnaHQpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwic2Nyb2xsIHBhcmVudCBiYXNlZCBvbjogXCIsIHtzY3JvbGxIZWlnaHQsIGNsaWVudEhlaWdodH0pO1xuICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFNjcm9sbFBhcmVudChlbGVtZW50LnBhcmVudEVsZW1lbnQpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbn1cbiJdfQ==