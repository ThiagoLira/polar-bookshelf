"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const DatastoreMutation_1 = require("./DatastoreMutation");
class DatastoreMutations {
    constructor(consistency) {
        this.consistency = consistency;
    }
    static create(consistency) {
        return new DatastoreMutations(consistency);
    }
    performOrderedWrites(primarySync, secondarySync, primaryMutations, secondaryMutations, reject) {
        primarySync(primaryMutations)
            .then(() => {
        })
            .catch((err) => {
            reject(err);
        });
        Promise.all([primaryMutations.written.get(),
            primaryMutations.committed.get()])
            .then(() => {
            secondarySync(secondaryMutations)
                .catch(err => reject(err));
        })
            .catch((err) => {
            reject(err);
        });
    }
    executeBatchedWrite(datastoreMutation, remoteSync, localSync, remoteMutations = new DatastoreMutation_1.DefaultDatastoreMutation(), localMutations = new DatastoreMutation_1.DefaultDatastoreMutation()) {
        return __awaiter(this, void 0, void 0, function* () {
            const writeRemoteThenLocal = (reject) => {
                this.performOrderedWrites(remoteSync, localSync, remoteMutations, localMutations, reject);
            };
            const writeLocalThenRemote = (reject) => {
                this.performOrderedWrites(localSync, remoteSync, localMutations, remoteMutations, reject);
            };
            return new Promise((resolve, reject) => {
                writeLocalThenRemote(reject);
                this.batched(remoteMutations, localMutations, datastoreMutation);
                switch (this.consistency) {
                    case 'committed':
                        remoteMutations.committed.get()
                            .then(() => resolve())
                            .catch((err) => reject(err));
                        break;
                    case 'written':
                        localMutations.written.get()
                            .then(() => resolve())
                            .catch((err) => reject(err));
                        break;
                }
            });
        });
    }
    batched(remoteMutations, localMutations, target) {
        this.batchPromises(remoteMutations.written.get(), localMutations.written.get(), target.written, 'written');
        this.batchPromises(remoteMutations.committed.get(), localMutations.committed.get(), target.committed, 'committed');
    }
    batchPromises(remotePromise, localPromise, latch, consistency) {
        const batch = Promise.all([remotePromise, localPromise]);
        batch.then((result) => {
            latch.resolve(result[0]);
        }).catch(err => {
            latch.reject(err);
        });
    }
    static handle(delegate, target, converter) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const result = yield delegate();
                const converted = converter(result);
                target.written.resolve(converted);
                target.committed.resolve(converted);
                return result;
            }
            catch (e) {
                target.written.reject(e);
                target.committed.reject(e);
                throw e;
            }
        });
    }
    static pipe(source, target, converter) {
        this.pipeLatch(source.written, target.written, converter, target.id);
        this.pipeLatch(source.committed, target.committed, converter, target.id);
    }
    static pipeLatch(source, target, converter, targetID) {
        source.get()
            .then((value) => {
            target.resolve(converter(value));
        })
            .catch(err => {
            target.reject(err);
        });
    }
}
exports.DatastoreMutations = DatastoreMutations;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YXN0b3JlTXV0YXRpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRGF0YXN0b3JlTXV0YXRpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsMkRBQWdGO0FBSWhGLE1BQWEsa0JBQWtCO0lBSTNCLFlBQW9CLFdBQWlDO1FBQ2pELElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ25DLENBQUM7SUFFTSxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQWlDO1FBQ2xELE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBT08sb0JBQW9CLENBQUksV0FBc0UsRUFDdEUsYUFBMEUsRUFDMUUsZ0JBQXNDLEVBQ3RDLGtCQUF3QyxFQUN4QyxNQUE0QjtRQUV4RCxXQUFXLENBQUMsZ0JBQWdCLENBQUM7YUFDeEIsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUVYLENBQUMsQ0FBQzthQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ1gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBSVAsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUU7WUFDOUIsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7YUFDMUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNQLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQztpQkFDNUIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFbkMsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDWCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFFWCxDQUFDO0lBb0JZLG1CQUFtQixDQUFJLGlC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cnQge0RhdGFzdG9yZU11dGF0aW9uLCBEZWZhdWx0RGF0YXN0b3JlTXV0YXRpb259IGZyb20gJy4vRGF0YXN0b3JlTXV0YXRpb24nO1xuaW1wb3J0IHtEYXRhc3RvcmVDb25zaXN0ZW5jeX0gZnJvbSAnLi9EYXRhc3RvcmUnO1xuaW1wb3J0IHtMYXRjaH0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdXRpbC9MYXRjaFwiO1xuXG5leHBvcnQgY2xhc3MgRGF0YXN0b3JlTXV0YXRpb25zIHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uc2lzdGVuY3k6IERhdGFzdG9yZUNvbnNpc3RlbmN5O1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihjb25zaXN0ZW5jeTogRGF0YXN0b3JlQ29uc2lzdGVuY3kpIHtcbiAgICAgICAgdGhpcy5jb25zaXN0ZW5jeSA9IGNvbnNpc3RlbmN5O1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlKGNvbnNpc3RlbmN5OiBEYXRhc3RvcmVDb25zaXN0ZW5jeSk6IERhdGFzdG9yZU11dGF0aW9ucyB7XG4gICAgICAgIHJldHVybiBuZXcgRGF0YXN0b3JlTXV0YXRpb25zKGNvbnNpc3RlbmN5KTtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIERvIGEgcHJpbWFyeSBzeW5jIGZvbGxvd2VkIGJ5IGEgc2Vjb25kYXJ5IHN5bmMgYW5kIHRoZW4gZm9yd2FyZCB0aGVpclxuICAgICAqIGNvbXBsZXRpb24gdG8gc2V0IG9mIG11dGF0aW9ucy5cbiAgICAgKi9cbiAgICBwcml2YXRlIHBlcmZvcm1PcmRlcmVkV3JpdGVzPFQ+KHByaW1hcnlTeW5jOiAocHJpbWFyeU11dGF0aW9uczogRGF0YXN0b3JlTXV0YXRpb248VD4pID0+IFByb21pc2U8dm9pZD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlTeW5jOiAoc2Vjb25kYXJ5TXV0YXRpb25zOiBEYXRhc3RvcmVNdXRhdGlvbjxUPikgPT4gUHJvbWlzZTx2b2lkPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW1hcnlNdXRhdGlvbnM6IERhdGFzdG9yZU11dGF0aW9uPFQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5TXV0YXRpb25zOiBEYXRhc3RvcmVNdXRhdGlvbjxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdDogKGVycjogRXJyb3IpID0+IHZvaWQpIHtcblxuICAgICAgICBwcmltYXJ5U3luYyhwcmltYXJ5TXV0YXRpb25zKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIG5vb3BcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVE9ETzogSSB1c2VkIHJhY2UgYmVmb3JlIGJ1dCBpdCBkaWRuJ3QgYWN0dWFsbHkgd29yayBwcm9wZXJseSBhbmQgSVxuICAgICAgICAvLyB0aGluayBpdCdzIGluY29ycmVjdCBhcyB3ZWxsLlxuICAgICAgICBQcm9taXNlLmFsbChbcHJpbWFyeU11dGF0aW9ucy53cml0dGVuLmdldCgpLFxuICAgICAgICAgICAgICAgICAgICAgcHJpbWFyeU11dGF0aW9ucy5jb21taXR0ZWQuZ2V0KCldKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHNlY29uZGFyeVN5bmMoc2Vjb25kYXJ5TXV0YXRpb25zKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gYSB3cml0ZSB3aGlsZSBjb29yZGluYXRpbmcgdGhlIHJlbW90ZSBhbmQgbG9jYWwgd3JpdGVzLlxuICAgICAqXG4gICAgICogVGhlIHJlbW90ZSBvcGVyYXRpb24gZXhlY3V0ZXMgYW5kIGNvbXBsZXRlcyB3cml0dGVuIG9uY2UgaXQncyB3cml0dGVuXG4gICAgICogbG9jYWxseSBidXQgcG90ZW50aWFsbHkgc3RpbGwgdW5zYWZlIGFzIGl0J3Mgbm90ICdjb21taXR0ZWQnLiAgT25jZSBpdCdzXG4gICAgICogY29tbWl0dGVkIGxvY2FsbHkgKGFuZCBzYWZlKSB0aGVuIHdlIGNhbiBwZXJmb3JtIHRoZSBsb2NhbCBvcGVyYXRpb25cbiAgICAgKiB3aGljaCBpcyBhbHNvIGF0b21pYyAoYW5kIHNhZmUpLlxuICAgICAqXG4gICAgICogVGhlbiB3ZSBwZXJmb3JtIEJPVEggYmF0Y2hlZCBvcGVyYXRpb25zIGFuZCBtYWtlIHN1cmUgdGhleSdyZSBhbGwgYm90aFxuICAgICAqIHdyaXR0ZW4gYW5kIGNvbW1pdHRlZCBiZWZvcmUgcmV0dXJuaW5nLlxuICAgICAqXG4gICAgICogVGhlIGNhbGxlciBET0VTIE5PVCBuZWVkIHRvIHdhaXQgZm9yIHRoZSBwcm9taXNlIHRvIGNvbXBsZXRlLiAgSXQgY291bGRcbiAgICAgKiBwdXQgdGhlbSBpbnRvIHF1ZXVlcyBvciBqdXN0IGxvb2sgYXQgdGhlIHdyaXR0ZW4gYW5kIGNvbW1pdHRlZCB2YWx1ZXNcbiAgICAgKiBvbiB0aGUgZGF0YXN0b3JlTXV0YXRpb24gYXMgaXQncyBtb3ZpbmcgZm9yd2FyZC4gIFRoaXMgYWxsb3dzIHVzIHRvXG4gICAgICogaGF2ZSBhIHByb2dyZXNzIGJhciBpbnRlZ3JhdGVkIHNob3dpbmcgdGhhdCB0aGUgc3luYyBvcGVyYXRpb25zIGFyZW4ndFxuICAgICAqIGNvbXBsZXRlZCB5ZXQuXG4gICAgICpcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUJhdGNoZWRXcml0ZTxUPihkYXRhc3RvcmVNdXRhdGlvbjogRGF0YXN0b3JlTXV0YXRpb248VD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlU3luYzogKHJlbW90ZU11dGF0aW9uczogRGF0YXN0b3JlTXV0YXRpb248VD4pID0+IFByb21pc2U8dm9pZD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxTeW5jOiAobG9jYWxNdXRhdGlvbnM6IERhdGFzdG9yZU11dGF0aW9uPFQ+KSA9PiBQcm9taXNlPHZvaWQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZU11dGF0aW9uczogRGF0YXN0b3JlTXV0YXRpb248VD4gPSBuZXcgRGVmYXVsdERhdGFzdG9yZU11dGF0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxNdXRhdGlvbnM6IERhdGFzdG9yZU11dGF0aW9uPFQ+ID0gbmV3IERlZmF1bHREYXRhc3RvcmVNdXRhdGlvbigpKTogUHJvbWlzZTx2b2lkPiB7XG5cbiAgICAgICAgY29uc3Qgd3JpdGVSZW1vdGVUaGVuTG9jYWwgPSAocmVqZWN0OiAoZXJyOiBFcnJvcikgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wZXJmb3JtT3JkZXJlZFdyaXRlczxUPihyZW1vdGVTeW5jLCBsb2NhbFN5bmMsIHJlbW90ZU11dGF0aW9ucywgbG9jYWxNdXRhdGlvbnMsIHJlamVjdCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgd3JpdGVMb2NhbFRoZW5SZW1vdGUgPSAocmVqZWN0OiAoZXJyOiBFcnJvcikgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wZXJmb3JtT3JkZXJlZFdyaXRlczxUPihsb2NhbFN5bmMsIHJlbW90ZVN5bmMsIGxvY2FsTXV0YXRpb25zLCByZW1vdGVNdXRhdGlvbnMsIHJlamVjdCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgLy8gd3JpdGVSZW1vdGVUaGVuTG9jYWwocmVqZWN0KTtcbiAgICAgICAgICAgIHdyaXRlTG9jYWxUaGVuUmVtb3RlKHJlamVjdCk7XG5cbiAgICAgICAgICAgIHRoaXMuYmF0Y2hlZChyZW1vdGVNdXRhdGlvbnMsIGxvY2FsTXV0YXRpb25zLCBkYXRhc3RvcmVNdXRhdGlvbik7XG5cbiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5jb25zaXN0ZW5jeSkge1xuXG4gICAgICAgICAgICAgICAgY2FzZSAnY29tbWl0dGVkJzpcblxuICAgICAgICAgICAgICAgICAgICByZW1vdGVNdXRhdGlvbnMuY29tbWl0dGVkLmdldCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiByZXNvbHZlKCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xuXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAnd3JpdHRlbic6XG5cbiAgICAgICAgICAgICAgICAgICAgbG9jYWxNdXRhdGlvbnMud3JpdHRlbi5nZXQoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gcmVzb2x2ZSgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcblxuICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgYmF0Y2hlZDxUPihyZW1vdGVNdXRhdGlvbnM6IERhdGFzdG9yZU11dGF0aW9uPFQ+LFxuICAgICAgICAgICAgICAgICAgICAgIGxvY2FsTXV0YXRpb25zOiBEYXRhc3RvcmVNdXRhdGlvbjxUPixcbiAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IERhdGFzdG9yZU11dGF0aW9uPFQ+ICkge1xuXG4gICAgICAgIHRoaXMuYmF0Y2hQcm9taXNlcyhyZW1vdGVNdXRhdGlvbnMud3JpdHRlbi5nZXQoKSwgbG9jYWxNdXRhdGlvbnMud3JpdHRlbi5nZXQoKSwgdGFyZ2V0LndyaXR0ZW4sICd3cml0dGVuJyk7XG5cbiAgICAgICAgdGhpcy5iYXRjaFByb21pc2VzKHJlbW90ZU11dGF0aW9ucy5jb21taXR0ZWQuZ2V0KCksIGxvY2FsTXV0YXRpb25zLmNvbW1pdHRlZC5nZXQoKSwgdGFyZ2V0LmNvbW1pdHRlZCwgJ2NvbW1pdHRlZCcpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcmVtb3RlUHJvbWlzZVxuICAgICAqIEBwYXJhbSBsb2NhbFByb21pc2VcbiAgICAgKiBAcGFyYW0gbGF0Y2hcbiAgICAgKiBAcGFyYW0gY29uc2lzdGVuY3kgVGhlIGNvbnNpc3RlbmN5IHRoaXMgcmVwcmVzZW50cy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGJhdGNoUHJvbWlzZXM8VD4ocmVtb3RlUHJvbWlzZTogUHJvbWlzZTxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxQcm9taXNlOiBQcm9taXNlPFQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXRjaDogTGF0Y2g8VD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNpc3RlbmN5OiBEYXRhc3RvcmVDb25zaXN0ZW5jeSk6IHZvaWQge1xuXG4gICAgICAgIGNvbnN0IGJhdGNoID0gUHJvbWlzZS5hbGwoW3JlbW90ZVByb21pc2UsIGxvY2FsUHJvbWlzZV0pO1xuXG4gICAgICAgIGJhdGNoLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgbGF0Y2gucmVzb2x2ZShyZXN1bHRbMF0pO1xuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgbGF0Y2gucmVqZWN0KGVycik7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyBhIGRhdGFzdG9yZSBtdXRhdGlvbiBpbmNsdWRpbmcgdGhlIHdyaXR0ZW4gYW5kIGNvbW1pdHRlZCBsYXRjaGVzXG4gICAgICogZm9yIHRoZSBlbnRpcmUgZGVsZWdhdGUuXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBoYW5kbGU8ViwgVD4oZGVsZWdhdGU6ICgpID0+IFByb21pc2U8Vj4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBEYXRhc3RvcmVNdXRhdGlvbjxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0ZXI6IChpbnB1dDogVikgPT4gVCk6IFByb21pc2U8Vj4ge1xuXG4gICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRlbGVnYXRlKCk7XG4gICAgICAgICAgICBjb25zdCBjb252ZXJ0ZWQgPSBjb252ZXJ0ZXIocmVzdWx0KTtcblxuICAgICAgICAgICAgdGFyZ2V0LndyaXR0ZW4ucmVzb2x2ZShjb252ZXJ0ZWQpO1xuICAgICAgICAgICAgdGFyZ2V0LmNvbW1pdHRlZC5yZXNvbHZlKGNvbnZlcnRlZCk7XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGFyZ2V0LndyaXR0ZW4ucmVqZWN0KGUpO1xuICAgICAgICAgICAgdGFyZ2V0LmNvbW1pdHRlZC5yZWplY3QoZSk7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQaXBlIHRoZSByZXNvbHZlIGFuZCByZWplY3Qgc3RhdHVzIG9mIHRoZSBsYXRjaGVzIHRvIHRoZSB0YXJnZXQuXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBwaXBlPFQsIFY+KHNvdXJjZTogRGF0YXN0b3JlTXV0YXRpb248VD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogRGF0YXN0b3JlTXV0YXRpb248Vj4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRlcjogKGlucHV0OiBUKSA9PiBWKTogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5waXBlTGF0Y2goc291cmNlLndyaXR0ZW4sIHRhcmdldC53cml0dGVuLCBjb252ZXJ0ZXIsIHRhcmdldC5pZCk7XG4gICAgICAgIHRoaXMucGlwZUxhdGNoKHNvdXJjZS5jb21taXR0ZWQsIHRhcmdldC5jb21taXR0ZWQsIGNvbnZlcnRlciwgdGFyZ2V0LmlkKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIHBpcGVMYXRjaDxULCBWPihzb3VyY2U6IExhdGNoPFQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IExhdGNoPFY+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0ZXI6IChpbnB1dDogVCkgPT4gVixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0SUQ6IG51bWJlcik6IHZvaWQge1xuXG4gICAgICAgIHNvdXJjZS5nZXQoKVxuICAgICAgICAgICAgLnRoZW4oKHZhbHVlOiBUKSA9PiB7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnJlc29sdmUoY29udmVydGVyKHZhbHVlKSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICB9XG5cbn1cbiJdfQ==