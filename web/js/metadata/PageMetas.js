"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Logger_1 = require("polar-shared/src/logger/Logger");
const Functions_1 = require("polar-shared/src/util/Functions");
const Hashcodes_1 = require("polar-shared/src/util/Hashcodes");
const Pagemarks_1 = require("./Pagemarks");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const AnnotationEvent_1 = require("../annotations/components/AnnotationEvent");
const log = Logger_1.Logger.create();
class PageMetas {
    static upgrade(pageMetas) {
        pageMetas = Object.assign({}, pageMetas);
        Functions_1.forDict(pageMetas, (key, pageMeta) => {
            if (!Preconditions_1.isPresent(pageMeta.textHighlights)) {
                pageMeta.textHighlights = {};
            }
            Functions_1.forDict(pageMeta.textHighlights, (_, textHighlight) => {
                if (!textHighlight.id) {
                    textHighlight.id = Hashcodes_1.Hashcodes.createID(textHighlight.rects);
                }
            });
            if (!Preconditions_1.isPresent(pageMeta.areaHighlights)) {
                pageMeta.areaHighlights = {};
            }
            if (!pageMeta.pagemarks) {
                pageMeta.pagemarks = {};
            }
            if (!pageMeta.screenshots) {
                pageMeta.screenshots = {};
            }
            if (!pageMeta.notes) {
                pageMeta.notes = {};
            }
            if (!pageMeta.comments) {
                pageMeta.comments = {};
            }
            if (!pageMeta.questions) {
                pageMeta.questions = {};
            }
            if (!pageMeta.readingProgress) {
                pageMeta.readingProgress = {};
            }
            pageMeta.pagemarks = Pagemarks_1.Pagemarks.upgrade(pageMeta.pagemarks);
        });
        return pageMetas;
    }
    static createModel(docMeta, memberName, callback, opts = {}) {
        Preconditions_1.Preconditions.assertPresent(docMeta, "docMeta");
        Preconditions_1.Preconditions.assertPresent(memberName, "memberName");
        Preconditions_1.Preconditions.assertPresent(callback, "callback");
        Functions_1.forDict(docMeta.pageMetas, (key, pageMeta) => {
            const member = pageMeta[memberName];
            if (!member) {
                log.warn("No member for key: " + key, memberName);
            }
            const traceListener = member.addTraceListener((traceEvent) => {
                if (!traceEvent.path.endsWith("/" + memberName)) {
                    return;
                }
                const annotationEvent = new AnnotationEvent_1.AnnotationEvent(Object.assign({}, traceEvent, {
                    docMeta,
                    pageMeta,
                    traceEvent,
                }));
                callback(annotationEvent);
                return true;
            });
            if (!opts.noSync) {
                traceListener.sync();
            }
        });
    }
}
exports.PageMetas = PageMetas;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFnZU1ldGFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUGFnZU1ldGFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkRBQXNEO0FBRXRELCtEQUF3RDtBQUN4RCwrREFBMEQ7QUFDMUQsMkNBQXNDO0FBRXRDLGtFQUF3RTtBQUN4RSwrRUFBMEU7QUFLMUUsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQWEsU0FBUztJQUVYLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBcUM7UUFFdkQsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXpDLG1CQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBRWpDLElBQUksQ0FBRSx5QkFBUyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsRUFBRTtnQkFFdEMsUUFBUSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7YUFDaEM7WUFHRCxtQkFBTyxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDLEVBQUUsYUFBYSxFQUFFLEVBQUU7Z0JBQ2xELElBQUksQ0FBRSxhQUFhLENBQUMsRUFBRSxFQUFFO29CQUVwQixhQUFhLENBQUMsRUFBRSxHQUFHLHFCQUFTLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDOUQ7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUlILElBQUksQ0FBRSx5QkFBUyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsRUFBRTtnQkFFdEMsUUFBUSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7YUFDaEM7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtnQkFFckIsUUFBUSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7YUFDM0I7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRTtnQkFFdkIsUUFBUSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7YUFDN0I7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRTtnQkFFakIsUUFBUSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7YUFDdkI7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRTtnQkFFcEIsUUFBUSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7YUFDMUI7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtnQkFFckIsUUFBUSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7YUFDM0I7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsRUFBRTtnQkFFM0IsUUFBUSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7YUFDakM7WUFFRCxRQUFRLENBQUMsU0FBUyxHQUFHLHFCQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUUvRCxDQUFDLENBQUUsQ0FBQztRQUVKLE9BQU8sU0FBUyxDQUFDO0lBRXJCLENBQUM7SUFNTSxNQUFNLENBQUMsV0FBVyxDQUFDLE9BQWlCLEVBQ2pCLFVBQWtCLEVBQ2xCLFFBQW9ELEVBQ3BELE9BQWtCLEVBQUU7UUFPMUMsNkJBQWEsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2hELDZCQUFhLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUN0RCw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFbEQsbUJBQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBRXpDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUVwQyxJQUFJLENBQUUsTUFBTSxFQUFFO2dCQUNWLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEdBQUcsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQ3JEO1lBRUQsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMsVUFBc0IsRUFBRSxFQUFFO2dCQUVyRSxJQUFJLENBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxFQUFFO29CQUM5QyxPQUFPO2lCQUNWO2dCQUVELE1BQU0sZUFBZSxHQUFHLElBQUksaUNBQWUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxVQUFVLEVBQUU7b0JBQ3RFLE9BQU87b0JBQ1AsUUFBUTtvQkFDUixVQUFVO2lCQUNiLENBQUMsQ0FBQyxDQUFDO2dCQUVKLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFFMUIsT0FBTyxJQUFJLENBQUM7WUFFaEIsQ0FBQyxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDZixhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDeEI7UUFFTCxDQUFDLENBQUMsQ0FBQztJQUdQLENBQUM7Q0FFSjtBQXZIRCw4QkF1SEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0xvZ2dlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7UGFnZU1ldGF9IGZyb20gJy4vUGFnZU1ldGEnO1xuaW1wb3J0IHtmb3JEaWN0fSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvRnVuY3Rpb25zJztcbmltcG9ydCB7SGFzaGNvZGVzfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvSGFzaGNvZGVzJztcbmltcG9ydCB7UGFnZW1hcmtzfSBmcm9tICcuL1BhZ2VtYXJrcyc7XG5pbXBvcnQge0RvY01ldGF9IGZyb20gJy4vRG9jTWV0YSc7XG5pbXBvcnQge2lzUHJlc2VudCwgUHJlY29uZGl0aW9uc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7QW5ub3RhdGlvbkV2ZW50fSBmcm9tICcuLi9hbm5vdGF0aW9ucy9jb21wb25lbnRzL0Fubm90YXRpb25FdmVudCc7XG5pbXBvcnQge1RyYWNlRXZlbnR9IGZyb20gJy4uL3Byb3hpZXMvVHJhY2VFdmVudCc7XG5pbXBvcnQge0lQYWdlTWV0YX0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSVBhZ2VNZXRhXCI7XG5pbXBvcnQge0lEb2NNZXRhfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JRG9jTWV0YVwiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmV4cG9ydCBjbGFzcyBQYWdlTWV0YXMge1xuXG4gICAgcHVibGljIHN0YXRpYyB1cGdyYWRlKHBhZ2VNZXRhczoge1trZXk6IG51bWJlcl06IElQYWdlTWV0YX0pIHtcblxuICAgICAgICBwYWdlTWV0YXMgPSBPYmplY3QuYXNzaWduKHt9LCBwYWdlTWV0YXMpO1xuXG4gICAgICAgIGZvckRpY3QocGFnZU1ldGFzLCAoa2V5LCBwYWdlTWV0YSkgPT4ge1xuXG4gICAgICAgICAgICBpZiAoISBpc1ByZXNlbnQocGFnZU1ldGEudGV4dEhpZ2hsaWdodHMpKSB7XG4gICAgICAgICAgICAgICAgLy8gbG9nLmRlYnVnKFwiTm8gdGV4dEhpZ2hsaWdodHMuICBBc3NpZ25pbmcgZGVmYXVsdC5cIik7XG4gICAgICAgICAgICAgICAgcGFnZU1ldGEudGV4dEhpZ2hsaWdodHMgPSB7fTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gbWFrZSBzdXJlIGxlZ2FjeSAvIG9sZCB0ZXh0IGhpZ2hsaWdodHMgYXJlIGdpdmVuIElEcy5cbiAgICAgICAgICAgIGZvckRpY3QocGFnZU1ldGEudGV4dEhpZ2hsaWdodHMsIChfLCB0ZXh0SGlnaGxpZ2h0KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCEgdGV4dEhpZ2hsaWdodC5pZCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBsb2cuZGVidWcoXCJUZXh0IGhpZ2hsaWdodCBnaXZlbiBJRFwiKTtcbiAgICAgICAgICAgICAgICAgICAgdGV4dEhpZ2hsaWdodC5pZCA9IEhhc2hjb2Rlcy5jcmVhdGVJRCh0ZXh0SGlnaGxpZ2h0LnJlY3RzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy8gVE9ETzogdG9vIG11Y2ggYm9pbGVycGxhdGUgaGVyZS5cblxuICAgICAgICAgICAgaWYgKCEgaXNQcmVzZW50KHBhZ2VNZXRhLmFyZWFIaWdobGlnaHRzKSkge1xuICAgICAgICAgICAgICAgIC8vIGxvZy5kZWJ1ZyhcIk5vIGFyZWFIaWdobGlnaHRzLiAgQXNzaWduaW5nIGRlZmF1bHQuXCIpO1xuICAgICAgICAgICAgICAgIHBhZ2VNZXRhLmFyZWFIaWdobGlnaHRzID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcGFnZU1ldGEucGFnZW1hcmtzKSB7XG4gICAgICAgICAgICAgICAgLy8gbG9nLmRlYnVnKFwiTm8gcGFnZW1hcmtzLiAgQXNzaWduaW5nIGRlZmF1bHQgKGVtcHR5IG1hcClcIik7XG4gICAgICAgICAgICAgICAgcGFnZU1ldGEucGFnZW1hcmtzID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcGFnZU1ldGEuc2NyZWVuc2hvdHMpIHtcbiAgICAgICAgICAgICAgICAvLyBsb2cuZGVidWcoXCJObyBzY3JlZW5zaG90cy4gIEFzc2lnbmluZyBkZWZhdWx0IChlbXB0eSBtYXApXCIpO1xuICAgICAgICAgICAgICAgIHBhZ2VNZXRhLnNjcmVlbnNob3RzID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcGFnZU1ldGEubm90ZXMpIHtcbiAgICAgICAgICAgICAgICAvLyBsb2cuZGVidWcoXCJObyBub3Rlcy4gIEFzc2lnbmluZyBkZWZhdWx0IChlbXB0eSBtYXApXCIpO1xuICAgICAgICAgICAgICAgIHBhZ2VNZXRhLm5vdGVzID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcGFnZU1ldGEuY29tbWVudHMpIHtcbiAgICAgICAgICAgICAgICAvLyBsb2cuZGVidWcoXCJObyBjb21tZW50cy4gIEFzc2lnbmluZyBkZWZhdWx0IChlbXB0eSBtYXApXCIpO1xuICAgICAgICAgICAgICAgIHBhZ2VNZXRhLmNvbW1lbnRzID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcGFnZU1ldGEucXVlc3Rpb25zKSB7XG4gICAgICAgICAgICAgICAgLy8gbG9nLmRlYnVnKFwiTm8gcXVlc3Rpb25zLiAgQXNzaWduaW5nIGRlZmF1bHQgKGVtcHR5IG1hcClcIik7XG4gICAgICAgICAgICAgICAgcGFnZU1ldGEucXVlc3Rpb25zID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcGFnZU1ldGEucmVhZGluZ1Byb2dyZXNzKSB7XG4gICAgICAgICAgICAgICAgLy8gbG9nLmRlYnVnKFwiTm8gcmVhZGluZ1Byb2dyZXNzTG9nLiAgQXNzaWduaW5nIGRlZmF1bHQgKGVtcHR5IG1hcClcIik7XG4gICAgICAgICAgICAgICAgcGFnZU1ldGEucmVhZGluZ1Byb2dyZXNzID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHBhZ2VNZXRhLnBhZ2VtYXJrcyA9IFBhZ2VtYXJrcy51cGdyYWRlKHBhZ2VNZXRhLnBhZ2VtYXJrcyk7XG5cbiAgICAgICAgfSApO1xuXG4gICAgICAgIHJldHVybiBwYWdlTWV0YXM7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBtb2RlbCBmb3IgYSBzcGVjaWZpYyBrZXkgd2l0aGluIFBhZ2VNZXRhcy5cbiAgICAgKlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlTW9kZWwoZG9jTWV0YTogSURvY01ldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW1iZXJOYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogKGFubm90YXRpb25FdmVudDogQW5ub3RhdGlvbkV2ZW50KSA9PiB2b2lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0czogTW9kZWxPcHRzID0ge30pIHtcblxuICAgICAgICAvLyBUT0RPOiBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gaGF2ZSB0aGlzIHJldHVybiBhbiBhcnJheSBvZiBhbGxcbiAgICAgICAgLy8gY3VycmVudGx5IGtub3duIHZhbHVlcyB0aGlzIHdheSBvbiBzdGFydHVwIEkgY2FuIHNlbmQgZXZlcnl0aGluZyBJXG4gICAgICAgIC8vIGtub3cgYWJvdXQgd2l0aG91dCBoYXZpbmcgdG8gcmVzb3J0IGluZGV4ZXMgb3IgdXBkYXRlIG1hcHMgbXVsdGlwbGVcbiAgICAgICAgLy8gdGltZXMuXG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KGRvY01ldGEsIFwiZG9jTWV0YVwiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KG1lbWJlck5hbWUsIFwibWVtYmVyTmFtZVwiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KGNhbGxiYWNrLCBcImNhbGxiYWNrXCIpO1xuXG4gICAgICAgIGZvckRpY3QoZG9jTWV0YS5wYWdlTWV0YXMsIChrZXksIHBhZ2VNZXRhKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IG1lbWJlciA9IHBhZ2VNZXRhW21lbWJlck5hbWVdO1xuXG4gICAgICAgICAgICBpZiAoISBtZW1iZXIpIHtcbiAgICAgICAgICAgICAgICBsb2cud2FybihcIk5vIG1lbWJlciBmb3Iga2V5OiBcIiArIGtleSwgbWVtYmVyTmFtZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHRyYWNlTGlzdGVuZXIgPSBtZW1iZXIuYWRkVHJhY2VMaXN0ZW5lcigodHJhY2VFdmVudDogVHJhY2VFdmVudCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKCEgdHJhY2VFdmVudC5wYXRoLmVuZHNXaXRoKFwiL1wiICsgbWVtYmVyTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IGFubm90YXRpb25FdmVudCA9IG5ldyBBbm5vdGF0aW9uRXZlbnQoT2JqZWN0LmFzc2lnbih7fSwgdHJhY2VFdmVudCwge1xuICAgICAgICAgICAgICAgICAgICBkb2NNZXRhLFxuICAgICAgICAgICAgICAgICAgICBwYWdlTWV0YSxcbiAgICAgICAgICAgICAgICAgICAgdHJhY2VFdmVudCxcbiAgICAgICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgICAgICBjYWxsYmFjayhhbm5vdGF0aW9uRXZlbnQpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoISBvcHRzLm5vU3luYykge1xuICAgICAgICAgICAgICAgIHRyYWNlTGlzdGVuZXIuc3luYygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuXG5cbiAgICB9XG5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBNb2RlbE9wdHMge1xuICAgIHJlYWRvbmx5IG5vU3luYz86IGJvb2xlYW47XG59XG4iXX0=