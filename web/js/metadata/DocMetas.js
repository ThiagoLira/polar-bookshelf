"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const PageMeta_1 = require("./PageMeta");
const DocMeta_1 = require("./DocMeta");
const PagemarkType_1 = require("polar-shared/src/metadata/PagemarkType");
const PageInfo_1 = require("./PageInfo");
const DocInfos_1 = require("./DocInfos");
const AnnotationInfos_1 = require("./AnnotationInfos");
const Pagemarks_1 = require("./Pagemarks");
const MetadataSerializer_1 = require("./MetadataSerializer");
const PageMetas_1 = require("./PageMetas");
const Functions_1 = require("polar-shared/src/util/Functions");
const TextHighlights_1 = require("./TextHighlights");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Errors_1 = require("../util/Errors");
const ISODateTimeStrings_1 = require("polar-shared/src/metadata/ISODateTimeStrings");
const FilePaths_1 = require("polar-shared/src/util/FilePaths");
const Backend_1 = require("polar-shared/src/datastore/Backend");
class DocMetas {
    static create(fingerprint, nrPages, filename) {
        const docInfo = DocInfos_1.DocInfos.create(fingerprint, nrPages, filename);
        const pageMetas = {};
        for (let idx = 1; idx <= nrPages; ++idx) {
            const pageInfo = new PageInfo_1.PageInfo({ num: idx });
            const pageMeta = new PageMeta_1.PageMeta({ pageInfo });
            pageMetas[idx] = pageMeta;
        }
        return new DocMeta_1.DocMeta(docInfo, pageMetas);
    }
    static createWithinInitialPagemarks(fingerprint, nrPages) {
        return MockDocMetas.createWithinInitialPagemarks(fingerprint, nrPages);
    }
    static createMockDocMeta() {
        return MockDocMetas.createMockDocMeta();
    }
    static getPageMeta(docMeta, num) {
        num = Preconditions_1.Preconditions.assertPresent(num, "num");
        const pageMeta = docMeta.pageMetas[num];
        if (!pageMeta) {
            throw new Error("No pageMeta for page: " + num);
        }
        return pageMeta;
    }
    static addPagemarks(docMeta, options) {
        if (!options) {
            options = {};
        }
        if (!options.nrPages) {
            options.nrPages = 3;
        }
        if (!options.offsetPage) {
            options.offsetPage = 1;
        }
        if (!options.percentage) {
            options.percentage = 100;
        }
        const maxPageNum = Math.min(options.offsetPage + options.nrPages - 1, docMeta.docInfo.nrPages);
        for (let pageNum = options.offsetPage; pageNum <= maxPageNum; ++pageNum) {
            const pagemark = Pagemarks_1.Pagemarks.create({
                type: PagemarkType_1.PagemarkType.SINGLE_COLUMN,
                percentage: 100,
                column: 0
            });
            Pagemarks_1.Pagemarks.updatePagemark(docMeta, pageNum, pagemark);
        }
    }
    static serialize(docMeta, spacing = "  ") {
        return MetadataSerializer_1.MetadataSerializer.serialize(docMeta, spacing);
    }
    static deserialize(data, fingerprint) {
        Preconditions_1.Preconditions.assertPresent(data, 'data');
        if (!(typeof data === "string")) {
            throw new Error("We can only deserialize strings: " + typeof data);
        }
        let docMeta = Object.create(DocMeta_1.DocMeta.prototype);
        try {
            docMeta = MetadataSerializer_1.MetadataSerializer.deserialize(docMeta, data);
            if (docMeta.docInfo && !docMeta.docInfo.filename) {
            }
            return DocMetas.upgrade(docMeta);
        }
        catch (e) {
            throw Errors_1.Errors.rethrow(e, "Unable to deserialize doc: " + fingerprint);
        }
    }
    static upgrade(docMeta) {
        docMeta.pageMetas = PageMetas_1.PageMetas.upgrade(docMeta.pageMetas);
        if (!docMeta.annotationInfo) {
            docMeta.annotationInfo = AnnotationInfos_1.AnnotationInfos.create();
        }
        if (!docMeta.attachments) {
            docMeta.attachments = {};
        }
        docMeta.docInfo = DocInfos_1.DocInfos.upgrade(docMeta.docInfo);
        return docMeta;
    }
    static computeProgress(docMeta) {
        let total = 0;
        Functions_1.forDict(docMeta.pageMetas, (key, pageMeta) => {
            Functions_1.forDict(pageMeta.pagemarks, (column, pagemark) => {
                total += pagemark.percentage;
            });
        });
        return total / (docMeta.docInfo.nrPages * 100);
    }
    static withBatchedMutations(docMeta, mutator) {
        return this.withMutating(docMeta, 'batch', mutator);
    }
    static withSkippedMutations(docMeta, mutator) {
        return this.withMutating(docMeta, 'skip', mutator);
    }
    static withMutating(docMeta, value, mutator) {
        if (docMeta.docInfo.mutating === value) {
            return mutator();
        }
        try {
            docMeta.docInfo.mutating = value;
            return mutator();
        }
        finally {
            docMeta.docInfo.mutating = undefined;
        }
    }
    static forceWrite(docMeta) {
        docMeta.docInfo.lastUpdated = ISODateTimeStrings_1.ISODateTimeStrings.create();
    }
}
exports.DocMetas = DocMetas;
class MockDocMetas {
    static createWithinInitialPagemarks(fingerprint, nrPages) {
        const result = DocMetas.create(fingerprint, nrPages);
        const maxPages = 3;
        for (let pageNum = 1; pageNum <= Math.min(nrPages, maxPages); ++pageNum) {
            const pagemark = Pagemarks_1.Pagemarks.create({
                type: PagemarkType_1.PagemarkType.SINGLE_COLUMN,
                percentage: 100,
                column: 0
            });
            Pagemarks_1.Pagemarks.updatePagemark(result, pageNum, pagemark);
        }
        return result;
    }
    static createMockDocMeta(fingerprint = "0x001") {
        const nrPages = 4;
        const docMeta = DocMetas.createWithinInitialPagemarks(fingerprint, nrPages);
        const textHighlight = TextHighlights_1.TextHighlights.createMockTextHighlight();
        DocMetas.getPageMeta(docMeta, 1).textHighlights[textHighlight.id] = textHighlight;
        return docMeta;
    }
    static createMockDocMetaFromPDF(datastore) {
        return __awaiter(this, void 0, void 0, function* () {
            const docMeta = MockDocMetas.createMockDocMeta();
            const pdfPath = FilePaths_1.FilePaths.join(__dirname, "..", "..", "..", "docs", "examples", "pdf", "chubby.pdf");
            const fileRef = {
                name: "chubby.pdf"
            };
            docMeta.docInfo.filename = fileRef.name;
            docMeta.docInfo.backend = Backend_1.Backend.STASH;
            yield datastore.writeFile(Backend_1.Backend.STASH, fileRef, { path: pdfPath });
            yield datastore.writeDocMeta(docMeta);
            const result = {
                docMeta, fileRef
            };
            return result;
        });
    }
}
exports.MockDocMetas = MockDocMetas;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRG9jTWV0YXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJEb2NNZXRhcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLHlDQUFvQztBQUNwQyx1Q0FBa0M7QUFDbEMseUVBQW9FO0FBQ3BFLHlDQUFvQztBQUNwQyx5Q0FBb0M7QUFDcEMsdURBQWtEO0FBQ2xELDJDQUFzQztBQUN0Qyw2REFBd0Q7QUFDeEQsMkNBQXNDO0FBQ3RDLCtEQUF3RDtBQUN4RCxxREFBZ0Q7QUFDaEQsa0VBQTZEO0FBQzdELDJDQUFzQztBQUN0QyxxRkFBZ0Y7QUFDaEYsK0RBQTBEO0FBRTFELGdFQUEyRDtBQUszRCxNQUFhLFFBQVE7SUFRVixNQUFNLENBQUMsTUFBTSxDQUFDLFdBQW1CLEVBQUUsT0FBZSxFQUFFLFFBQWlCO1FBRXhFLE1BQU0sT0FBTyxHQUFHLG1CQUFRLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFaEUsTUFBTSxTQUFTLEdBQThCLEVBQUUsQ0FBQztRQUVoRCxLQUFLLElBQUksR0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLElBQUksT0FBTyxFQUFFLEVBQUUsR0FBRyxFQUFFO1lBQ3JDLE1BQU0sUUFBUSxHQUFHLElBQUksbUJBQVEsQ0FBQyxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sUUFBUSxHQUFHLElBQUksbUJBQVEsQ0FBQyxFQUFDLFFBQVEsRUFBQyxDQUFDLENBQUM7WUFDMUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQztTQUM3QjtRQUVELE9BQU8sSUFBSSxpQkFBTyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztJQUUzQyxDQUFDO0lBYU0sTUFBTSxDQUFDLDRCQUE0QixDQUFDLFdBQW1CLEVBQUUsT0FBZTtRQUMzRSxPQUFPLFlBQVksQ0FBQyw0QkFBNEIsQ0FBQyxXQUFXLEVBQUUsT0FBTyxD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LENBQUMsQ0FBQztZQUV0QyxNQUFNLE1BQU0sR0FBWTtnQkFDcEIsT0FBTyxFQUFFLE9BQU87YUFDbkIsQ0FBQztZQUVGLE9BQU8sTUFBTSxDQUFDO1FBRWxCLENBQUM7S0FBQTtDQUVKO0FBbkVELG9DQW1FQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UGFnZU1ldGF9IGZyb20gJy4vUGFnZU1ldGEnO1xuaW1wb3J0IHtEb2NNZXRhfSBmcm9tICcuL0RvY01ldGEnO1xuaW1wb3J0IHtQYWdlbWFya1R5cGV9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvUGFnZW1hcmtUeXBlJztcbmltcG9ydCB7UGFnZUluZm99IGZyb20gJy4vUGFnZUluZm8nO1xuaW1wb3J0IHtEb2NJbmZvc30gZnJvbSAnLi9Eb2NJbmZvcyc7XG5pbXBvcnQge0Fubm90YXRpb25JbmZvc30gZnJvbSAnLi9Bbm5vdGF0aW9uSW5mb3MnO1xuaW1wb3J0IHtQYWdlbWFya3N9IGZyb20gJy4vUGFnZW1hcmtzJztcbmltcG9ydCB7TWV0YWRhdGFTZXJpYWxpemVyfSBmcm9tICcuL01ldGFkYXRhU2VyaWFsaXplcic7XG5pbXBvcnQge1BhZ2VNZXRhc30gZnJvbSAnLi9QYWdlTWV0YXMnO1xuaW1wb3J0IHtmb3JEaWN0fSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvRnVuY3Rpb25zJztcbmltcG9ydCB7VGV4dEhpZ2hsaWdodHN9IGZyb20gJy4vVGV4dEhpZ2hsaWdodHMnO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtFcnJvcnN9IGZyb20gJy4uL3V0aWwvRXJyb3JzJztcbmltcG9ydCB7SVNPRGF0ZVRpbWVTdHJpbmdzfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lTT0RhdGVUaW1lU3RyaW5ncyc7XG5pbXBvcnQge0ZpbGVQYXRoc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy91dGlsL0ZpbGVQYXRocyc7XG5pbXBvcnQge0RhdGFzdG9yZX0gZnJvbSAnLi4vZGF0YXN0b3JlL0RhdGFzdG9yZSc7XG5pbXBvcnQge0JhY2tlbmR9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvZGF0YXN0b3JlL0JhY2tlbmQnO1xuaW1wb3J0IHtJUGFnZU1ldGF9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lQYWdlTWV0YVwiO1xuaW1wb3J0IHtJRG9jTWV0YX0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSURvY01ldGFcIjtcbmltcG9ydCB7RmlsZVJlZn0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvZGF0YXN0b3JlL0ZpbGVSZWZcIjtcblxuZXhwb3J0IGNsYXNzIERvY01ldGFzIHtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSB0aGUgYmFzaWMgRG9jSW5mbyBzdHJ1Y3R1cmUgdGhhdCB3ZSBjYW4gdXNlIHdpdGggcmVxdWlyZWQgLyBiYXNpY1xuICAgICAqIGZpZWxkIHN0cnVjdHVyZS5cbiAgICAgKiBAcGFyYW0gZmluZ2VycHJpbnQgVGhlIGZpbmdlcnByaW50IG9mIHRoZSBkb2N1bWVudFxuICAgICAqIEBwYXJhbSBuclBhZ2VzIFRoZSBudW1iZXIgb2YgcGFnZXMgaW4gdGhpcyBkb2N1bWVudC5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZShmaW5nZXJwcmludDogc3RyaW5nLCBuclBhZ2VzOiBudW1iZXIsIGZpbGVuYW1lPzogc3RyaW5nKSB7XG5cbiAgICAgICAgY29uc3QgZG9jSW5mbyA9IERvY0luZm9zLmNyZWF0ZShmaW5nZXJwcmludCwgbnJQYWdlcywgZmlsZW5hbWUpO1xuXG4gICAgICAgIGNvbnN0IHBhZ2VNZXRhczoge1tpZDogc3RyaW5nXTogSVBhZ2VNZXRhfSA9IHt9O1xuXG4gICAgICAgIGZvciAobGV0IGlkeCA9IDE7IGlkeCA8PSBuclBhZ2VzOyArK2lkeCkge1xuICAgICAgICAgICAgY29uc3QgcGFnZUluZm8gPSBuZXcgUGFnZUluZm8oe251bTogaWR4fSk7XG4gICAgICAgICAgICBjb25zdCBwYWdlTWV0YSA9IG5ldyBQYWdlTWV0YSh7cGFnZUluZm99KTtcbiAgICAgICAgICAgIHBhZ2VNZXRhc1tpZHhdID0gcGFnZU1ldGE7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IERvY01ldGEoZG9jSW5mbywgcGFnZU1ldGFzKTtcblxuICAgIH1cblxuICAgIC8vIGxldCByZXN1bHQ6IElEb2NJbmZvID0gT2JqZWN0LmNyZWF0ZShEb2NJbmZvcy5wcm90b3R5cGUpO1xuICAgIC8vXG4gICAgLy8gcmVzdWx0LmZpbmdlcnByaW50ID0gZmluZ2VycHJpbnQ7XG4gICAgLy8gcmVzdWx0Lm5yUGFnZXMgPSBuclBhZ2VzO1xuICAgIC8vIHJlc3VsdC5pbml0KHJlc3VsdCk7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBEb2NNZXRhIG9iamVjdCBidXQgcGxhY2UgaW5pdGlhbCBwYWdlbWFya3Mgb24gaXQuIFRoaXMgaXMgdXNlZnVsXG4gICAgICogZm9yIHRlc3RpbmcuXG4gICAgICogQGRlcHJlY2F0ZWQgdXNlIE1vY2tEb2NNZXRhc1xuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlV2l0aGluSW5pdGlhbFBhZ2VtYXJrcyhmaW5nZXJwcmludDogc3RyaW5nLCBuclBhZ2VzOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIE1vY2tEb2NNZXRhcy5jcmVhdGVXaXRoaW5Jbml0aWFsUGFnZW1hcmtzKGZpbmdlcnByaW50LCBuclBhZ2VzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAZGVwcmVjYXRlZCB1c2UgTW9ja0RvY01ldGFzXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGVNb2NrRG9jTWV0YSgpIHtcbiAgICAgICAgcmV0dXJuIE1vY2tEb2NNZXRhcy5jcmVhdGVNb2NrRG9jTWV0YSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0UGFnZU1ldGEoZG9jTWV0YTogSURvY01ldGEsIG51bTogbnVtYmVyKSB7XG5cbiAgICAgICAgbnVtID0gUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KG51bSwgXCJudW1cIik7XG5cbiAgICAgICAgY29uc3QgcGFnZU1ldGEgPSBkb2NNZXRhLnBhZ2VNZXRhc1tudW1dO1xuXG4gICAgICAgIGlmICghcGFnZU1ldGEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHBhZ2VNZXRhIGZvciBwYWdlOiBcIiArIG51bSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcGFnZU1ldGE7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGFkZFBhZ2VtYXJrcyhkb2NNZXRhOiBJRG9jTWV0YSwgb3B0aW9uczogYW55KSB7XG5cbiAgICAgICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICAgICAgICBvcHRpb25zID0ge307XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIW9wdGlvbnMubnJQYWdlcykge1xuICAgICAgICAgICAgb3B0aW9ucy5uclBhZ2VzID0gMztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghb3B0aW9ucy5vZmZzZXRQYWdlKSB7XG4gICAgICAgICAgICAvLyB0aGUgc3RhcnRpbmcgcGFnZVxuICAgICAgICAgICAgb3B0aW9ucy5vZmZzZXRQYWdlID0gMTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghb3B0aW9ucy5wZXJjZW50YWdlKSB7XG4gICAgICAgICAgICAvLyB0aGUgcGVyY2VudGFnZSB2YWx1ZSBmcm9tIDAtMTAwXG4gICAgICAgICAgICBvcHRpb25zLnBlcmNlbnRhZ2UgPSAxMDA7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtYXhQYWdlTnVtID0gTWF0aC5taW4ob3B0aW9ucy5vZmZzZXRQYWdlICsgb3B0aW9ucy5uclBhZ2VzIC0gMSwgZG9jTWV0YS5kb2NJbmZvLm5yUGFnZXMpO1xuXG4gICAgICAgIGZvciAobGV0IHBhZ2VOdW0gPSBvcHRpb25zLm9mZnNldFBhZ2U7IHBhZ2VOdW0gPD0gbWF4UGFnZU51bTsgKytwYWdlTnVtICkge1xuXG4gICAgICAgICAgICBjb25zdCBwYWdlbWFyayA9IFBhZ2VtYXJrcy5jcmVhdGUoe1xuICAgICAgICAgICAgICAgIHR5cGU6IFBhZ2VtYXJrVHlwZS5TSU5HTEVfQ09MVU1OLFxuICAgICAgICAgICAgICAgIHBlcmNlbnRhZ2U6IDEwMCxcbiAgICAgICAgICAgICAgICBjb2x1bW46IDBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBQYWdlbWFya3MudXBkYXRlUGFnZW1hcmsoZG9jTWV0YSwgcGFnZU51bSwgcGFnZW1hcmspO1xuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgc2VyaWFsaXplKGRvY01ldGE6IElEb2NNZXRhLCBzcGFjaW5nOiBzdHJpbmcgPSBcIiAgXCIpIHtcbiAgICAgICAgcmV0dXJuIE1ldGFkYXRhU2VyaWFsaXplci5zZXJpYWxpemUoZG9jTWV0YSwgc3BhY2luZyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBkZXNlcmlhbGl6ZShkYXRhOiBzdHJpbmcsIGZpbmdlcnByaW50OiBzdHJpbmcpOiBJRG9jTWV0YSB7XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KGRhdGEsICdkYXRhJyk7XG5cbiAgICAgICAgaWYgKCEgKHR5cGVvZiBkYXRhID09PSBcInN0cmluZ1wiKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV2UgY2FuIG9ubHkgZGVzZXJpYWxpemUgc3RyaW5nczogXCIgKyB0eXBlb2YgZGF0YSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZG9jTWV0YTogSURvY01ldGEgPSBPYmplY3QuY3JlYXRlKERvY01ldGEucHJvdG90eXBlKTtcblxuICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICBkb2NNZXRhID0gTWV0YWRhdGFTZXJpYWxpemVyLmRlc2VyaWFsaXplKGRvY01ldGEsIGRhdGEpO1xuXG4gICAgICAgICAgICBpZiAoZG9jTWV0YS5kb2NJbmZvICYmICFkb2NNZXRhLmRvY0luZm8uZmlsZW5hbWUpIHtcbiAgICAgICAgICAgICAgICAvLyBsb2cud2FybihcIkRvY01ldGEgaGFzIG5vIGZpbGVuYW1lOiBcIiArIGRvY01ldGEuZG9jSW5mby5maW5nZXJwcmludCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBEb2NNZXRhcy51cGdyYWRlKGRvY01ldGEpO1xuXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9ycy5yZXRocm93KGUsIFwiVW5hYmxlIHRvIGRlc2VyaWFsaXplIGRvYzogXCIgKyBmaW5nZXJwcmludCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgdXBncmFkZShkb2NNZXRhOiBJRG9jTWV0YSk6IElEb2NNZXRhIHtcblxuICAgICAgICAvLyB2YWxpZGF0ZSB0aGUgSlNPTiBkYXRhIGFuZCBzZXQgZGVmYXVsdHMuIEluIHRoZSBmdXR1cmUgd2Ugc2hvdWxkXG4gICAgICAgIC8vIG1pZ3JhdGUgdG8gdXNpbmcgc29tZXRoaW5nIGxpa2UgQUpWIHRvIHByb3ZpZGUgdGhlc2UgZGVmYXVsdHMgYW5kXG4gICAgICAgIC8vIGFsc28gcGVyZm9ybSB0eXBlIGFzc2VydGlvbi5cblxuICAgICAgICBkb2NNZXRhLnBhZ2VNZXRhcyA9IFBhZ2VNZXRhcy51cGdyYWRlKGRvY01ldGEucGFnZU1ldGFzKTtcblxuICAgICAgICBpZiAoIWRvY01ldGEuYW5ub3RhdGlvbkluZm8pIHtcbiAgICAgICAgICAgIC8vIGxvZy5kZWJ1ZyhcIk5vIGFubm90YXRpb24gaW5mby4uIEFkZGluZyBkZWZhdWx0LlwiKTtcbiAgICAgICAgICAgIGRvY01ldGEuYW5ub3RhdGlvbkluZm8gPSBBbm5vdGF0aW9uSW5mb3MuY3JlYXRlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWRvY01ldGEuYXR0YWNobWVudHMpIHtcbiAgICAgICAgICAgIC8vIGxvZy5kZWJ1ZyhcIk5vIGF0dGFjaG1lbnRzLiBBZGRpbmcgZW1wdHkgbWFwLlwiKTtcbiAgICAgICAgICAgIGRvY01ldGEuYXR0YWNobWVudHMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRvY01ldGEuZG9jSW5mbyA9IERvY0luZm9zLnVwZ3JhZGUoZG9jTWV0YS5kb2NJbmZvKTtcblxuICAgICAgICByZXR1cm4gZG9jTWV0YTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbXB1dGUgdGhlIHByb2dyZXNzIG9mIGEgZG9jdW1lbnQgYmFzZWQgb24gdGhlIHBhZ2VtYXJrcy5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNvbXB1dGVQcm9ncmVzcyhkb2NNZXRhOiBJRG9jTWV0YSk6IG51bWJlciB7XG5cbiAgICAgICAgbGV0IHRvdGFsID0gMDtcblxuICAgICAgICBmb3JEaWN0KGRvY01ldGEucGFnZU1ldGFzLCAoa2V5LCBwYWdlTWV0YSkgPT4ge1xuXG4gICAgICAgICAgICBmb3JEaWN0KHBhZ2VNZXRhLnBhZ2VtYXJrcywgKGNvbHVtbiwgcGFnZW1hcmspID0+IHtcblxuICAgICAgICAgICAgICAgIHRvdGFsICs9IHBhZ2VtYXJrLnBlcmNlbnRhZ2U7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0b3RhbCAvIChkb2NNZXRhLmRvY0luZm8ubnJQYWdlcyAqIDEwMCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGNoYW5nZXMgdG8gdGhlIGRvY3VtZW50IHNvIHRoYXQgdGhleSB3cml0ZSBhcyBvbmUgYmF0Y2hlZCBtdXRhdGlvblxuICAgICAqIGF0IHRoZSBlbmQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZG9jTWV0YSBUaGUgZG9jIHRvIG11dGF0ZVxuICAgICAqXG4gICAgICogQHBhcmFtIG11dGF0b3IgIFRoZSBmdW5jdGlvbiB0byBleGVjdXRlIHdoaWNoIHdpbGwgbXV0YXRpb24gdGhlXG4gICAgICogdW5kZXJseWluZyBEb2NNZXRhIHByb3Blcmx5LlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgd2l0aEJhdGNoZWRNdXRhdGlvbnM8VD4oZG9jTWV0YTogSURvY01ldGEsIG11dGF0b3I6ICgpID0+IFQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2l0aE11dGF0aW5nKGRvY01ldGEsICdiYXRjaCcsIG11dGF0b3IpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgd2l0aFNraXBwZWRNdXRhdGlvbnM8VD4oZG9jTWV0YTogSURvY01ldGEsIG11dGF0b3I6ICgpID0+IFQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2l0aE11dGF0aW5nKGRvY01ldGEsICdza2lwJywgbXV0YXRvcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgd2l0aE11dGF0aW5nPFQ+KGRvY01ldGE6IElEb2NNZXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogJ3NraXAnIHwgJ2JhdGNoJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXV0YXRvcjogKCkgPT4gVCkge1xuXG4gICAgICAgIGlmIChkb2NNZXRhLmRvY0luZm8ubXV0YXRpbmcgPT09IHZhbHVlKSB7XG4gICAgICAgICAgICAvLyB3ZSB3ZXJlIGNhbGxlZCB0d2ljZSBzbyBkb24ndCByZXNldCBpdHNlbGYgaW4gdGhlIGZpbmFsbHkgYmxvY2tcbiAgICAgICAgICAgIC8vIGJlbG93IHRvIHRyaWdnZXIgdG9vIG1hbnkgdXBkYXRlcy4gSnVzdCBtdXRhdGUgZGlyZWN0bHkuXG4gICAgICAgICAgICByZXR1cm4gbXV0YXRvcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgZG9jTWV0YS5kb2NJbmZvLm11dGF0aW5nID0gdmFsdWU7XG5cbiAgICAgICAgICAgIHJldHVybiBtdXRhdG9yKCk7XG5cbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIC8vIHNldCBpdCB0byB1bmRlZmluZWQgc28gdGhhdCBpdCBpc24ndCBhY3R1YWxseSBwZXJzaXN0ZWQgaW4gdGhlXG4gICAgICAgICAgICAvLyByZXN1bHRpbmcgSlNPTlxuICAgICAgICAgICAgZG9jTWV0YS5kb2NJbmZvLm11dGF0aW5nID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIEZvcmNlIGEgd3JpdGUgb2YgdGhlIERvY01ldGFcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGZvcmNlV3JpdGUoZG9jTWV0YTogSURvY01ldGEpIHtcbiAgICAgICAgZG9jTWV0YS5kb2NJbmZvLmxhc3RVcGRhdGVkID0gSVNPRGF0ZVRpbWVTdHJpbmdzLmNyZWF0ZSgpO1xuICAgIH1cblxufVxuXG5leHBvcnQgY2xhc3MgTW9ja0RvY01ldGFzIHtcblxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgRG9jTWV0YSBvYmplY3QgYnV0IHBsYWNlIGluaXRpYWwgcGFnZW1hcmtzIG9uIGl0LiBUaGlzIGlzIHVzZWZ1bFxuICAgICAqIGZvciB0ZXN0aW5nLlxuICAgICAqXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGVXaXRoaW5Jbml0aWFsUGFnZW1hcmtzKGZpbmdlcnByaW50OiBzdHJpbmcsIG5yUGFnZXM6IG51bWJlcik6IElEb2NNZXRhIHtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBEb2NNZXRhcy5jcmVhdGUoZmluZ2VycHJpbnQsIG5yUGFnZXMpO1xuXG4gICAgICAgIGNvbnN0IG1heFBhZ2VzID0gMztcbiAgICAgICAgZm9yIChsZXQgcGFnZU51bSA9IDE7IHBhZ2VOdW0gPD0gTWF0aC5taW4obnJQYWdlcywgbWF4UGFnZXMpOyArK3BhZ2VOdW0gKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhZ2VtYXJrID0gUGFnZW1hcmtzLmNyZWF0ZSh7XG4gICAgICAgICAgICAgICAgdHlwZTogUGFnZW1hcmtUeXBlLlNJTkdMRV9DT0xVTU4sXG4gICAgICAgICAgICAgICAgcGVyY2VudGFnZTogMTAwLFxuICAgICAgICAgICAgICAgIGNvbHVtbjogMFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIFBhZ2VtYXJrcy51cGRhdGVQYWdlbWFyayhyZXN1bHQsIHBhZ2VOdW0sIHBhZ2VtYXJrKTtcblxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlTW9ja0RvY01ldGEoZmluZ2VycHJpbnQ6IHN0cmluZyA9IFwiMHgwMDFcIikge1xuXG4gICAgICAgIGNvbnN0IG5yUGFnZXMgPSA0O1xuICAgICAgICBjb25zdCBkb2NNZXRhID0gRG9jTWV0YXMuY3JlYXRlV2l0aGluSW5pdGlhbFBhZ2VtYXJrcyhmaW5nZXJwcmludCwgbnJQYWdlcyk7XG5cbiAgICAgICAgY29uc3QgdGV4dEhpZ2hsaWdodCA9IFRleHRIaWdobGlnaHRzLmNyZWF0ZU1vY2tUZXh0SGlnaGxpZ2h0KCk7XG5cbiAgICAgICAgRG9jTWV0YXMuZ2V0UGFnZU1ldGEoZG9jTWV0YSwgMSkudGV4dEhpZ2hsaWdodHNbdGV4dEhpZ2hsaWdodC5pZF0gPSB0ZXh0SGlnaGxpZ2h0O1xuXG4gICAgICAgIHJldHVybiBkb2NNZXRhO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBjcmVhdGVNb2NrRG9jTWV0YUZyb21QREYoZGF0YXN0b3JlOiBEYXRhc3RvcmUpOiBQcm9taXNlPE1vY2tEb2M+IHtcblxuICAgICAgICBjb25zdCBkb2NNZXRhID0gTW9ja0RvY01ldGFzLmNyZWF0ZU1vY2tEb2NNZXRhKCk7XG5cbiAgICAgICAgY29uc3QgcGRmUGF0aCA9IEZpbGVQYXRocy5qb2luKF9fZGlybmFtZSwgXCIuLlwiLCBcIi4uXCIsIFwiLi5cIiwgXCJkb2NzXCIsIFwiZXhhbXBsZXNcIiwgXCJwZGZcIiwgXCJjaHViYnkucGRmXCIpO1xuXG4gICAgICAgIGNvbnN0IGZpbGVSZWY6IEZpbGVSZWYgPSB7XG4gICAgICAgICAgICBuYW1lOiBcImNodWJieS5wZGZcIlxuICAgICAgICB9O1xuXG4gICAgICAgIGRvY01ldGEuZG9jSW5mby5maWxlbmFtZSA9IGZpbGVSZWYubmFtZTtcbiAgICAgICAgZG9jTWV0YS5kb2NJbmZvLmJhY2tlbmQgPSBCYWNrZW5kLlNUQVNIO1xuXG4gICAgICAgIGF3YWl0IGRhdGFzdG9yZS53cml0ZUZpbGUoQmFja2VuZC5TVEFTSCwgZmlsZVJlZiwge3BhdGg6IHBkZlBhdGh9KTtcblxuICAgICAgICBhd2FpdCBkYXRhc3RvcmUud3JpdGVEb2NNZXRhKGRvY01ldGEpO1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogTW9ja0RvYyA9IHtcbiAgICAgICAgICAgIGRvY01ldGEsIGZpbGVSZWZcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTW9ja0RvYyB7XG4gICAgcmVhZG9ubHkgZG9jTWV0YTogSURvY01ldGE7XG4gICAgcmVhZG9ubHkgZmlsZVJlZjogRmlsZVJlZjtcbn1cbiJdfQ==