"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Optional_1 = require("polar-shared/src/util/ts/Optional");
const Logger_1 = require("polar-shared/src/logger/Logger");
const Strings_1 = require("polar-shared/src/util/Strings");
const Objects_1 = require("polar-shared/src/util/Objects");
const log = Logger_1.Logger.create();
class AggregateParser {
    constructor() {
        this.delegates = [
            new TwitterCardParser(),
            new OGCardParser()
        ];
    }
    parse(doc) {
        const results = this.delegates.map(current => {
            try {
                return current.parse(doc);
            }
            catch (e) {
                log.error("Unable to parse doc: ", e);
                return createNullContentMeta();
            }
        });
        const result = createNullContentMeta();
        for (const key of Objects_1.Objects.typedKeys(result)) {
            result[key] = this.first(current => current[key], ...results);
        }
        return result;
    }
    first(converter, ...contentMeta) {
        const results = contentMeta.map(current => converter(current))
            .map(current => Strings_1.Strings.filterEmpty(current));
        return Optional_1.Optional.first(...results).getOrUndefined();
    }
}
class ContentMetas {
    static parse(doc) {
        return this.parser.parse(doc);
    }
}
exports.ContentMetas = ContentMetas;
ContentMetas.parser = new AggregateParser();
class TwitterCardParser {
    parse(doc) {
        const result = createNullContentMeta();
        result.title = metaValue(doc, 'twitter:title').getOrUndefined();
        result.description = metaValue(doc, 'twitter:description').getOrUndefined();
        return result;
    }
}
class OGCardParser {
    parse(doc) {
        const result = createNullContentMeta();
        result.title = metaValue(doc, 'article:title').getOrUndefined();
        result.description = metaValue(doc, 'article:description').getOrUndefined();
        return result;
    }
}
function createNullContentMeta() {
    const result = {
        title: undefined,
        description: undefined
    };
    return result;
}
function metaValue(doc, name) {
    const optionalMetaElement = meta(doc, name);
    if (!optionalMetaElement.isPresent()) {
        return Optional_1.Optional.empty();
    }
    const metaElement = optionalMetaElement.get();
    let content = metaElement.getAttribute("content");
    if (Preconditions_1.isPresent(content)) {
        return Optional_1.Optional.of(content);
    }
    content = metaElement.getAttribute("value");
    return Optional_1.Optional.of(content);
}
function meta(doc, name) {
    let match = doc.querySelector(`meta[name=${name}]`);
    if (!match) {
        match = doc.querySelector(`meta[property=${name}]`);
    }
    if (!match) {
        match = doc.querySelector(`meta[itemprop=${name}]`);
    }
    return Optional_1.Optional.of(match);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGVudE1ldGFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ29udGVudE1ldGFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esa0VBQXlEO0FBQ3pELGdFQUEyRDtBQUMzRCwyREFBc0Q7QUFDdEQsMkRBQXNEO0FBQ3RELDJEQUFzRDtBQUV0RCxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFNUIsTUFBTSxlQUFlO0lBQXJCO1FBRXFCLGNBQVMsR0FBd0I7WUFDOUMsSUFBSSxpQkFBaUIsRUFBRTtZQUN2QixJQUFJLFlBQVksRUFBRTtTQUlyQixDQUFDO0lBd0NOLENBQUM7SUF0Q1UsS0FBSyxDQUFDLEdBQWE7UUFHdEIsTUFBTSxPQUFPLEdBQ1QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFFekIsSUFBSTtnQkFDQSxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDN0I7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFFUixHQUFHLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN0QyxPQUFPLHFCQUFxQixFQUFFLENBQUM7YUFDbEM7UUFFTCxDQUFDLENBQUMsQ0FBQztRQUdQLE1BQU0sTUFBTSxHQUFHLHFCQUFxQixFQUFFLENBQUM7UUFFdkMsS0FBSyxNQUFNLEdBQUcsSUFBSSxpQkFBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN6QyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDO1NBQ2pFO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFFbEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxTQUEyRCxFQUMzRCxHQUFHLFdBQTBCO1FBRXZDLE1B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LEdBQUcsQ0FBQyxDQUFDO0tBQ3ZEO0lBRUQsT0FBTyxtQkFBUSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUU5QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb250ZW50TWV0YX0gZnJvbSBcIi4vQ29udGVudE1ldGFcIjtcbmltcG9ydCB7aXNQcmVzZW50fSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtPcHRpb25hbH0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdXRpbC90cy9PcHRpb25hbFwiO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL2xvZ2dlci9Mb2dnZXJcIjtcbmltcG9ydCB7U3RyaW5nc30gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdXRpbC9TdHJpbmdzXCI7XG5pbXBvcnQge09iamVjdHN9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL3V0aWwvT2JqZWN0c1wiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmNsYXNzIEFnZ3JlZ2F0ZVBhcnNlciBpbXBsZW1lbnRzIENvbnRlbnRNZXRhUGFyc2VyIHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVsZWdhdGVzOiBDb250ZW50TWV0YVBhcnNlcltdID0gW1xuICAgICAgICBuZXcgVHdpdHRlckNhcmRQYXJzZXIoKSxcbiAgICAgICAgbmV3IE9HQ2FyZFBhcnNlcigpXG5cbiAgICAgICAgLy8gVE9ETyBzdXBwb3J0IGhhdG9tLCBtaWNyb2RhdGFcblxuICAgIF07XG5cbiAgICBwdWJsaWMgcGFyc2UoZG9jOiBEb2N1bWVudCk6IFJlYWRvbmx5PENvbnRlbnRNZXRhPiB7XG5cbiAgICAgICAgLy8gcGFyc2UgdGhlIGRvYyB1c2luZyBldmVyeSBwYXJzZXJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9XG4gICAgICAgICAgICB0aGlzLmRlbGVnYXRlcy5tYXAoY3VycmVudCA9PiB7XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudC5wYXJzZShkb2MpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgYWxsb3cgdGhlc2UgdG8gdGhyb3cgZXhjZXB0aW9ucy4uLlxuICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoXCJVbmFibGUgdG8gcGFyc2UgZG9jOiBcIiwgZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVOdWxsQ29udGVudE1ldGEoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIC8vIG5vdyB0YWtlIHRoZSByZXN1bHRzIGFuZCBtZXJnZSB0aGVtLlxuICAgICAgICBjb25zdCByZXN1bHQgPSBjcmVhdGVOdWxsQ29udGVudE1ldGEoKTtcblxuICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3RzLnR5cGVkS2V5cyhyZXN1bHQpKSB7XG4gICAgICAgICAgICByZXN1bHRba2V5XSA9IHRoaXMuZmlyc3QoY3VycmVudCA9PiBjdXJyZW50W2tleV0sIC4uLnJlc3VsdHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIHByaXZhdGUgZmlyc3QoY29udmVydGVyOiAoY29udGVudE1ldGE6IENvbnRlbnRNZXRhKSA9PiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAuLi5jb250ZW50TWV0YTogQ29udGVudE1ldGFbXSk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0cyA9XG4gICAgICAgICAgICBjb250ZW50TWV0YS5tYXAoY3VycmVudCA9PiBjb252ZXJ0ZXIoY3VycmVudCkpXG4gICAgICAgICAgICAgICAgICAgICAgIC5tYXAoY3VycmVudCA9PiBTdHJpbmdzLmZpbHRlckVtcHR5KGN1cnJlbnQpKTtcblxuICAgICAgICByZXR1cm4gT3B0aW9uYWwuZmlyc3QoLi4ucmVzdWx0cykuZ2V0T3JVbmRlZmluZWQoKTtcblxuICAgIH1cblxufVxuXG5leHBvcnQgY2xhc3MgQ29udGVudE1ldGFzIHtcblxuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IHBhcnNlciA9IG5ldyBBZ2dyZWdhdGVQYXJzZXIoKTtcblxuICAgIC8qKlxuICAgICAqIFBhcnNlIG1ldGFkYXRhIGZyb20gdGhlIGdpdmVuIGRvY3VtZW50LlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgcGFyc2UoZG9jOiBEb2N1bWVudCk6IFJlYWRvbmx5PENvbnRlbnRNZXRhPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlci5wYXJzZShkb2MpO1xuICAgIH1cblxufVxuXG5pbnRlcmZhY2UgQ29udGVudE1ldGFQYXJzZXIge1xuXG4gICAgcGFyc2UoZG9jOiBEb2N1bWVudCk6IFJlYWRvbmx5PENvbnRlbnRNZXRhPjtcblxufVxuXG5cbmNsYXNzIFR3aXR0ZXJDYXJkUGFyc2VyIGltcGxlbWVudHMgQ29udGVudE1ldGFQYXJzZXIge1xuXG4gICAgcHVibGljIHBhcnNlKGRvYzogRG9jdW1lbnQpOiBDb250ZW50TWV0YSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGNyZWF0ZU51bGxDb250ZW50TWV0YSgpO1xuXG4gICAgICAgIHJlc3VsdC50aXRsZSA9IG1ldGFWYWx1ZShkb2MsICd0d2l0dGVyOnRpdGxlJykuZ2V0T3JVbmRlZmluZWQoKTtcbiAgICAgICAgcmVzdWx0LmRlc2NyaXB0aW9uID0gbWV0YVZhbHVlKGRvYywgJ3R3aXR0ZXI6ZGVzY3JpcHRpb24nKS5nZXRPclVuZGVmaW5lZCgpO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG59XG5cbmNsYXNzIE9HQ2FyZFBhcnNlciBpbXBsZW1lbnRzIENvbnRlbnRNZXRhUGFyc2VyIHtcblxuICAgIHB1YmxpYyBwYXJzZShkb2M6IERvY3VtZW50KTogQ29udGVudE1ldGEge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBjcmVhdGVOdWxsQ29udGVudE1ldGEoKTtcblxuICAgICAgICByZXN1bHQudGl0bGUgPSBtZXRhVmFsdWUoZG9jLCAnYXJ0aWNsZTp0aXRsZScpLmdldE9yVW5kZWZpbmVkKCk7XG4gICAgICAgIHJlc3VsdC5kZXNjcmlwdGlvbiA9IG1ldGFWYWx1ZShkb2MsICdhcnRpY2xlOmRlc2NyaXB0aW9uJykuZ2V0T3JVbmRlZmluZWQoKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxufVxuXG5cbmZ1bmN0aW9uIGNyZWF0ZU51bGxDb250ZW50TWV0YSgpOiBDb250ZW50TWV0YSB7XG5cbiAgICBjb25zdCByZXN1bHQ6IENvbnRlbnRNZXRhID0ge1xuICAgICAgICB0aXRsZTogdW5kZWZpbmVkLFxuICAgICAgICBkZXNjcmlwdGlvbjogdW5kZWZpbmVkXG4gICAgfTtcblxuICAgIHJldHVybiByZXN1bHQ7XG5cbn1cblxuZnVuY3Rpb24gbWV0YVZhbHVlKGRvYzogRG9jdW1lbnQsIG5hbWU6IHN0cmluZyk6IE9wdGlvbmFsPHN0cmluZz4ge1xuXG4gICAgY29uc3Qgb3B0aW9uYWxNZXRhRWxlbWVudCA9IG1ldGEoZG9jLCBuYW1lKTtcblxuICAgIGlmICghIG9wdGlvbmFsTWV0YUVsZW1lbnQuaXNQcmVzZW50KCkpIHtcbiAgICAgICAgcmV0dXJuIE9wdGlvbmFsLmVtcHR5KCk7XG4gICAgfVxuXG4gICAgY29uc3QgbWV0YUVsZW1lbnQgPSBvcHRpb25hbE1ldGFFbGVtZW50LmdldCgpO1xuXG4gICAgbGV0IGNvbnRlbnQgPSBtZXRhRWxlbWVudC5nZXRBdHRyaWJ1dGUoXCJjb250ZW50XCIpO1xuXG4gICAgaWYgKGlzUHJlc2VudChjb250ZW50KSkge1xuICAgICAgICByZXR1cm4gT3B0aW9uYWwub2YoY29udGVudCk7XG4gICAgfVxuXG4gICAgY29udGVudCA9IG1ldGFFbGVtZW50LmdldEF0dHJpYnV0ZShcInZhbHVlXCIpO1xuXG4gICAgcmV0dXJuIE9wdGlvbmFsLm9mKGNvbnRlbnQpO1xuXG59XG5cblxuZnVuY3Rpb24gbWV0YShkb2M6IERvY3VtZW50LCBuYW1lOiBzdHJpbmcpOiBPcHRpb25hbDxFbGVtZW50PiB7XG5cbiAgICBsZXQgbWF0Y2ggPSBkb2MucXVlcnlTZWxlY3RvcihgbWV0YVtuYW1lPSR7bmFtZX1dYCk7XG5cbiAgICBpZiAoIW1hdGNoICkge1xuICAgICAgICBtYXRjaCA9IGRvYy5xdWVyeVNlbGVjdG9yKGBtZXRhW3Byb3BlcnR5PSR7bmFtZX1dYCk7XG4gICAgfVxuXG4gICAgaWYgKCFtYXRjaCApIHtcbiAgICAgICAgbWF0Y2ggPSBkb2MucXVlcnlTZWxlY3RvcihgbWV0YVtpdGVtcHJvcD0ke25hbWV9XWApO1xuICAgIH1cblxuICAgIHJldHVybiBPcHRpb25hbC5vZihtYXRjaCk7XG5cbn1cblxuIl19