"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const FilePaths_1 = require("polar-shared/src/util/FilePaths");
const ToasterMessages_1 = require("../ui/toaster/ToasterMessages");
const Toaster_1 = require("../ui/toaster/Toaster");
const ProgressTracker_1 = require("polar-shared/src/util/ProgressTracker");
const ProgressMessages_1 = require("../ui/progress_bar/ProgressMessages");
const FileImportClient_1 = require("../apps/repository/FileImportClient");
const Logger_1 = require("polar-shared/src/logger/Logger");
const Functions_1 = require("polar-shared/src/util/Functions");
const FileImportRequests_1 = require("../apps/repository/FileImportRequests");
const log = Logger_1.Logger.create();
class PDFDownloadHandlers {
    static create(webContents, onDownloaded = Functions_1.NULL_FUNCTION, onDownload = Functions_1.NULL_FUNCTION) {
        const willDownloadHandler = (event, downloadItem, downloadWebContents) => {
            log.info("Going to to download: ", downloadItem.getURL());
            const mimeType = downloadItem.getMimeType();
            const basename = FilePaths_1.FilePaths.basename(downloadItem.getURL());
            const tmpPath = FilePaths_1.FilePaths.createTempName(basename);
            log.info("Download PDF file to " + tmpPath);
            ToasterMessages_1.ToasterMessages.send({ type: Toaster_1.ToasterMessageType.INFO, message: "PDF download starting for " + basename });
            downloadItem.setSavePath(tmpPath);
            const progressTracker = new ProgressTracker_1.ProgressTracker({ total: downloadItem.getTotalBytes(), id: 'download:' + basename });
            downloadItem.once('done', (event, state) => {
                ProgressMessages_1.ProgressMessages.broadcast(progressTracker.terminate());
                const message = `PDF download ${state} for ${basename}`;
                switch (state) {
                    case 'completed':
                        ToasterMessages_1.ToasterMessages.send({ type: Toaster_1.ToasterMessageType.SUCCESS, message });
                        FileImportClient_1.FileImportClient.send(FileImportRequests_1.FileImportRequests.fromPath(tmpPath));
                        break;
                    case 'cancelled':
                        ToasterMessages_1.ToasterMessages.send({ type: Toaster_1.ToasterMessageType.WARNING, message });
                        break;
                    case 'interrupted':
                        ToasterMessages_1.ToasterMessages.send({ type: Toaster_1.ToasterMessageType.WARNING, message });
                        break;
                }
                onDownloaded();
            });
            downloadItem.on('updated', () => {
                const progress = progressTracker.abs(downloadItem.getReceivedBytes());
                ProgressMessages_1.ProgressMessages.broadcast(progress);
            });
            onDownload();
        };
        const session = webContents.session;
        session.addListener('will-download', willDownloadHandler);
        webContents.on('destroyed', () => {
            session.removeListener('will-download', willDownloadHandler);
        });
    }
}
exports.PDFDownloadHandlers = PDFDownloadHandlers;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUERGRG93bmxvYWRIYW5kbGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlBERkRvd25sb2FkSGFuZGxlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSwrREFBMEQ7QUFDMUQsbUVBQThEO0FBQzlELG1EQUF5RDtBQUN6RCwyRUFBc0U7QUFDdEUsMEVBQXFFO0FBQ3JFLDBFQUFxRTtBQUVyRSwyREFBc0Q7QUFDdEQsK0RBQThEO0FBQzlELDhFQUF5RTtBQUV6RSxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFNUIsTUFBYSxtQkFBbUI7SUFRckIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUF3QixFQUN4QixlQUEyQix5QkFBYSxFQUN4QyxhQUF5Qix5QkFBYTtRQU12RCxNQUFNLG1CQUFtQixHQUFHLENBQUMsS0FBWSxFQUNaLFlBQTBCLEVBQzFCLG1CQUFnQyxFQUFFLEVBQUU7WUFFN0QsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUUxRCxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7WUFPNUMsTUFBTSxRQUFRLEdBQUcscUJBQVMsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDM0QsTUFBTSxPQUFPLEdBQUcscUJBQVMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7WUFNbkQsR0FBRyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxPQUFPLENBQUMsQ0FBQztZQUU1QyxpQ0FBZSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBRSw0QkFBa0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLDRCQUE0QixHQUFHLFFBQVEsRUFBQyxDQUFDLENBQUM7WUFFeEcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVsQyxNQUFNLGVBQWUsR0FBRyxJQUFJLGlDQUFlLENBQUMsRUFBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLGFBQWEsRUFBRSxFQUFFLEVBQUUsRUFBRSxXQUFXLEdBQUcsUUFBUSxFQUFDLENBQUMsQ0FBQztZQUUvRyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFHdkMsbUNBQWdCLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO2dCQUV4RCxNQUFNLE9BQU8sR0FBRyxnQkFBZ0IsS0FBSyxRQUFRLFFBQVEsRUFBRSxDQUFDO2dCQUV4RCxRQUFRLEtBQUssRUFBRTtvQkFFWCxLQUFLLFdBQVc7d0JBQ1osaUNBQWUsQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsNEJBQWtCLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUM7d0JBQ2xFLG1DQUFnQixDQUFDLElBQUksQ0FBQyx1Q0FBa0IsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzt3QkFFNUQsTUFBTTtvQkFFVixLQUFLLFdBQVc7d0JBQ1osaUNBQWUsQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsNEJBQWtCLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUM7d0JBQ2xFLE1BQU07b0JBRVYsS0FBSyxhQUFhO3dCQUNkLGlDQUFlLENBQUMsSUFBSSxDQUFDLEVBQUMsSUFBSSxFQUFFLDRCQUFrQixDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFDO3dCQUNsRSxNQUFNO2lCQUViO2dCQUVELFlBQVksRUFBRSxDQUFDO1lBRW5CLENBQUMsQ0FBQyxDQUFDO1lBRUgsWUFBWSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFO2dCQUU1QixNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7Z0JBQ3RFLG1DQUFnQixDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV6QyxDQUFDLENBQUMsQ0FBQztZQUVILFVBQVUsRUFBRSxDQUFDO1FBRWpCLENBQUMsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFFcEMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxlQUFlLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztRQUUxRCxXQUFXLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7WUFDN0IsT0FBTyxDQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztRQUNqRSxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7Q0FFSjtBQTlGRCxrREE4RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Jyb3dzZXJXaW5kb3csIERvd25sb2FkSXRlbSwgV2ViQ29udGVudHN9IGZyb20gXCJlbGVjdHJvblwiO1xuaW1wb3J0IHtGaWxlUGF0aHN9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC9GaWxlUGF0aHMnO1xuaW1wb3J0IHtUb2FzdGVyTWVzc2FnZXN9IGZyb20gJy4uL3VpL3RvYXN0ZXIvVG9hc3Rlck1lc3NhZ2VzJztcbmltcG9ydCB7VG9hc3Rlck1lc3NhZ2VUeXBlfSBmcm9tICcuLi91aS90b2FzdGVyL1RvYXN0ZXInO1xuaW1wb3J0IHtQcm9ncmVzc1RyYWNrZXJ9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC9Qcm9ncmVzc1RyYWNrZXInO1xuaW1wb3J0IHtQcm9ncmVzc01lc3NhZ2VzfSBmcm9tICcuLi91aS9wcm9ncmVzc19iYXIvUHJvZ3Jlc3NNZXNzYWdlcyc7XG5pbXBvcnQge0ZpbGVJbXBvcnRDbGllbnR9IGZyb20gJy4uL2FwcHMvcmVwb3NpdG9yeS9GaWxlSW1wb3J0Q2xpZW50JztcbmltcG9ydCB7QXBwTGF1bmNoZXJ9IGZyb20gJy4uL2FwcHMvbWFpbi9BcHBMYXVuY2hlcic7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7TlVMTF9GVU5DVElPTn0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdXRpbC9GdW5jdGlvbnNcIjtcbmltcG9ydCB7RmlsZUltcG9ydFJlcXVlc3RzfSBmcm9tICcuLi9hcHBzL3JlcG9zaXRvcnkvRmlsZUltcG9ydFJlcXVlc3RzJztcblxuY29uc3QgbG9nID0gTG9nZ2VyLmNyZWF0ZSgpO1xuXG5leHBvcnQgY2xhc3MgUERGRG93bmxvYWRIYW5kbGVycyB7XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB3ZWJDb250ZW50cyAgVGhlIHdlYkNvbnRlbnRzIHdoaWNoIG5lZWRzIGRvd25sb2FkIHN1cHBvcnQuXG4gICAgICogQHBhcmFtIG9uRG93bmxvYWRlZCBDYWxsZWQgd2hlbiB0aGUgZG93bmxvYWQgaXMgY29tcGxldGUuXG4gICAgICogQHBhcmFtIG9uRG93bmxvYWQgQ2FsbGVkIHdoZW4gdGhlIGRvd25sb2FkIGlzIHN0YXJ0ZWRcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZSh3ZWJDb250ZW50czogV2ViQ29udGVudHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgb25Eb3dubG9hZGVkOiAoKSA9PiB2b2lkID0gTlVMTF9GVU5DVElPTixcbiAgICAgICAgICAgICAgICAgICAgICAgICBvbkRvd25sb2FkOiAoKSA9PiB2b2lkID0gTlVMTF9GVU5DVElPTikge1xuXG4gICAgICAgIC8vIFRPRE86IG1pZ2h0IG5vdCBldmVuIG5lZWQgdGhpcyBoYW5kbGVyIGhlcmUgaWYgd2UgaGFuZGxlIGl0IGluXG4gICAgICAgIC8vIHRoZSBBUEkgYW5kIGxvb2sgYXQgdGhlIG1pbWVUeXBlIHRoZXJlIHdoaWNoIGlzIGEgYmV0dGVyIHdheVxuICAgICAgICAvLyB0byBoYW5kbGUgdGhpcy5cblxuICAgICAgICBjb25zdCB3aWxsRG93bmxvYWRIYW5kbGVyID0gKGV2ZW50OiBFdmVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3dubG9hZEl0ZW06IERvd25sb2FkSXRlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3dubG9hZFdlYkNvbnRlbnRzOiBXZWJDb250ZW50cykgPT4ge1xuXG4gICAgICAgICAgICBsb2cuaW5mbyhcIkdvaW5nIHRvIHRvIGRvd25sb2FkOiBcIiwgZG93bmxvYWRJdGVtLmdldFVSTCgpKTtcblxuICAgICAgICAgICAgY29uc3QgbWltZVR5cGUgPSBkb3dubG9hZEl0ZW0uZ2V0TWltZVR5cGUoKTtcblxuICAgICAgICAgICAgLy8gaWYgKG1pbWVUeXBlICE9PSAnYXBwbGljYXRpb24vcGRmJykge1xuICAgICAgICAgICAgLy8gICAgIGxvZy53YXJuKFwiRG93bmxvYWRpbmcgUERGIGFuZCB1bmFibGUgdG8gaGFuZGxlOiBcIiArIG1pbWVUeXBlKTtcbiAgICAgICAgICAgIC8vICAgICByZXR1cm47XG4gICAgICAgICAgICAvLyB9XG5cbiAgICAgICAgICAgIGNvbnN0IGJhc2VuYW1lID0gRmlsZVBhdGhzLmJhc2VuYW1lKGRvd25sb2FkSXRlbS5nZXRVUkwoKSk7XG4gICAgICAgICAgICBjb25zdCB0bXBQYXRoID0gRmlsZVBhdGhzLmNyZWF0ZVRlbXBOYW1lKGJhc2VuYW1lKTtcblxuICAgICAgICAgICAgLy8gVE9ETzogY29tcHV0ZSB0aGUgcGF0aCBpbiB0aGUgc3Rhc2ggb3RoZXJ3aXNlIHdlJ3JlIHdhc3RpbmcgSU9cbiAgICAgICAgICAgIC8vIHdyaXRpbmcgdG8gdHdvIHBsYWNlcy4uLiAodW5sZXNzIHdlIHVzZSBhIGhhcmQgbGluaykuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgLy8gVE9ETzogdXNlIGEgdG1wZGlyIHdpdGhpbiBzdGFzaCBhbmQgdGhlbiBtb3ZlIGl0IHdoZW4gZmluaXNoZWRcbiAgICAgICAgICAgIGxvZy5pbmZvKFwiRG93bmxvYWQgUERGIGZpbGUgdG8gXCIgKyB0bXBQYXRoKTtcblxuICAgICAgICAgICAgVG9hc3Rlck1lc3NhZ2VzLnNlbmQoe3R5cGU6IFRvYXN0ZXJNZXNzYWdlVHlwZS5JTkZPLCBtZXNzYWdlOiBcIlBERiBkb3dubG9hZCBzdGFydGluZyBmb3IgXCIgKyBiYXNlbmFtZX0pO1xuXG4gICAgICAgICAgICBkb3dubG9hZEl0ZW0uc2V0U2F2ZVBhdGgodG1wUGF0aCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzVHJhY2tlciA9IG5ldyBQcm9ncmVzc1RyYWNrZXIoe3RvdGFsOiBkb3dubG9hZEl0ZW0uZ2V0VG90YWxCeXRlcygpLCBpZDogJ2Rvd25sb2FkOicgKyBiYXNlbmFtZX0pO1xuXG4gICAgICAgICAgICBkb3dubG9hZEl0ZW0ub25jZSgnZG9uZScsIChldmVudCwgc3RhdGUpID0+IHtcblxuICAgICAgICAgICAgICAgIC8vIHNlbmQgdGhlIGZpbmFsIHByb2dyZXNzIGV2ZW50LlxuICAgICAgICAgICAgICAgIFByb2dyZXNzTWVzc2FnZXMuYnJvYWRjYXN0KHByb2dyZXNzVHJhY2tlci50ZXJtaW5hdGUoKSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYFBERiBkb3dubG9hZCAke3N0YXRlfSBmb3IgJHtiYXNlbmFtZX1gO1xuXG4gICAgICAgICAgICAgICAgc3dpdGNoIChzdGF0ZSkge1xuXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NvbXBsZXRlZCc6XG4gICAgICAgICAgICAgICAgICAgICAgICBUb2FzdGVyTWVzc2FnZXMuc2VuZCh7dHlwZTogVG9hc3Rlck1lc3NhZ2VUeXBlLlNVQ0NFU1MsIG1lc3NhZ2V9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIEZpbGVJbXBvcnRDbGllbnQuc2VuZChGaWxlSW1wb3J0UmVxdWVzdHMuZnJvbVBhdGgodG1wUGF0aCkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICBjYXNlICdjYW5jZWxsZWQnOlxuICAgICAgICAgICAgICAgICAgICAgICAgVG9hc3Rlck1lc3NhZ2VzLnNlbmQoe3R5cGU6IFRvYXN0ZXJNZXNzYWdlVHlwZS5XQVJOSU5HLCBtZXNzYWdlfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICBjYXNlICdpbnRlcnJ1cHRlZCc6XG4gICAgICAgICAgICAgICAgICAgICAgICBUb2FzdGVyTWVzc2FnZXMuc2VuZCh7dHlwZTogVG9hc3Rlck1lc3NhZ2VUeXBlLldBUk5JTkcsIG1lc3NhZ2V9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgb25Eb3dubG9hZGVkKCk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBkb3dubG9hZEl0ZW0ub24oJ3VwZGF0ZWQnLCAoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IHByb2dyZXNzVHJhY2tlci5hYnMoZG93bmxvYWRJdGVtLmdldFJlY2VpdmVkQnl0ZXMoKSk7XG4gICAgICAgICAgICAgICAgUHJvZ3Jlc3NNZXNzYWdlcy5icm9hZGNhc3QocHJvZ3Jlc3MpO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgb25Eb3dubG9hZCgpO1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHdlYkNvbnRlbnRzLnNlc3Npb247XG5cbiAgICAgICAgc2Vzc2lvbi5hZGRMaXN0ZW5lcignd2lsbC1kb3dubG9hZCcsIHdpbGxEb3dubG9hZEhhbmRsZXIpO1xuXG4gICAgICAgIHdlYkNvbnRlbnRzLm9uKCdkZXN0cm95ZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICBzZXNzaW9uLnJlbW92ZUxpc3RlbmVyKCd3aWxsLWRvd25sb2FkJywgd2lsbERvd25sb2FkSGFuZGxlcik7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG59XG4iXX0=