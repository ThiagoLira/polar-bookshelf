"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Logger_1 = require("polar-shared/src/logger/Logger");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const DocFormatFactory_1 = require("../../../docformat/DocFormatFactory");
const AnnotationRects_1 = require("../../../metadata/AnnotationRects");
const AreaHighlights_1 = require("../../../metadata/AreaHighlights");
const AnnotationPointers_1 = require("../../../annotations/AnnotationPointers");
const Rects_1 = require("../../../Rects");
const DocMetas_1 = require("../../../metadata/DocMetas");
const Arrays_1 = require("polar-shared/src/util/Arrays");
const log = Logger_1.Logger.create();
class AreaHighlightController {
    constructor(model) {
        this.model = Preconditions_1.Preconditions.assertNotNull(model, "model");
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
    }
    start() {
        this.model.registerListenerForDocumentLoaded((event) => this.onDocumentLoaded(event));
        window.addEventListener("message", event => this.onMessageReceived(event), false);
    }
    onDocumentLoaded(event) {
        log.info("onDocumentLoaded: ", event.docMeta);
    }
    onMessageReceived(event) {
        if (event.data && event.data.type === "create-area-highlight") {
            this.onCreateAreaHighlight(event.data);
        }
        if (event.data && event.data.type === "delete-area-highlight") {
            this.onDeleteAreaHighlight(event.data);
        }
    }
    onCreateAreaHighlight(contextMenuLocation) {
        log.info("Creating area highlight: ", contextMenuLocation);
        const rectFromEvent = AnnotationRects_1.AnnotationRects.createFromEvent(contextMenuLocation);
        const annotationRect = AreaHighlights_1.AreaHighlights.toCorrectScale(Rects_1.Rects.createFromBasicRect(rectFromEvent));
        log.info("annotationRect", annotationRect);
        const areaHighlight = AreaHighlights_1.AreaHighlights.create({ rect: annotationRect });
        log.info("areaHighlight", areaHighlight);
        const docMeta = this.model.docMeta;
        const pageMeta = DocMetas_1.DocMetas.getPageMeta(docMeta, contextMenuLocation.pageNum);
        pageMeta.areaHighlights[areaHighlight.id] = areaHighlight;
    }
    onDeleteAreaHighlight(triggerEvent) {
        const annotationPointers = AnnotationPointers_1.AnnotationPointers.toAnnotationPointers(".area-highlight", triggerEvent);
        const annotationPointer = Arrays_1.Arrays.first(annotationPointers);
        if (annotationPointer) {
            const datastore = this.model.persistenceLayerProvider();
            const pageMeta = DocMetas_1.DocMetas.getPageMeta(this.model.docMeta, annotationPointer.pageNum);
            const areaHighlight = pageMeta.areaHighlights[annotationPointer.id];
            const { docMeta } = this.model;
            const opts = {
                datastore, areaHighlight, pageMeta, docMeta
            };
            AreaHighlights_1.AreaHighlights.delete(opts)
                .catch(err => log.error("Unable to delete area highlight: ", err));
        }
    }
}
exports.AreaHighlightController = AreaHighlightController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXJlYUhpZ2hsaWdodENvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBcmVhSGlnaGxpZ2h0Q29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDJEQUFzRDtBQUN0RCxrRUFBNkQ7QUFDN0QsMEVBQXFFO0FBRXJFLHVFQUFrRTtBQUNsRSxxRUFBZ0U7QUFDaEUsZ0ZBQTJFO0FBTzNFLDBDQUFxQztBQUNyQyx5REFBb0Q7QUFDcEQseURBQW9EO0FBR3BELE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFhLHVCQUF1QjtJQU1oQyxZQUFZLEtBQVk7UUFDcEIsSUFBSSxDQUFDLEtBQUssR0FBRyw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLFNBQVMsR0FBRyxtQ0FBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQWlCcEQsQ0FBQztJQUVNLEtBQUs7UUFFUixJQUFJLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUV0RixNQUFNLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXRGLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxLQUEwQjtRQUMvQyxHQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRU8saUJBQWlCLENBQUMsS0FBbUI7UUFFekMsSUFBSSxLQUFLLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLHVCQUF1QixFQUFFO1lBQzNELElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDMUM7UUFFRCxJQUFJLEtBQUssQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssdUJBQXVCLEVBQUU7WUFDM0QsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMxQztJQUVMLENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxtQkFBd0M7UUFFbEUsR0FBRyxDQUFDLElBQUksQ0FBQywyQkFBMkIsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1FBRTNELE1BQU0sYUFBYSxHQUFHLGlDQUFlLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDM0UsTUFBTSxjQUFjLEdBQUcsK0JBQWMsQ0FBQyxjQUFjLENBQUMsYUFBSyxDQUFDLG1CQUFtQixDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFFL0YsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUUzQyxNQUFNLGFBQWEsR0FBRywrQkFBYyxDQUFDLE1BQU0sQ0FBQyxFQUFDLElBQUksRUFBRSxjQUFjLEVBQUMsQ0FBQyxDQUFDO1FBRXBFLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRXpDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQ25DLE1BQU0sUUFBUSxHQUFJLG1CQUFRLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU3RSxRQUFRLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUM7SUFFOUQsQ0FBQztJQUVPLHFCQUFxQixDQUFDLFlBQTBCO1FBRXBELE1BQU0sa0JBQWtCLEdBQ2xCLHVDQUFrQixDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRS9FLE1BQU0saUJBQWlCLEdBQUcsZUFBTSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBRTNELElBQUksaUJBQWlCLEVBQUU7WUFFbkIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1lBQ3hELE1BQU0sUUFBUSxHQUFHLG1CQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JGLE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDcEUsTUFBTSxFQUFDLE9BQU8sRUFBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFFN0IsTUFBTSxJQUFJLEdBQTRCO2dCQUNsQyxTQUFTLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxPQUFPO2FBQzlDLENBQUM7WUFFRiwrQkFBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7aUJBQ3RCLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUUxRTtJQUVMLENBQUM7Q0FFSjtBQWhHRCwwREFnR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RvY3VtZW50TG9hZGVkRXZlbnQsIE1vZGVsfSBmcm9tICcuLi8uLi8uLi9tb2RlbC9Nb2RlbCc7XG5pbXBvcnQge0RvY0Zvcm1hdH0gZnJvbSAnLi4vLi4vLi4vZG9jZm9ybWF0L0RvY0Zvcm1hdCc7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7UHJlY29uZGl0aW9uc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7RG9jRm9ybWF0RmFjdG9yeX0gZnJvbSAnLi4vLi4vLi4vZG9jZm9ybWF0L0RvY0Zvcm1hdEZhY3RvcnknO1xuaW1wb3J0IHtDb250ZXh0TWVudUxvY2F0aW9ufSBmcm9tICcuLi8uLi8uLi9jb250ZXh0bWVudS9Db250ZXh0TWVudUxvY2F0aW9uJztcbmltcG9ydCB7QW5ub3RhdGlvblJlY3RzfSBmcm9tICcuLi8uLi8uLi9tZXRhZGF0YS9Bbm5vdGF0aW9uUmVjdHMnO1xuaW1wb3J0IHtBcmVhSGlnaGxpZ2h0c30gZnJvbSAnLi4vLi4vLi4vbWV0YWRhdGEvQXJlYUhpZ2hsaWdodHMnO1xuaW1wb3J0IHtBbm5vdGF0aW9uUG9pbnRlcnN9IGZyb20gJy4uLy4uLy4uL2Fubm90YXRpb25zL0Fubm90YXRpb25Qb2ludGVycyc7XG5pbXBvcnQge1RyaWdnZXJFdmVudH0gZnJvbSAnLi4vLi4vLi4vY29udGV4dG1lbnUvVHJpZ2dlckV2ZW50JztcbmltcG9ydCB7T3B0aW9uYWx9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC90cy9PcHRpb25hbCc7XG5pbXBvcnQge0FyZWFIaWdobGlnaHREZWxldGVPcHRzfSBmcm9tICcuLi8uLi8uLi9tZXRhZGF0YS9BcmVhSGlnaGxpZ2h0cyc7XG5pbXBvcnQge0FyZWFIaWdobGlnaHRSZWN0c30gZnJvbSAnLi4vLi4vLi4vbWV0YWRhdGEvQXJlYUhpZ2hsaWdodFJlY3RzJztcbmltcG9ydCB7RG9Xcml0ZU9wdHN9IGZyb20gJy4uLy4uLy4uL21ldGFkYXRhL0FyZWFIaWdobGlnaHRzJztcbmltcG9ydCB7QXJlYUhpZ2hsaWdodH0gZnJvbSAnLi4vLi4vLi4vbWV0YWRhdGEvQXJlYUhpZ2hsaWdodCc7XG5pbXBvcnQge1JlY3RzfSBmcm9tICcuLi8uLi8uLi9SZWN0cyc7XG5pbXBvcnQge0RvY01ldGFzfSBmcm9tIFwiLi4vLi4vLi4vbWV0YWRhdGEvRG9jTWV0YXNcIjtcbmltcG9ydCB7QXJyYXlzfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy91dGlsL0FycmF5c1wiO1xuXG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuZXhwb3J0IGNsYXNzIEFyZWFIaWdobGlnaHRDb250cm9sbGVyIHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgbW9kZWw6IE1vZGVsO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBkb2NGb3JtYXQ6IERvY0Zvcm1hdDtcblxuICAgIGNvbnN0cnVjdG9yKG1vZGVsOiBNb2RlbCkge1xuICAgICAgICB0aGlzLm1vZGVsID0gUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKG1vZGVsLCBcIm1vZGVsXCIpO1xuICAgICAgICB0aGlzLmRvY0Zvcm1hdCA9IERvY0Zvcm1hdEZhY3RvcnkuZ2V0SW5zdGFuY2UoKTtcblxuICAgICAgICAvLyBpcGNSZW5kZXJlci5vbignY29udGV4dC1tZW51LWNvbW1hbmQnLCAoZXZlbnQ6IEVsZWN0cm9uLkV2ZW50LCBhcmc6IGFueSkgPT4ge1xuICAgICAgICAvL1xuICAgICAgICAvLyAgICAgc3dpdGNoIChhcmcuY29tbWFuZCkge1xuICAgICAgICAvL1xuICAgICAgICAvLyAgICAgICAgIGNhc2UgXCJkZWxldGUtYXJlYS1oaWdobGlnaHRcIjpcbiAgICAgICAgLy8gICAgICAgICAgICAgdGhpcy5vbkRlbGV0ZUFyZWFIaWdobGlnaHQoZXZlbnQpO1xuICAgICAgICAvLyAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgLy9cbiAgICAgICAgLy8gICAgICAgICBkZWZhdWx0OlxuICAgICAgICAvLyAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJVbmhhbmRsZWQgY29tbWFuZDogXCIgKyBhcmcuY29tbWFuZCk7XG4gICAgICAgIC8vICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAvLyAgICAgfVxuICAgICAgICAvL1xuICAgICAgICAvLyB9KTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpIHtcblxuICAgICAgICB0aGlzLm1vZGVsLnJlZ2lzdGVyTGlzdGVuZXJGb3JEb2N1bWVudExvYWRlZCgoZXZlbnQpID0+IHRoaXMub25Eb2N1bWVudExvYWRlZChldmVudCkpO1xuXG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibWVzc2FnZVwiLCBldmVudCA9PiB0aGlzLm9uTWVzc2FnZVJlY2VpdmVkKGV2ZW50KSwgZmFsc2UpO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkRvY3VtZW50TG9hZGVkKGV2ZW50OiBEb2N1bWVudExvYWRlZEV2ZW50KSB7XG4gICAgICAgIGxvZy5pbmZvKFwib25Eb2N1bWVudExvYWRlZDogXCIsIGV2ZW50LmRvY01ldGEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25NZXNzYWdlUmVjZWl2ZWQoZXZlbnQ6IE1lc3NhZ2VFdmVudCkge1xuXG4gICAgICAgIGlmIChldmVudC5kYXRhICYmIGV2ZW50LmRhdGEudHlwZSA9PT0gXCJjcmVhdGUtYXJlYS1oaWdobGlnaHRcIikge1xuICAgICAgICAgICAgdGhpcy5vbkNyZWF0ZUFyZWFIaWdobGlnaHQoZXZlbnQuZGF0YSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXZlbnQuZGF0YSAmJiBldmVudC5kYXRhLnR5cGUgPT09IFwiZGVsZXRlLWFyZWEtaGlnaGxpZ2h0XCIpIHtcbiAgICAgICAgICAgIHRoaXMub25EZWxldGVBcmVhSGlnaGxpZ2h0KGV2ZW50LmRhdGEpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ3JlYXRlQXJlYUhpZ2hsaWdodChjb250ZXh0TWVudUxvY2F0aW9uOiBDb250ZXh0TWVudUxvY2F0aW9uKSB7XG5cbiAgICAgICAgbG9nLmluZm8oXCJDcmVhdGluZyBhcmVhIGhpZ2hsaWdodDogXCIsIGNvbnRleHRNZW51TG9jYXRpb24pO1xuXG4gICAgICAgIGNvbnN0IHJlY3RGcm9tRXZlbnQgPSBBbm5vdGF0aW9uUmVjdHMuY3JlYXRlRnJvbUV2ZW50KGNvbnRleHRNZW51TG9jYXRpb24pO1xuICAgICAgICBjb25zdCBhbm5vdGF0aW9uUmVjdCA9IEFyZWFIaWdobGlnaHRzLnRvQ29ycmVjdFNjYWxlKFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3QocmVjdEZyb21FdmVudCkpO1xuXG4gICAgICAgIGxvZy5pbmZvKFwiYW5ub3RhdGlvblJlY3RcIiwgYW5ub3RhdGlvblJlY3QpO1xuXG4gICAgICAgIGNvbnN0IGFyZWFIaWdobGlnaHQgPSBBcmVhSGlnaGxpZ2h0cy5jcmVhdGUoe3JlY3Q6IGFubm90YXRpb25SZWN0fSk7XG5cbiAgICAgICAgbG9nLmluZm8oXCJhcmVhSGlnaGxpZ2h0XCIsIGFyZWFIaWdobGlnaHQpO1xuXG4gICAgICAgIGNvbnN0IGRvY01ldGEgPSB0aGlzLm1vZGVsLmRvY01ldGE7XG4gICAgICAgIGNvbnN0IHBhZ2VNZXRhID0gIERvY01ldGFzLmdldFBhZ2VNZXRhKGRvY01ldGEsIGNvbnRleHRNZW51TG9jYXRpb24ucGFnZU51bSk7XG5cbiAgICAgICAgcGFnZU1ldGEuYXJlYUhpZ2hsaWdodHNbYXJlYUhpZ2hsaWdodC5pZF0gPSBhcmVhSGlnaGxpZ2h0O1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkRlbGV0ZUFyZWFIaWdobGlnaHQodHJpZ2dlckV2ZW50OiBUcmlnZ2VyRXZlbnQpIHtcblxuICAgICAgICBjb25zdCBhbm5vdGF0aW9uUG9pbnRlcnNcbiAgICAgICAgICAgID0gQW5ub3RhdGlvblBvaW50ZXJzLnRvQW5ub3RhdGlvblBvaW50ZXJzKFwiLmFyZWEtaGlnaGxpZ2h0XCIsIHRyaWdnZXJFdmVudCk7XG5cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvblBvaW50ZXIgPSBBcnJheXMuZmlyc3QoYW5ub3RhdGlvblBvaW50ZXJzKTtcblxuICAgICAgICBpZiAoYW5ub3RhdGlvblBvaW50ZXIpIHtcblxuICAgICAgICAgICAgY29uc3QgZGF0YXN0b3JlID0gdGhpcy5tb2RlbC5wZXJzaXN0ZW5jZUxheWVyUHJvdmlkZXIoKTtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VNZXRhID0gRG9jTWV0YXMuZ2V0UGFnZU1ldGEodGhpcy5tb2RlbC5kb2NNZXRhLCBhbm5vdGF0aW9uUG9pbnRlci5wYWdlTnVtKTtcbiAgICAgICAgICAgIGNvbnN0IGFyZWFIaWdobGlnaHQgPSBwYWdlTWV0YS5hcmVhSGlnaGxpZ2h0c1thbm5vdGF0aW9uUG9pbnRlci5pZF07XG4gICAgICAgICAgICBjb25zdCB7ZG9jTWV0YX0gPSB0aGlzLm1vZGVsO1xuXG4gICAgICAgICAgICBjb25zdCBvcHRzOiBBcmVhSGlnaGxpZ2h0RGVsZXRlT3B0cyA9IHtcbiAgICAgICAgICAgICAgICBkYXRhc3RvcmUsIGFyZWFIaWdobGlnaHQsIHBhZ2VNZXRhLCBkb2NNZXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBBcmVhSGlnaGxpZ2h0cy5kZWxldGUob3B0cylcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IGxvZy5lcnJvcihcIlVuYWJsZSB0byBkZWxldGUgYXJlYSBoaWdobGlnaHQ6IFwiLCBlcnIpKTtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbn1cbiJdfQ==