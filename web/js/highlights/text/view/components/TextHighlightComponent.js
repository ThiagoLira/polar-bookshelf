"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Dictionaries_1 = require("polar-shared/src/util/Dictionaries");
const Component_1 = require("../../../../components/Component");
const DocFormatFactory_1 = require("../../../../docformat/DocFormatFactory");
const Rects_1 = require("../../../../Rects");
const Logger_1 = require("polar-shared/src/logger/Logger");
const HighlightColor_1 = require("polar-shared/src/metadata/HighlightColor");
const log = Logger_1.Logger.create();
class TextHighlightComponent extends Component_1.Component {
    constructor() {
        super();
        this.textHighlight = undefined;
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
    }
    init(annotationEvent) {
        this.docMeta = annotationEvent.docMeta;
        this.textHighlight = annotationEvent.value;
        this.pageMeta = annotationEvent.pageMeta;
        this.pageNum = this.pageMeta.pageInfo.num;
        this.pageElement = this.docFormat.getPageElementFromPageNum(this.pageNum);
    }
    render() {
        this.destroy();
        log.debug("render()");
        Dictionaries_1.Dictionaries.forDict(this.textHighlight.rects, (id, highlightRect) => {
            const pageElement = Preconditions_1.Preconditions.assertPresent(this.pageElement);
            const pageMeta = Preconditions_1.Preconditions.assertPresent(this.pageMeta);
            const docMeta = Preconditions_1.Preconditions.assertPresent(this.docMeta);
            const textHighlight = Preconditions_1.Preconditions.assertPresent(this.textHighlight);
            log.debug("Rendering annotation at: " + JSON.stringify(highlightRect, null, "  "));
            const highlightElement = document.createElement("div");
            highlightElement.setAttribute("data-type", "text-highlight");
            highlightElement.setAttribute("data-doc-fingerprint", docMeta.docInfo.fingerprint);
            highlightElement.setAttribute("data-text-highlight-id", textHighlight.id);
            highlightElement.setAttribute("data-page-num", `${pageMeta.pageInfo.num}`);
            highlightElement.setAttribute("data-annotation-type", "text-highlight");
            highlightElement.setAttribute("data-annotation-id", textHighlight.id);
            highlightElement.setAttribute("data-annotation-page-num", `${pageMeta.pageInfo.num}`);
            highlightElement.setAttribute("data-annotation-doc-fingerprint", docMeta.docInfo.fingerprint);
            const color = textHighlight.color || 'yellow';
            highlightElement.setAttribute("data-annotation-color", color);
            highlightElement.className = `text-highlight annotation text-highlight-${textHighlight.id}`;
            highlightElement.style.position = "absolute";
            highlightElement.style.mixBlendMode = 'multiply';
            const backgroundColor = HighlightColor_1.HighlightColors.toBackgroundColor(color, 0.5);
            highlightElement.style.backgroundColor = backgroundColor;
            if (this.docFormat.name === "pdf") {
                const currentScale = this.docFormat.currentScale();
                highlightRect = Rects_1.Rects.scale(highlightRect, currentScale);
            }
            highlightElement.style.left = `${highlightRect.left}px`;
            highlightElement.style.top = `${highlightRect.top}px`;
            highlightElement.style.width = `${highlightRect.width}px`;
            highlightElement.style.height = `${highlightRect.height}px`;
            pageElement.insertBefore(highlightElement, pageElement.firstChild);
        });
    }
    destroy() {
        const selector = `.text-highlight-${this.textHighlight.id}`;
        const highlightElements = document.querySelectorAll(selector);
        log.debug(`Found N elements for selector ${selector}: ` + highlightElements.length);
        highlightElements.forEach(highlightElement => {
            highlightElement.parentElement.removeChild(highlightElement);
        });
    }
}
exports.TextHighlightComponent = TextHighlightComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGV4dEhpZ2hsaWdodENvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlRleHRIaWdobGlnaHRDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxrRUFBNkQ7QUFDN0QscUVBQWdFO0FBQ2hFLGdFQUEyRDtBQUMzRCw2RUFBd0U7QUFDeEUsNkNBQXdDO0FBQ3hDLDJEQUFzRDtBQUN0RCw2RUFBeUU7QUFPekUsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQWEsc0JBQXVCLFNBQVEscUJBQVM7SUE4QmpEO1FBQ0ksS0FBSyxFQUFFLENBQUM7UUFuQkosa0JBQWEsR0FBb0IsU0FBUyxDQUFDO1FBcUIvQyxJQUFJLENBQUMsU0FBUyxHQUFHLG1DQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRXBELENBQUM7SUFNTSxJQUFJLENBQUMsZUFBZ0M7UUFJeEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxhQUFhLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQztRQUMzQyxJQUFJLENBQUMsUUFBUSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUM7UUFFekMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7UUFDMUMsSUFBSSxDQUFDLFdBQVcsR0FBaUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFNUYsQ0FBQztJQUtNLE1BQU07UUFFVCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFZixHQUFHLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXRCLDJCQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFjLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLGFBQWEsRUFBRSxFQUFF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TSxJQUFJLENBQUM7WUFNNUQsV0FBVyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFdkUsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBS00sT0FBTztRQUVWLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixJQUFJLENBQUMsYUFBYyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQzdELE1BQU0saUJBQWlCLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTlELEdBQUcsQ0FBQyxLQUFLLENBQUMsaUNBQWlDLFFBQVEsSUFBSSxHQUFHLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXBGLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1lBQ3pDLGdCQUFnQixDQUFDLGFBQWMsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNsRSxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7Q0FFSjtBQTVJRCx3REE0SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RvY0Zvcm1hdH0gZnJvbSAnLi4vLi4vLi4vLi4vZG9jZm9ybWF0L0RvY0Zvcm1hdCc7XG5pbXBvcnQge0Fubm90YXRpb25FdmVudH0gZnJvbSAnLi4vLi4vLi4vLi4vYW5ub3RhdGlvbnMvY29tcG9uZW50cy9Bbm5vdGF0aW9uRXZlbnQnO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtEaWN0aW9uYXJpZXN9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC9EaWN0aW9uYXJpZXMnO1xuaW1wb3J0IHtDb21wb25lbnR9IGZyb20gJy4uLy4uLy4uLy4uL2NvbXBvbmVudHMvQ29tcG9uZW50JztcbmltcG9ydCB7RG9jRm9ybWF0RmFjdG9yeX0gZnJvbSAnLi4vLi4vLi4vLi4vZG9jZm9ybWF0L0RvY0Zvcm1hdEZhY3RvcnknO1xuaW1wb3J0IHtSZWN0c30gZnJvbSAnLi4vLi4vLi4vLi4vUmVjdHMnO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvbG9nZ2VyL0xvZ2dlcic7XG5pbXBvcnQge0hpZ2hsaWdodENvbG9yc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9IaWdobGlnaHRDb2xvcic7XG5pbXBvcnQge0lQYWdlTWV0YX0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSVBhZ2VNZXRhXCI7XG5pbXBvcnQge0lEb2NNZXRhfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JRG9jTWV0YVwiO1xuaW1wb3J0IHtIaWdobGlnaHRDb2xvcn0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSUJhc2VIaWdobGlnaHRcIjtcbmltcG9ydCB7SVJlY3R9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC9yZWN0cy9JUmVjdCc7XG5pbXBvcnQge0lUZXh0SGlnaGxpZ2h0fSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JVGV4dEhpZ2hsaWdodFwiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmV4cG9ydCBjbGFzcyBUZXh0SGlnaGxpZ2h0Q29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50IHtcblxuICAgIHByaXZhdGUgZG9jRm9ybWF0OiBEb2NGb3JtYXQ7XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIHByaXZhdGUgZG9jTWV0YT86IElEb2NNZXRhO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBwcml2YXRlIHRleHRIaWdobGlnaHQ/OiBJVGV4dEhpZ2hsaWdodCA9IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgcHJpdmF0ZSBwYWdlTWV0YT86IElQYWdlTWV0YTtcblxuICAgIC8qKlxuICAgICAqIFRoZSBwYWdlIHdlJ3JlIHdvcmtpbmcgd2l0aC5cbiAgICAgKi9cbiAgICBwcml2YXRlIHBhZ2VOdW0/OiBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgLnBhZ2Ugd2UncmUgd29ya2luZyB3aXRoLlxuICAgICAqXG4gICAgICovXG4gICAgcHJpdmF0ZSBwYWdlRWxlbWVudD86IEhUTUxFbGVtZW50O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5kb2NGb3JtYXQgPSBEb2NGb3JtYXRGYWN0b3J5LmdldEluc3RhbmNlKCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAT3ZlcnJpZGVcbiAgICAgKiBAcGFyYW0gYW5ub3RhdGlvbkV2ZW50XG4gICAgICovXG4gICAgcHVibGljIGluaXQoYW5ub3RhdGlvbkV2ZW50OiBBbm5vdGF0aW9uRXZlbnQpIHtcblxuICAgICAgICAvLyBUT0RPOiB3ZSBzaG91bGQgYSBzcGVjaWZpYyBldmVudCBjbGFzcyBmb3IgdGhpcyBkYXRhIHdoaWNoIGlzIGNhcHR1cmVkXG4gICAgICAgIC8vIHdpdGhpbiBhIGhpZ2hlciBsZXZlbCBhbm5vdGF0aW9uRXZlbnQuXG4gICAgICAgIHRoaXMuZG9jTWV0YSA9IGFubm90YXRpb25FdmVudC5kb2NNZXRhO1xuICAgICAgICB0aGlzLnRleHRIaWdobGlnaHQgPSBhbm5vdGF0aW9uRXZlbnQudmFsdWU7XG4gICAgICAgIHRoaXMucGFnZU1ldGEgPSBhbm5vdGF0aW9uRXZlbnQucGFnZU1ldGE7XG5cbiAgICAgICAgdGhpcy5wYWdlTnVtID0gdGhpcy5wYWdlTWV0YS5wYWdlSW5mby5udW07XG4gICAgICAgIHRoaXMucGFnZUVsZW1lbnQgPSA8SFRNTEVsZW1lbnQ+IHRoaXMuZG9jRm9ybWF0LmdldFBhZ2VFbGVtZW50RnJvbVBhZ2VOdW0odGhpcy5wYWdlTnVtKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBPdmVycmlkZVxuICAgICAqL1xuICAgIHB1YmxpYyByZW5kZXIoKSB7XG5cbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XG5cbiAgICAgICAgbG9nLmRlYnVnKFwicmVuZGVyKClcIik7XG5cbiAgICAgICAgRGljdGlvbmFyaWVzLmZvckRpY3QodGhpcy50ZXh0SGlnaGxpZ2h0IS5yZWN0cywgKGlkLCBoaWdobGlnaHRSZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhZ2VFbGVtZW50ID0gUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KHRoaXMucGFnZUVsZW1lbnQpO1xuICAgICAgICAgICAgY29uc3QgcGFnZU1ldGEgPSBQcmVjb25kaXRpb25zLmFzc2VydFByZXNlbnQodGhpcy5wYWdlTWV0YSk7XG4gICAgICAgICAgICBjb25zdCBkb2NNZXRhID0gUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KHRoaXMuZG9jTWV0YSk7XG4gICAgICAgICAgICBjb25zdCB0ZXh0SGlnaGxpZ2h0ID0gUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KHRoaXMudGV4dEhpZ2hsaWdodCk7XG5cbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIlJlbmRlcmluZyBhbm5vdGF0aW9uIGF0OiBcIiArIEpTT04uc3RyaW5naWZ5KGhpZ2hsaWdodFJlY3QsIG51bGwsIFwiICBcIikpO1xuXG4gICAgICAgICAgICBjb25zdCBoaWdobGlnaHRFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblxuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLXR5cGVcIiwgXCJ0ZXh0LWhpZ2hsaWdodFwiKTtcbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1kb2MtZmluZ2VycHJpbnRcIiwgZG9jTWV0YS5kb2NJbmZvLmZpbmdlcnByaW50KTtcbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS10ZXh0LWhpZ2hsaWdodC1pZFwiLCB0ZXh0SGlnaGxpZ2h0LmlkKTtcbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1wYWdlLW51bVwiLCBgJHtwYWdlTWV0YS5wYWdlSW5mby5udW19YCk7XG5cbiAgICAgICAgICAgIC8vIGFubm90YXRpb24gZGVzY3JpcHRvciBtZXRhZGF0YS5cbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hbm5vdGF0aW9uLXR5cGVcIiwgXCJ0ZXh0LWhpZ2hsaWdodFwiKTtcbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hbm5vdGF0aW9uLWlkXCIsIHRleHRIaWdobGlnaHQuaWQpO1xuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWFubm90YXRpb24tcGFnZS1udW1cIiwgYCR7cGFnZU1ldGEucGFnZUluZm8ubnVtfWApO1xuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWFubm90YXRpb24tZG9jLWZpbmdlcnByaW50XCIsIGRvY01ldGEuZG9jSW5mby5maW5nZXJwcmludCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbG9yOiBIaWdobGlnaHRDb2xvciA9IHRleHRIaWdobGlnaHQuY29sb3IgfHwgJ3llbGxvdyc7XG5cbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hbm5vdGF0aW9uLWNvbG9yXCIsIGNvbG9yKTtcblxuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5jbGFzc05hbWUgPSBgdGV4dC1oaWdobGlnaHQgYW5ub3RhdGlvbiB0ZXh0LWhpZ2hsaWdodC0ke3RleHRIaWdobGlnaHQuaWR9YDtcblxuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zdHlsZS5wb3NpdGlvbiA9IFwiYWJzb2x1dGVcIjtcbiAgICAgICAgICAgIChoaWdobGlnaHRFbGVtZW50LnN0eWxlIGFzIGFueSkubWl4QmxlbmRNb2RlID0gJ211bHRpcGx5JztcblxuICAgICAgICAgICAgY29uc3QgYmFja2dyb3VuZENvbG9yID0gSGlnaGxpZ2h0Q29sb3JzLnRvQmFja2dyb3VuZENvbG9yKGNvbG9yLCAwLjUpO1xuXG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGJhY2tncm91bmRDb2xvcjtcbiAgICAgICAgICAgIC8vIGhpZ2hsaWdodEVsZW1lbnQuc3R5bGUub3BhY2l0eSA9IGAwLjVgO1xuXG4gICAgICAgICAgICAvLyB0b0JhY2tncm91bmRDb2xvclxuXG4gICAgICAgICAgICBpZiAodGhpcy5kb2NGb3JtYXQubmFtZSA9PT0gXCJwZGZcIikge1xuICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgb25seSBuZWVkZWQgZm9yIFBERiBhbmQgd2UgbWlnaHQgYmUgYWJsZSB0byB1c2UgYSB0cmFuc2Zvcm1cbiAgICAgICAgICAgICAgICAvLyBpbiB0aGUgZnV0dXJlIHdoaWNoIHdvdWxkIGJlIGVhc2llci5cbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U2NhbGUgPSB0aGlzLmRvY0Zvcm1hdC5jdXJyZW50U2NhbGUoKTtcbiAgICAgICAgICAgICAgICBoaWdobGlnaHRSZWN0ID0gUmVjdHMuc2NhbGUoaGlnaGxpZ2h0UmVjdCwgY3VycmVudFNjYWxlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5zdHlsZS5sZWZ0ID0gYCR7aGlnaGxpZ2h0UmVjdC5sZWZ0fXB4YDtcbiAgICAgICAgICAgIGhpZ2hsaWdodEVsZW1lbnQuc3R5bGUudG9wID0gYCR7aGlnaGxpZ2h0UmVjdC50b3B9cHhgO1xuXG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnN0eWxlLndpZHRoID0gYCR7aGlnaGxpZ2h0UmVjdC53aWR0aH1weGA7XG4gICAgICAgICAgICBoaWdobGlnaHRFbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke2hpZ2hsaWdodFJlY3QuaGVpZ2h0fXB4YDtcblxuICAgICAgICAgICAgLy8gVE9ETzogdGhlIHByb2JsZW0gd2l0aCB0aGlzIHN0cmF0ZWd5IGlzIHRoYXQgaXQgaW5zZXJ0cyBlbGVtZW50cyBpbiB0aGVcbiAgICAgICAgICAgIC8vIFJFVkVSU0Ugb3JkZXIgdGhleSBhcmUgcHJlc2VudGVkIHZpc3VhbGx5LiAgVGhpcyBpc24ndCBhIHByb2JsZW0gYnV0XG4gICAgICAgICAgICAvLyBpdCBtaWdodCBiZWNvbWUgY29uZnVzaW5nIHRvIGRlYnVnIHRoaXMgaXNzdWUuICBBIHF1aWNrIGZpeCBpcyB0b1xuICAgICAgICAgICAgLy8ganVzdCByZXZlcnNlIHRoZSBhcnJheSBiZWZvcmUgd2UgcmVuZGVyIHRoZSBlbGVtZW50cy5cbiAgICAgICAgICAgIHBhZ2VFbGVtZW50Lmluc2VydEJlZm9yZShoaWdobGlnaHRFbGVtZW50LCBwYWdlRWxlbWVudC5maXJzdENoaWxkKTtcblxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBPdmVycmlkZVxuICAgICAqL1xuICAgIHB1YmxpYyBkZXN0cm95KCkge1xuXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yID0gYC50ZXh0LWhpZ2hsaWdodC0ke3RoaXMudGV4dEhpZ2hsaWdodCEuaWR9YDtcbiAgICAgICAgY29uc3QgaGlnaGxpZ2h0RWxlbWVudHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTtcblxuICAgICAgICBsb2cuZGVidWcoYEZvdW5kIE4gZWxlbWVudHMgZm9yIHNlbGVjdG9yICR7c2VsZWN0b3J9OiBgICsgaGlnaGxpZ2h0RWxlbWVudHMubGVuZ3RoKTtcblxuICAgICAgICBoaWdobGlnaHRFbGVtZW50cy5mb3JFYWNoKGhpZ2hsaWdodEVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgaGlnaGxpZ2h0RWxlbWVudC5wYXJlbnRFbGVtZW50IS5yZW1vdmVDaGlsZChoaWdobGlnaHRFbGVtZW50KTtcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbn1cbiJdfQ==