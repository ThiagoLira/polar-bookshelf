"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("polar-shared/src/Preconditions");
const TextNodes_1 = require("./TextNodes");
const Rects_1 = require("../../../Rects");
const Functions_1 = require("polar-shared/src/util/Functions");
const Text_1 = require("../../../util/Text");
class TextRegion {
    constructor() {
        this.textNodes = [];
    }
    push(textNode) {
        if (textNode.textContent.length > 1) {
            throw new Error("Nodes must be split");
        }
        this.textNodes.push(textNode);
    }
    getTextNodes() {
        return this.textNodes;
    }
    get length() {
        return this.textNodes.length;
    }
    toString() {
        let result = "";
        this.textNodes.forEach(textNode => {
            result += textNode.textContent;
        });
        return result;
    }
    format() {
        return `(${this.textNodes.length}): \n` + Text_1.Text.indent(this.toString(), "  ");
    }
    toJSON() {
        return { nrNodes: this.textNodes.length, text: this.toString() };
    }
}
exports.TextRegion = TextRegion;
class TextBlock extends TextRegion {
}
class MergedTextBlock {
    constructor(obj) {
        this.textNode = obj.textNode;
        this.rect = obj.rect;
        this.text = obj.text;
    }
    toString() {
        return this.text;
    }
    toExternal() {
        return { text: this.text, rect: this.rect };
    }
}
class NodeArray {
    constructor(nodes) {
        Preconditions_1.Preconditions.assertNotNull(nodes, "nodes");
        this.nodes = nodes;
    }
    get length() {
        return this.nodes.length;
    }
    static createFromElement(element) {
        if (element.nodeType === Node.ELEMENT_NODE) {
            return new NodeArray(element.childNodes);
        }
        else if (element.nodeType === Node.TEXT_NODE) {
            throw new Error("Text node not supported");
        }
        else {
            throw new Error("Unable to handle node type: " + element.nodeType);
        }
    }
}
exports.NodeArray = NodeArray;
class TextNodeRows {
    static fromTextNode(textNode) {
        if (textNode.nodeType !== Node.TEXT_NODE) {
            throw new Error("Not a text node");
        }
        let nodeArray = TextNodeRows.splitTextNodePerCharacter(textNode);
        let textRegions = TextNodeRows.computeTextRegions(nodeArray, null);
        let textBlocks = TextNodeRows.computeTextBlocks(textRegions);
        let mergedTextBlocks = TextNodeRows.mergeTextBlocks(textBlocks);
        let result = mergedTextBlocks.map(current => current.textNode);
        return result;
    }
    static fromTextNodes(textNodes) {
        const result = [];
        textNodes.forEach(textNode => {
            result.push(...TextNodeRows.fromTextNode(textNode));
        });
        return result;
    }
    static splitElement(element) {
        let result = 0;
        Array.from(element.childNodes).forEach(current => {
            if (current.nodeType === Node.TEXT_NODE) {
                let nodeArray = TextNodeRows.splitTextNodePerCharacter(current);
                result += nodeArray.length;
            }
            if (current.nodeType === Node.ELEMENT_NODE) {
                result += TextNodeRows.splitElement(current);
            }
        });
        return result;
    }
    static computeTextRegions(nodeArray, textRegions) {
        Preconditions_1.Preconditions.assertNotNull(nodeArray, "nodeArray");
        if (nodeArray.constructor !== NodeArray) {
            throw new Error("Not a node array: " + nodeArray.constructor);
        }
        Preconditions_1.Preconditions.assertNotNull(nodeArray.nodes, "nodeArray.nodes");
        if (!textRegions) {
            textRegions = [];
        }
        let textRegion = new TextRegion();
        Functions_1.createSiblings(nodeArray.nodes).forEach(position => {
            let currentNode = position.curr;
            if (currentNode.nodeType === Node.TEXT_NODE) {
                textRegion.push(currentNode);
            }
            if (currentNode.nodeType === Node.ELEMENT_NODE) {
                textRegions.push(textRegion);
                textRegion = new TextRegion();
                TextNodeRows.computeTextRegions(NodeArray.createFromElement(currentNode), textRegions);
            }
            if (position.next === null && textRegion.length > 0) {
                textRegions.push(textRegion);
            }
        });
        return textRegions;
    }
    static computeTextBlocks(textRegions) {
        const textBlocks = [];
        textRegions.forEach(textRegion => {
            let textBlock = new TextBlock();
            let prevRect = null;
            Functions_1.createSiblings(textRegion.getTextNodes()).forEach(position => {
                let currRect = TextNodes_1.TextNodes.getRange(position.curr).getBoundingClientRect();
                if (Rects_1.Rects.isVisible(currRect)) {
                    if (prevRect != null) {
                        if (TextNodeRows.computeRowKey(prevRect) !== TextNodeRows.computeRowKey(currRect)) {
                            textBlocks.push(textBlock);
                            textBlock = new TextBlock();
                        }
                    }
                    prevRect = currRect;
                }
                textBlock.push(position.curr);
                if (position.next === null && textBlock.length > 0) {
                    textBlocks.push(textBlock);
                }
            });
        });
        return textBlocks;
    }
    static mergeTextBlocks(textBlocks) {
        const result = [];
        textBlocks.forEach(textBlock => {
            let textNodes = textBlock.getTextNodes().slice();
            let text = textBlock.toString();
            let textNode = textNodes.pop();
            textNode.textContent = text;
            textNodes.forEach(orphanedNode => {
                orphanedNode.parentNode.removeChild(orphanedNode);
            });
            result.push(new MergedTextBlock({
                textNode,
                text,
                rect: TextNodes_1.TextNodes.getRange(textNode).getBoundingClientRect()
            }));
        });
        return result;
    }
    static computeRowKey(rect) {
        return `${rect.top}:${rect.bottom}`;
    }
    static splitTextNodePerCharacter(textNode) {
        let result = [];
        while (textNode.textContent.length > 1) {
            result.push(textNode);
            textNode = textNode.splitText(1);
        }
        result.push(textNode);
        return new NodeArray(result);
    }
}
exports.TextNodeRows = TextNodeRows;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGV4dE5vZGVSb3dzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVGV4dE5vZGVSb3dzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBdUJBLGtFQUE2RDtBQUM3RCwyQ0FBc0M7QUFDdEMsMENBQXFDO0FBQ3JDLCtEQUErRDtBQUMvRCw2Q0FBd0M7QUFFeEMsTUFBYSxVQUFVO0lBSW5CO1FBRlEsY0FBUyxHQUFVLEVBQUUsQ0FBQztJQUc5QixDQUFDO0lBRUQsSUFBSSxDQUFDLFFBQWE7UUFFZCxJQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7U0FDMUM7UUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBS0QsWUFBWTtRQUNSLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ04sT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztJQUNqQyxDQUFDO0lBS0QsUUFBUTtRQUVKLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUVoQixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM5QixNQUFNLElBQUksUUFBUSxDQUFDLFdBQVcsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sTUFBTSxDQUFDO0lBRWxCLENBQUM7SUFFRCxNQUFNO1FBQ0YsT0FBTyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxPQUFPLEdBQUcsV0FBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakYsQ0FBQztJQUVELE1BQU07UUFFRixPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxF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QyxxQkFBcUIsRUFBRTthQUM3RCxDQUFDLENBQUMsQ0FBQztRQUVSLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFFbEIsQ0FBQztJQU9ELE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBMEI7UUFDM0MsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFRRCxNQUFNLENBQUMseUJBQXlCLENBQUMsUUFBYTtRQUUxQyxJQUFJLE1BQU0sR0FBRyxFQUVaLENBQUM7UUFFRixPQUFNLFFBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3RCLFFBQVEsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3BDO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV0QixPQUFPLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRWpDLENBQUM7Q0FFSjtBQTdSRCxvQ0E2UkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEEgcmVnaW9uIG9mIHRleHQgd2l0aGluIHRoZSBkb2N1bWVudCB3aGVyZSB0aGUgbm9kZXMgYXJlIHNwbGl0IGFuZCBhcmUgYmFjayB0b1xuICogYmFjayB3aXRob3V0IGFuIGVsZW1lbnQgaW4gYmV0d2VlbiBidXQgTUFZIGJlIGJldHdlZW4gZGlmZmVyZW50IHJvd3MuXG4gKlxuICogV2UgdXNlIHRoaXMgaXMgYmVjYXVzZSB3ZSdyZSBnZXR0aW5nIHR3byByZWdpb25zIHdpdGggJ2V4cGFuZGVkJyBib3hlcy4gIEFuXG4gKiBleHBhbmRlZCBib3ggaXMgbGlrZSB0aGlzXG4gKlxuICogKy0tLS0tLS0tLS0tLS0tLS0rXG4gKiB8eHh4eHh4eHh4eHh4eHh4eHxcbiAqIHx4eCAgICAgICAgICAgICAgfFxuICogKy0tLS0tLS0tLS0tLS0tLS0rXG4gKlxuICogLSBJbnN0ZWFkIHdlIHNob3VsZCBjYWxsIHNwbGl0VGV4dCBhbmQgdGhlbiBidWlsZCB0d28gYm94ZXMgbGlrZTpcbiAqXG4gKiArLS0tLS0tLS0tLS0tLS0tLStcbiAqIHx4eHh4eHh4eHh4eHh4eHh4fFxuICogKy0tKy0tLS0tLS0tLS0tLS0rXG4gKiB8eHh8XG4gKiArLS0rXG4gKlxuICogd2hpY2ggd291bGQgbG9vayBmYXIgbW9yZSBhcHByb3ByaWF0ZVxuICpcbiAqL1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zXCI7XG5pbXBvcnQge1RleHROb2Rlc30gZnJvbSAnLi9UZXh0Tm9kZXMnO1xuaW1wb3J0IHtSZWN0c30gZnJvbSAnLi4vLi4vLi4vUmVjdHMnO1xuaW1wb3J0IHtjcmVhdGVTaWJsaW5nc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy91dGlsL0Z1bmN0aW9ucyc7XG5pbXBvcnQge1RleHR9IGZyb20gJy4uLy4uLy4uL3V0aWwvVGV4dCc7XG5cbmV4cG9ydCBjbGFzcyBUZXh0UmVnaW9uIHtcblxuICAgIHByaXZhdGUgdGV4dE5vZGVzOiBhbnlbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgfVxuXG4gICAgcHVzaCh0ZXh0Tm9kZTogYW55KSB7XG5cbiAgICAgICAgaWYodGV4dE5vZGUudGV4dENvbnRlbnQubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm9kZXMgbXVzdCBiZSBzcGxpdFwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudGV4dE5vZGVzLnB1c2godGV4dE5vZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0aGUgbm9kZXMgZm9yIHRoaXMgcmVnaW9uLlxuICAgICAqL1xuICAgIGdldFRleHROb2RlcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGV4dE5vZGVzO1xuICAgIH1cblxuICAgIGdldCBsZW5ndGgoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRleHROb2Rlcy5sZW5ndGg7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIGFuIGFycmF5IG9mIHRleHQgbm9kZXMgaW50byBhIHN0cmluZy5cbiAgICAgKi9cbiAgICB0b1N0cmluZygpIHtcblxuICAgICAgICBsZXQgcmVzdWx0ID0gXCJcIjtcblxuICAgICAgICB0aGlzLnRleHROb2Rlcy5mb3JFYWNoKHRleHROb2RlID0+IHtcbiAgICAgICAgICAgIHJlc3VsdCArPSB0ZXh0Tm9kZS50ZXh0Q29udGVudDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIGZvcm1hdCgpIHtcbiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnRleHROb2Rlcy5sZW5ndGh9KTogXFxuYCArIFRleHQuaW5kZW50KHRoaXMudG9TdHJpbmcoKSwgXCIgIFwiKTtcbiAgICB9XG5cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIC8vIEZJWE1FOiB0aGlzIGlzbid0IHRvSlNPTiBhcyBpdCdzIHJldHVybmluZyBhbiBvYmplY3QuLi4gbm90IGEgc3RyaW5nLlxuICAgICAgICByZXR1cm4geyBuck5vZGVzOiB0aGlzLnRleHROb2Rlcy5sZW5ndGgsIHRleHQ6IHRoaXMudG9TdHJpbmcoKSB9O1xuICAgIH1cblxufVxuXG4vKipcbiAqIEEgVGV4dEJsb2NrIGFyZSBzdHJ1Y3R1cmFsbHkgdGhlIHNhbWUgYXMgVGV4dFJlZ2lvbiBidXQgc2VtYW50aWNhbGx5IGFcbiAqIFRleHRCbG9jayBpcyBvbiBkaWZmZXJlbnQgdmlzdWFsIHJvd3MuXG4gKi9cbmNsYXNzIFRleHRCbG9jayBleHRlbmRzIFRleHRSZWdpb24ge1xuXG59XG5cbmNsYXNzIE1lcmdlZFRleHRCbG9jayB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbWVyZ2VkIE5vZGUgb2YgdHlwZSBURVhUX05PREVcbiAgICAgKi9cbiAgICBwdWJsaWMgdGV4dE5vZGU6IGFueTtcblxuICAgIC8qKlxuICAgICAqIFRoZSByZWN0IG9mIHRoaXMgbm9kZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVjdDogYW55O1xuXG4gICAgLyoqXG4gICAgICogVGhlIHRleHQgdmFsdWUgb2YgdGhlIG5vZGUuXG4gICAgICovXG4gICAgcHVibGljIHRleHQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKG9iajogYW55KSB7XG5cbiAgICAgICAgdGhpcy50ZXh0Tm9kZSA9IG9iai50ZXh0Tm9kZTtcbiAgICAgICAgdGhpcy5yZWN0ID0gb2JqLnJlY3Q7XG4gICAgICAgIHRoaXMudGV4dCA9IG9iai50ZXh0O1xuXG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRleHQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29udmVydCB0byBhbiBvYmplY3QgdGhhdCBjYW4gYmUgc2VyaWFsaXplZC5cbiAgICAgKi9cbiAgICB0b0V4dGVybmFsKCkge1xuICAgICAgICByZXR1cm4ge3RleHQ6IHRoaXMudGV4dCwgcmVjdDogdGhpcy5yZWN0fTtcbiAgICB9XG5cbn1cblxuLyoqXG4gKiBIb2xkcyBhbiBhcnJheSBvZiBub2RlcyB0aGF0IHdlIGNhbiB3b3JrIHdpdGguXG4gKi9cbmV4cG9ydCBjbGFzcyBOb2RlQXJyYXkge1xuXG4gICAgcHJpdmF0ZSBub2RlczogYW55O1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gbm9kZXMge0FycmF5PE5vZGU+fVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5vZGVzOiBhbnkpIHtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKG5vZGVzLCBcIm5vZGVzXCIpO1xuICAgICAgICB0aGlzLm5vZGVzID0gbm9kZXM7XG4gICAgfVxuXG4gICAgZ2V0IGxlbmd0aCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZXMubGVuZ3RoO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgaW5wdXQgYXMgYSBsaXN0IG9mIG5vZGVzIHRvIHByb2Nlc3MuICBJZiB0aGUgbm9kZSB3ZSBnaXZlIGl0IGlzXG4gICAgICogQUxSRUFEWSBhIHNpbmdsZSB0ZXh0IG5vZGUganVzdCByZXR1cm4gdGhhdCB3cmFwcGVkIGluIGFuIGFycmF5LlxuICAgICAqIEBwYXJhbSBlbGVtZW50XG4gICAgICovXG4gICAgc3RhdGljIGNyZWF0ZUZyb21FbGVtZW50KGVsZW1lbnQ6IGFueSkge1xuXG4gICAgICAgIGlmKGVsZW1lbnQubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IE5vZGVBcnJheShlbGVtZW50LmNoaWxkTm9kZXMpO1xuICAgICAgICB9IGVsc2UgaWYoZWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRleHQgbm9kZSBub3Qgc3VwcG9ydGVkXCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5hYmxlIHRvIGhhbmRsZSBub2RlIHR5cGU6IFwiICsgZWxlbWVudC5ub2RlVHlwZSk7XG4gICAgICAgIH1cblxuICAgIH1cblxufVxuXG4vKipcbiAqIEJ1aWxkIHJvd3Mgb2YgY29udGlndW91cyB0ZXh0IG5vZGVzIHBsdXMgYnJlYWsgdGhlbSBhcGFydCBiYXNlZCBvbiBob3cgdGhleVxuICogZGlzcGxheSB2aXN1YWxseS5cbiAqXG4gKiBUaGlzIGFsZ29yaXRobSBoYXMgdGhyZWUgc3RlcHM6XG4gKlxuICogLSBzcGxpdCBhbGwgdGhlIHRleHQgbm9kZXMgaW50byBzaW5nbGUgY2hhciB0ZXh0IG5vZGVzXG4gKiAtIGZpbmQgYWxsICdyZWdpb25zJyBvZiBjb250aWd1b3VzIHRleHQgbm9kZXNcbiAqXG4gKiAtIHRoZW4gZmluZCBhbGwgJ2Jsb2NrcycgaW4gdGhlc2UgcmVnaW9ucyBieSBzcGxpdHRpbmcgdGhlIHJlZ2lvbnMgd2hlcmVcbiAqICAgdGhlIHRleHQgc3RhcnRzIGEgbmV3IHJvdyB2ZXJ0aWNhbGx5LlxuICpcbiAqL1xuZXhwb3J0IGNsYXNzIFRleHROb2RlUm93cyB7XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB0ZXh0Tm9kZSB7Tm9kZX1cbiAgICAgKiBAcmV0dXJuIHtBcnJheTxOb2RlPn1cbiAgICAgKi9cbiAgICBzdGF0aWMgZnJvbVRleHROb2RlKHRleHROb2RlOiBhbnkpIHtcblxuICAgICAgICBpZih0ZXh0Tm9kZS5ub2RlVHlwZSAhPT0gTm9kZS5URVhUX05PREUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vdCBhIHRleHQgbm9kZVwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBub2RlQXJyYXkgPSBUZXh0Tm9kZVJvd3Muc3BsaXRUZXh0Tm9kZVBlckNoYXJhY3Rlcih0ZXh0Tm9kZSk7XG5cbiAgICAgICAgbGV0IHRleHRSZWdpb25zID0gVGV4dE5vZGVSb3dzLmNvbXB1dGVUZXh0UmVnaW9ucyhub2RlQXJyYXksIG51bGwpO1xuXG4gICAgICAgIGxldCB0ZXh0QmxvY2tzID0gVGV4dE5vZGVSb3dzLmNvbXB1dGVUZXh0QmxvY2tzKHRleHRSZWdpb25zKTtcblxuICAgICAgICBsZXQgbWVyZ2VkVGV4dEJsb2NrcyA9IFRleHROb2RlUm93cy5tZXJnZVRleHRCbG9ja3ModGV4dEJsb2Nrcyk7XG5cbiAgICAgICAgbGV0IHJlc3VsdCA9IG1lcmdlZFRleHRCbG9ja3MubWFwKGN1cnJlbnQgPT4gY3VycmVudC50ZXh0Tm9kZSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHRleHROb2RlcyB7QXJyYXk8Tm9kZT59XG4gICAgICogQHJldHVybiB7QXJyYXk8Tm9kZT59XG4gICAgICovXG4gICAgc3RhdGljIGZyb21UZXh0Tm9kZXModGV4dE5vZGVzOiBhbnlbXSkge1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAdHlwZSB7QXJyYXk8Tm9kZT59XG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IFtdO1xuXG4gICAgICAgIHRleHROb2Rlcy5mb3JFYWNoKHRleHROb2RlID0+IHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC4uLlRleHROb2RlUm93cy5mcm9tVGV4dE5vZGUodGV4dE5vZGUpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9jb25zb2xlLmxvZyhcIkZJWE1FOiAxMjM6IGdvaW5nIHRvIHJldHVybiBOOiBcIiArIHJlc3VsdC5sZW5ndGgpXG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGVsZW1lbnQge0VsZW1lbnR9IFRoZSByb290IG5vZGUgdG8gc3BsaXQuXG4gICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIG5vZGVzIHNwbGl0LlxuICAgICAqL1xuICAgIHN0YXRpYyBzcGxpdEVsZW1lbnQoZWxlbWVudDogSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICBsZXQgcmVzdWx0ID0gMDtcblxuICAgICAgICBBcnJheS5mcm9tKGVsZW1lbnQuY2hpbGROb2RlcykuZm9yRWFjaChjdXJyZW50ID0+IHtcblxuICAgICAgICAgICAgaWYoY3VycmVudC5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUpIHtcbiAgICAgICAgICAgICAgICBsZXQgbm9kZUFycmF5ID0gVGV4dE5vZGVSb3dzLnNwbGl0VGV4dE5vZGVQZXJDaGFyYWN0ZXIoY3VycmVudCk7XG4gICAgICAgICAgICAgICAgcmVzdWx0ICs9IG5vZGVBcnJheS5sZW5ndGg7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmKGN1cnJlbnQubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7XG4gICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBhIHJlZ3VsYXIgZWxlbWVudCByZWN1cnNlIGludG8gaXQgc3BsaXR0aW5nIHRoYXQgdG9vLlxuICAgICAgICAgICAgICAgIHJlc3VsdCArPSBUZXh0Tm9kZVJvd3Muc3BsaXRFbGVtZW50KDxIVE1MRWxlbWVudD4gY3VycmVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRleHQgcmVnaW9ucyBhcmUgZ3JvdXBzIG9mIGNvbnRpZ3VvdXMgdGV4dCBub2RlcyB0aGF0IGFyZSBiYWNrIHRvIGJhY2tcbiAgICAgKiB3aXRob3V0IGFuIGVsZW1lbnQgaW4gYmV0d2Vlbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBub2RlQXJyYXkge05vZGVBcnJheX1cbiAgICAgKiBAcGFyYW0gW3RleHRSZWdpb25zXSB7QXJyYXk8VGV4dFJlZ2lvbj59IFRoZSBzdGFydGluZyB0ZXh0IHJlZ2lvbnMuIFVzZWQgbW9zdGx5IGZvciByZWN1cnNpb24uXG4gICAgICogQHJldHVybiB7QXJyYXk8VGV4dFJlZ2lvbj59IFRoZSBjb21wdXRlZCB0ZXh0IHJlZ2lvbnNcbiAgICAgKi9cbiAgICBzdGF0aWMgY29tcHV0ZVRleHRSZWdpb25zKG5vZGVBcnJheTogYW55LCB0ZXh0UmVnaW9uczogYW55KSB7XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKG5vZGVBcnJheSwgXCJub2RlQXJyYXlcIik7XG5cbiAgICAgICAgaWYobm9kZUFycmF5LmNvbnN0cnVjdG9yICE9PSBOb2RlQXJyYXkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vdCBhIG5vZGUgYXJyYXk6IFwiICsgbm9kZUFycmF5LmNvbnN0cnVjdG9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0Tm90TnVsbChub2RlQXJyYXkubm9kZXMsIFwibm9kZUFycmF5Lm5vZGVzXCIpO1xuXG4gICAgICAgIC8vIGFsbCB0ZXh0IHJlZ2lvbnMgdGhhdCB3ZSdyZSB3b3JraW5nIG9uXG4gICAgICAgIGlmKCF0ZXh0UmVnaW9ucykge1xuICAgICAgICAgICAgdGV4dFJlZ2lvbnMgPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoZSBjdXJyZW50IHJlZ2lvblxuICAgICAgICAvKipcbiAgICAgICAgICogQHR5cGUge1RleHRSZWdpb259XG4gICAgICAgICAqL1xuICAgICAgICBsZXQgdGV4dFJlZ2lvbiA9IG5ldyBUZXh0UmVnaW9uKCk7XG5cbiAgICAgICAgY3JlYXRlU2libGluZ3Mobm9kZUFycmF5Lm5vZGVzKS5mb3JFYWNoKHBvc2l0aW9uID0+IHtcblxuICAgICAgICAgICAgbGV0IGN1cnJlbnROb2RlID0gcG9zaXRpb24uY3VycjtcblxuICAgICAgICAgICAgaWYoY3VycmVudE5vZGUubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFKSB7XG4gICAgICAgICAgICAgICAgdGV4dFJlZ2lvbi5wdXNoKGN1cnJlbnROb2RlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYoY3VycmVudE5vZGUubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7XG5cbiAgICAgICAgICAgICAgICB0ZXh0UmVnaW9ucy5wdXNoKHRleHRSZWdpb24pO1xuICAgICAgICAgICAgICAgIHRleHRSZWdpb24gPSBuZXcgVGV4dFJlZ2lvbigpO1xuXG4gICAgICAgICAgICAgICAgVGV4dE5vZGVSb3dzLmNvbXB1dGVUZXh0UmVnaW9ucyhOb2RlQXJyYXkuY3JlYXRlRnJvbUVsZW1lbnQoY3VycmVudE5vZGUpLCB0ZXh0UmVnaW9ucyk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gKioqIGhhbmRsZSB0aGUgbGFzdCBub2RlXG5cbiAgICAgICAgICAgIGlmKHBvc2l0aW9uLm5leHQgPT09IG51bGwgJiYgdGV4dFJlZ2lvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgLy8gZG9uJ3QgZHJvcCB0aGUgbGFzdCBibG9ja1xuICAgICAgICAgICAgICAgIHRleHRSZWdpb25zLnB1c2godGV4dFJlZ2lvbik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRleHRSZWdpb25zO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRnJvbSB0aGUgcmVnaW9ucyB3ZSBjYW4gY29tcHV0ZSB0aGUgYmxvY2tzIGlmIHRoZSBSZWN0IHJvd3MgYXJlbid0IHRoZVxuICAgICAqIHNhbWUuXG4gICAgICpcbiAgICAgKiBUaGUgcmVjdCByb3dzIGFyZSBjb21wdXRlZCBieSBsb29raW5nIGF0IHRoZSB0b3AgYW5kIGJvdHRvbSBvZiB0aGUgcm93XG4gICAgICogdG8gc2VlIGlmIHRoZXkgYXJlIGRpZmZlcmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB0ZXh0UmVnaW9ucyB7QXJyYXk8VGV4dFJlZ2lvbj59XG4gICAgICogQHJldHVybiB7QXJyYXk8VGV4dEJsb2NrPn1cbiAgICAgKi9cbiAgICBzdGF0aWMgY29tcHV0ZVRleHRCbG9ja3ModGV4dFJlZ2lvbnM6IFJlYWRvbmx5QXJyYXk8VGV4dFJlZ2lvbj4pIHtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQHR5cGUge0FycmF5PFRleHRCbG9jaz59XG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCB0ZXh0QmxvY2tzOiBhbnlbXSA9IFtdO1xuXG4gICAgICAgIHRleHRSZWdpb25zLmZvckVhY2godGV4dFJlZ2lvbiA9PiB7XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQHR5cGUge1RleHRCbG9ja31cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgbGV0IHRleHRCbG9jayA9IG5ldyBUZXh0QmxvY2soKTtcblxuICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB0aGUgcHJldmlvdXMgKHZpc2libGUpIHJlY3QgdGhhdCB3ZSd2ZSBzZWVuIHNvIHRoYXRcbiAgICAgICAgICAgIC8vIHdlIGNhbiBjb21wYXJlIG91ciBwb3NpdGlvbi5cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAdHlwZSB7RE9NUmVjdH1cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgbGV0IHByZXZSZWN0OiBhbnkgPSBudWxsO1xuXG4gICAgICAgICAgICBjcmVhdGVTaWJsaW5ncyh0ZXh0UmVnaW9uLmdldFRleHROb2RlcygpKS5mb3JFYWNoKHBvc2l0aW9uID0+IHtcblxuICAgICAgICAgICAgICAgIC8vICoqKiBoYW5kbGUgbWlkZGxlIG5vZGVzXG5cbiAgICAgICAgICAgICAgICBsZXQgY3VyclJlY3QgPSBUZXh0Tm9kZXMuZ2V0UmFuZ2UocG9zaXRpb24uY3VycikuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cbiAgICAgICAgICAgICAgICBpZihSZWN0cy5pc1Zpc2libGUoY3VyclJlY3QpKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYocHJldlJlY3QgIT0gbnVsbCkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBoYXZlIHNlZW4gYXQgbGVhc3Qgb25lIHJlY3QgYmVmb3JlIHNvIHdlIGNhbiBjb21wYXJlIHRoZW0gbm93LlxuXG4gICAgICAgICAgICAgICAgICAgICAgIGlmKFRleHROb2RlUm93cy5jb21wdXRlUm93S2V5KHByZXZSZWN0KSAhPT0gVGV4dE5vZGVSb3dzLmNvbXB1dGVSb3dLZXkoY3VyclJlY3QpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSdyZSBpbiBhIG5ldyBibG9jayBub3cgYXMgd2UndmUganVtcGVkIHRvIGEgbmV3IHZpc3VhbCByb3cuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0QmxvY2tzLnB1c2godGV4dEJsb2NrKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRCbG9jayA9IG5ldyBUZXh0QmxvY2soKTtcbiAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBzaW5jZSB0aGUgY3VycmVudCByZWN0IGlzIHZpc2libGUgd2UgY2FuIHVwZGF0ZSB0aGVcbiAgICAgICAgICAgICAgICAgICAgLy8gcHJldlJlY3QgdG8gYXZvaWQgXFxuIFxcciBpc3N1ZXMgd2hpY2ggaGF2ZSB6ZXJvIHdpZHRoLlxuICAgICAgICAgICAgICAgICAgICBwcmV2UmVjdCA9IGN1cnJSZWN0O1xuXG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICB0ZXh0QmxvY2sucHVzaChwb3NpdGlvbi5jdXJyKTtcblxuICAgICAgICAgICAgICAgIC8vICoqKiBoYW5kbGUgdGhlIGxhc3Qgbm9kZVxuXG4gICAgICAgICAgICAgICAgaWYocG9zaXRpb24ubmV4dCA9PT0gbnVsbCAmJiB0ZXh0QmxvY2subGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBkb24ndCBkcm9wIHRoZSBsYXN0IGJsb2NrXG4gICAgICAgICAgICAgICAgICAgIHRleHRCbG9ja3MucHVzaCh0ZXh0QmxvY2spO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRleHRCbG9ja3M7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqXG4gICAgICogQHBhcmFtIHRleHRCbG9ja3Mge0FycmF5PFRleHRCbG9jaz59XG4gICAgICogQHJldHVybiB7QXJyYXk8TWVyZ2VkVGV4dEJsb2NrPn1cbiAgICAgKi9cbiAgICBzdGF0aWMgbWVyZ2VUZXh0QmxvY2tzKHRleHRCbG9ja3M6IFJlYWRvbmx5QXJyYXk8VGV4dEJsb2NrPik6IFJlYWRvbmx5QXJyYXk8TWVyZ2VkVGV4dEJsb2NrPiB7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqIEB0eXBlIHtBcnJheTxNZXJnZWRUZXh0QmxvY2s+fVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgcmVzdWx0OiBNZXJnZWRUZXh0QmxvY2tbXSA9IFtdO1xuXG4gICAgICAgIHRleHRCbG9ja3MuZm9yRWFjaCh0ZXh0QmxvY2sgPT4ge1xuXG4gICAgICAgICAgICBsZXQgdGV4dE5vZGVzID0gdGV4dEJsb2NrLmdldFRleHROb2RlcygpLnNsaWNlKCk7XG5cbiAgICAgICAgICAgIGxldCB0ZXh0ID0gdGV4dEJsb2NrLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgICAgIC8vIHRoZSBmaXJzdCBub2RlIHNob3VsZCBnZXQgdGhlIHRleHQgdmFsdWUuXG5cbiAgICAgICAgICAgIGxldCB0ZXh0Tm9kZSA9IHRleHROb2Rlcy5wb3AoKTtcbiAgICAgICAgICAgIHRleHROb2RlLnRleHRDb250ZW50ID0gdGV4dDtcblxuICAgICAgICAgICAgLy8gbm93IHJlbW92ZSB0aGUgcmVtYWluaW5nIG5vZGVzIGZyb20gdGhlIERPTS5cbiAgICAgICAgICAgIHRleHROb2Rlcy5mb3JFYWNoKG9ycGhhbmVkTm9kZSA9PiB7XG4gICAgICAgICAgICAgICAgb3JwaGFuZWROb2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQob3JwaGFuZWROb2RlKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXN1bHQucHVzaChuZXcgTWVyZ2VkVGV4dEJsb2NrKHtcbiAgICAgICAgICAgICAgICB0ZXh0Tm9kZSxcbiAgICAgICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgICAgIHJlY3Q6IFRleHROb2Rlcy5nZXRSYW5nZSh0ZXh0Tm9kZSkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcmVjdCB7RE9NUmVjdH1cbiAgICAgKiBAcmV0dXJuIHtzdHJpbmd9XG4gICAgICovXG4gICAgc3RhdGljIGNvbXB1dGVSb3dLZXkocmVjdDogRE9NUmVjdCB8IENsaWVudFJlY3QpIHtcbiAgICAgICAgcmV0dXJuIGAke3JlY3QudG9wfToke3JlY3QuYm90dG9tfWA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3BsaXQgdGhlIGdpdmVuIHRleHQgbm9kZSBzbyB0aGF0IGV2ZXJ5IGNoYXJhY3RlciBoYXMgaXRzIG93biB0ZXh0XG4gICAgICogbm9kZSBzbyB0aGF0IHdlIGNhbiBzZWUgdGhlIGFjdHVhbCBwb3NpdGlvbiBvbiB0aGUgc2NyZWVuLlxuICAgICAqXG4gICAgICogQHJldHVybiB7Tm9kZUFycmF5fSBUaGUgbnVtYmVyIG9mIHNwbGl0cyB3ZSBwZXJmb3JtZWQuXG4gICAgICovXG4gICAgc3RhdGljIHNwbGl0VGV4dE5vZGVQZXJDaGFyYWN0ZXIodGV4dE5vZGU6IGFueSkge1xuXG4gICAgICAgIGxldCByZXN1bHQgPSBbXG5cbiAgICAgICAgXTtcblxuICAgICAgICB3aGlsZSh0ZXh0Tm9kZS50ZXh0Q29udGVudC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaCh0ZXh0Tm9kZSk7XG4gICAgICAgICAgICB0ZXh0Tm9kZSA9IHRleHROb2RlLnNwbGl0VGV4dCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc3VsdC5wdXNoKHRleHROb2RlKTtcblxuICAgICAgICByZXR1cm4gbmV3IE5vZGVBcnJheShyZXN1bHQpO1xuXG4gICAgfVxuXG59XG5cbiJdfQ==