"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Reactor_1 = require("./Reactor");
const Preconditions_1 = require("polar-shared/src/Preconditions");
class QueuedReactor {
    constructor(delegate = new Reactor_1.Reactor()) {
        this.queue = {};
        this.delegate = delegate;
    }
    addEventListener(eventName, eventListener) {
        this.delegate.addEventListener(eventName, eventListener);
        if (this.hasEnqueued(eventName)) {
            for (const current of this.clearEnqueued(eventName)) {
                this.delegate.dispatchEvent(eventName, current);
            }
        }
        const release = () => {
            this.removeEventListener(eventName, eventListener);
        };
        return { eventListener, release };
    }
    once(eventName) {
        return new Promise((resolve => {
            const listener = (event) => {
                resolve(event);
                this.removeEventListener(eventName, listener);
            };
            this.addEventListener(eventName, listener);
        }));
    }
    dispatchEvent(eventName, value) {
        if (this.delegate.hasEventListeners(eventName)) {
            this.delegate.dispatchEvent(eventName, value);
        }
        else {
            this.enqueue(eventName, value);
        }
    }
    getEventListeners(eventName) {
        return this.delegate.getEventListeners(eventName);
    }
    hasEventListeners(eventName) {
        return this.delegate.hasEventListeners(eventName);
    }
    registerEvent(eventName) {
        this.delegate.registerEvent(eventName);
        return this;
    }
    hasRegisteredEvent(eventName) {
        return this.delegate.hasRegisteredEvent(eventName);
    }
    clearEvent(eventName) {
        this.delegate.clearEvent(eventName);
    }
    removeEventListener(eventName, listener) {
        return this.delegate.removeEventListener(eventName, listener);
    }
    size(eventName) {
        return this.delegate.size(eventName);
    }
    enqueue(eventName, value) {
        if (!Preconditions_1.isPresent(this.queue[eventName])) {
            this.queue[eventName] = [];
        }
        this.queue[eventName].push(value);
        return this;
    }
    clearEnqueued(eventName) {
        if (Preconditions_1.isPresent(this.queue[eventName])) {
            const data = this.queue[eventName];
            delete this.queue[eventName];
            return data;
        }
        else {
            return [];
        }
    }
    hasEnqueued(eventName) {
        return Preconditions_1.isPresent(this.queue[eventName]) && this.queue[eventName].length > 0;
    }
}
exports.QueuedReactor = QueuedReactor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVldWVkUmVhY3Rvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlF1ZXVlZFJlYWN0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBNkQ7QUFFN0Qsa0VBQXlEO0FBT3pELE1BQWEsYUFBYTtJQU10QixZQUFZLFdBQVcsSUFBSSxpQkFBTyxFQUFLO1FBRnRCLFVBQUssR0FBMEIsRUFBRSxDQUFDO1FBRy9DLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzdCLENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxTQUFpQixFQUFFLGFBQStCO1FBRXRFLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBSXpELElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUU3QixLQUFLLE1BQU0sT0FBTyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUNuRDtTQUVKO1FBRUQsTUFBTSxPQUFPLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDdkQsQ0FBQyxDQUFDO1FBRUYsT0FBTyxFQUFDLGFBQWEsRUFBRSxPQUFPLEVBQUMsQ0FBQztJQUVwQyxDQUFDO0lBR00sSUFBSSxDQUFDLFNBQWlCO1FBRXpCLE9BQU8sSUFBSSxPQUFPLENBQUksQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUU3QixNQUFNLFFBQVEsR0FBRyxDQUFDLEtBQVEsRUFBRSxFQUFFO2dCQUMxQixPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2YsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUM7WUFFRixJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRS9DLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFUixDQUFDO0lBRU0sYUFBYSxDQUFDLFNBQWlCLEVBQUUsS0FBUTtRQUU1QyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFHNUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBRWpEO2FBQU07WUFHSCxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUVsQztJQUVMLENBQUM7SUFFTSxpQkFBaUIsQ0FBQyxTQUFpQjtRQUN0QyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVNLGlCQUFpQixDQUFDLFNBQWlCO1FBQ3RDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRU0sYUFBYSxDQUFDLFNBQWlCO1FBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxTQUFpQjtRQUN2QyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVNLFVBQVUsQ0FBQyxTQUFpQjtRQUMvQixJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRU0sbUJBQW1CLENBQUMsU0FBaUIsRUFBRSxRQUEwQjtRQUNwRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFTSxJQUFJLENBQUMsU0FBaUI7UUFDekIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sT0FBTyxDQUFDLFNBQWlCLEVBQUUsS0FBUTtRQUV2QyxJQUFJLENBQUUseUJBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUU7WUFDcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDOUI7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVsQyxPQUFPLElBQUksQ0FBQztJQUVoQixDQUFDO0lBTU8sYUFBYSxDQUFDLFNBQWlCO1FBRW5DLElBQUkseUJBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUU7WUFFbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNuQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDN0IsT0FBTyxJQUFJLENBQUM7U0FFZjthQUFNO1lBQ0gsT0FBTyxFQUFFLENBQUM7U0FDYjtJQUVMLENBQUM7SUFFTyxXQUFXLENBQUMsU0FBaUI7UUFDakMsT0FBTyx5QkFBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDaEYsQ0FBQztDQUVKO0FBL0hELHNDQStIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SU11dGFibGVSZWFjdG9yLCBJUmVhY3RvciwgUmVhY3Rvcn0gZnJvbSAnLi9SZWFjdG9yJztcbmltcG9ydCB7RXZlbnRMaXN0ZW5lciwgUmVnaXN0ZXJlZEV2ZW50TGlzdGVuZXJ9IGZyb20gJy4vRXZlbnRMaXN0ZW5lcic7XG5pbXBvcnQge2lzUHJlc2VudH0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zJztcblxuLyoqXG4gKiBBIHJlYWN0b3IgdGhhdCBhbGxvd3MgZGlzcGF0Y2hFdmVudHMgdG8gYmUgcXVldWUnZCB1cCB1bnRpbCB0aGUgZmlyc3RcbiAqIGxpc3RlbmVyIGlzIGFkZGVkIGZvciBhbiBldmVudCBhdCB3aGljaCBwb2ludCB0aGUgZXhpc3RpbmcgdmFsdWVzIGFyZVxuICogZHJhaW5lZC5cbiAqL1xuZXhwb3J0IGNsYXNzIFF1ZXVlZFJlYWN0b3I8Vj4gaW1wbGVtZW50cyBJUmVhY3RvcjxWPiwgSU11dGFibGVSZWFjdG9yPFY+IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVsZWdhdGU6IFJlYWN0b3I8Vj47XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHF1ZXVlOiB7W25hbWU6IHN0cmluZ106IFZbXX0gPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKGRlbGVnYXRlID0gbmV3IFJlYWN0b3I8Vj4oKSkge1xuICAgICAgICB0aGlzLmRlbGVnYXRlID0gZGVsZWdhdGU7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lOiBzdHJpbmcsIGV2ZW50TGlzdGVuZXI6IEV2ZW50TGlzdGVuZXI8Vj4pOiBSZWdpc3RlcmVkRXZlbnRMaXN0ZW5lcjxWPiB7XG5cbiAgICAgICAgdGhpcy5kZWxlZ2F0ZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZXZlbnRMaXN0ZW5lcik7XG5cbiAgICAgICAgLy8gbm93IGNhbGwgYWxsIHRoZSBldmVudHMgb24gdGhlIGRlbGVnYXRlIGRpcmVjdGx5LlxuXG4gICAgICAgIGlmICh0aGlzLmhhc0VucXVldWVkKGV2ZW50TmFtZSkpIHtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBjdXJyZW50IG9mIHRoaXMuY2xlYXJFbnF1ZXVlZChldmVudE5hbWUpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZS5kaXNwYXRjaEV2ZW50KGV2ZW50TmFtZSwgY3VycmVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlbGVhc2UgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBldmVudExpc3RlbmVyKTtcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4ge2V2ZW50TGlzdGVuZXIsIHJlbGVhc2V9O1xuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgb25jZShldmVudE5hbWU6IHN0cmluZyk6IFByb21pc2U8Vj4ge1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxWPigocmVzb2x2ZSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGxpc3RlbmVyID0gKGV2ZW50OiBWKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShldmVudCk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgbGlzdGVuZXIpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgbGlzdGVuZXIpO1xuXG4gICAgICAgIH0pKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBkaXNwYXRjaEV2ZW50KGV2ZW50TmFtZTogc3RyaW5nLCB2YWx1ZTogVik6IHZvaWQge1xuXG4gICAgICAgIGlmICh0aGlzLmRlbGVnYXRlLmhhc0V2ZW50TGlzdGVuZXJzKGV2ZW50TmFtZSkpIHtcblxuICAgICAgICAgICAgLy8gd2UgYWxyZWFkeSBoYXZlIGxpc3RlbmVycyBmb3IgdGhpcyBzbyBkaXNwYXRjaCBpdCBkaXJlY3RseVxuICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZS5kaXNwYXRjaEV2ZW50KGV2ZW50TmFtZSwgdmFsdWUpO1xuXG4gICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgIC8vIG5vIGxpc3RlbmVycyB5ZXQgc28gZW5xdWV1ZSBpdCB1bnRpbCB0aGUgZmlyc3QgbGlzdGVuZXIgaXMgcmVhZHkuXG4gICAgICAgICAgICB0aGlzLmVucXVldWUoZXZlbnROYW1lLCB2YWx1ZSk7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIGdldEV2ZW50TGlzdGVuZXJzKGV2ZW50TmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRlbGVnYXRlLmdldEV2ZW50TGlzdGVuZXJzKGV2ZW50TmFtZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGhhc0V2ZW50TGlzdGVuZXJzKGV2ZW50TmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRlbGVnYXRlLmhhc0V2ZW50TGlzdGVuZXJzKGV2ZW50TmFtZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlZ2lzdGVyRXZlbnQoZXZlbnROYW1lOiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5kZWxlZ2F0ZS5yZWdpc3RlckV2ZW50KGV2ZW50TmFtZSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBoYXNSZWdpc3RlcmVkRXZlbnQoZXZlbnROYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGVsZWdhdGUuaGFzUmVnaXN0ZXJlZEV2ZW50KGV2ZW50TmFtZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNsZWFyRXZlbnQoZXZlbnROYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kZWxlZ2F0ZS5jbGVhckV2ZW50KGV2ZW50TmFtZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lOiBzdHJpbmcsIGxpc3RlbmVyOiBFdmVudExpc3RlbmVyPFY+KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRlbGVnYXRlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lcik7XG4gICAgfVxuXG4gICAgcHVibGljIHNpemUoZXZlbnROYW1lOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5kZWxlZ2F0ZS5zaXplKGV2ZW50TmFtZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBlbnF1ZXVlKGV2ZW50TmFtZTogc3RyaW5nLCB2YWx1ZTogVik6IHRoaXMge1xuXG4gICAgICAgIGlmICghIGlzUHJlc2VudCh0aGlzLnF1ZXVlW2V2ZW50TmFtZV0pKSB7XG4gICAgICAgICAgICB0aGlzLnF1ZXVlW2V2ZW50TmFtZV0gPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucXVldWVbZXZlbnROYW1lXS5wdXNoKHZhbHVlKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsZWFyIHRoZSBlbnF1ZXVlZCBxdWV1ZSBmb3IgdGhpcyBldmVudCBuYW1lIGFuZCByZXR1cm4gdGhlIGRhdGEgdGhlcmVcbiAgICAgKiBwcmV2aW91c2x5LlxuICAgICAqL1xuICAgIHByaXZhdGUgY2xlYXJFbnF1ZXVlZChldmVudE5hbWU6IHN0cmluZyk6IFZbXSB7XG5cbiAgICAgICAgaWYgKGlzUHJlc2VudCh0aGlzLnF1ZXVlW2V2ZW50TmFtZV0pKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnF1ZXVlW2V2ZW50TmFtZV07XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5xdWV1ZVtldmVudE5hbWVdO1xuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNFbnF1ZXVlZChldmVudE5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gaXNQcmVzZW50KHRoaXMucXVldWVbZXZlbnROYW1lXSkgJiYgdGhpcy5xdWV1ZVtldmVudE5hbWVdLmxlbmd0aCA+IDA7XG4gICAgfVxuXG59XG4iXX0=