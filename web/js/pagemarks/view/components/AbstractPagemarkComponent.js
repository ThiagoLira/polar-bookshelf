"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Pagemarks_1 = require("../../../metadata/Pagemarks");
const Logger_1 = require("polar-shared/src/logger/Logger");
const Component_1 = require("../../../components/Component");
const DocFormatFactory_1 = require("../../../docformat/DocFormatFactory");
const AnnotationRects_1 = require("../../../metadata/AnnotationRects");
const PagemarkRect_1 = require("../../../metadata/PagemarkRect");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Styles_1 = require("../../../util/Styles");
const Optional_1 = require("polar-shared/src/util/ts/Optional");
const Rects_1 = require("../../../Rects");
const BoxController_1 = require("../../../boxes/controller/BoxController");
const PagemarkMode_1 = require("polar-shared/src/metadata/PagemarkMode");
const DocMetas_1 = require("../../../metadata/DocMetas");
const Preconditions_2 = require("polar-shared/src/Preconditions");
const log = Logger_1.Logger.create();
const ENABLE_BOX_CONTROLLER = true;
class AbstractPagemarkComponent extends Component_1.Component {
    constructor(type) {
        super();
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
        this.type = type;
        this.options = {
            templateElement: undefined,
            placementElement: undefined
        };
    }
    init(annotationEvent) {
        this.annotationEvent = annotationEvent;
        this.pagemark = annotationEvent.value;
        this.pagemarkBoxController = new BoxController_1.BoxController((boxMoveEvent) => this.onBoxMoved(boxMoveEvent));
    }
    onBoxMoved(boxMoveEvent) {
        const annotationRect = AnnotationRects_1.AnnotationRects.createFromPositionedRect(boxMoveEvent.boxRect, boxMoveEvent.restrictionRect);
        const rect = new PagemarkRect_1.PagemarkRect(annotationRect);
        if (boxMoveEvent.state === "completed") {
            log.info("Box move completed.  Updating to trigger persistence.");
            const annotationEvent = this.annotationEvent;
            const pageNum = annotationEvent.pageMeta.pageInfo.num;
            const docMeta = annotationEvent.docMeta;
            const pageMeta = DocMetas_1.DocMetas.getPageMeta(docMeta, pageNum);
            this.pagemark = pageMeta.pagemarks[this.pagemark.id];
            const newPagemark = Object.assign({}, this.pagemark);
            newPagemark.percentage = rect.toPercentage();
            newPagemark.rect = rect;
            log.info("New pagemark: ", JSON.stringify(this.pagemark, null, "  "));
            Pagemarks_1.Pagemarks.updatePagemark(annotationEvent.docMeta, pageNum, newPagemark);
            this.pagemark = newPagemark;
        }
        else {
        }
    }
    render() {
        const container = this.annotationEvent.container;
        Preconditions_1.Preconditions.assertPresent(container, "container");
        if (!this.pagemark) {
            throw new Error("Pagemark is required");
        }
        if (!Preconditions_2.isPresent(this.pagemark.percentage)) {
            throw new Error("Pagemark has no percentage");
        }
        let templateElement = this.options.templateElement;
        let placementElement = this.options.placementElement;
        if (!templateElement) {
            templateElement = container.element;
        }
        if (!placementElement) {
            placementElement = container.element.querySelector(".canvasWrapper, .iframeWrapper");
            log.debug("Using a default placementElement from selector: ", placementElement);
        }
        Preconditions_1.Preconditions.assertPresent(templateElement, "templateElement");
        Preconditions_1.Preconditions.assertPresent(placementElement, "placementElement");
        log.info("Using templateElement: ", templateElement);
        log.info("Using placementElement: ", placementElement);
        const id = this.createID();
        let pagemarkElement = document.getElementById(id);
        if (pagemarkElement === null) {
            pagemarkElement = document.createElement("div");
            pagemarkElement.setAttribute("id", id);
            placementElement.parentElement.insertBefore(pagemarkElement, placementElement);
            if (ENABLE_BOX_CONTROLLER) {
                log.info("Creating box controller for pagemarkElement: ", pagemarkElement);
                this.pagemarkBoxController.register({
                    target: pagemarkElement,
                    restrictionElement: placementElement,
                    intersectedElementsSelector: ".pagemark"
                });
            }
        }
        const annotationEvent = this.annotationEvent;
        pagemarkElement.setAttribute("data-pagemark-id", this.pagemark.id);
        pagemarkElement.setAttribute("data-annotation-id", this.pagemark.id);
        pagemarkElement.setAttribute("data-annotation-type", "pagemark");
        pagemarkElement.setAttribute("data-annotation-doc-fingerprint", annotationEvent.docMeta.docInfo.fingerprint);
        pagemarkElement.setAttribute("data-annotation-page-num", `${annotationEvent.pageMeta.pageInfo.num}`);
        pagemarkElement.setAttribute("data-type", "pagemark");
        pagemarkElement.setAttribute("data-doc-fingerprint", annotationEvent.docMeta.docInfo.fingerprint);
        pagemarkElement.setAttribute("data-page-num", `${annotationEvent.pageMeta.pageInfo.num}`);
        pagemarkElement.className = "pagemark annotation";
        const pagemarkColor = this.toPagemarkColor();
        pagemarkElement.style.backgroundColor = pagemarkColor.backgroundColor;
        pagemarkElement.style.opacity = "" + pagemarkColor.opacity;
        pagemarkElement.style.mixBlendMode = 'multiply';
        pagemarkElement.style.position = "absolute";
        const placementRect = this.createPlacementRect(placementElement);
        const pagemarkRect = this.toOverlayRect(placementRect, this.pagemark);
        if (this.type === 'primary') {
            if (pagemarkElement.children.length === 0) {
                this.createInternalDiv(pagemarkElement);
            }
        }
        pagemarkElement.style.left = `${pagemarkRect.left}px`;
        pagemarkElement.style.top = `${pagemarkRect.top}px`;
        pagemarkElement.style.width = `${pagemarkRect.width}px`;
        pagemarkElement.style.height = `${pagemarkRect.height}px`;
        pagemarkElement.style.zIndex = '9';
        pagemarkElement.style.pointerEvents = 'none';
    }
    createInternalDiv(pagemarkElement) {
        const createInternalDiv = () => {
            const internalDiv = document.createElement('div');
            internalDiv.style.pointerEvents = 'auto';
            internalDiv.style.position = 'absolute';
            return internalDiv;
        };
        const createHorizontalInternalDiv = () => {
            const internalDiv = createInternalDiv();
            internalDiv.style.width = '100%';
            internalDiv.style.height = '2mm';
            return internalDiv;
        };
        const createVerticalInternalDiv = () => {
            const internalDiv = createInternalDiv();
            internalDiv.style.width = '2mm';
            internalDiv.style.height = '100%';
            return internalDiv;
        };
        const createInternalDivs = () => {
            const left = createVerticalInternalDiv();
            left.style.left = '0';
            left.style.top = '0';
            const right = createVerticalInternalDiv();
            right.style.right = '0';
            right.style.top = '0';
            const top = createHorizontalInternalDiv();
            top.style.left = '0';
            top.style.top = '0';
            const bottom = createHorizontalInternalDiv();
            bottom.style.bottom = '0';
            bottom.style.left = '0';
            return [left, right, top, bottom];
        };
        const internalDivs = createInternalDivs();
        let pointerEvents = 'auto';
        const doChangePointerEvents = (newValue) => {
            if (pointerEvents !== newValue) {
                pagemarkElement.style.pointerEvents = newValue;
                pointerEvents = newValue;
            }
        };
        for (const internalDiv of internalDivs) {
            internalDiv.addEventListener('mouseenter', (event) => {
                doChangePointerEvents('auto');
                event.preventDefault();
            });
            internalDiv.addEventListener('mouseleave', (event) => {
                doChangePointerEvents('none');
                event.preventDefault();
            });
            pagemarkElement.appendChild(internalDiv);
        }
    }
    toPagemarkColor() {
        class PagemarkColors {
        }
        PagemarkColors.BLUE = {
            backgroundColor: "#00CCFF",
            opacity: 0.3
        };
        PagemarkColors.LIGHTBLUE = {
            backgroundColor: "#00CCFF",
            opacity: 0.15
        };
        PagemarkColors.GREY = {
            backgroundColor: "rgb(125, 125, 125)",
            opacity: 0.3
        };
        if (!this.pagemark) {
            return PagemarkColors.BLUE;
        }
        if (!this.pagemark.mode) {
            return PagemarkColors.BLUE;
        }
        switch (this.pagemark.mode) {
            case PagemarkMode_1.PagemarkMode.IGNORED:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.TABLE_OF_CONTENTS:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.APPENDIX:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.REFERENCES:
                return PagemarkColors.GREY;
            case PagemarkMode_1.PagemarkMode.PRE_READ:
                return PagemarkColors.LIGHTBLUE;
            default:
                return PagemarkColors.BLUE;
        }
    }
    destroy() {
        const pagemarkElement = document.getElementById(this.createID());
        if (pagemarkElement) {
            pagemarkElement.innerHTML = '';
            if (pagemarkElement.parentElement) {
                pagemarkElement.parentElement.removeChild(pagemarkElement);
            }
        }
    }
    createPlacementRect(placementElement) {
        const positioning = Styles_1.Styles.positioning(placementElement);
        const positioningPX = Styles_1.Styles.positioningToPX(positioning);
        const result = {
            left: Optional_1.Optional.of(positioningPX.left).getOrElse(placementElement.offsetLeft),
            top: Optional_1.Optional.of(positioningPX.top).getOrElse(placementElement.offsetTop),
            width: Optional_1.Optional.of(positioningPX.width).getOrElse(placementElement.offsetWidth),
            height: Optional_1.Optional.of(positioningPX.height).getOrElse(placementElement.offsetHeight),
        };
        return Rects_1.Rects.createFromBasicRect(result);
    }
    createID() {
        return `${this.type}-pagemark-${this.pagemark.id}`;
    }
    toOverlayRect(placementRect, pagemark) {
        const pagemarkRect = new PagemarkRect_1.PagemarkRect(pagemark.rect);
        const overlayRect = pagemarkRect.toDimensions(placementRect.dimensions);
        return Rects_1.Rects.createFromBasicRect({
            left: overlayRect.left + placementRect.left,
            top: overlayRect.top + placementRect.top,
            width: overlayRect.width,
            height: overlayRect.height,
        });
    }
}
exports.AbstractPagemarkComponent = AbstractPagemarkComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWJzdHJhY3RQYWdlbWFya0NvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFic3RyYWN0UGFnZW1hcmtDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyREFBc0Q7QUFDdEQsMkRBQXNEO0FBQ3RELDZEQUF3RDtBQUN4RCwwRUFBcUU7QUFJckUsdUVBQWtFO0FBQ2xFLGlFQUE0RDtBQUM1RCxrRUFBNkQ7QUFDN0QsaURBQTRDO0FBQzVDLGdFQUEyRDtBQUMzRCwwQ0FBcUM7QUFFckMsMkVBQXNFO0FBQ3RFLHlFQUFvRTtBQUNwRSx5REFBb0Q7QUFDcEQsa0VBQXlEO0FBSXpELE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQztBQUVuQyxNQUFhLHlCQUEwQixTQUFRLHFCQUFTO0lBaUJwRCxZQUFZLElBQTJCO1FBQ25DLEtBQUssRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLFNBQVMsR0FBRyxtQ0FBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVoRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUVqQixJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ1gsZUFBZSxFQUFFLFNBQVM7WUFDMUIsZ0JBQWdCLEVBQUUsU0FBUztTQUM5QixDQUFDO0lBRU4sQ0FBQztJQUtNLElBQUksQ0FBQyxlQUFnQztRQUV4QyxJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsUUFBUSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUM7UUFFdEMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksNkJBQWEsQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBRXBHLENBQUM7SUFNTSxVQUFVLENBQUMsWUFBMEI7UUFFeEMsTUFBTSxjQUFj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V0FBVyxDQUFDO1lBQy9FLE1BQU0sRUFBRSxtQkFBUSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQztTQUNyRixDQUFDO1FBRUYsT0FBTyxhQUFLLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFN0MsQ0FBQztJQUtPLFFBQVE7UUFDWixPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksYUFBYSxJQUFJLENBQUMsUUFBUyxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQ3hELENBQUM7SUFLTyxhQUFhLENBQUMsYUFBbUIsRUFBRSxRQUE4QjtRQUVyRSxNQUFNLFlBQVksR0FBRyxJQUFJLDJCQUFZLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXJELE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBSXhFLE9BQU8sYUFBSyxDQUFDLG1CQUFtQixDQUFDO1lBQzdCLElBQUksRUFBRSxXQUFXLENBQUMsSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJO1lBQzNDLEdBQUcsRUFBRSxXQUFXLENBQUMsR0FBRyxHQUFHLGFBQWEsQ0FBQyxHQUFHO1lBQ3hDLEtBQUssRUFBRSxXQUFXLENBQUMsS0FBSztZQUN4QixNQUFNLEVBQUUsV0FBVyxDQUFDLE1BQU07U0FDN0IsQ0FBQyxDQUFDO0lBRVAsQ0FBQztDQUVKO0FBdmJELDhEQXViQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UGFnZW1hcmtzfSBmcm9tIFwiLi4vLi4vLi4vbWV0YWRhdGEvUGFnZW1hcmtzXCI7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7Q29tcG9uZW50fSBmcm9tICcuLi8uLi8uLi9jb21wb25lbnRzL0NvbXBvbmVudCc7XG5pbXBvcnQge0RvY0Zvcm1hdEZhY3Rvcnl9IGZyb20gJy4uLy4uLy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXRGYWN0b3J5JztcbmltcG9ydCB7RG9jRm9ybWF0fSBmcm9tICcuLi8uLi8uLi9kb2Nmb3JtYXQvRG9jRm9ybWF0JztcbmltcG9ydCB7QW5ub3RhdGlvbkV2ZW50fSBmcm9tICcuLi8uLi8uLi9hbm5vdGF0aW9ucy9jb21wb25lbnRzL0Fubm90YXRpb25FdmVudCc7XG5pbXBvcnQge1BhZ2VtYXJrfSBmcm9tICcuLi8uLi8uLi9tZXRhZGF0YS9QYWdlbWFyayc7XG5pbXBvcnQge0Fubm90YXRpb25SZWN0c30gZnJvbSAnLi4vLi4vLi4vbWV0YWRhdGEvQW5ub3RhdGlvblJlY3RzJztcbmltcG9ydCB7UGFnZW1hcmtSZWN0fSBmcm9tICcuLi8uLi8uLi9tZXRhZGF0YS9QYWdlbWFya1JlY3QnO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtTdHlsZXN9IGZyb20gJy4uLy4uLy4uL3V0aWwvU3R5bGVzJztcbmltcG9ydCB7T3B0aW9uYWx9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC90cy9PcHRpb25hbCc7XG5pbXBvcnQge1JlY3RzfSBmcm9tICcuLi8uLi8uLi9SZWN0cyc7XG5pbXBvcnQge1JlY3R9IGZyb20gJy4uLy4uLy4uL1JlY3QnO1xuaW1wb3J0IHtCb3hDb250cm9sbGVyfSBmcm9tIFwiLi4vLi4vLi4vYm94ZXMvY29udHJvbGxlci9Cb3hDb250cm9sbGVyXCI7XG5pbXBvcnQge1BhZ2VtYXJrTW9kZX0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9QYWdlbWFya01vZGUnO1xuaW1wb3J0IHtEb2NNZXRhc30gZnJvbSBcIi4uLy4uLy4uL21ldGFkYXRhL0RvY01ldGFzXCI7XG5pbXBvcnQge2lzUHJlc2VudH0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7SVBhZ2VtYXJrfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JUGFnZW1hcmtcIjtcbmltcG9ydCB7Qm94TW92ZUV2ZW50fSBmcm9tIFwiLi4vLi4vLi4vYm94ZXMvY29udHJvbGxlci9Cb3hNb3ZlRXZlbnRcIjtcblxuY29uc3QgbG9nID0gTG9nZ2VyLmNyZWF0ZSgpO1xuXG5jb25zdCBFTkFCTEVfQk9YX0NPTlRST0xMRVIgPSB0cnVlO1xuXG5leHBvcnQgY2xhc3MgQWJzdHJhY3RQYWdlbWFya0NvbXBvbmVudCBleHRlbmRzIENvbXBvbmVudCB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgdHlwZSBvZiB0aGUgcGFnZW1hcmsgKHByaW1hcnkgb3IgdGh1bWJuYWlsKVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdHlwZTogUGFnZW1hcmtDb21wb25lbnRUeXBlO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBkb2NGb3JtYXQ6IERvY0Zvcm1hdDtcblxuICAgIHByaXZhdGUgcGFnZW1hcms/OiBJUGFnZW1hcms7XG5cbiAgICBwcml2YXRlIGFubm90YXRpb25FdmVudD86IEFubm90YXRpb25FdmVudDtcblxuICAgIHByaXZhdGUgcGFnZW1hcmtCb3hDb250cm9sbGVyOiBCb3hDb250cm9sbGVyIHwgdW5kZWZpbmVkO1xuXG4gICAgcHJvdGVjdGVkIG9wdGlvbnM6IEVsZW1lbnRPcHRpb25zO1xuXG4gICAgY29uc3RydWN0b3IodHlwZTogUGFnZW1hcmtDb21wb25lbnRUeXBlKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5kb2NGb3JtYXQgPSBEb2NGb3JtYXRGYWN0b3J5LmdldEluc3RhbmNlKCk7XG5cbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcblxuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICAgICAgICB0ZW1wbGF0ZUVsZW1lbnQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHBsYWNlbWVudEVsZW1lbnQ6IHVuZGVmaW5lZFxuICAgICAgICB9O1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQE92ZXJyaWRlXG4gICAgICovXG4gICAgcHVibGljIGluaXQoYW5ub3RhdGlvbkV2ZW50OiBBbm5vdGF0aW9uRXZlbnQpIHtcblxuICAgICAgICB0aGlzLmFubm90YXRpb25FdmVudCA9IGFubm90YXRpb25FdmVudDtcbiAgICAgICAgdGhpcy5wYWdlbWFyayA9IGFubm90YXRpb25FdmVudC52YWx1ZTtcblxuICAgICAgICB0aGlzLnBhZ2VtYXJrQm94Q29udHJvbGxlciA9IG5ldyBCb3hDb250cm9sbGVyKChib3hNb3ZlRXZlbnQpID0+IHRoaXMub25Cb3hNb3ZlZChib3hNb3ZlRXZlbnQpKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGJveE1vdmVFdmVudCB7Qm94TW92ZUV2ZW50fVxuICAgICAqL1xuICAgIHB1YmxpYyBvbkJveE1vdmVkKGJveE1vdmVFdmVudDogQm94TW92ZUV2ZW50KSB7XG5cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvblJlY3QgPSBBbm5vdGF0aW9uUmVjdHMuY3JlYXRlRnJvbVBvc2l0aW9uZWRSZWN0KGJveE1vdmVFdmVudC5ib3hSZWN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm94TW92ZUV2ZW50LnJlc3RyaWN0aW9uUmVjdCk7XG5cbiAgICAgICAgY29uc3QgcmVjdCA9IG5ldyBQYWdlbWFya1JlY3QoYW5ub3RhdGlvblJlY3QpO1xuXG4gICAgICAgIGlmIChib3hNb3ZlRXZlbnQuc3RhdGUgPT09IFwiY29tcGxldGVkXCIpIHtcblxuICAgICAgICAgICAgbG9nLmluZm8oXCJCb3ggbW92ZSBjb21wbGV0ZWQuICBVcGRhdGluZyB0byB0cmlnZ2VyIHBlcnNpc3RlbmNlLlwiKTtcblxuICAgICAgICAgICAgY29uc3QgYW5ub3RhdGlvbkV2ZW50ID0gdGhpcy5hbm5vdGF0aW9uRXZlbnQhO1xuICAgICAgICAgICAgY29uc3QgcGFnZU51bSA9IGFubm90YXRpb25FdmVudC5wYWdlTWV0YS5wYWdlSW5mby5udW07XG4gICAgICAgICAgICBjb25zdCBkb2NNZXRhID0gYW5ub3RhdGlvbkV2ZW50LmRvY01ldGE7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhZ2VNZXRhID0gRG9jTWV0YXMuZ2V0UGFnZU1ldGEoZG9jTWV0YSwgcGFnZU51bSk7XG5cbiAgICAgICAgICAgIC8vIHJlLXJlYWQgdGhlIGN1cnJlbnQgcGFnZW1hcmsgZnJvbSB0aGUgbW9kZWxcbiAgICAgICAgICAgIHRoaXMucGFnZW1hcmsgPSBwYWdlTWV0YS5wYWdlbWFya3NbdGhpcy5wYWdlbWFyayEuaWRdO1xuXG4gICAgICAgICAgICBjb25zdCBuZXdQYWdlbWFyayA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMucGFnZW1hcmspO1xuICAgICAgICAgICAgbmV3UGFnZW1hcmsucGVyY2VudGFnZSA9IHJlY3QudG9QZXJjZW50YWdlKCk7XG4gICAgICAgICAgICBuZXdQYWdlbWFyay5yZWN0ID0gcmVjdDtcblxuICAgICAgICAgICAgbG9nLmluZm8oXCJOZXcgcGFnZW1hcms6IFwiLCBKU09OLnN0cmluZ2lmeSh0aGlzLnBhZ2VtYXJrLCBudWxsLCBcIiAgXCIpKTtcbiAgICAgICAgICAgIFBhZ2VtYXJrcy51cGRhdGVQYWdlbWFyayhhbm5vdGF0aW9uRXZlbnQuZG9jTWV0YSwgcGFnZU51bSwgbmV3UGFnZW1hcmspO1xuXG4gICAgICAgICAgICB0aGlzLnBhZ2VtYXJrID0gbmV3UGFnZW1hcms7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiTmV3IHBhZ2VtYXJrOiBcIiwgSlNPTi5zdHJpbmdpZnkodGhpcy5wYWdlbWFyaywgbnVsbCwgXCIgIFwiKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIk5ldyBwYWdlbWFya1JlY3Q6IFwiLCB0aGlzLnBhZ2VtYXJrIS5yZWN0KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBPdmVycmlkZVxuICAgICAqXG4gICAgICovXG4gICAgcHVibGljIHJlbmRlcigpIHtcblxuICAgICAgICAvLyBUT0RPOiBwbGFjZW1lbkVsZW1lbnQgc2hvdWxkIGJlIGNhbGxlZCBjb250YWluZXJFbGVtZW50XG5cbiAgICAgICAgLy8gVE9ETzogd2Ugc2hvdWxkIGhhdmUgcGFnZW1hcmtSZWN0IGFuZCBwb3NpdGlvbmVkUGFnZW1hcmtSZWN0IHRvb1xuXG4gICAgICAgIC8vIFRPRE86IHNlZSBvZiB0ZW1wbGF0ZUVsZW1lbnQgYW5kIHBsYWNlbWVudEVsZW1lbnQgYXJlIGFsd2F5cyB0aGVcbiAgICAgICAgLy8gICAgICAgc2FtZSBub3cuICBUaGV5IG1pZ2h0IGJlLlxuXG4gICAgICAgIC8vXG4gICAgICAgIC8vIC0gdGhlIG9wdGlvbnMgYnVpbGRpbmcgY2FuJ3QgYmUgcmVsaWFibHkgdGVzdGVkXG4gICAgICAgIC8vXG4gICAgICAgIC8vIC0gdGhlcmUgYXJlIHRvbyBtYW55IHdheXMgdG8gY29tcHV0ZSB0aGUgb3B0aW9uc1xuICAgICAgICAvL1xuICAgICAgICAvLyAtIHdlIFBMQUNFIHRoZSBlbGVtZW50IGFzIHBhcnQgb2YgdGhpcyBmdW5jdGlvbi4gIEhhdmUgYSBzZWNvbmRhcnlcbiAgICAgICAgLy8gICB3YXkgdG8ganVzdCBDUkVBVEUgdGhlIGVsZW1lbnQgc28gdGhhdCB3ZSBjYW4gdGVzdCB0aGUgc2V0dGluZ3NcbiAgICAgICAgLy8gICBwcm9wZXJseS5cblxuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmFubm90YXRpb25FdmVudCEuY29udGFpbmVyO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydFByZXNlbnQoY29udGFpbmVyLCBcImNvbnRhaW5lclwiKTtcblxuICAgICAgICBpZiAoIXRoaXMucGFnZW1hcmspIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhZ2VtYXJrIGlzIHJlcXVpcmVkXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFpc1ByZXNlbnQodGhpcy5wYWdlbWFyay5wZXJjZW50YWdlKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGFnZW1hcmsgaGFzIG5vIHBlcmNlbnRhZ2VcIik7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdGVtcGxhdGVFbGVtZW50ID0gdGhpcy5vcHRpb25zLnRlbXBsYXRlRWxlbWVudDtcblxuICAgICAgICBsZXQgcGxhY2VtZW50RWxlbWVudCA9IHRoaXMub3B0aW9ucy5wbGFjZW1lbnRFbGVtZW50O1xuXG4gICAgICAgIGlmICghdGVtcGxhdGVFbGVtZW50KSB7XG4gICAgICAgICAgICB0ZW1wbGF0ZUVsZW1lbnQgPSBjb250YWluZXIuZWxlbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIHBsYWNlbWVudEVsZW1lbnQpIHtcbiAgICAgICAgICAgIC8vIFRPRE86IG1vdmUgdGhpcyB0byB0aGUgcHJvcGVyIGNvbXBvbmVudFxuICAgICAgICAgICAgcGxhY2VtZW50RWxlbWVudCA9IDxIVE1MRWxlbWVudD4gY29udGFpbmVyLmVsZW1lbnQucXVlcnlTZWxlY3RvcihcIi5jYW52YXNXcmFwcGVyLCAuaWZyYW1lV3JhcHBlclwiKTtcbiAgICAgICAgICAgIC8vIFRPRE86IHdlIG5lZWQgdG8gY29kZSB0aGlzIGRpcmVjdGx5IGludG8gdGhlIGNhbGxlclxuICAgICAgICAgICAgbG9nLmRlYnVnKFwiVXNpbmcgYSBkZWZhdWx0IHBsYWNlbWVudEVsZW1lbnQgZnJvbSBzZWxlY3RvcjogXCIsIHBsYWNlbWVudEVsZW1lbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KHRlbXBsYXRlRWxlbWVudCwgXCJ0ZW1wbGF0ZUVsZW1lbnRcIik7XG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0UHJlc2VudChwbGFjZW1lbnRFbGVtZW50LCBcInBsYWNlbWVudEVsZW1lbnRcIik7XG5cbiAgICAgICAgbG9nLmluZm8oXCJVc2luZyB0ZW1wbGF0ZUVsZW1lbnQ6IFwiLCB0ZW1wbGF0ZUVsZW1lbnQpO1xuICAgICAgICBsb2cuaW5mbyhcIlVzaW5nIHBsYWNlbWVudEVsZW1lbnQ6IFwiLCBwbGFjZW1lbnRFbGVtZW50KTtcblxuICAgICAgICAvLyBhIHVuaXF1ZSBJRCBpbiB0aGUgRE9NIGZvciB0aGlzIGVsZW1lbnQuXG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5jcmVhdGVJRCgpO1xuXG4gICAgICAgIGxldCBwYWdlbWFya0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7XG5cbiAgICAgICAgaWYgKHBhZ2VtYXJrRWxlbWVudCA9PT0gbnVsbCApIHtcblxuICAgICAgICAgICAgLy8gVE9ETzogSSBkb24ndCBsaWtlIGRvaW5nIGFueSB0eXBlIG9mIGluaXQgaGVyZS4uLiBpdCdzIHVnbHkuLi5cblxuICAgICAgICAgICAgLy8gb25seSBjcmVhdGUgdGhlIHBhZ2VtYXJrIGlmIGl0J3MgbWlzc2luZy5cbiAgICAgICAgICAgIHBhZ2VtYXJrRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgICAgICBwYWdlbWFya0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiaWRcIiwgaWQpO1xuXG4gICAgICAgICAgICBwbGFjZW1lbnRFbGVtZW50LnBhcmVudEVsZW1lbnQhLmluc2VydEJlZm9yZShwYWdlbWFya0VsZW1lbnQsIHBsYWNlbWVudEVsZW1lbnQpO1xuXG4gICAgICAgICAgICBpZiAoRU5BQkxFX0JPWF9DT05UUk9MTEVSKSB7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJDcmVhdGluZyBib3ggY29udHJvbGxlciBmb3IgcGFnZW1hcmtFbGVtZW50OiBcIiwgcGFnZW1hcmtFbGVtZW50KTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhZ2VtYXJrQm94Q29udHJvbGxlciEucmVnaXN0ZXIoe1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IHBhZ2VtYXJrRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgcmVzdHJpY3Rpb25FbGVtZW50OiBwbGFjZW1lbnRFbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3RlZEVsZW1lbnRzU2VsZWN0b3I6IFwiLnBhZ2VtYXJrXCJcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvbkV2ZW50ID0gdGhpcy5hbm5vdGF0aW9uRXZlbnQhO1xuXG4gICAgICAgIC8vIHNldCBhIHBhZ2VtYXJrLWlkIGluIHRoZSBET00gc28gdGhhdCB3ZSBjYW4gd29yayB3aXRoIGl0IHdoZW4gd2UgdXNlXG4gICAgICAgIC8vIHRoZSBjb250ZXh0IG1lbnUsIGV0Yy5cbiAgICAgICAgLy8gVE9ETzogdGhpcyBpcyBkdXBsaWNhdGVkIGNvZGUgYWNyb3NzIHRocmVlIHBsYWNlcy4uIGFsbCBtYWpvclxuICAgICAgICAvLyBhbm5vdGF0aW9uIGNvbXBvbmVudHMuXG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLXBhZ2VtYXJrLWlkXCIsIHRoaXMucGFnZW1hcmsuaWQpO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hbm5vdGF0aW9uLWlkXCIsIHRoaXMucGFnZW1hcmsuaWQpO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1hbm5vdGF0aW9uLXR5cGVcIiwgXCJwYWdlbWFya1wiKTtcbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtYW5ub3RhdGlvbi1kb2MtZmluZ2VycHJpbnRcIiwgYW5ub3RhdGlvbkV2ZW50LmRvY01ldGEuZG9jSW5mby5maW5nZXJwcmludCk7XG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWFubm90YXRpb24tcGFnZS1udW1cIiwgYCR7YW5ub3RhdGlvbkV2ZW50LnBhZ2VNZXRhLnBhZ2VJbmZvLm51bX1gKTtcblxuXG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLXR5cGVcIiwgXCJwYWdlbWFya1wiKTtcbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnNldEF0dHJpYnV0ZShcImRhdGEtZG9jLWZpbmdlcnByaW50XCIsIGFubm90YXRpb25FdmVudC5kb2NNZXRhLmRvY0luZm8uZmluZ2VycHJpbnQpO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1wYWdlLW51bVwiLCBgJHthbm5vdGF0aW9uRXZlbnQucGFnZU1ldGEucGFnZUluZm8ubnVtfWApO1xuXG5cbiAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGhhdmUgYSByZWxpYWJsZSBDU1MgY2xhc3NuYW1lIHRvIHdvcmsgd2l0aC5cbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LmNsYXNzTmFtZSA9IFwicGFnZW1hcmsgYW5ub3RhdGlvblwiO1xuXG4gICAgICAgIC8vIHBhZ2VtYXJrLnN0eWxlLmJhY2tncm91bmRDb2xvcj1cInJnYigxOTgsIDE5OCwgMTk4KVwiO1xuXG4gICAgICAgIGNvbnN0IHBhZ2VtYXJrQ29sb3IgPSB0aGlzLnRvUGFnZW1hcmtDb2xvcigpO1xuXG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBwYWdlbWFya0NvbG9yLmJhY2tncm91bmRDb2xvcjtcbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBcIlwiICsgcGFnZW1hcmtDb2xvci5vcGFjaXR5O1xuXG4gICAgICAgIChwYWdlbWFya0VsZW1lbnQuc3R5bGUgYXMgYW55KS5taXhCbGVuZE1vZGUgPSAnbXVsdGlwbHknO1xuXG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zdHlsZS5wb3NpdGlvbiA9IFwiYWJzb2x1dGVcIjtcblxuICAgICAgICAvLyBUT0RPOiB3ZSBkb24ndCBhY3R1YWxseSBuZWVkIHRoZSBwbGFjZW1lbnQgcmVjdC4uIGp1c3QgdGhlIGRpbWVuc2lvbnNcbiAgICAgICAgLy8gb2YgdGhlIGNvbnRhaW5lci5cbiAgICAgICAgY29uc3QgcGxhY2VtZW50UmVjdCA9IHRoaXMuY3JlYXRlUGxhY2VtZW50UmVjdChwbGFjZW1lbnRFbGVtZW50KTtcbiAgICAgICAgY29uc3QgcGFnZW1hcmtSZWN0ID0gdGhpcy50b092ZXJsYXlSZWN0KHBsYWNlbWVudFJlY3QsIHRoaXMucGFnZW1hcmspO1xuXG4gICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdwcmltYXJ5Jykge1xuXG4gICAgICAgICAgICBpZiAocGFnZW1hcmtFbGVtZW50LmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlSW50ZXJuYWxEaXYocGFnZW1hcmtFbGVtZW50KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgLy8gVE9ETzogd2hhdCBJIG5lZWQgaXMgYSBnZW5lcmljIHdheSB0byBjb3ZlciBhbiBlbGVtZW50IGFuZCBwbGFjZVxuICAgICAgICAvLyBzb21ldGhpbmcgb24gdG9wIG9mIGl0IG5vIG1hdHRlciB3aGF0IHBvc2l0aW9uaW5nIHN0cmF0ZWd5IGl0IHVzZXMuXG5cbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLmxlZnQgPSBgJHtwYWdlbWFya1JlY3QubGVmdH1weGA7XG4gICAgICAgIHBhZ2VtYXJrRWxlbWVudC5zdHlsZS50b3AgPSBgJHtwYWdlbWFya1JlY3QudG9wfXB4YDtcbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLndpZHRoID0gYCR7cGFnZW1hcmtSZWN0LndpZHRofXB4YDtcbiAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke3BhZ2VtYXJrUmVjdC5oZWlnaHR9cHhgO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc3R5bGUuekluZGV4ID0gJzknO1xuICAgICAgICBwYWdlbWFya0VsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJztcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBpbnRlcm5hbCBkaXYgdGhhdCBhbGxvd3MgdXMgdG8gdHVybiBvZmYgcG9pbnRlci1ldmVudHNcbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZUludGVybmFsRGl2KHBhZ2VtYXJrRWxlbWVudDogSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICBjb25zdCBjcmVhdGVJbnRlcm5hbERpdiA9ICgpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgaW50ZXJuYWxEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuICAgICAgICAgICAgLy8gaW50ZXJuYWxEaXYuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJ3BpbmsnO1xuICAgICAgICAgICAgaW50ZXJuYWxEaXYuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdhdXRvJztcbiAgICAgICAgICAgIGludGVybmFsRGl2LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcblxuICAgICAgICAgICAgcmV0dXJuIGludGVybmFsRGl2O1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgY3JlYXRlSG9yaXpvbnRhbEludGVybmFsRGl2ID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBpbnRlcm5hbERpdiA9IGNyZWF0ZUludGVybmFsRGl2KCk7XG5cbiAgICAgICAgICAgIGludGVybmFsRGl2LnN0eWxlLndpZHRoID0gJzEwMCUnO1xuICAgICAgICAgICAgaW50ZXJuYWxEaXYuc3R5bGUuaGVpZ2h0ID0gJzJtbSc7XG5cbiAgICAgICAgICAgIHJldHVybiBpbnRlcm5hbERpdjtcblxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVZlcnRpY2FsSW50ZXJuYWxEaXYgPSAoKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGludGVybmFsRGl2ID0gY3JlYXRlSW50ZXJuYWxEaXYoKTtcblxuICAgICAgICAgICAgaW50ZXJuYWxEaXYuc3R5bGUud2lkdGggPSAnMm1tJztcbiAgICAgICAgICAgIGludGVybmFsRGl2LnN0eWxlLmhlaWdodCA9ICcxMDAlJztcblxuICAgICAgICAgICAgcmV0dXJuIGludGVybmFsRGl2O1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgY3JlYXRlSW50ZXJuYWxEaXZzID0gKCkgPT4ge1xuXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGlzIGNvdWxkIGJlIGNsZWFuZWQgdXAgYSBiaXQgYnkgcGFzc2luZyBwb3NpdGlvbiBkaXJlY3RseVxuXG4gICAgICAgICAgICBjb25zdCBsZWZ0ID0gY3JlYXRlVmVydGljYWxJbnRlcm5hbERpdigpO1xuICAgICAgICAgICAgbGVmdC5zdHlsZS5sZWZ0ID0gJzAnO1xuICAgICAgICAgICAgbGVmdC5zdHlsZS50b3AgPSAnMCc7XG5cbiAgICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gY3JlYXRlVmVydGljYWxJbnRlcm5hbERpdigpO1xuICAgICAgICAgICAgcmlnaHQuc3R5bGUucmlnaHQgPSAnMCc7XG4gICAgICAgICAgICByaWdodC5zdHlsZS50b3AgPSAnMCc7XG5cbiAgICAgICAgICAgIGNvbnN0IHRvcCA9IGNyZWF0ZUhvcml6b250YWxJbnRlcm5hbERpdigpO1xuICAgICAgICAgICAgdG9wLnN0eWxlLmxlZnQgPSAnMCc7XG4gICAgICAgICAgICB0b3Auc3R5bGUudG9wID0gJzAnO1xuXG4gICAgICAgICAgICBjb25zdCBib3R0b20gPSBjcmVhdGVIb3Jpem9udGFsSW50ZXJuYWxEaXYoKTtcbiAgICAgICAgICAgIGJvdHRvbS5zdHlsZS5ib3R0b20gPSAnMCc7XG4gICAgICAgICAgICBib3R0b20uc3R5bGUubGVmdCA9ICcwJztcblxuICAgICAgICAgICAgcmV0dXJuIFsgbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tXTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGludGVybmFsRGl2cyA9IGNyZWF0ZUludGVybmFsRGl2cygpO1xuXG4gICAgICAgIHR5cGUgUG9pbnRlckV2ZW50cyA9ICdhdXRvJyB8ICdub25lJztcblxuICAgICAgICBsZXQgcG9pbnRlckV2ZW50czogUG9pbnRlckV2ZW50cyA9ICdhdXRvJztcblxuICAgICAgICBjb25zdCBkb0NoYW5nZVBvaW50ZXJFdmVudHMgPSAobmV3VmFsdWU6IFBvaW50ZXJFdmVudHMpID0+IHtcblxuICAgICAgICAgICAgaWYgKHBvaW50ZXJFdmVudHMgIT09IG5ld1ZhbHVlKSB7XG4gICAgICAgICAgICAgICAgcGFnZW1hcmtFbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSBuZXdWYWx1ZTtcbiAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzID0gbmV3VmFsdWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfTtcblxuICAgICAgICBmb3IgKGNvbnN0IGludGVybmFsRGl2IG9mIGludGVybmFsRGl2cykge1xuXG4gICAgICAgICAgICBpbnRlcm5hbERpdi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZG9DaGFuZ2VQb2ludGVyRXZlbnRzKCdhdXRvJyk7XG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpbnRlcm5hbERpdi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZG9DaGFuZ2VQb2ludGVyRXZlbnRzKCdub25lJyk7XG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBwYWdlbWFya0VsZW1lbnQuYXBwZW5kQ2hpbGQoaW50ZXJuYWxEaXYpO1xuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgdG9QYWdlbWFya0NvbG9yKCkge1xuXG4gICAgICAgIGNsYXNzIFBhZ2VtYXJrQ29sb3JzIHtcblxuICAgICAgICAgICAgcHVibGljIHN0YXRpYyBCTFVFID0ge1xuICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogXCIjMDBDQ0ZGXCIsXG4gICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBwdWJsaWMgc3RhdGljIExJR0hUQkxVRSA9IHtcbiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IFwiIzAwQ0NGRlwiLFxuICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuMTVcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHB1YmxpYyBzdGF0aWMgR1JFWSA9IHtcbiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IFwicmdiKDEyNSwgMTI1LCAxMjUpXCIsXG4gICAgICAgICAgICAgICAgb3BhY2l0eTogMC4zXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoISB0aGlzLnBhZ2VtYXJrKSB7XG4gICAgICAgICAgICByZXR1cm4gUGFnZW1hcmtDb2xvcnMuQkxVRTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5wYWdlbWFyay5tb2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gUGFnZW1hcmtDb2xvcnMuQkxVRTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN3aXRjaCAodGhpcy5wYWdlbWFyay5tb2RlKSB7XG5cbiAgICAgICAgICAgIGNhc2UgUGFnZW1hcmtNb2RlLklHTk9SRUQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIFBhZ2VtYXJrQ29sb3JzLkdSRVk7XG5cbiAgICAgICAgICAgIGNhc2UgUGFnZW1hcmtNb2RlLlRBQkxFX09GX0NPTlRFTlRTOlxuICAgICAgICAgICAgICAgIHJldHVybiBQYWdlbWFya0NvbG9ycy5HUkVZO1xuXG4gICAgICAgICAgICBjYXNlIFBhZ2VtYXJrTW9kZS5BUFBFTkRJWDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUGFnZW1hcmtDb2xvcnMuR1JFWTtcblxuICAgICAgICAgICAgY2FzZSBQYWdlbWFya01vZGUuUkVGRVJFTkNFUzpcbiAgICAgICAgICAgICAgICByZXR1cm4gUGFnZW1hcmtDb2xvcnMuR1JFWTtcblxuICAgICAgICAgICAgY2FzZSBQYWdlbWFya01vZGUuUFJFX1JFQUQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIFBhZ2VtYXJrQ29sb3JzLkxJR0hUQkxVRTtcblxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gUGFnZW1hcmtDb2xvcnMuQkxVRTtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAT3ZlcnJpZGVcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBwdWJsaWMgZGVzdHJveSgpIHtcblxuICAgICAgICBjb25zdCBwYWdlbWFya0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmNyZWF0ZUlEKCkpO1xuXG4gICAgICAgIGlmIChwYWdlbWFya0VsZW1lbnQpIHtcblxuICAgICAgICAgICAgcGFnZW1hcmtFbGVtZW50LmlubmVySFRNTCA9ICcnO1xuXG4gICAgICAgICAgICBpZiAocGFnZW1hcmtFbGVtZW50LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICBwYWdlbWFya0VsZW1lbnQucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZChwYWdlbWFya0VsZW1lbnQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlUGxhY2VtZW50UmVjdChwbGFjZW1lbnRFbGVtZW50OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uaW5nID0gU3R5bGVzLnBvc2l0aW9uaW5nKHBsYWNlbWVudEVsZW1lbnQpO1xuICAgICAgICBjb25zdCBwb3NpdGlvbmluZ1BYID0gU3R5bGVzLnBvc2l0aW9uaW5nVG9QWChwb3NpdGlvbmluZyk7XG5cbiAgICAgICAgLy8gVE9ETzogdGhpcyBjb3VsZCBiZSBjbGVhbmVkIHVwIGEgYml0Li4uXG5cbiAgICAgICAgLy8gVE9ETzogdGhlIG9mZnNldFdpZHRoIGRvZXMgbm90IHByb3Blcmx5IGhhdmUgdGhlIHdpZHRoIGFwcGxpZWQgdG9cbiAgICAgICAgLy8gaXQgZm9yIHNvbWUgcmVhc29uIHdoZW4gc2NhbGUgaXMgYmVpbmcgdXNlZC4gIGdldEJvdW5kaW5nQ2xpZW50UmVjdFxuICAgICAgICAvLyB3b3JrcyB0aG91Z2guXG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgICAgbGVmdDogT3B0aW9uYWwub2YocG9zaXRpb25pbmdQWC5sZWZ0KS5nZXRPckVsc2UocGxhY2VtZW50RWxlbWVudC5vZmZzZXRMZWZ0KSxcbiAgICAgICAgICAgIHRvcDogT3B0aW9uYWwub2YocG9zaXRpb25pbmdQWC50b3ApLmdldE9yRWxzZShwbGFjZW1lbnRFbGVtZW50Lm9mZnNldFRvcCksXG4gICAgICAgICAgICB3aWR0aDogT3B0aW9uYWwub2YocG9zaXRpb25pbmdQWC53aWR0aCkuZ2V0T3JFbHNlKHBsYWNlbWVudEVsZW1lbnQub2Zmc2V0V2lkdGgpLFxuICAgICAgICAgICAgaGVpZ2h0OiBPcHRpb25hbC5vZihwb3NpdGlvbmluZ1BYLmhlaWdodCkuZ2V0T3JFbHNlKHBsYWNlbWVudEVsZW1lbnQub2Zmc2V0SGVpZ2h0KSxcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gUmVjdHMuY3JlYXRlRnJvbUJhc2ljUmVjdChyZXN1bHQpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgdW5pcXVlIERPTSBJRCBmb3IgdGhpcyBwYWdlbWFyay5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZUlEKCkge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy50eXBlfS1wYWdlbWFyay0ke3RoaXMucGFnZW1hcmshLmlkfWA7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogSSBoYXZlIHRvIGltcHJvdmUgdGhpcyBncmFtbWFyLi4uIHBsYWNlbWVudCwgcG9zaXRpb25lZCwgZXRjLi5cbiAgICAvLyB3aGljaCBvbmUgaXMgd2hpY2guXG5cbiAgICBwcml2YXRlIHRvT3ZlcmxheVJlY3QocGxhY2VtZW50UmVjdDogUmVjdCwgcGFnZW1hcms6IFBhZ2VtYXJrIHwgSVBhZ2VtYXJrKSB7XG5cbiAgICAgICAgY29uc3QgcGFnZW1hcmtSZWN0ID0gbmV3IFBhZ2VtYXJrUmVjdChwYWdlbWFyay5yZWN0KTtcblxuICAgICAgICBjb25zdCBvdmVybGF5UmVjdCA9IHBhZ2VtYXJrUmVjdC50b0RpbWVuc2lvbnMocGxhY2VtZW50UmVjdC5kaW1lbnNpb25zKTtcblxuICAgICAgICAvLyB3ZSBoYXZlIHRvIGFwcGx5IHRoZSBvcmlnaW5hbCBwbGFjZW1lbnRSZWN0IHRvcCBhbmQgbGVmdCBzbyBpdCdzXG4gICAgICAgIC8vIHBsYWNlZCBhcyBhIHByb3BlciBvdmVybGF5XG4gICAgICAgIHJldHVybiBSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KHtcbiAgICAgICAgICAgIGxlZnQ6IG92ZXJsYXlSZWN0LmxlZnQgKyBwbGFjZW1lbnRSZWN0LmxlZnQsXG4gICAgICAgICAgICB0b3A6IG92ZXJsYXlSZWN0LnRvcCArIHBsYWNlbWVudFJlY3QudG9wLFxuICAgICAgICAgICAgd2lkdGg6IG92ZXJsYXlSZWN0LndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBvdmVybGF5UmVjdC5oZWlnaHQsXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG59XG5cbmludGVyZmFjZSBFbGVtZW50T3B0aW9ucyB7XG4gICAgdGVtcGxhdGVFbGVtZW50PzogSFRNTEVsZW1lbnQ7XG4gICAgcGxhY2VtZW50RWxlbWVudD86IEhUTUxFbGVtZW50O1xufVxuXG50eXBlIFBhZ2VtYXJrQ29tcG9uZW50VHlwZSA9ICdwcmltYXJ5JyB8ICd0aHVtYm5haWwnO1xuXG5pbnRlcmZhY2UgUGFnZW1hcmtDb2xvciB7XG4gICAgYmFja2dyb3VuZENvbG9yOiBzdHJpbmc7XG4gICAgb3BhY2l0eTogbnVtYmVyO1xufVxuIl19