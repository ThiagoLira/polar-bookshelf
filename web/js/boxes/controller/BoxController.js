"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const BoxMoveEvent_1 = require("./BoxMoveEvent");
const BoxOptions_1 = require("./BoxOptions");
const Rects_1 = require("../../Rects");
const Logger_1 = require("polar-shared/src/logger/Logger");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const RectEdges_1 = require("../../pagemarks/controller/interact/edges/RectEdges");
const Optional_1 = require("polar-shared/src/util/ts/Optional");
const DragRectAdjacencyCalculator_1 = require("../../pagemarks/controller/interact/drag/DragRectAdjacencyCalculator");
const ResizeRectAdjacencyCalculator_1 = require("../../pagemarks/controller/interact/resize/ResizeRectAdjacencyCalculator");
const Functions_1 = require("polar-shared/src/util/Functions");
const interactjs_1 = __importDefault(require("interactjs"));
const Objects_1 = require("polar-shared/src/util/Objects");
const log = Logger_1.Logger.create();
class BoxController {
    constructor(onMove = Functions_1.NULL_FUNCTION) {
        this.onMove = onMove;
    }
    register(opts) {
        const boxOptions = new BoxOptions_1.BoxOptions(opts);
        const restrictionElement = Optional_1.Optional.of(boxOptions.restrictionElement)
            .getOrElse(boxOptions.target.parentElement);
        interactjs_1.default(boxOptions.target)
            .draggable({
            inertia: false,
            restrict: {
                restriction: restrictionElement,
                outer: 'parent',
                elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
            },
            restrictEdges: {
                outer: 'parent',
            },
        })
            .resizable({
            edges: {
                left: true,
                right: true,
                bottom: true,
                top: true
            },
            restrictEdges: {
                outer: restrictionElement,
            },
            restrict: {
                restriction: restrictionElement,
            },
            restrictSize: {
                min: { width: 50, height: 50 },
            },
            inertia: false,
        })
            .on('dragstart', (interactionEvent) => {
            this._captureStartTargetRect(interactionEvent);
        })
            .on('dragmove', (interactionEvent) => {
            if (!interactionEvent.currentTarget.parentElement) {
                return;
            }
            const target = interactionEvent.target;
            const restrictionRect = this.computeRestrictionRect(restrictionElement);
            const origin = this._computeOriginXY(interactionEvent);
            const targetRect = Rects_1.Rects.fromElementStyle(target);
            const intersectedBoxes = this._calculateIntersectedBoxes(interactionEvent.currentTarget, Rects_1.Rects.createFromBasicRect({
                left: origin.x,
                top: origin.y,
                width: targetRect.width,
                height: targetRect.height
            }), boxOptions.intersectedElementsSelector);
            let boxRect = Rects_1.Rects.createFromBasicRect({
                left: origin.x,
                top: origin.y,
                width: targetRect.width,
                height: targetRect.height
            });
            if (intersectedBoxes.intersectedRects.length === 0) {
                log.info("NOT INTERSECTED");
                log.info("Moving to origin: " + JSON.stringify(origin));
                this._moveTargetElement(origin.x, origin.y, target);
            }
            else {
                log.info("INTERSECTED========== ");
                const primaryRect = Rects_1.Rects.createFromBasicRect({
                    left: origin.x,
                    top: origin.y,
                    width: targetRect.width,
                    height: targetRect.height
                });
                const intersectedRect = intersectedBoxes.intersectedRects[0];
                const adjacency = DragRectAdjacencyCalculator_1.DragRectAdjacencyCalculator.calculate(primaryRect, intersectedRect, restrictionRect);
                const adjustedRect = adjacency.adjustedRect;
                if (adjustedRect) {
                    this._moveTargetElement(adjustedRect.left, adjustedRect.top, target);
                    boxRect = adjustedRect;
                }
                else {
                    console.warn("Can't move due to no valid adjustedRect we can work with.");
                }
            }
            interactionEvent.interaction.lastBoxMoveEvent =
                this.fireOnMove("drag", restrictionRect, boxRect, target.id, target);
        })
            .on('dragend', (interactionEvent) => {
            this.fireOnMoveEnd(interactionEvent);
        })
            .on('resizestart', (interactionEvent) => {
            this._captureStartTargetRect(interactionEvent);
            log.info("resizestart: interactionEvent.rect: " + JSON.stringify(interactionEvent.rect, null, "  "));
            interactionEvent.interaction.startRect = Objects_1.Objects.duplicate(interactionEvent.rect);
        })
            .on('resizemove', (interactionEvent) => {
            log.info("resizemove: event: ", interactionEvent);
            log.info("resizemove: event.target: ", interactionEvent.target);
            log.info("resizemove: interactionEvent.interaction.startRect: " + JSON.stringify(interactionEvent.interaction.startRect, null, "  "));
            const target = interactionEvent.target;
            const restrictionRect = this.computeRestrictionRect(restrictionElement);
            const tempRect = Rects_1.Rects.createFromBasicRect(interactionEvent.rect);
            const deltaRect = Rects_1.Rects.subtract(tempRect, interactionEvent.interaction.startRect);
            const resizeRect = Rects_1.Rects.add(interactionEvent.interaction.startTargetRect, deltaRect);
            const intersectedBoxes = this._calculateIntersectedBoxes(target, resizeRect, boxOptions.intersectedElementsSelector);
            log.info("resizemove: deltaRect: " + JSON.stringify(deltaRect, null, "  "));
            let boxRect;
            if (intersectedBoxes.intersectedRects.length === 0) {
                log.info("Resizing in non-intersected mode");
                boxRect = resizeRect;
                this._resizeTargetElement(resizeRect, target);
            }
            else {
                log.info("Resizing in intersected mode");
                const resizeRectAdjacencyCalculator = new ResizeRectAdjacencyCalculator_1.ResizeRectAdjacencyCalculator();
                const intersectedRect = intersectedBoxes.intersectedRects[0];
                const rectEdges = new RectEdges_1.RectEdges(interactionEvent.edges);
                const adjustedRect = resizeRectAdjacencyCalculator.calculate(resizeRect, intersectedRect, rectEdges);
                log.info("resizemove: adjustedRect: " + JSON.stringify(adjustedRect, null, "  "));
                boxRect = adjustedRect;
                this._resizeTargetElement(adjustedRect, target);
            }
            interactionEvent.interaction.lastBoxMoveEvent
                = this.fireOnMove("resize", restrictionRect, boxRect, target.id, target);
        })
            .on('resizeend', (interactionEvent) => {
            this.fireOnMoveEnd(interactionEvent);
        });
    }
    computeRestrictionRect(element) {
        const computeDimensions = () => {
            if ('canvas' === element.tagName.toLowerCase()) {
                const canvasElement = element;
                return {
                    width: canvasElement.width,
                    height: canvasElement.height,
                };
            }
            return {
                width: element.offsetWidth,
                height: element.offsetHeight
            };
        };
        const dimensions = computeDimensions();
        Preconditions_1.Preconditions.assertCondition(dimensions.width > 0, 'restrictionRect width');
        Preconditions_1.Preconditions.assertCondition(dimensions.height > 0, 'restrictionRect height');
        return Rects_1.Rects.createFromBasicRect(Object.assign({ left: 0, top: 0 }, dimensions));
    }
    fireOnMove(type, restrictionRect, boxRect, id, target) {
        const boxMoveEvent = new BoxMoveEvent_1.BoxMoveEvent({
            type,
            restrictionRect,
            boxRect,
            id,
            target,
        });
        if (this.onMove) {
            this.onMove(boxMoveEvent);
        }
        return boxMoveEvent;
    }
    fireOnMoveEnd(interactionEvent) {
        if (interactionEvent.interaction.lastBoxMoveEvent) {
            const boxMoveEvent = Object.assign({}, interactionEvent.interaction.lastBoxMoveEvent);
            boxMoveEvent.state = "completed";
            if (this.onMove) {
                log.info("Firing completed BoxMoveEvent: ", boxMoveEvent);
                setTimeout(() => this.onMove(boxMoveEvent), 1);
            }
        }
    }
    _calculateIntersectedBoxes(element, resizeRect, intersectedElementsSelector) {
        Preconditions_1.Preconditions.assertPresent(element, "element");
        Preconditions_1.Preconditions.assertPresent(resizeRect, "resizeRect");
        Preconditions_1.Preconditions.assertPresent(intersectedElementsSelector, "intersectedElementsSelector");
        log.info("_calculateIntersectedBoxes: resizeRect is: " + JSON.stringify(resizeRect, null, "  "));
        if (!element.parentElement) {
            const msg = "Element not within DOM: ";
            log.error(msg, element);
            throw new Error(msg);
        }
        const intersectedElements = element.parentElement.querySelectorAll(intersectedElementsSelector);
        const boxes = Array.from(intersectedElements)
            .filter(current => current !== element)
            .map(current => current);
        boxes.forEach(current => current.getAttribute("id") !== element.getAttribute("id"));
        const intersectedRects = [];
        boxes.forEach(box => {
            const boxRect = Rects_1.Rects.fromElementStyle(box);
            if (Rects_1.Rects.intersect(boxRect, resizeRect)) {
                intersectedRects.push(boxRect);
            }
        });
        return {
            resizeRect,
            intersectedRects
        };
    }
    _computeOriginXY(interactionEvent) {
        const delta = {
            x: interactionEvent.pageX - interactionEvent._interaction.coords.start.page.x,
            y: interactionEvent.pageY - interactionEvent._interaction.coords.start.page.y
        };
        const x = interactionEvent.interaction.startTargetRect.left + delta.x;
        const y = interactionEvent.interaction.startTargetRect.top + delta.y;
        return { x, y };
    }
    _moveTargetElement(x, y, target) {
        target.style.left = `${x}px`;
        target.style.top = `${y}px`;
        target.setAttribute('data-x', `${x}`);
        target.setAttribute('data-y', `${y}`);
    }
    _resizeTargetElement(rect, target) {
        this._moveTargetElement(rect.left, rect.top, target);
        target.style.width = `${rect.width}px`;
        target.style.height = `${rect.height}px`;
    }
    _captureStartTargetRect(interactionEvent) {
        interactionEvent.interaction.startTargetRect = Rects_1.Rects.fromElementStyle(interactionEvent.target);
    }
}
exports.BoxController = BoxController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm94Q29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkJveENvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxpREFBNEM7QUFDNUMsNkNBQXdDO0FBQ3hDLHVDQUFrQztBQUVsQywyREFBc0Q7QUFDdEQsa0VBQTZEO0FBQzdELG1GQUE4RTtBQUM5RSxnRUFBMkQ7QUFDM0Qsc0hBQWlIO0FBQ2pILDRIQUF1SDtBQUN2SCwrREFBOEQ7QUFFOUQsNERBQWtDO0FBQ2xDLDJEQUFzRDtBQUl0RCxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFNNUIsTUFBYSxhQUFhO0lBSXRCLFlBQVksU0FBd0MseUJBQWE7UUFFN0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFFekIsQ0FBQztJQUlNLFFBQVEsQ0FBQyxJQUFnQjtRQUU1QixNQUFNLFVBQVUsR0FBRyxJQUFJLHVCQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFNeEMsTUFBTSxrQkFBa0IsR0FDcEIsbUJBQVEsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDO2FBQ2pDLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLGFBQWMsQ0FBQyxDQUFDO1FBRXpELG9CQUFRLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQzthQUN0QixTQUFTLENBQUM7WUFFUCxPQUFPLEVBQUUsS0FBSztZQUNkLFFBQVEsRUFBRTtnQkFDTixXQUFXLEVBQUUsa0JBQWtCO2dCQUMvQixLQUFLLEVBQUUsUUFBUTtnQkFFZixXQUFXLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFO2FBQ3hEO1lBRUQsYUFBYSxFQUFFO2dCQUNYLEtBQUssRUFBRSxRQUFRO2FBRWxCO1NBRUosQ0FBQzthQUNELFNBQVMsQ0FBRTtZ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R0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXJFLE9BQU8sRUFBQyxDQUFDLEVBQUUsQ0FBQyxFQUFDLENBQUM7SUFFbEIsQ0FBQztJQUdPLGtCQUFrQixDQUFDLENBQVMsRUFBRSxDQUFTLEVBQUUsTUFBbUI7UUFFaEUsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUM3QixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRzVCLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0QyxNQUFNLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFJMUMsQ0FBQztJQUVPLG9CQUFvQixDQUFDLElBQVUsRUFBRSxNQUFtQjtRQUd4RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBR3JELE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDO0lBRTdDLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxnQkFBcUI7UUFHakQsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLGVBQWUsR0FBRyxhQUFLLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkcsQ0FBQztDQUVKO0FBaGJELHNDQWdiQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Qm94TW92ZUV2ZW50fSBmcm9tICcuL0JveE1vdmVFdmVudCc7XG5pbXBvcnQge0JveE9wdGlvbnN9IGZyb20gJy4vQm94T3B0aW9ucyc7XG5pbXBvcnQge1JlY3RzfSBmcm9tICcuLi8uLi9SZWN0cyc7XG5pbXBvcnQge1JlY3R9IGZyb20gJy4uLy4uL1JlY3QnO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvbG9nZ2VyL0xvZ2dlcic7XG5pbXBvcnQge1ByZWNvbmRpdGlvbnN9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvUHJlY29uZGl0aW9ucyc7XG5pbXBvcnQge1JlY3RFZGdlc30gZnJvbSAnLi4vLi4vcGFnZW1hcmtzL2NvbnRyb2xsZXIvaW50ZXJhY3QvZWRnZXMvUmVjdEVkZ2VzJztcbmltcG9ydCB7T3B0aW9uYWx9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC90cy9PcHRpb25hbCc7XG5pbXBvcnQge0RyYWdSZWN0QWRqYWNlbmN5Q2FsY3VsYXRvcn0gZnJvbSAnLi4vLi4vcGFnZW1hcmtzL2NvbnRyb2xsZXIvaW50ZXJhY3QvZHJhZy9EcmFnUmVjdEFkamFjZW5jeUNhbGN1bGF0b3InO1xuaW1wb3J0IHtSZXNpemVSZWN0QWRqYWNlbmN5Q2FsY3VsYXRvcn0gZnJvbSAnLi4vLi4vcGFnZW1hcmtzL2NvbnRyb2xsZXIvaW50ZXJhY3QvcmVzaXplL1Jlc2l6ZVJlY3RBZGphY2VuY3lDYWxjdWxhdG9yJztcbmltcG9ydCB7TlVMTF9GVU5DVElPTn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy91dGlsL0Z1bmN0aW9ucyc7XG5cbmltcG9ydCBpbnRlcmFjdCBmcm9tICdpbnRlcmFjdGpzJztcbmltcG9ydCB7T2JqZWN0c30gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdXRpbC9PYmplY3RzXCI7XG5pbXBvcnQgcmVzdCBmcm9tIFwibW9jaGEtcGFyYWxsZWwtdGVzdHMvZGlzdC9iaW4vb3B0aW9ucy9yZXN0XCI7XG5pbXBvcnQge0lEaW1lbnNpb25zfSBmcm9tIFwiLi4vLi4vdXRpbC9JRGltZW5zaW9uc1wiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbi8qKlxuICogQSBnZW5lcmljIGNvbnRyb2xsZXIgZm9yIGRyYWdnaW5nIGJveGVzIChkaXZzKSB3aGljaCBhcmUgcmVzaXplYWJsZSBhbmQgY2FuXG4gKiBiZSBkcmFnZ2VkIHdpdGhpbiBhIGNvbnRhaW5lciBhbmQgYWJzb2x1dGVseSBwb3NpdGlvbmVkLlxuICovXG5leHBvcnQgY2xhc3MgQm94Q29udHJvbGxlciB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG9uTW92ZTogKGV2ZW50OiBCb3hNb3ZlRXZlbnQpID0+IHZvaWQ7XG5cbiAgICBjb25zdHJ1Y3Rvcihvbk1vdmU6IChldmVudDogQm94TW92ZUV2ZW50KSA9PiB2b2lkID0gTlVMTF9GVU5DVElPTikge1xuXG4gICAgICAgIHRoaXMub25Nb3ZlID0gb25Nb3ZlO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICovXG4gICAgcHVibGljIHJlZ2lzdGVyKG9wdHM6IEJveE9wdGlvbnMpIHtcblxuICAgICAgICBjb25zdCBib3hPcHRpb25zID0gbmV3IEJveE9wdGlvbnMob3B0cyk7XG5cbiAgICAgICAgLy8gVE9ETzogYXNzZXJ0IHRoYXQgdGhlIGJveGVzIGZvciB0aGUgc2VsZWN0b3IgYXJlIEFMUkVBRFkgYWJzb2x1dGVseVxuICAgICAgICAvLyBwb3NpdGlvbmVkIGJlZm9yZSB3ZSBhY2NlcHQgdGhlbSBhbmQgdGhleSBhcmUgZG9uZSB1c2luZyBzdHlsZVxuICAgICAgICAvLyBhdHRyaWJ1dGVzIGJlY2F1c2Ugd2UncmUgaW5jb21wYXRpYmxlIHdpdGggdGhlbSBvdGhlcndpc2UuXG5cbiAgICAgICAgY29uc3QgcmVzdHJpY3Rpb25FbGVtZW50ID1cbiAgICAgICAgICAgIE9wdGlvbmFsLm9mKGJveE9wdGlvbnMucmVzdHJpY3Rpb25FbGVtZW50KVxuICAgICAgICAgICAgICAgICAgICAuZ2V0T3JFbHNlKGJveE9wdGlvbnMudGFyZ2V0LnBhcmVudEVsZW1lbnQhKTtcblxuICAgICAgICBpbnRlcmFjdChib3hPcHRpb25zLnRhcmdldClcbiAgICAgICAgICAgIC5kcmFnZ2FibGUoe1xuXG4gICAgICAgICAgICAgICAgaW5lcnRpYTogZmFsc2UsXG4gICAgICAgICAgICAgICAgcmVzdHJpY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdHJpY3Rpb246IHJlc3RyaWN0aW9uRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6ICdwYXJlbnQnLFxuXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnRSZWN0OiB7IHRvcDogMCwgbGVmdDogMCwgYm90dG9tOiAxLCByaWdodDogMSB9XG4gICAgICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgICAgIHJlc3RyaWN0RWRnZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6ICdwYXJlbnQnLFxuICAgICAgICAgICAgICAgICAgICAvLyBvdXRlcjogY29tcHV0ZVJlc3RyaWN0aW9uLFxuICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAucmVzaXphYmxlKCB7XG5cbiAgICAgICAgICAgICAgICAvLyByZXNpemUgZnJvbSBhbGwgZWRnZXMgYW5kIGNvcm5lcnNcbiAgICAgICAgICAgICAgICBlZGdlczoge1xuICAgICAgICAgICAgICAgICAgICBsZWZ0OiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByaWdodDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgYm90dG9tOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB0b3A6IHRydWVcbiAgICAgICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAgICAgLy8gS2VlcCB0aGUgZWRnZXMgaW5zaWRlIHRoZSBwYXJlbnQuIHRoaXMgaXMgbmVlZGVkIG9yIGVsc2UgdGhlXG4gICAgICAgICAgICAgICAgLy8gYm91bmQgc3RyZXRjaGVzIHNsaWdodGx5IGJleW9uZCB0aGUgY29udGFpbmVyLlxuICAgICAgICAgICAgICAgIHJlc3RyaWN0RWRnZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6IHJlc3RyaWN0aW9uRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgLy8gb3V0ZXI6IGNvbXB1dGVSZXN0cmljdGlvbixcbiAgICAgICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAgICAgcmVzdHJpY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdHJpY3Rpb246IHJlc3RyaWN0aW9uRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgLy8gcmVzdHJpY3Rpb246IGNvbXB1dGVSZXN0cmljdGlvblxuICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICAgICAvLyBtaW5pbXVtIHNpemVcbiAgICAgICAgICAgICAgICByZXN0cmljdFNpemU6IHtcbiAgICAgICAgICAgICAgICAgICAgbWluOiB7IHdpZHRoOiA1MCwgaGVpZ2h0OiA1MCB9LFxuICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICAgICBpbmVydGlhOiBmYWxzZSxcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vbignZHJhZ3N0YXJ0JywgKGludGVyYWN0aW9uRXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2NhcHR1cmVTdGFydFRhcmdldFJlY3QoaW50ZXJhY3Rpb25FdmVudCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdkcmFnbW92ZScsIChpbnRlcmFjdGlvbkV2ZW50OiBhbnkpID0+IHtcblxuICAgICAgICAgICAgICAgIC8vIGxvZy5pbmZvKFwiPT09PT09PT09PT09PT09PT09PT09XCIpXG4gICAgICAgICAgICAgICAgLy8gbG9nLmluZm8oXCJkcmFnbW92ZTogZXZlbnQ6IFwiLCBldmVudCk7XG4gICAgICAgICAgICAgICAgLy8gbG9nLmluZm8oXCJkcmFnbW92ZTogZXZlbnQuaW50ZXJhY3Rpb24ubXlUaW1lc3RhbXA6IFwiLFxuICAgICAgICAgICAgICAgIC8vIGV2ZW50LmludGVyYWN0aW9uLm15VGltZXN0YW1wKTsgbG9nLmluZm8oXCJkcmFnbW92ZTpcbiAgICAgICAgICAgICAgICAvLyBldmVudC50YXJnZXQ6IFwiLCBldmVudC50YXJnZXQpOyBsb2cuaW5mbyhcImRyYWdtb3ZlOlxuICAgICAgICAgICAgICAgIC8vIGV2ZW50LnJlc3RyaWN0OiBcIiwgZXZlbnQucmVzdHJpY3QpOyBsb2cuaW5mbyhgZHJhZ21vdmU6XG4gICAgICAgICAgICAgICAgLy8gZXZlbnQuZHg6ICR7ZXZlbnQuZHh9IGFuZCBldmVudC5keTogJHtldmVudC5keX1gKTtcbiAgICAgICAgICAgICAgICAvLyBsb2cuaW5mbyhgZHJhZ21vdmU6IGV2ZW50LngwOiAke2V2ZW50LngwfSBhbmQgZXZlbnQueTA6XG4gICAgICAgICAgICAgICAgLy8gJHtldmVudC55MH1gKTsgbG9nLmluZm8oYGRyYWdtb3ZlOiBldmVudC5jbGllbnRYOlxuICAgICAgICAgICAgICAgIC8vICR7ZXZlbnQuY2xpZW50WH0gYW5kIGV2ZW50LmNsaWVudFk6ICR7ZXZlbnQuY2xpZW50WX1gKTtcbiAgICAgICAgICAgICAgICAvLyBsb2cuaW5mbyhgZHJhZ21vdmU6IGV2ZW50LmNsaWVudFgwOiAke2V2ZW50LmNsaWVudFgwfSBhbmRcbiAgICAgICAgICAgICAgICAvLyBldmVudC5jbGllbnRZMDogJHtldmVudC5jbGllbnRZMH1gKTtcblxuICAgICAgICAgICAgICAgIGlmICghIGludGVyYWN0aW9uRXZlbnQuY3VycmVudFRhcmdldC5wYXJlbnRFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHdlJ3ZlIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBET00gYnV0IHdlJ3JlIHN0aWxsIGdldHRpbmdcbiAgICAgICAgICAgICAgICAgICAgLy8gZHJhZyBldmVudHMgc28gd2Ugc2hvdWxkIHlpZWxkLlxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gaW50ZXJhY3Rpb25FdmVudC50YXJnZXQ7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZXN0cmljdGlvblJlY3QgPSB0aGlzLmNvbXB1dGVSZXN0cmljdGlvblJlY3QocmVzdHJpY3Rpb25FbGVtZW50KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMuX2NvbXB1dGVPcmlnaW5YWShpbnRlcmFjdGlvbkV2ZW50KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFJlY3QgPSBSZWN0cy5mcm9tRWxlbWVudFN0eWxlKHRhcmdldCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnNlY3RlZEJveGVzID0gdGhpcy5fY2FsY3VsYXRlSW50ZXJzZWN0ZWRCb3hlcyhpbnRlcmFjdGlvbkV2ZW50LmN1cnJlbnRUYXJnZXQsIFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgICAgICAgICBsZWZ0OiBvcmlnaW4ueCxcbiAgICAgICAgICAgICAgICAgICAgdG9wOiBvcmlnaW4ueSxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRhcmdldFJlY3Qud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGFyZ2V0UmVjdC5oZWlnaHRcbiAgICAgICAgICAgICAgICB9KSwgYm94T3B0aW9ucy5pbnRlcnNlY3RlZEVsZW1lbnRzU2VsZWN0b3IpO1xuXG4gICAgICAgICAgICAgICAgbGV0IGJveFJlY3QgPSBSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdDogb3JpZ2luLngsXG4gICAgICAgICAgICAgICAgICAgIHRvcDogb3JpZ2luLnksXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiB0YXJnZXRSZWN0LndpZHRoLFxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHRhcmdldFJlY3QuaGVpZ2h0XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW50ZXJzZWN0ZWRCb3hlcy5pbnRlcnNlY3RlZFJlY3RzLmxlbmd0aCA9PT0gMCkge1xuXG4gICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwiTk9UIElOVEVSU0VDVEVEXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwiTW92aW5nIHRvIG9yaWdpbjogXCIgKyBKU09OLnN0cmluZ2lmeShvcmlnaW4pKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRhcmdldEVsZW1lbnQob3JpZ2luLngsIG9yaWdpbi55LCB0YXJnZXQpO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIklOVEVSU0VDVEVEPT09PT09PT09PSBcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJpbWFyeVJlY3QgPSBSZWN0cy5jcmVhdGVGcm9tQmFzaWNSZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IG9yaWdpbi54LFxuICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBvcmlnaW4ueSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiB0YXJnZXRSZWN0LndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB0YXJnZXRSZWN0LmhlaWdodFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnNlY3RlZFJlY3QgPSBpbnRlcnNlY3RlZEJveGVzLmludGVyc2VjdGVkUmVjdHNbMF07XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRqYWNlbmN5ID0gRHJhZ1JlY3RBZGphY2VuY3lDYWxjdWxhdG9yLmNhbGN1bGF0ZShwcmltYXJ5UmVjdCwgaW50ZXJzZWN0ZWRSZWN0LCByZXN0cmljdGlvblJlY3QpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkanVzdGVkUmVjdCA9IGFkamFjZW5jeS5hZGp1c3RlZFJlY3Q7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFkanVzdGVkUmVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbW92ZVRhcmdldEVsZW1lbnQoYWRqdXN0ZWRSZWN0LmxlZnQsIGFkanVzdGVkUmVjdC50b3AsIHRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBib3hSZWN0ID0gYWRqdXN0ZWRSZWN0O1xuXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHNob3VsZCBuZXZlciBoYXBwZW4gYnV0IGxvZyBpdCBpZiB0aGVyZSBpcyBhXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBidWcuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJDYW4ndCBtb3ZlIGR1ZSB0byBubyB2YWxpZCBhZGp1c3RlZFJlY3Qgd2UgY2FuIHdvcmsgd2l0aC5cIik7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24ubGFzdEJveE1vdmVFdmVudCA9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlyZU9uTW92ZShcImRyYWdcIiwgcmVzdHJpY3Rpb25SZWN0LCBib3hSZWN0LCB0YXJnZXQuaWQsIHRhcmdldCk7XG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub24oJ2RyYWdlbmQnLCAoaW50ZXJhY3Rpb25FdmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5maXJlT25Nb3ZlRW5kKGludGVyYWN0aW9uRXZlbnQpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vbigncmVzaXplc3RhcnQnLCAoaW50ZXJhY3Rpb25FdmVudDogYW55KSA9PiB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9jYXB0dXJlU3RhcnRUYXJnZXRSZWN0KGludGVyYWN0aW9uRXZlbnQpO1xuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplc3RhcnQ6IGludGVyYWN0aW9uRXZlbnQucmVjdDogXCIgKyBKU09OLnN0cmluZ2lmeShpbnRlcmFjdGlvbkV2ZW50LnJlY3QsIG51bGwsIFwiICBcIikpO1xuICAgICAgICAgICAgICAgIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24uc3RhcnRSZWN0ID0gT2JqZWN0cy5kdXBsaWNhdGUoaW50ZXJhY3Rpb25FdmVudC5yZWN0KTtcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vbigncmVzaXplbW92ZScsIChpbnRlcmFjdGlvbkV2ZW50OiBhbnkpID0+IHtcblxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplbW92ZTogZXZlbnQ6IFwiLCBpbnRlcmFjdGlvbkV2ZW50KTtcbiAgICAgICAgICAgICAgICBsb2cuaW5mbyhcInJlc2l6ZW1vdmU6IGV2ZW50LnRhcmdldDogXCIsIGludGVyYWN0aW9uRXZlbnQudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAvLyBsb2cuaW5mbyhcInJlc2l6ZW1vdmU6IGV2ZW50LnJlc3RyaWN0OiBcIixcbiAgICAgICAgICAgICAgICAvLyBpbnRlcmFjdGlvbkV2ZW50LnJlc3RyaWN0KTsgbG9nLmluZm8oXCJyZXNpemVtb3ZlOlxuICAgICAgICAgICAgICAgIC8vIGludGVyYWN0aW9uRXZlbnQucmVjdDogXCIgK1xuICAgICAgICAgICAgICAgIC8vIEpTT04uc3RyaW5naWZ5KGludGVyYWN0aW9uRXZlbnQucmVjdCwgbnVsbCwgXCIgIFwiKSk7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJyZXNpemVtb3ZlOiBpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0UmVjdDogXCIgKyBKU09OLnN0cmluZ2lmeShpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0UmVjdCwgbnVsbCwgXCIgIFwiKSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBpbnRlcmFjdGlvbkV2ZW50LnRhcmdldDtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RyaWN0aW9uUmVjdCA9IHRoaXMuY29tcHV0ZVJlc3RyaWN0aW9uUmVjdChyZXN0cmljdGlvbkVsZW1lbnQpO1xuXG4gICAgICAgICAgICAgICAgLy8gdGhlIHRlbXBSZWN0IGlzIHRoZSByZWN0IHRoYXQgdGhlIHVzZXIgaGFzIGF0dGVtcHRlZCB0byBkcmF3XG4gICAgICAgICAgICAgICAgLy8gYnV0IHdoaWNoIHdlIGhhdmUgbm90IHlldCBhY2NlcHRlZCBhbmQgaXMgY29udHJvbGxlZCBieVxuICAgICAgICAgICAgICAgIC8vIGludGVyYWN0LmpzXG5cbiAgICAgICAgICAgICAgICBjb25zdCB0ZW1wUmVjdCA9IFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3QoaW50ZXJhY3Rpb25FdmVudC5yZWN0KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGRlbHRhUmVjdCA9IFJlY3RzLnN1YnRyYWN0KHRlbXBSZWN0LCBpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLnN0YXJ0UmVjdCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZXNpemVSZWN0ID0gUmVjdHMuYWRkKGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24uc3RhcnRUYXJnZXRSZWN0LCBkZWx0YVJlY3QpO1xuXG4gICAgICAgICAgICAgICAgLy8gYmVmb3JlIHdlIHJlc2l6ZSwgdmVyaWZ5IHRoYXQgd2UgQ0FOIHJlc2l6ZS4uXG5cbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnNlY3RlZEJveGVzID0gdGhpcy5fY2FsY3VsYXRlSW50ZXJzZWN0ZWRCb3hlcyh0YXJnZXQsIHJlc2l6ZVJlY3QsIGJveE9wdGlvbnMuaW50ZXJzZWN0ZWRFbGVtZW50c1NlbGVjdG9yKTtcblxuICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplbW92ZTogZGVsdGFSZWN0OiBcIiArIEpTT04uc3RyaW5naWZ5KGRlbHRhUmVjdCwgbnVsbCwgXCIgIFwiKSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgYm94UmVjdDtcblxuICAgICAgICAgICAgICAgIGlmIChpbnRlcnNlY3RlZEJveGVzLmludGVyc2VjdGVkUmVjdHMubGVuZ3RoID09PSAwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oXCJSZXNpemluZyBpbiBub24taW50ZXJzZWN0ZWQgbW9kZVwiKTtcblxuICAgICAgICAgICAgICAgICAgICBib3hSZWN0ID0gcmVzaXplUmVjdDtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNpemVUYXJnZXRFbGVtZW50KHJlc2l6ZVJlY3QsIHRhcmdldCk7XG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBpdHMnIGFsc28gcG9zc2libGUgdG8gcmVzaXplIHNtYWxsZXIgdGhhbiB0aGVcbiAgICAgICAgICAgICAgICAgICAgLy8gbWluU2l6ZSB3ZSBkZWZpbmVkIGFib3ZlLi4uXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gRklYTUU6IHdoZW4gaW50ZXJzZWN0ZWQsIGlmIHdlIGRyYWcgZG93biwgdGhlIHJlY3RcbiAgICAgICAgICAgICAgICAgICAgLy8gdmFuaXNoZXMuLi4gIEZJWE1FOiBwdWxsaW5nIGl0IGxlZnQgd2hpbGUgaW50ZXJzZWN0ZWRcbiAgICAgICAgICAgICAgICAgICAgLy8gYWxzbyBtYWtlcyBpdCB2YW5pc2guLi5cblxuICAgICAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIlJlc2l6aW5nIGluIGludGVyc2VjdGVkIG1vZGVcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzaXplUmVjdEFkamFjZW5jeUNhbGN1bGF0b3IgPSBuZXcgUmVzaXplUmVjdEFkamFjZW5jeUNhbGN1bGF0b3IoKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnNlY3RlZFJlY3QgPSBpbnRlcnNlY3RlZEJveGVzLmludGVyc2VjdGVkUmVjdHNbMF07XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjdEVkZ2VzID0gbmV3IFJlY3RFZGdlcyhpbnRlcmFjdGlvbkV2ZW50LmVkZ2VzKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGp1c3RlZFJlY3QgPSByZXNpemVSZWN0QWRqYWNlbmN5Q2FsY3VsYXRvci5jYWxjdWxhdGUocmVzaXplUmVjdCwgaW50ZXJzZWN0ZWRSZWN0LCByZWN0RWRnZXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKFwicmVzaXplbW92ZTogYWRqdXN0ZWRSZWN0OiBcIiArIEpTT04uc3RyaW5naWZ5KGFkanVzdGVkUmVjdCwgbnVsbCwgXCIgIFwiKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgYm94UmVjdCA9IGFkanVzdGVkUmVjdDtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNpemVUYXJnZXRFbGVtZW50KGFkanVzdGVkUmVjdCwgdGFyZ2V0KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24ubGFzdEJveE1vdmVFdmVudFxuICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZmlyZU9uTW92ZShcInJlc2l6ZVwiLCByZXN0cmljdGlvblJlY3QsIGJveFJlY3QsIHRhcmdldC5pZCwgdGFyZ2V0KTtcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vbigncmVzaXplZW5kJywgKGludGVyYWN0aW9uRXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZmlyZU9uTW92ZUVuZChpbnRlcmFjdGlvbkV2ZW50KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb21wdXRlUmVzdHJpY3Rpb25SZWN0KGVsZW1lbnQ6IEhUTUxFbGVtZW50KSB7XG5cbiAgICAgICAgY29uc3QgY29tcHV0ZURpbWVuc2lvbnMgPSAoKTogSURpbWVuc2lvbnMgPT4ge1xuXG4gICAgICAgICAgICBpZiAoJ2NhbnZhcycgPT09IGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjYW52YXNFbGVtZW50ID0gPEhUTUxDYW52YXNFbGVtZW50PiBlbGVtZW50O1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGNhbnZhc0VsZW1lbnQud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogY2FudmFzRWxlbWVudC5oZWlnaHQsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHdpZHRoOiBlbGVtZW50Lm9mZnNldFdpZHRoLFxuICAgICAgICAgICAgICAgIGhlaWdodDogZWxlbWVudC5vZmZzZXRIZWlnaHRcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBkaW1lbnNpb25zID0gY29tcHV0ZURpbWVuc2lvbnMoKTtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydENvbmRpdGlvbihkaW1lbnNpb25zLndpZHRoID4gMCwgJ3Jlc3RyaWN0aW9uUmVjdCB3aWR0aCcpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydENvbmRpdGlvbihkaW1lbnNpb25zLmhlaWdodCA+IDAsICdyZXN0cmljdGlvblJlY3QgaGVpZ2h0Jyk7XG5cbiAgICAgICAgcmV0dXJuIFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgICAgIHRvcDogMCxcbiAgICAgICAgICAgIC4uLmRpbWVuc2lvbnNcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGZpcmVPbk1vdmUodHlwZTogJ2RyYWcnIHwgJ3Jlc2l6ZScsXG4gICAgICAgICAgICAgICAgICAgICAgIHJlc3RyaWN0aW9uUmVjdDogUmVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgYm94UmVjdDogUmVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIGNvbnN0IGJveE1vdmVFdmVudCA9IG5ldyBCb3hNb3ZlRXZlbnQoe1xuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICAgIHJlc3RyaWN0aW9uUmVjdCxcbiAgICAgICAgICAgIGJveFJlY3QsXG4gICAgICAgICAgICBpZCxcbiAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHRoaXMub25Nb3ZlKSB7XG4gICAgICAgICAgICB0aGlzLm9uTW92ZShib3hNb3ZlRXZlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGJveE1vdmVFdmVudDtcblxuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBmaXJlT25Nb3ZlRW5kKGludGVyYWN0aW9uRXZlbnQ6IGFueSkge1xuXG4gICAgICAgIGlmIChpbnRlcmFjdGlvbkV2ZW50LmludGVyYWN0aW9uLmxhc3RCb3hNb3ZlRXZlbnQpIHtcblxuICAgICAgICAgICAgY29uc3QgYm94TW92ZUV2ZW50ID0gT2JqZWN0LmFzc2lnbih7fSwgaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5sYXN0Qm94TW92ZUV2ZW50KTtcblxuICAgICAgICAgICAgYm94TW92ZUV2ZW50LnN0YXRlID0gXCJjb21wbGV0ZWRcIjtcblxuICAgICAgICAgICAgaWYgKHRoaXMub25Nb3ZlKSB7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJGaXJpbmcgY29tcGxldGVkIEJveE1vdmVFdmVudDogXCIsIGJveE1vdmVFdmVudCk7XG5cbiAgICAgICAgICAgICAgICAvLyBmb3Igc29tZSByZWFzb24sIHdpdGhvdXQgYSB0aW1lb3V0LCB0aGUgY29udHJvbGxlciBqdXN0IHNlZW1zXG4gICAgICAgICAgICAgICAgLy8gdG8gbG9jayB1cC5cbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMub25Nb3ZlKGJveE1vdmVFdmVudCksIDEpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICovXG4gICAgcHJpdmF0ZSBfY2FsY3VsYXRlSW50ZXJzZWN0ZWRCb3hlcyhlbGVtZW50OiBIVE1MRWxlbWVudCwgcmVzaXplUmVjdDogUmVjdCwgaW50ZXJzZWN0ZWRFbGVtZW50c1NlbGVjdG9yOiBzdHJpbmcpIHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydFByZXNlbnQoZWxlbWVudCwgXCJlbGVtZW50XCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydFByZXNlbnQocmVzaXplUmVjdCwgXCJyZXNpemVSZWN0XCIpO1xuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydFByZXNlbnQoaW50ZXJzZWN0ZWRFbGVtZW50c1NlbGVjdG9yLCBcImludGVyc2VjdGVkRWxlbWVudHNTZWxlY3RvclwiKTtcblxuXG4gICAgICAgIC8vIC8vIFRoaXMgaXMgd2hlcmUgd2UgYXJlIE5PVywgbm93IHdoZXJlIHdlIGFyZSBHT0lORyB0byBiZS5cbiAgICAgICAgLy8gbGV0IGVsZW1lbnRSZWN0ID0gUmVjdHMuZnJvbUVsZW1lbnRTdHlsZShlbGVtZW50KTtcblxuICAgICAgICAvLyBsb2cuaW5mbyhgeDogJHt4fTogeTogJHt5fWApO1xuICAgICAgICBsb2cuaW5mbyhcIl9jYWxjdWxhdGVJbnRlcnNlY3RlZEJveGVzOiByZXNpemVSZWN0IGlzOiBcIiArIEpTT04uc3RyaW5naWZ5KHJlc2l6ZVJlY3QsIG51bGwsIFwiICBcIikpO1xuXG4gICAgICAgIC8vIFRPRE86IGl0IGxvb2tzIGxpa2UgdGhlcmUncyBhbiBpc3N1ZSB3aXRoIHBhcmVudEVsZW1lbnQgYmVpbmcgbWlzc2luZ1xuICAgICAgICAvLyBoZXJlLiAgSWYgdGhlIHBhcmVudEVsZW1lbnQgaXMgbWlzc2luZyBJIHByb2JhYmx5IG5lZWQgdG8gaWdub3JlIHRoZVxuICAgICAgICAvLyBpbnRlcnNlY3RlZCBib3hlcz9cblxuICAgICAgICBpZiAoISBlbGVtZW50LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IFwiRWxlbWVudCBub3Qgd2l0aGluIERPTTogXCI7XG4gICAgICAgICAgICBsb2cuZXJyb3IobXNnLCBlbGVtZW50KTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgaW50ZXJzZWN0ZWRFbGVtZW50cyA9IGVsZW1lbnQucGFyZW50RWxlbWVudCEucXVlcnlTZWxlY3RvckFsbChpbnRlcnNlY3RlZEVsZW1lbnRzU2VsZWN0b3IpO1xuXG4gICAgICAgIGNvbnN0IGJveGVzOiBIVE1MRWxlbWVudFtdXG4gICAgICAgICAgICA9IEFycmF5LmZyb20oaW50ZXJzZWN0ZWRFbGVtZW50cylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihjdXJyZW50ID0+IGN1cnJlbnQgIT09IGVsZW1lbnQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoY3VycmVudCA9PiBjdXJyZW50IGFzIEhUTUxFbGVtZW50KTtcblxuICAgICAgICAvLyBtYWtlIHN1cmUgdGhhdCBvdXIgYm94ZXMgYXJlbid0IHRoZSBzYW1lIElEIGFzIHRoZSBlbGVtZW50LiB3ZSBjYW5cbiAgICAgICAgLy8gcmVtb3ZlIHRoaXMgd2hlbiB3ZSBnbyB0byBwcm9kdWN0aW9uXG4gICAgICAgIGJveGVzLmZvckVhY2goY3VycmVudCA9PiBjdXJyZW50LmdldEF0dHJpYnV0ZShcImlkXCIpICE9PSBlbGVtZW50LmdldEF0dHJpYnV0ZShcImlkXCIpKTtcblxuICAgICAgICBjb25zdCBpbnRlcnNlY3RlZFJlY3RzOiBSZWN0W10gPSBbXTtcblxuICAgICAgICBib3hlcy5mb3JFYWNoKGJveCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGJveFJlY3QgPSBSZWN0cy5mcm9tRWxlbWVudFN0eWxlKGJveCk7XG5cbiAgICAgICAgICAgIGlmIChSZWN0cy5pbnRlcnNlY3QoYm94UmVjdCwgcmVzaXplUmVjdCkpIHtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3RlZFJlY3RzLnB1c2goYm94UmVjdCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJlc2l6ZVJlY3QsXG4gICAgICAgICAgICBpbnRlcnNlY3RlZFJlY3RzXG4gICAgICAgIH07XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBpbnRlcmFjdGlvbkV2ZW50XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIF9jb21wdXRlT3JpZ2luWFkoaW50ZXJhY3Rpb25FdmVudDogYW55KSB7XG5cbiAgICAgICAgY29uc3QgZGVsdGEgPSB7XG4gICAgICAgICAgICB4OiBpbnRlcmFjdGlvbkV2ZW50LnBhZ2VYIC0gaW50ZXJhY3Rpb25FdmVudC5faW50ZXJhY3Rpb24uY29vcmRzLnN0YXJ0LnBhZ2UueCxcbiAgICAgICAgICAgIHk6IGludGVyYWN0aW9uRXZlbnQucGFnZVkgLSBpbnRlcmFjdGlvbkV2ZW50Ll9pbnRlcmFjdGlvbi5jb29yZHMuc3RhcnQucGFnZS55XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbG9nLmluZm8oYGRyYWdtb3ZlOiBkZWx0YS54OiAke2RlbHRhLnh9IGFuZCBkZWx0YS55OiAke2RlbHRhLnl9YCk7XG4gICAgICAgIC8vIGxvZy5pbmZvKGBkcmFnbW92ZTogaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5zdGFydENvb3Jkcy5wYWdlOiBgXG4gICAgICAgIC8vICsgSlNPTi5zdHJpbmdpZnkoaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5zdGFydENvb3Jkcy5wYWdlKSApO1xuICAgICAgICAvLyBsb2cuaW5mbyhgZHJhZ21vdmU6IHRlc3REZWx0YTogYCArIEpTT04uc3RyaW5naWZ5KGRlbHRhKSk7XG5cbiAgICAgICAgY29uc3QgeCA9IGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24uc3RhcnRUYXJnZXRSZWN0LmxlZnQgKyBkZWx0YS54O1xuICAgICAgICBjb25zdCB5ID0gaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbi5zdGFydFRhcmdldFJlY3QudG9wICsgZGVsdGEueTtcblxuICAgICAgICByZXR1cm4ge3gsIHl9O1xuXG4gICAgfVxuXG5cbiAgICBwcml2YXRlIF9tb3ZlVGFyZ2V0RWxlbWVudCh4OiBudW1iZXIsIHk6IG51bWJlciwgdGFyZ2V0OiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgIHRhcmdldC5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7XG4gICAgICAgIHRhcmdldC5zdHlsZS50b3AgPSBgJHt5fXB4YDtcblxuICAgICAgICAvLyB1cGRhdGUgdGhlIHBvc2l0aW9uIGF0dHJpYnV0ZXNcbiAgICAgICAgdGFyZ2V0LnNldEF0dHJpYnV0ZSgnZGF0YS14JywgYCR7eH1gKTtcbiAgICAgICAgdGFyZ2V0LnNldEF0dHJpYnV0ZSgnZGF0YS15JywgYCR7eX1gKTtcblxuICAgICAgICAvLyB1cGRhdGVUYXJnZXRUZXh0KHRhcmdldCk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZXNpemVUYXJnZXRFbGVtZW50KHJlY3Q6IFJlY3QsIHRhcmdldDogSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICAvLyBmaXJzdCBtb3ZlIGl0IHRoZSBzYW1lIHdheSBhcyBpZiBpdCB3ZXJlIGRyYWdnZWRcbiAgICAgICAgdGhpcy5fbW92ZVRhcmdldEVsZW1lbnQocmVjdC5sZWZ0LCByZWN0LnRvcCwgdGFyZ2V0KTtcblxuICAgICAgICAvLyBub3cgc2V0IHRoZSB3aWR0aCBhbmQgaGVpZ2h0XG4gICAgICAgIHRhcmdldC5zdHlsZS53aWR0aCAgPSBgJHtyZWN0LndpZHRofXB4YDtcbiAgICAgICAgdGFyZ2V0LnN0eWxlLmhlaWdodCA9IGAke3JlY3QuaGVpZ2h0fXB4YDtcblxuICAgIH1cblxuICAgIHByaXZhdGUgX2NhcHR1cmVTdGFydFRhcmdldFJlY3QoaW50ZXJhY3Rpb25FdmVudDogYW55KSB7XG4gICAgICAgIC8vIHRoaXMgbW9kaWZpZXMgaW50ZXJhY3Rpb25FdmVudC5pbnRlcmFjdGlvbiBieSBzaWRlIGVmZmVjdCB3aGljaCBJXG4gICAgICAgIC8vIGRvbid0IGxpa2UuXG4gICAgICAgIGludGVyYWN0aW9uRXZlbnQuaW50ZXJhY3Rpb24uc3RhcnRUYXJnZXRSZWN0ID0gUmVjdHMuZnJvbUVsZW1lbnRTdHlsZShpbnRlcmFjdGlvbkV2ZW50LnRhcmdldCk7XG4gICAgfVxuXG59XG4iXX0=