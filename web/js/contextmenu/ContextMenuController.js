"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const Elements_1 = require("../util/Elements");
const ContextMenuType_1 = require("./ContextMenuType");
const MatchingSelector_1 = require("./MatchingSelector");
const AnnotationDescriptors_1 = require("../metadata/AnnotationDescriptors");
const Logger_1 = require("polar-shared/src/logger/Logger");
const TriggerEvent_1 = require("./TriggerEvent");
const DocDescriptor_1 = require("../metadata/DocDescriptor");
const DocFormatFactory_1 = require("../docformat/DocFormatFactory");
const Functions_1 = require("polar-shared/src/util/Functions");
const BrowserContextMenus_1 = require("./browser/BrowserContextMenus");
const Platforms_1 = require("polar-shared/src/util/Platforms");
const log = Logger_1.Logger.create();
class ContextMenuController {
    constructor(model) {
        this.model = model;
        if (electron_1.ipcRenderer) {
            electron_1.ipcRenderer.on('context-menu-command', (event, arg) => {
            });
        }
    }
    start() {
        log.info("Starting ContextMenuController");
        if (Platforms_1.Platforms.isDesktop()) {
            BrowserContextMenus_1.BrowserContextMenus.create();
            document.querySelectorAll(".page").forEach((targetElement) => {
                this.registerPageContextMenuListener(targetElement);
            });
        }
        else {
            log.warn("Not running context menu on mobile device");
        }
    }
    registerPageContextMenuListener(targetElement) {
        targetElement.addEventListener('contextmenu', (event) => {
            this.onContextMenuHandler(event, [".text-highlight",
                ".area-highlight",
                ".pagemark",
                ".page"]);
            event.preventDefault();
        });
    }
    registerDefaultContextMenuListener(targetElement) {
        targetElement.addEventListener('contextmenu', (event) => {
            this.onContextMenuHandler(event, ["*"]);
            event.preventDefault();
        });
    }
    onContextMenuHandler(event, annotationSelectors) {
        const matchingSelectors = ContextMenuController.elementsFromEventMatchingSelectors(event, annotationSelectors);
        const contextMenuTypes = [];
        Functions_1.forDict(matchingSelectors, (selector, current) => {
            if (current.elements.length > 0) {
                contextMenuTypes.push(ContextMenuController.toContextMenuType(current.selector));
            }
        });
        const docDescriptor = new DocDescriptor_1.DocDescriptor({
            fingerprint: this.model.docMeta.docInfo.fingerprint
        });
        log.info("Creating context menu for contextMenuTypes: ", contextMenuTypes);
        const pageElement = Elements_1.Elements.untilRoot(event.target, ".page");
        const docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
        const pageNum = docFormat.getPageNumFromPageElement(pageElement);
        const eventTargetOffset = Elements_1.Elements.getRelativeOffsetRect(event.target, pageElement);
        const pageOffset = {
            x: eventTargetOffset.left + event.offsetX,
            y: eventTargetOffset.top + event.offsetY
        };
        const triggerEvent = TriggerEvent_1.TriggerEvent.create({
            point: {
                x: event.pageX,
                y: event.pageY
            },
            points: {
                page: {
                    x: event.pageX,
                    y: event.pageY
                },
                client: {
                    x: event.clientX,
                    y: event.clientY
                },
                offset: {
                    x: event.offsetX,
                    y: event.offsetY
                },
                pageOffset
            },
            pageNum,
            contextMenuTypes,
            matchingSelectors,
            docDescriptor
        });
        BrowserContextMenus_1.BrowserContextMenus.trigger(triggerEvent, event);
    }
    static withActivePagemarks(closure) {
        const elements = Array.from(document.querySelectorAll(".pagemark"));
        const elementStyleRestores = [];
        for (const element of elements) {
            elementStyleRestores.push({
                element, pointerEvents: element.style.pointerEvents
            });
            element.style.pointerEvents = 'auto';
        }
        const result = closure();
        for (const restore of elementStyleRestores) {
            restore.element.style.pointerEvents = restore.pointerEvents;
        }
        return result;
    }
    static elementsFromEvent(event) {
        if (event.target instanceof HTMLElement) {
            const point = { x: event.clientX, y: event.clientY };
            const doc = event.target.ownerDocument;
            if (doc) {
                return this.withActivePagemarks(() => {
                    return doc.elementsFromPoint(point.x, point.y);
                });
            }
        }
        return [];
    }
    static toContextMenuType(selector) {
        let result = selector.toUpperCase();
        result = result.replace(".", "");
        result = result.replace("-", "_");
        return ContextMenuType_1.ContextMenuTypes.fromString(result);
    }
    static elementsFromEventMatchingSelectors(event, selectors) {
        const result = {};
        selectors.forEach(selector => {
            result[selector] = new MatchingSelector_1.MatchingSelector(selector, [], []);
        });
        const elements = ContextMenuController.elementsFromEvent(event);
        elements.forEach((element) => {
            selectors.forEach(selector => {
                if (element.matches(selector)) {
                    const matchingSelector = result[selector];
                    matchingSelector.elements.push(element);
                    const annotationDescriptor = AnnotationDescriptors_1.AnnotationDescriptors.createFromElement(element);
                    if (annotationDescriptor) {
                        matchingSelector.annotationDescriptors.push(annotationDescriptor);
                    }
                }
            });
        });
        return result;
    }
}
exports.ContextMenuController = ContextMenuController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGV4dE1lbnVDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ29udGV4dE1lbnVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQXFDO0FBRXJDLCtDQUEwQztBQUMxQyx1REFBb0U7QUFDcEUseURBQW9EO0FBQ3BELDZFQUF3RTtBQUN4RSwyREFBc0Q7QUFDdEQsaURBQTRDO0FBQzVDLDZEQUF3RDtBQUN4RCxvRUFBK0Q7QUFDL0QsK0RBQXdEO0FBRXhELHVFQUFrRTtBQUVsRSwrREFBMEQ7QUFFMUQsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBUzVCLE1BQWEscUJBQXFCO0lBSTlCLFlBQVksS0FBWTtRQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLHNCQUFXLEVBQUU7WUFFYixzQkFBVyxDQUFDLEVBQUUsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLEtBQVUsRUFBRSxHQUFRLEVBQUUsRUFBRTtZQUtoRSxDQUFDLENBQUMsQ0FBQztTQUVOO0lBQ0wsQ0FBQztJQUVNLEtBQUs7UUFLUixHQUFHLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFHM0MsSUFBSSxxQkFBUyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBRXZCLHlDQUFtQixDQUFDLE1BQU0sRUFBRSxDQUFDO1lBRTdCLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxhQUFhLEVBQUUsRUFBRTtnQkFDekQsSUFBSSxDQUFDLCtCQUErQixDQUFlLGFBQWEsQ0FBQyxDQUFDO1lBQ3RFLENBQUMsQ0FBQyxDQUFDO1NBRU47YUFBTTtZQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsMkNBQTJDLENBQUMsQ0FBQztTQUN6RDtJQUVMLENBQUM7SUFFTywrQkFBK0IsQ0FBQyxhQUEwQjtRQUU5RCxhQUFhLENBQUMsZ0JBQWdCLENB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b0IsR0FBRyw2Q0FBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFFOUUsSUFBSSxvQkFBb0IsRUFBRTt3QkFDdEIsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7cUJBQ3JFO2lCQUNKO1lBRUwsQ0FBQyxDQUFDLENBQUM7UUFFUCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sTUFBTSxDQUFDO0lBRWxCLENBQUM7Q0FFSjtBQXRQRCxzREFzUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2lwY1JlbmRlcmVyfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQge01vZGVsfSBmcm9tICcuLi9tb2RlbC9Nb2RlbCc7XG5pbXBvcnQge0VsZW1lbnRzfSBmcm9tICcuLi91dGlsL0VsZW1lbnRzJztcbmltcG9ydCB7Q29udGV4dE1lbnVUeXBlLCBDb250ZXh0TWVudVR5cGVzfSBmcm9tICcuL0NvbnRleHRNZW51VHlwZSc7XG5pbXBvcnQge01hdGNoaW5nU2VsZWN0b3J9IGZyb20gJy4vTWF0Y2hpbmdTZWxlY3Rvcic7XG5pbXBvcnQge0Fubm90YXRpb25EZXNjcmlwdG9yc30gZnJvbSAnLi4vbWV0YWRhdGEvQW5ub3RhdGlvbkRlc2NyaXB0b3JzJztcbmltcG9ydCB7TG9nZ2VyfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtUcmlnZ2VyRXZlbnR9IGZyb20gJy4vVHJpZ2dlckV2ZW50JztcbmltcG9ydCB7RG9jRGVzY3JpcHRvcn0gZnJvbSAnLi4vbWV0YWRhdGEvRG9jRGVzY3JpcHRvcic7XG5pbXBvcnQge0RvY0Zvcm1hdEZhY3Rvcnl9IGZyb20gJy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXRGYWN0b3J5JztcbmltcG9ydCB7Zm9yRGljdH0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy91dGlsL0Z1bmN0aW9ucyc7XG5pbXBvcnQge0VsZWN0cm9uQ29udGV4dE1lbnVzfSBmcm9tICcuL2VsZWN0cm9uL0VsZWN0cm9uQ29udGV4dE1lbnVzJztcbmltcG9ydCB7QnJvd3NlckNvbnRleHRNZW51c30gZnJvbSAnLi9icm93c2VyL0Jyb3dzZXJDb250ZXh0TWVudXMnO1xuaW1wb3J0IHtCcm93c2VyQ29udGV4dE1lbnV9IGZyb20gJy4vYnJvd3Nlci9Ccm93c2VyQ29udGV4dE1lbnUnO1xuaW1wb3J0IHtQbGF0Zm9ybXN9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL3V0aWwvUGxhdGZvcm1zXCI7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuLyoqXG4gKiBIYW5kbGVzIGxpc3RlbmluZyBmb3IgY29udGV4dCBtZW51cyBhbmQgdGhlbiBjYWxsaW5nIGJhY2sgdGhlIHByb3BlciBoYW5kbGVyLlxuICpcbiAqIElQQyBtZXNzYWdlczpcbiAqXG4gKiBjb250ZXh0LW1lbnUtY3JlYXRlLWZsYXNoY2FyZDogb3BlbiB0aGUgJ2NyZWF0ZSBmbGFzaGNhcmQnIG1vZGFsLlxuICovXG5leHBvcnQgY2xhc3MgQ29udGV4dE1lbnVDb250cm9sbGVyIHtcblxuICAgIHByaXZhdGUgbW9kZWw6IE1vZGVsO1xuXG4gICAgY29uc3RydWN0b3IobW9kZWw6IE1vZGVsKSB7XG4gICAgICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcblxuICAgICAgICBpZiAoaXBjUmVuZGVyZXIpIHtcblxuICAgICAgICAgICAgaXBjUmVuZGVyZXIub24oJ2NvbnRleHQtbWVudS1jb21tYW5kJywgKGV2ZW50OiBhbnksIGFyZzogYW55KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBJIGRvbid0IHRoaW5rIHdlIG5lZWQgdG8gbGlzdGVuIHRvIHRoZXNlIGhlcmUgYnV0IHJhdGhlciBpbiB0aGVcbiAgICAgICAgICAgICAgICAvLyBzcGVjaWZpYyBjb250cm9sbGVycy5cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpIHtcblxuICAgICAgICAvLyBUT0RPOiB0aGlzIHNob3VsZCBiZSByZWZhY3RvcmVkIHRvIG1ha2UgaXQgdGVzdGFibGUgd2l0aCBqc2RvbSBvbmNlXG4gICAgICAgIC8vIEkgZ2V0IGl0IHdvcmtpbmcuXG5cbiAgICAgICAgbG9nLmluZm8oXCJTdGFydGluZyBDb250ZXh0TWVudUNvbnRyb2xsZXJcIik7XG5cblxuICAgICAgICBpZiAoUGxhdGZvcm1zLmlzRGVza3RvcCgpKSB7XG5cbiAgICAgICAgICAgIEJyb3dzZXJDb250ZXh0TWVudXMuY3JlYXRlKCk7XG5cbiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIucGFnZVwiKS5mb3JFYWNoKCh0YXJnZXRFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclBhZ2VDb250ZXh0TWVudUxpc3RlbmVyKDxIVE1MRWxlbWVudD4gdGFyZ2V0RWxlbWVudCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nLndhcm4oXCJOb3QgcnVubmluZyBjb250ZXh0IG1lbnUgb24gbW9iaWxlIGRldmljZVwiKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWdpc3RlclBhZ2VDb250ZXh0TWVudUxpc3RlbmVyKHRhcmdldEVsZW1lbnQ6IEhUTUxFbGVtZW50KSB7XG5cbiAgICAgICAgdGFyZ2V0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjb250ZXh0bWVudScsIChldmVudCkgPT4ge1xuXG4gICAgICAgICAgICB0aGlzLm9uQ29udGV4dE1lbnVIYW5kbGVyKGV2ZW50LCBbIFwiLnRleHQtaGlnaGxpZ2h0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiLmFyZWEtaGlnaGxpZ2h0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiLnBhZ2VtYXJrXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiLnBhZ2VcIl0gKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlZ2lzdGVyRGVmYXVsdENvbnRleHRNZW51TGlzdGVuZXIodGFyZ2V0RWxlbWVudDogSFRNTEVsZW1lbnQpIHtcblxuICAgICAgICB0YXJnZXRFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgKGV2ZW50KSA9PiB7XG5cbiAgICAgICAgICAgIHRoaXMub25Db250ZXh0TWVudUhhbmRsZXIoZXZlbnQsIFsgXCIqXCIgXSApO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgb25Db250ZXh0TWVudUhhbmRsZXIoZXZlbnQ6IE1vdXNlRXZlbnQsIGFubm90YXRpb25TZWxlY3RvcnM6IHN0cmluZ1tdKSB7XG5cbiAgICAgICAgY29uc3QgbWF0Y2hpbmdTZWxlY3RvcnNcbiAgICAgICAgICAgID0gQ29udGV4dE1lbnVDb250cm9sbGVyLmVsZW1lbnRzRnJvbUV2ZW50TWF0Y2hpbmdTZWxlY3RvcnMoZXZlbnQsIGFubm90YXRpb25TZWxlY3RvcnMgKTtcblxuICAgICAgICBjb25zdCBjb250ZXh0TWVudVR5cGVzOiBDb250ZXh0TWVudVR5cGVbXSA9IFtdO1xuXG4gICAgICAgIGZvckRpY3QobWF0Y2hpbmdTZWxlY3RvcnMsIChzZWxlY3Rvcjogc3RyaW5nLCBjdXJyZW50OiBNYXRjaGluZ1NlbGVjdG9yKSA9PiB7XG4gICAgICAgICAgICBpZiAoY3VycmVudC5lbGVtZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgY29udGV4dE1lbnVUeXBlcy5wdXNoKENvbnRleHRNZW51Q29udHJvbGxlci50b0NvbnRleHRNZW51VHlwZShjdXJyZW50LnNlbGVjdG9yKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGRvY0Rlc2NyaXB0b3IgPSBuZXcgRG9jRGVzY3JpcHRvcih7XG4gICAgICAgICAgICBmaW5nZXJwcmludDogdGhpcy5tb2RlbC5kb2NNZXRhLmRvY0luZm8uZmluZ2VycHJpbnRcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbG9nLmluZm8oXCJDcmVhdGluZyBjb250ZXh0IG1lbnUgZm9yIGNvbnRleHRNZW51VHlwZXM6IFwiLCBjb250ZXh0TWVudVR5cGVzKTtcblxuICAgICAgICBjb25zdCBwYWdlRWxlbWVudCA9IEVsZW1lbnRzLnVudGlsUm9vdCg8SFRNTEVsZW1lbnQ+IGV2ZW50LnRhcmdldCwgXCIucGFnZVwiKTtcblxuICAgICAgICBjb25zdCBkb2NGb3JtYXQgPSBEb2NGb3JtYXRGYWN0b3J5LmdldEluc3RhbmNlKCk7XG5cbiAgICAgICAgY29uc3QgcGFnZU51bSA9IGRvY0Zvcm1hdC5nZXRQYWdlTnVtRnJvbVBhZ2VFbGVtZW50KHBhZ2VFbGVtZW50KTtcblxuICAgICAgICBjb25zdCBldmVudFRhcmdldE9mZnNldCA9IEVsZW1lbnRzLmdldFJlbGF0aXZlT2Zmc2V0UmVjdCg8SFRNTEVsZW1lbnQ+IGV2ZW50LnRhcmdldCwgcGFnZUVsZW1lbnQpO1xuXG4gICAgICAgIC8vIGNvbXB1dGUgdGhlIG9mZnNldCBvZiB0aGUgZXZlbnQgcmVsYXRpdmUgdG8gdGhlIHBhZ2Ugd2UncmVcbiAgICAgICAgLy8gdmlld2luZ1xuICAgICAgICBjb25zdCBwYWdlT2Zmc2V0ID0ge1xuXG4gICAgICAgICAgICB4OiBldmVudFRhcmdldE9mZnNldC5sZWZ0ICsgZXZlbnQub2Zmc2V0WCxcbiAgICAgICAgICAgIHk6IGV2ZW50VGFyZ2V0T2Zmc2V0LnRvcCArIGV2ZW50Lm9mZnNldFlcblxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHRyaWdnZXJFdmVudCA9IFRyaWdnZXJFdmVudC5jcmVhdGUoe1xuICAgICAgICAgICAgcG9pbnQ6IHtcbiAgICAgICAgICAgICAgICB4OiBldmVudC5wYWdlWCxcbiAgICAgICAgICAgICAgICB5OiBldmVudC5wYWdlWVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBvaW50czoge1xuICAgICAgICAgICAgICAgIHBhZ2U6IHtcbiAgICAgICAgICAgICAgICAgICAgeDogZXZlbnQucGFnZVgsXG4gICAgICAgICAgICAgICAgICAgIHk6IGV2ZW50LnBhZ2VZXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgICAgICAgICAgeDogZXZlbnQuY2xpZW50WCxcbiAgICAgICAgICAgICAgICAgICAgeTogZXZlbnQuY2xpZW50WVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb2Zmc2V0OiB7XG4gICAgICAgICAgICAgICAgICAgIHg6IGV2ZW50Lm9mZnNldFgsXG4gICAgICAgICAgICAgICAgICAgIHk6IGV2ZW50Lm9mZnNldFlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHBhZ2VPZmZzZXRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYWdlTnVtLFxuICAgICAgICAgICAgY29udGV4dE1lbnVUeXBlcyxcbiAgICAgICAgICAgIG1hdGNoaW5nU2VsZWN0b3JzLFxuICAgICAgICAgICAgZG9jRGVzY3JpcHRvclxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBFbGVjdHJvbkNvbnRleHRNZW51cy50cmlnZ2VyKHRyaWdnZXJFdmVudCk7XG5cbiAgICAgICAgQnJvd3NlckNvbnRleHRNZW51cy50cmlnZ2VyKHRyaWdnZXJFdmVudCwgZXZlbnQpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFnZW1hcmtzIGhhdmUgcG9pbnRlci1ldmVudHM6IG5vbmUgYW5kIHRoZXkgZG9uJ3Qgc2hvdyB1cCB3aGVuIHVzaW5nXG4gICAgICogZWxlbWVudHNGcm9tUG9pbnQgc28gd2UgaGF2ZSB0byB0ZW1wb3JhcmlseSBlbmFibGUgdGhlbS5cbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyB3aXRoQWN0aXZlUGFnZW1hcmtzPFQ+KGNsb3N1cmU6ICgpID0+IFQpIHtcblxuICAgICAgICBpbnRlcmZhY2UgRWxlbWVudFN0eWxlUmVzdG9yZSB7XG4gICAgICAgICAgICByZWFkb25seSBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgIHJlYWRvbmx5IHBvaW50ZXJFdmVudHM6IHN0cmluZyB8IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBlbGVtZW50cyA9XG4gICAgICAgICAgICA8SFRNTEVsZW1lbnRbXT4gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnBhZ2VtYXJrXCIpKTtcblxuICAgICAgICBjb25zdCBlbGVtZW50U3R5bGVSZXN0b3JlczogRWxlbWVudFN0eWxlUmVzdG9yZVtdID0gW107XG5cbiAgICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7XG5cbiAgICAgICAgICAgIGVsZW1lbnRTdHlsZVJlc3RvcmVzLnB1c2goe1xuICAgICAgICAgICAgICAgIGVsZW1lbnQsIHBvaW50ZXJFdmVudHM6IGVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50c1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdhdXRvJztcblxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gY2xvc3VyZSgpO1xuXG4gICAgICAgIGZvciAoY29uc3QgcmVzdG9yZSBvZiBlbGVtZW50U3R5bGVSZXN0b3Jlcykge1xuICAgICAgICAgICAgcmVzdG9yZS5lbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSByZXN0b3JlLnBvaW50ZXJFdmVudHM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgc3RhdGljIGVsZW1lbnRzRnJvbUV2ZW50KGV2ZW50OiBNb3VzZUV2ZW50KSB7XG5cbiAgICAgICAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTQxNzY5ODgvd2h5LWlzLWRvY3VtZW50LWVsZW1lbnRmcm9tcG9pbnQtYWZmZWN0ZWQtYnktcG9pbnRlci1ldmVudHMtbm9uZVxuXG4gICAgICAgIGlmIChldmVudC50YXJnZXQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgICAgICAvLyB0aGUgcG9pbnQgbXVzdCBiZSByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnRcbiAgICAgICAgICAgIGNvbnN0IHBvaW50ID0ge3g6IGV2ZW50LmNsaWVudFgsIHk6IGV2ZW50LmNsaWVudFl9O1xuXG4gICAgICAgICAgICBjb25zdCBkb2MgPSBldmVudC50YXJnZXQub3duZXJEb2N1bWVudDtcblxuICAgICAgICAgICAgaWYgKGRvYykge1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMud2l0aEFjdGl2ZVBhZ2VtYXJrcygoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiA8SFRNTEVsZW1lbnRbXT4gZG9jLmVsZW1lbnRzRnJvbVBvaW50KHBvaW50LngsIHBvaW50LnkpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBbXTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgdG9Db250ZXh0TWVudVR5cGUoc2VsZWN0b3I6IHN0cmluZyk6IENvbnRleHRNZW51VHlwZSB7XG4gICAgICAgIGxldCByZXN1bHQgPSBzZWxlY3Rvci50b1VwcGVyQ2FzZSgpO1xuICAgICAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZShcIi5cIiwgXCJcIik7XG4gICAgICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKFwiLVwiLCBcIl9cIik7XG4gICAgICAgIHJldHVybiBDb250ZXh0TWVudVR5cGVzLmZyb21TdHJpbmcocmVzdWx0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSByZXN1bHQgYnkgbG9va2luZyBhdCBhbGwgdGhlIGV2ZW50cywgYW5kIGFsbCB0aGUgc2VsZWN0b3JzLFxuICAgICAqIGJ1aWxkaW5nIHVwIGFuIGluZGV4IG9mIG1hdGNoaW5nIGVsZW1lbnRzIGF0IHRoZSBwb3NpdGlvbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBldmVudFxuICAgICAqIEBwYXJhbSBzZWxlY3RvcnNcbiAgICAgKi9cbiAgICAgcHVibGljIHN0YXRpYyBlbGVtZW50c0Zyb21FdmVudE1hdGNoaW5nU2VsZWN0b3JzKGV2ZW50OiBNb3VzZUV2ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3JzOiBzdHJpbmdbXSk6IE1hdGNoaW5nU2VsZWN0b3JNYXAge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogTWF0Y2hpbmdTZWxlY3Rvck1hcCA9IHt9O1xuXG4gICAgICAgIHNlbGVjdG9ycy5mb3JFYWNoKHNlbGVjdG9yID0+IHtcbiAgICAgICAgICAgIHJlc3VsdFtzZWxlY3Rvcl0gPSBuZXcgTWF0Y2hpbmdTZWxlY3RvcihzZWxlY3RvciwgW10sIFtdKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZWxlbWVudHMgPSBDb250ZXh0TWVudUNvbnRyb2xsZXIuZWxlbWVudHNGcm9tRXZlbnQoZXZlbnQpO1xuXG4gICAgICAgIGVsZW1lbnRzLmZvckVhY2goKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiB7XG5cbiAgICAgICAgICAgIHNlbGVjdG9ycy5mb3JFYWNoKHNlbGVjdG9yID0+IHtcblxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm1hdGNoZXMoc2VsZWN0b3IpKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0Y2hpbmdTZWxlY3RvciA9IHJlc3VsdFtzZWxlY3Rvcl07XG5cbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hpbmdTZWxlY3Rvci5lbGVtZW50cy5wdXNoKGVsZW1lbnQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFubm90YXRpb25EZXNjcmlwdG9yID0gQW5ub3RhdGlvbkRlc2NyaXB0b3JzLmNyZWF0ZUZyb21FbGVtZW50KGVsZW1lbnQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChhbm5vdGF0aW9uRGVzY3JpcHRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hpbmdTZWxlY3Rvci5hbm5vdGF0aW9uRGVzY3JpcHRvcnMucHVzaChhbm5vdGF0aW9uRGVzY3JpcHRvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbn1cblxuLy8gbm9pbnNwZWN0aW9uIFRzTGludFxuZXhwb3J0IHR5cGUgTWF0Y2hpbmdTZWxlY3Rvck1hcCA9IHtba2V5OiBzdHJpbmddOiBNYXRjaGluZ1NlbGVjdG9yfTtcbiJdfQ==