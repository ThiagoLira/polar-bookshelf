"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const TriggerEvent_1 = require("../TriggerEvent");
const electron_1 = require("electron");
const Logger_1 = require("polar-shared/src/logger/Logger");
const Broadcaster_1 = require("../../ipc/Broadcaster");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const ContextMenuType_1 = require("../ContextMenuType");
const AnnotationSidebarClient_1 = require("../../annotation_sidebar/AnnotationSidebarClient");
const PagemarkModes_1 = require("../../metadata/PagemarkModes");
const ContextMenuMessages_1 = require("../ContextMenuMessages");
const Arrays_1 = require("polar-shared/src/util/Arrays");
const log = Logger_1.Logger.create();
class ElectronContextMenu {
    constructor() {
        electron_1.ipcMain.on('context-menu-trigger', (event, message) => {
            const triggerEvent = TriggerEvent_1.TriggerEvent.create(message);
            this.trigger(triggerEvent, event.sender);
        });
        new Broadcaster_1.Broadcaster('create-annotation');
    }
    trigger(triggerEvent, sender) {
        Preconditions_1.Preconditions.assertNotNull(sender, "sender");
        const window = electron_1.BrowserWindow.getFocusedWindow();
        const ctxMenu = this.createContextMenu(triggerEvent, sender);
        ctxMenu.popup({
            window
        });
    }
    cmdNotify(command, triggerEvent, sender) {
        const event = {
            command,
            matchingSelectors: triggerEvent.matchingSelectors,
            docDescriptor: triggerEvent.docDescriptor
        };
        sender.send("context-menu-command", event);
    }
    createContextMenu(triggerEvent, sender) {
        Preconditions_1.Preconditions.assertNotNull(sender, "sender");
        const contextMenus = [];
        if (triggerEvent.contextMenuTypes.includes(ContextMenuType_1.ContextMenuType.PAGE)) {
            contextMenus.push(this.createPageContextMenu(triggerEvent, sender));
        }
        if (triggerEvent.contextMenuTypes.includes(ContextMenuType_1.ContextMenuType.TEXT_HIGHLIGHT)) {
            contextMenus.push(this.createTextHighlightContextMenu(triggerEvent, sender));
        }
        if (triggerEvent.contextMenuTypes.includes(ContextMenuType_1.ContextMenuType.AREA_HIGHLIGHT)) {
            contextMenus.push(this.createAreaHighlightContextMenu(triggerEvent, sender));
        }
        if (triggerEvent.contextMenuTypes.includes(ContextMenuType_1.ContextMenuType.PAGEMARK)) {
            contextMenus.push(this.createPagemarkContextMenu(triggerEvent, sender));
        }
        contextMenus.push(this.createDefaultContextMenu(triggerEvent, sender));
        const ctxMenu = new electron_1.Menu();
        Arrays_1.Arrays.createSiblings(contextMenus).forEach(contextMenuCursor => {
            contextMenuCursor.curr.items.forEach(menuItem => {
                ctxMenu.append(menuItem);
            });
            if (contextMenuCursor.curr.items.length > 0 && contextMenuCursor.next) {
                ctxMenu.append(new electron_1.MenuItem({
                    type: 'separator'
                }));
            }
        });
        return ctxMenu;
    }
    createTextHighlightContextMenu(triggerEvent, sender) {
        const ctxMenu = new electron_1.Menu();
        ctxMenu.append(this.createSubmenu('Text Highlight', [
            new electron_1.MenuItem({
                label: 'Delete',
                click: () => ContextMenuMessages_1.ContextMenuMessages.postContextMenuMessage("delete-text-highlight", triggerEvent)
            })
        ]));
        return ctxMenu;
    }
    createAreaHighlightContextMenu(triggerEvent, sender) {
        const ctxMenu = new electron_1.Menu();
        ctxMenu.append(this.createSubmenu('Area Highlight', [
            new electron_1.MenuItem({
                label: 'Delete',
                click: () => ContextMenuMessages_1.ContextMenuMessages.postContextMenuMessage("delete-area-highlight", triggerEvent)
            })
        ]));
        return ctxMenu;
    }
    createPagemarkContextMenu(triggerEvent, sender) {
        const ctxMenu = new electron_1.Menu();
        const createModeSubmenuItems = () => {
            return PagemarkModes_1.PagemarkModes.toDescriptors().map(current => {
                return new electron_1.MenuItem({
                    label: current.title,
                    click: () => ContextMenuMessages_1.ContextMenuMessages.postContextMenuMessage("set-pagemark-mode-" + current.key, triggerEvent)
                });
            });
        };
        ctxMenu.append(this.createSubmenu('Pagemark', [
            this.createSubmenu('Mode ...', createModeSubmenuItems()),
            new electron_1.MenuItem({
                label: 'Delete Pagemark',
                click: () => ContextMenuMessages_1.ContextMenuMessages.postContextMenuMessage("delete-pagemark", triggerEvent)
            })
        ]));
        return ctxMenu;
    }
    createPageContextMenu(triggerEvent, sender) {
        const ctxMenu = new electron_1.Menu();
        ctxMenu.append(new electron_1.MenuItem({
            label: 'Create Pagemark to Point',
            click: () => ContextMenuMessages_1.ContextMenuMessages.postContextMenuMessage("create-pagemark-to-point", triggerEvent)
        }));
        ctxMenu.append(new electron_1.MenuItem({
            label: 'Create Pagemark Box',
            click: () => ContextMenuMessages_1.ContextMenuMessages.postContextMenuMessage("create-pagemark", triggerEvent)
        }));
        ctxMenu.append(new electron_1.MenuItem({
            label: 'Create Area Highlight',
            click: () => ContextMenuMessages_1.ContextMenuMessages.postContextMenuMessage("create-area-highlight", triggerEvent)
        }));
        return ctxMenu;
    }
    createDefaultContextMenu(triggerEvent, sender) {
        const ctxMenu = new electron_1.Menu();
        ctxMenu.append(new electron_1.MenuItem({
            label: 'Toggle Annotation Sidebar',
            id: "toggle-annotation-sidebar",
            click: () => AnnotationSidebarClient_1.AnnotationSidebarClient.toggleAnnotationSidebar()
        }));
        ctxMenu.append(new electron_1.MenuItem({
            label: 'Inspect Element',
            id: "inspect",
            click: event => {
                const window = electron_1.BrowserWindow.getFocusedWindow();
                if (!window) {
                    throw new Error("No current window");
                }
                window.webContents.inspectElement(triggerEvent.point.x, triggerEvent.point.y);
                if (window.webContents.isDevToolsOpened()) {
                    window.webContents.devToolsWebContents.focus();
                }
            }
        }));
        return ctxMenu;
    }
    createSubmenu(label, menuItems) {
        const submenu = new electron_1.Menu();
        const submenuItem = new electron_1.MenuItem({
            label,
            type: 'submenu',
            submenu
        });
        menuItems.forEach(menuItem => {
            submenu.append(menuItem);
        });
        return submenuItem;
    }
}
exports.ElectronContextMenu = ElectronContextMenu;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWxlY3Ryb25Db250ZXh0TWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkVsZWN0cm9uQ29udGV4dE1lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrREFBNkM7QUFDN0MsdUNBQTZFO0FBQzdFLDJEQUFzRDtBQUN0RCx1REFBa0Q7QUFDbEQsa0VBQTZEO0FBQzdELHdEQUFtRDtBQUNuRCw4RkFBeUY7QUFDekYsZ0VBQTJEO0FBQzNELGdFQUEyRDtBQUUzRCx5REFBb0Q7QUFFcEQsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBUzVCLE1BQWEsbUJBQW1CO0lBRTVCO1FBR0ksa0JBQU8sQ0FBQyxFQUFFLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxLQUFxQixFQUFFLE9BQVksRUFBRSxFQUFFO1lBRXZFLE1BQU0sWUFBWSxHQUFHLDJCQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRWxELElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU3QyxDQUFDLENBQUMsQ0FBQztRQUdILElBQUkseUJBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBRXpDLENBQUM7SUFPTSxPQUFPLENBQUMsWUFBMEIsRUFBRSxNQUFtQjtRQUUxRCw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFOUMsTUFBTSxNQUFNLEdBQUcsd0JBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRWhELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFNN0QsT0FBTyxDQUFDLEtBQUssQ0FBZ0I7WUFDekIsTUFBTTtTQUNULENBQUMsQ0FBQztJQUVQLENBQUM7SUFVTyxTQUFTLENBQUMsT0FBZSxFQUFFLFlBQTBCLEVBQUUsTUFBbUI7UUFJOUUsTUFBTSxLQUFL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QixLQUFLLEVBQUUsaUJBQWlCO1lBQ3hCLEVBQUUsRUFBRSxTQUFTO1lBRWIsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUFFO2dCQUVYLE1BQU0sTUFBTSxHQUFHLHdCQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztnQkFFaEQsSUFBSSxDQUFFLE1BQU0sRUFBRTtvQkFDVixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7aUJBQ3hDO2dCQUlELE1BQU0sQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRTlFLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFO29CQUN2QyxNQUFNLENBQUMsV0FBVyxDQUFDLG1CQUFtQixDQUFDLEtBQUssRUFBRSxDQUFDO2lCQUNsRDtZQUVMLENBQUM7U0FFSixDQUFDLENBQUMsQ0FBQztRQUdKLE9BQU8sT0FBTyxDQUFDO0lBRW5CLENBQUM7SUFFTSxhQUFhLENBQUMsS0FBYSxFQUFFLFNBQXFCO1FBRXJELE1BQU0sT0FBTyxHQUFHLElBQUksZUFBSSxFQUFFLENBQUM7UUFFM0IsTUFBTSxXQUFXLEdBQUcsSUFBSSxtQkFBUSxDQUFDO1lBQzdCLEtBQUs7WUFDTCxJQUFJLEVBQUUsU0FBUztZQUNmLE9BQU87U0FDVixDQUFDLENBQUM7UUFFSCxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3pCLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFdBQVcsQ0FBQztJQUV2QixDQUFDO0NBRUo7QUE1VUQsa0RBNFVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtUcmlnZ2VyRXZlbnR9IGZyb20gJy4uL1RyaWdnZXJFdmVudCc7XG5pbXBvcnQge0Jyb3dzZXJXaW5kb3csIGlwY01haW4sIE1lbnUsIE1lbnVJdGVtLCBXZWJDb250ZW50c30gZnJvbSAnZWxlY3Ryb24nO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvbG9nZ2VyL0xvZ2dlcic7XG5pbXBvcnQge0Jyb2FkY2FzdGVyfSBmcm9tICcuLi8uLi9pcGMvQnJvYWRjYXN0ZXInO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtDb250ZXh0TWVudVR5cGV9IGZyb20gJy4uL0NvbnRleHRNZW51VHlwZSc7XG5pbXBvcnQge0Fubm90YXRpb25TaWRlYmFyQ2xpZW50fSBmcm9tICcuLi8uLi9hbm5vdGF0aW9uX3NpZGViYXIvQW5ub3RhdGlvblNpZGViYXJDbGllbnQnO1xuaW1wb3J0IHtQYWdlbWFya01vZGVzfSBmcm9tICcuLi8uLi9tZXRhZGF0YS9QYWdlbWFya01vZGVzJztcbmltcG9ydCB7Q29udGV4dE1lbnVNZXNzYWdlc30gZnJvbSAnLi4vQ29udGV4dE1lbnVNZXNzYWdlcyc7XG5pbXBvcnQgUG9wdXBPcHRpb25zID0gRWxlY3Ryb24uUG9wdXBPcHRpb25zO1xuaW1wb3J0IHtBcnJheXN9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL3V0aWwvQXJyYXlzXCI7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuLyoqXG4gKiBDYXJlZnVsIGhlcmUgYXMgdGhpcyBpcyBjb25mdXNpbmcuICBXZSdyZSB1c2luZyB0aGUgUkVNT1ZFIGludGVyZmFjZSBzbyB0aGVcbiAqIGNvbnRleHQgY2hhbmdlcy4gVGhpcyBjb2RlIGlzIHRyaWdnZXJlZCBmcm9tIHRoZSByZW5kZXJlciBidXQgdGhlbiBydW5zXG4gKiBpbiB0aGUgbWFpbiBwcm9jZXNzLlxuICpcbiAqIEBFbGVjdHJvbk1haW5Db250ZXh0XG4gKi9cbmV4cG9ydCBjbGFzcyBFbGVjdHJvbkNvbnRleHRNZW51IHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuXG4gICAgICAgIC8vIFRPRE86IG1vdmUgdGhpcyB0byBhIHN0YXJ0IG1ldGhvZC5cbiAgICAgICAgaXBjTWFpbi5vbignY29udGV4dC1tZW51LXRyaWdnZXInLCAoZXZlbnQ6IEVsZWN0cm9uLkV2ZW50LCBtZXNzYWdlOiBhbnkpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgdHJpZ2dlckV2ZW50ID0gVHJpZ2dlckV2ZW50LmNyZWF0ZShtZXNzYWdlKTtcblxuICAgICAgICAgICAgdGhpcy50cmlnZ2VyKHRyaWdnZXJFdmVudCwgZXZlbnQuc2VuZGVyKTtcblxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBub2luc3BlY3Rpb24gVHNMaW50OiBuby11bnVzZWQtZXhwcmVzc2lvblxuICAgICAgICBuZXcgQnJvYWRjYXN0ZXIoJ2NyZWF0ZS1hbm5vdGF0aW9uJyk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB0cmlnZ2VyRXZlbnQge1RyaWdnZXJFdmVudH1cbiAgICAgKiBAcGFyYW0gc2VuZGVyXG4gICAgICovXG4gICAgcHVibGljIHRyaWdnZXIodHJpZ2dlckV2ZW50OiBUcmlnZ2VyRXZlbnQsIHNlbmRlcjogV2ViQ29udGVudHMpIHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwoc2VuZGVyLCBcInNlbmRlclwiKTtcblxuICAgICAgICBjb25zdCB3aW5kb3cgPSBCcm93c2VyV2luZG93LmdldEZvY3VzZWRXaW5kb3coKTtcblxuICAgICAgICBjb25zdCBjdHhNZW51ID0gdGhpcy5jcmVhdGVDb250ZXh0TWVudSh0cmlnZ2VyRXZlbnQsIHNlbmRlcik7XG5cbiAgICAgICAgLy8gVGhlIGRvY3VtZW50YXRpb24gZm9yIHRoaXMgbG9va3Mgd3JvbmcgYW5kIGl0IGFjdHVhbGx5IHRha2VzIHRocmVlXG4gICAgICAgIC8vIGFyZ3VtZW50cyBub3QgYSBvYmplY3QuIE5vdGUgdGhhdCB3ZSBzaG91bGQgTk9UIGluY2x1ZGUgdGhlIG1vdXNlXG4gICAgICAgIC8vIHBvaW50IGFzIGJ5IGRlZmF1bHQgaXQgdXNlcyB0aGUgbW91c2UgcG9pbnQgYW55d2F5IHdoaWNoIGlzIGFsbW9zdFxuICAgICAgICAvLyBhbHdheXMgd2hhdCB3ZSB3YW50LlxuICAgICAgICBjdHhNZW51LnBvcHVwKDxQb3B1cE9wdGlvbnM+IHtcbiAgICAgICAgICAgIHdpbmRvd1xuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlbmQgdGhlIGFubm90YXRpb24gQkFDSyB0byB0aGUgc2VuZGVyIHdpdGggdGhlIHNwZWNpZmljIGFjdGlvbnMgdG8gdGFrZS5cbiAgICAgKlxuICAgICAqIEBkZXByZWNhdGVkIE1vdmUgdG8gcG9zdENvbnRleHRNZW51TWVzc2FnZVxuICAgICAqIEBwYXJhbSBjb21tYW5kXG4gICAgICogQHBhcmFtIHRyaWdnZXJFdmVudFxuICAgICAqIEBwYXJhbSBzZW5kZXJcbiAgICAgKi9cbiAgICBwcml2YXRlIGNtZE5vdGlmeShjb21tYW5kOiBzdHJpbmcsIHRyaWdnZXJFdmVudDogVHJpZ2dlckV2ZW50LCBzZW5kZXI6IFdlYkNvbnRlbnRzKSB7XG5cbiAgICAgICAgLy8gd2UncmUgc2VuZGluZyBiYWNrIExFU1MgZGF0YSBiZWNhdXNlIEkgdGhpbmsgYWxsIG9mIHRoZSBvcmlnaW5hbCBkYXRhXG4gICAgICAgIC8vIGlzIHByb2JhYmx5IG5vdCBuZWVkZWQuXG4gICAgICAgIGNvbnN0IGV2ZW50ID0ge1xuICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgIG1hdGNoaW5nU2VsZWN0b3JzOiB0cmlnZ2VyRXZlbnQubWF0Y2hpbmdTZWxlY3RvcnMsXG4gICAgICAgICAgICBkb2NEZXNjcmlwdG9yOiB0cmlnZ2VyRXZlbnQuZG9jRGVzY3JpcHRvclxuICAgICAgICB9O1xuXG4gICAgICAgIHNlbmRlci5zZW5kKFwiY29udGV4dC1tZW51LWNvbW1hbmRcIiwgZXZlbnQpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdHJpZ2dlckV2ZW50IHtUcmlnZ2VyRXZlbnR9XG4gICAgICogQHBhcmFtIHNlbmRlclxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlQ29udGV4dE1lbnUodHJpZ2dlckV2ZW50OiBUcmlnZ2VyRXZlbnQsIHNlbmRlcjogV2ViQ29udGVudHMpIHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydE5vdE51bGwoc2VuZGVyLCBcInNlbmRlclwiKTtcblxuICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gYSB0ZW1wbGF0ZSBhcyB0aGUgY29kZSBpcyBjbGVhbmVyXG5cbiAgICAgICAgY29uc3QgY29udGV4dE1lbnVzOiBNZW51W10gPSBbXTtcblxuICAgICAgICBpZiAodHJpZ2dlckV2ZW50LmNvbnRleHRNZW51VHlwZXMuaW5jbHVkZXMoQ29udGV4dE1lbnVUeXBlLlBBR0UpKSB7XG4gICAgICAgICAgICBjb250ZXh0TWVudXMucHVzaCh0aGlzLmNyZWF0ZVBhZ2VDb250ZXh0TWVudSh0cmlnZ2VyRXZlbnQsIHNlbmRlcikpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRyaWdnZXJFdmVudC5jb250ZXh0TWVudVR5cGVzLmluY2x1ZGVzKENvbnRleHRNZW51VHlwZS5URVhUX0hJR0hMSUdIVCkpIHtcbiAgICAgICAgICAgIGNvbnRleHRNZW51cy5wdXNoKHRoaXMuY3JlYXRlVGV4dEhpZ2hsaWdodENvbnRleHRNZW51KHRyaWdnZXJFdmVudCwgc2VuZGVyKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHJpZ2dlckV2ZW50LmNvbnRleHRNZW51VHlwZXMuaW5jbHVkZXMoQ29udGV4dE1lbnVUeXBlLkFSRUFfSElHSExJR0hUKSkge1xuICAgICAgICAgICAgY29udGV4dE1lbnVzLnB1c2godGhpcy5jcmVhdGVBcmVhSGlnaGxpZ2h0Q29udGV4dE1lbnUodHJpZ2dlckV2ZW50LCBzZW5kZXIpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0cmlnZ2VyRXZlbnQuY29udGV4dE1lbnVUeXBlcy5pbmNsdWRlcyhDb250ZXh0TWVudVR5cGUuUEFHRU1BUkspKSB7XG4gICAgICAgICAgICBjb250ZXh0TWVudXMucHVzaCh0aGlzLmNyZWF0ZVBhZ2VtYXJrQ29udGV4dE1lbnUodHJpZ2dlckV2ZW50LCBzZW5kZXIpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnRleHRNZW51cy5wdXNoKHRoaXMuY3JlYXRlRGVmYXVsdENvbnRleHRNZW51KHRyaWdnZXJFdmVudCwgc2VuZGVyKSk7XG5cbiAgICAgICAgY29uc3QgY3R4TWVudSA9IG5ldyBNZW51KCk7XG5cbiAgICAgICAgQXJyYXlzLmNyZWF0ZVNpYmxpbmdzKGNvbnRleHRNZW51cykuZm9yRWFjaChjb250ZXh0TWVudUN1cnNvciA9PiB7XG5cbiAgICAgICAgICAgIGNvbnRleHRNZW51Q3Vyc29yLmN1cnIuaXRlbXMuZm9yRWFjaChtZW51SXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgY3R4TWVudS5hcHBlbmQobWVudUl0ZW0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChjb250ZXh0TWVudUN1cnNvci5jdXJyLml0ZW1zLmxlbmd0aCA+IDAgJiYgY29udGV4dE1lbnVDdXJzb3IubmV4dCkge1xuICAgICAgICAgICAgICAgIGN0eE1lbnUuYXBwZW5kKG5ldyBNZW51SXRlbSh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzZXBhcmF0b3InXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBjdHhNZW51O1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdHJpZ2dlckV2ZW50IHtUcmlnZ2VyRXZlbnR9XG4gICAgICogQHBhcmFtIHNlbmRlclxuICAgICAqIEByZXR1cm4ge0VsZWN0cm9uLk1lbnV9XG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVUZXh0SGlnaGxpZ2h0Q29udGV4dE1lbnUodHJpZ2dlckV2ZW50OiBUcmlnZ2VyRXZlbnQsIHNlbmRlcjogV2ViQ29udGVudHMpOiBNZW51IHtcblxuICAgICAgICBjb25zdCBjdHhNZW51ID0gbmV3IE1lbnUoKTtcblxuICAgICAgICBjdHhNZW51LmFwcGVuZCh0aGlzLmNyZWF0ZVN1Ym1lbnUoJ1RleHQgSGlnaGxpZ2h0JywgW1xuICAgICAgICAgICAgLy8gbmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgIC8vICAgICBsYWJlbDogJ0FkZCBGbGFzaGNhcmQnLFxuICAgICAgICAgICAgLy8gICAgIC8vIGFjY2VsZXJhdG9yOiAnQ21kT3JDdHJsK0EnLFxuICAgICAgICAgICAgLy8gICAgIGNsaWNrOiAoKSA9PiB0aGlzLnBvc3RDb250ZXh0TWVudU1lc3NhZ2UoXCJhZGQtZmxhc2hjYXJkXCIsIHRyaWdnZXJFdmVudClcbiAgICAgICAgICAgIC8vIH0pLFxuICAgICAgICAgICAgLy8gbmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgIC8vICAgICBsYWJlbDogJ0FkZCBDb21tZW50JyxcbiAgICAgICAgICAgIC8vICAgICAvLyBhY2NlbGVyYXRvcjogJ0NtZE9yQ3RybCtBJyxcbiAgICAgICAgICAgIC8vICAgICBjbGljazogKCkgPT4gdGhpcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiYWRkLWNvbW1lbnRcIiwgdHJpZ2dlckV2ZW50KVxuICAgICAgICAgICAgLy8gfSksXG4gICAgICAgICAgICBuZXcgTWVudUl0ZW0oe1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnRGVsZXRlJyxcbiAgICAgICAgICAgICAgICAvLyBhY2NlbGVyYXRvcjogJ0NtZE9yQ3RybCtBJyxcbiAgICAgICAgICAgICAgICBjbGljazogKCkgPT4gQ29udGV4dE1lbnVNZXNzYWdlcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiZGVsZXRlLXRleHQtaGlnaGxpZ2h0XCIsIHRyaWdnZXJFdmVudClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIF0pKTtcblxuICAgICAgICByZXR1cm4gY3R4TWVudTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHRyaWdnZXJFdmVudCB7VHJpZ2dlckV2ZW50fVxuICAgICAqIEBwYXJhbSBzZW5kZXJcbiAgICAgKiBAcmV0dXJuIHtFbGVjdHJvbi5NZW51fVxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlQXJlYUhpZ2hsaWdodENvbnRleHRNZW51KHRyaWdnZXJFdmVudDogVHJpZ2dlckV2ZW50LCBzZW5kZXI6IFdlYkNvbnRlbnRzKTogTWVudSB7XG5cbiAgICAgICAgY29uc3QgY3R4TWVudSA9IG5ldyBNZW51KCk7XG5cbiAgICAgICAgY3R4TWVudS5hcHBlbmQodGhpcy5jcmVhdGVTdWJtZW51KCdBcmVhIEhpZ2hsaWdodCcsIFtcbiAgICAgICAgICAgIC8vIG5ldyBNZW51SXRlbSh7XG4gICAgICAgICAgICAvLyAgICAgbGFiZWw6ICdBZGQgRmxhc2hjYXJkJyxcbiAgICAgICAgICAgIC8vICAgICBjbGljazogKCkgPT4gdGhpcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiYWRkLWZsYXNoY2FyZFwiLCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgICAgICAvLyB9KSxcbiAgICAgICAgICAgIC8vIG5ldyBNZW51SXRlbSh7XG4gICAgICAgICAgICAvLyAgICAgbGFiZWw6ICdBZGQgQ29tbWVudCcsXG4gICAgICAgICAgICAvLyAgICAgLy8gYWNjZWxlcmF0b3I6ICdDbWRPckN0cmwrQScsXG4gICAgICAgICAgICAvLyAgICAgY2xpY2s6ICgpID0+IHRoaXMucG9zdENvbnRleHRNZW51TWVzc2FnZShcImFkZC1jb21tZW50XCIsIHRyaWdnZXJFdmVudClcbiAgICAgICAgICAgIC8vIH0pLFxuICAgICAgICAgICAgbmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgICAgICBsYWJlbDogJ0RlbGV0ZScsXG4gICAgICAgICAgICAgICAgLy8gYWNjZWxlcmF0b3I6ICdDbWRPckN0cmwrQScsXG4gICAgICAgICAgICAgICAgY2xpY2s6ICgpID0+IENvbnRleHRNZW51TWVzc2FnZXMucG9zdENvbnRleHRNZW51TWVzc2FnZShcImRlbGV0ZS1hcmVhLWhpZ2hsaWdodFwiLCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgICAgICB9KVxuICAgICAgICBdKSk7XG5cbiAgICAgICAgcmV0dXJuIGN0eE1lbnU7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlUGFnZW1hcmtDb250ZXh0TWVudSh0cmlnZ2VyRXZlbnQ6IFRyaWdnZXJFdmVudCwgc2VuZGVyOiBXZWJDb250ZW50cyk6IE1lbnUge1xuXG4gICAgICAgIGNvbnN0IGN0eE1lbnUgPSBuZXcgTWVudSgpO1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZU1vZGVTdWJtZW51SXRlbXMgPSAoKSA9PiB7XG5cbiAgICAgICAgICAgIHJldHVybiBQYWdlbWFya01vZGVzLnRvRGVzY3JpcHRvcnMoKS5tYXAoY3VycmVudCA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBNZW51SXRlbSh7XG4gICAgICAgICAgICAgICAgICAgICBsYWJlbDogY3VycmVudC50aXRsZSxcbiAgICAgICAgICAgICAgICAgICAgIGNsaWNrOiAoKSA9PiBDb250ZXh0TWVudU1lc3NhZ2VzLnBvc3RDb250ZXh0TWVudU1lc3NhZ2UoXCJzZXQtcGFnZW1hcmstbW9kZS1cIiArIGN1cnJlbnQua2V5LCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfTtcblxuICAgICAgICBjdHhNZW51LmFwcGVuZCh0aGlzLmNyZWF0ZVN1Ym1lbnUoJ1BhZ2VtYXJrJywgW1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVTdWJtZW51KCdNb2RlIC4uLicsIGNyZWF0ZU1vZGVTdWJtZW51SXRlbXMoKSksXG4gICAgICAgICAgICBuZXcgTWVudUl0ZW0oe1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnRGVsZXRlIFBhZ2VtYXJrJyxcbiAgICAgICAgICAgICAgICAvLyBhY2NlbGVyYXRvcjogJ0NtZE9yQ3RybCtBJyxcbiAgICAgICAgICAgICAgICBjbGljazogKCkgPT4gQ29udGV4dE1lbnVNZXNzYWdlcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiZGVsZXRlLXBhZ2VtYXJrXCIsIHRyaWdnZXJFdmVudClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIF0pKTtcblxuICAgICAgICByZXR1cm4gY3R4TWVudTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVQYWdlQ29udGV4dE1lbnUodHJpZ2dlckV2ZW50OiBUcmlnZ2VyRXZlbnQsIHNlbmRlcjogV2ViQ29udGVudHMpOiBNZW51IHtcblxuICAgICAgICBjb25zdCBjdHhNZW51ID0gbmV3IE1lbnUoKTtcblxuICAgICAgICAvLyBUT0RPOiBwYWdlIGhpZ2hsaWdodHMgZG9uJ3Qgd29yayByaWdodCBub3cgYXMgd2UgbmVlZCBhbiBhbm5vdGF0aW9uXG4gICAgICAgIC8vIHRvIGJhc2UgaXQgb2ZmIG9mLlxuICAgICAgICAvLyBjdHhNZW51LmFwcGVuZChuZXcgTWVudUl0ZW0oe1xuICAgICAgICAvLyAgICAgbGFiZWw6ICdBZGQgRmxhc2hjYXJkJyxcbiAgICAgICAgLy8gICAgIC8vYWNjZWxlcmF0b3I6ICdDbWRPckN0cmwrQScsXG4gICAgICAgIC8vICAgICBjbGljazogKCkgPT4gdGhpcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiYWRkLWZsYXNoY2FyZFwiLCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgIC8vIH0pKTtcblxuXG4gICAgICAgIC8vIGN0eE1lbnUuYXBwZW5kKHRoaXMuY3JlYXRlU3VibWVudSgnQ3JlYXRlIFBhZ2VtYXJrLi4uJywgW1xuICAgICAgICAvL1xuICAgICAgICAvLyAgICAgbmV3IE1lbnVJdGVtKHtcbiAgICAgICAgLy8gICAgICAgICBsYWJlbDogJy4uLiBUbyBQb2ludCcsXG4gICAgICAgIC8vICAgICAgICAgY2xpY2s6ICgpID0+IHRoaXMucG9zdENvbnRleHRNZW51TWVzc2FnZShcImNyZWF0ZS1wYWdlbWFyay10by1wb2ludFwiLCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgIC8vICAgICB9KSxcbiAgICAgICAgLy9cbiAgICAgICAgLy8gICAgIG5ldyBNZW51SXRlbSh7XG4gICAgICAgIC8vICAgICAgICAgbGFiZWw6ICcuLi4gQm94IEF0IFBvaW50JyxcbiAgICAgICAgLy8gICAgICAgICBjbGljazogKCkgPT4gdGhpcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiY3JlYXRlLXBhZ2VtYXJrXCIsIHRyaWdnZXJFdmVudClcbiAgICAgICAgLy8gICAgIH0pLFxuICAgICAgICAvL1xuICAgICAgICAvLyBdKSk7XG5cbiAgICAgICAgY3R4TWVudS5hcHBlbmQobmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgIGxhYmVsOiAnQ3JlYXRlIFBhZ2VtYXJrIHRvIFBvaW50JyxcbiAgICAgICAgICAgIC8vIGFjY2VsZXJhdG9yOiBcIkNvbW1hbmRPckNvbnRyb2wrQWx0K0xlZnRDbGlja1wiLFxuICAgICAgICAgICAgLy8gcmVnaXN0ZXJBY2NlbGVyYXRvcjogZmFsc2UsXG4gICAgICAgICAgICBjbGljazogKCkgPT4gQ29udGV4dE1lbnVNZXNzYWdlcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiY3JlYXRlLXBhZ2VtYXJrLXRvLXBvaW50XCIsIHRyaWdnZXJFdmVudClcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIGN0eE1lbnUuYXBwZW5kKG5ldyBNZW51SXRlbSh7XG4gICAgICAgICAgICBsYWJlbDogJ0NyZWF0ZSBQYWdlbWFyayBCb3gnLFxuICAgICAgICAgICAgY2xpY2s6ICgpID0+IENvbnRleHRNZW51TWVzc2FnZXMucG9zdENvbnRleHRNZW51TWVzc2FnZShcImNyZWF0ZS1wYWdlbWFya1wiLCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgIH0pKTtcblxuICAgICAgICBjdHhNZW51LmFwcGVuZChuZXcgTWVudUl0ZW0oe1xuICAgICAgICAgICAgbGFiZWw6ICdDcmVhdGUgQXJlYSBIaWdobGlnaHQnLFxuICAgICAgICAgICAgY2xpY2s6ICgpID0+IENvbnRleHRNZW51TWVzc2FnZXMucG9zdENvbnRleHRNZW51TWVzc2FnZShcImNyZWF0ZS1hcmVhLWhpZ2hsaWdodFwiLCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgIH0pKTtcblxuICAgICAgICAvLyBjdHhNZW51LmFwcGVuZChuZXcgTWVudUl0ZW0oe1xuICAgICAgICAvLyAgICAgbGFiZWw6ICdTeW5jIEZsYXNoY2FyZHMgdG8gQW5raScsXG4gICAgICAgIC8vICAgICBjbGljazogKCkgPT4gdGhpcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwic3RhcnQtc3luY1wiLCB0cmlnZ2VyRXZlbnQpXG4gICAgICAgIC8vIH0pKTtcblxuICAgICAgICAvLyBjdHhNZW51LmFwcGVuZChuZXcgTWVudUl0ZW0oe1xuICAgICAgICAvLyAgICAgbGFiZWw6ICdDcmVhdGUgQW5ub3RhdGlvbicsXG4gICAgICAgIC8vICAgICBjbGljazogKCkgPT4gdGhpcy5wb3N0Q29udGV4dE1lbnVNZXNzYWdlKFwiY3JlYXRlLWFubm90YXRpb25cIiwgdHJpZ2dlckV2ZW50KVxuICAgICAgICAvLyB9KSk7XG5cbiAgICAgICAgcmV0dXJuIGN0eE1lbnU7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlRGVmYXVsdENvbnRleHRNZW51KHRyaWdnZXJFdmVudDogVHJpZ2dlckV2ZW50LCBzZW5kZXI6IFdlYkNvbnRlbnRzKTogTWVudSB7XG5cbiAgICAgICAgY29uc3QgY3R4TWVudSA9IG5ldyBNZW51KCk7XG5cbiAgICAgICAgLy8gVE9ETzogZGlzcGxheSB0aGlzIGZpcnN0IGFuZCBvbmx5IGlmIHRleHQgaXMgaGlnaGxpZ2h0ZWRcbiAgICAgICAgLy8gY3R4TWVudS5hcHBlbmQobmV3IE1lbnVJdGVtKHsgbGFiZWw6ICdDb3B5JywgYWNjZWxlcmF0b3I6ICdDbWRPckN0cmwrQycsIHJvbGU6ICdjb3B5JyB9KSk7XG5cbiAgICAgICAgY3R4TWVudS5hcHBlbmQobmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgIGxhYmVsOiAnVG9nZ2xlIEFubm90YXRpb24gU2lkZWJhcicsXG4gICAgICAgICAgICBpZDogXCJ0b2dnbGUtYW5ub3RhdGlvbi1zaWRlYmFyXCIsXG4gICAgICAgICAgICBjbGljazogKCkgPT4gQW5ub3RhdGlvblNpZGViYXJDbGllbnQudG9nZ2xlQW5ub3RhdGlvblNpZGViYXIoKVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgY3R4TWVudS5hcHBlbmQobmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgIGxhYmVsOiAnSW5zcGVjdCBFbGVtZW50JyxcbiAgICAgICAgICAgIGlkOiBcImluc3BlY3RcIixcbiAgICAgICAgICAgIC8vIGFjY2VsZXJhdG9yOiAnQ3RybCtTaGlmdCtJJyxcbiAgICAgICAgICAgIGNsaWNrOiBldmVudCA9PiB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCB3aW5kb3cgPSBCcm93c2VyV2luZG93LmdldEZvY3VzZWRXaW5kb3coKTtcblxuICAgICAgICAgICAgICAgIGlmICghIHdpbmRvdykge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyBjdXJyZW50IHdpbmRvd1wiKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyB0aGUgcG9pbnRzIGFyZSBTTElHSFRMWSBvZmYgZm9yIHRoZSBpZnJhbWUgdmVyc2lvbiB3aGljaCBpc1xuICAgICAgICAgICAgICAgIC8vIHZlcnkgYW5ub3lpbmcuXG4gICAgICAgICAgICAgICAgd2luZG93LndlYkNvbnRlbnRzLmluc3BlY3RFbGVtZW50KHRyaWdnZXJFdmVudC5wb2ludC54LCB0cmlnZ2VyRXZlbnQucG9pbnQueSk7XG5cbiAgICAgICAgICAgICAgICBpZiAod2luZG93LndlYkNvbnRlbnRzLmlzRGV2VG9vbHNPcGVuZWQoKSkge1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cud2ViQ29udGVudHMuZGV2VG9vbHNXZWJDb250ZW50cy5mb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pKTtcblxuXG4gICAgICAgIHJldHVybiBjdHhNZW51O1xuXG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZVN1Ym1lbnUobGFiZWw6IHN0cmluZywgbWVudUl0ZW1zOiBNZW51SXRlbVtdKTogTWVudUl0ZW0ge1xuXG4gICAgICAgIGNvbnN0IHN1Ym1lbnUgPSBuZXcgTWVudSgpO1xuXG4gICAgICAgIGNvbnN0IHN1Ym1lbnVJdGVtID0gbmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgIGxhYmVsLFxuICAgICAgICAgICAgdHlwZTogJ3N1Ym1lbnUnLFxuICAgICAgICAgICAgc3VibWVudVxuICAgICAgICB9KTtcblxuICAgICAgICBtZW51SXRlbXMuZm9yRWFjaChtZW51SXRlbSA9PiB7XG4gICAgICAgICAgICBzdWJtZW51LmFwcGVuZChtZW51SXRlbSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBzdWJtZW51SXRlbTtcblxuICAgIH1cblxufVxuIl19