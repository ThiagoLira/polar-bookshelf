"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const Logger_1 = require("polar-shared/src/logger/Logger");
const ResourcePaths_1 = require("../../electron/webresource/ResourcePaths");
const AuthHosts_1 = require("./AuthHosts");
const log = Logger_1.Logger.create();
const WIDTH = 900 * 1.2;
const HEIGHT = 1100 * 1.2;
const SIDEBAR_BUFFER = 100;
const DEFAULT_URL = ResourcePaths_1.ResourcePaths.resourceURLFromRelativeURL('./apps/home/default.html');
exports.APP_ICON = ResourcePaths_1.ResourcePaths.resourceURLFromRelativeURL('./icon.png');
exports.BROWSER_WINDOW_OPTIONS = Object.freeze({
    backgroundColor: '#FFF',
    width: WIDTH + SIDEBAR_BUFFER,
    height: HEIGHT,
    show: false,
    icon: exports.APP_ICON,
    webPreferences: {
        nodeIntegration: true,
        defaultEncoding: 'UTF-8',
        webSecurity: false,
        webaudio: true,
        partition: 'persist:polar-app'
    }
});
class MainAppBrowserWindowFactory {
    static createWindow(browserWindowOptions = exports.BROWSER_WINDOW_OPTIONS, url = DEFAULT_URL) {
        browserWindowOptions = Object.assign({}, browserWindowOptions);
        const position = this.computeXY();
        if (position) {
            browserWindowOptions.x = position.x;
            browserWindowOptions.y = position.y;
        }
        const display = electron_1.screen.getPrimaryDisplay();
        const MIN_FACTOR = 0.4;
        const dimensionMappings = [
            { original: 'minHeight', dimension: 'height', defaultValue: display.size.width * MIN_FACTOR },
            { original: 'minWidth', dimension: 'width', defaultValue: display.size.height * MIN_FACTOR },
            { original: 'height', dimension: 'height' },
            { original: 'width', dimension: 'width' }
        ];
        for (const dimensionMapping of dimensionMappings) {
            const current = browserWindowOptions[dimensionMapping.original] || dimensionMapping.defaultValue;
            const max = display.size[dimensionMapping.dimension];
            browserWindowOptions[dimensionMapping.original]
                = Math.min(current, max);
        }
        const browserWindow = new electron_1.BrowserWindow(browserWindowOptions);
        browserWindow.on('close', function (e) {
            e.preventDefault();
            if (browserWindow.webContents) {
                browserWindow.webContents.clearHistory();
                browserWindow.webContents.session.clearCache(() => {
                    browserWindow.destroy();
                });
            }
        });
        browserWindow.webContents.on('new-window', (e, url) => {
            e.preventDefault();
            electron_1.shell.openExternal(url)
                .catch(err => log.error("Cloud open external URL", err, url));
        });
        browserWindow.webContents.on('will-navigate', (e, navURL) => {
            const parsedURL = new URL(navURL);
            const host = parsedURL.hostname;
            const allowedHosts = AuthHosts_1.AuthHosts.get();
            if (host === "localhost") {
                log.info("Always allowing localhost URL");
                return;
            }
            if (navURL.startsWith("https://") && allowedHosts.includes(host)) {
                log.info("Allowing URL for authentication: " + navURL);
                return;
            }
            log.info("Attempt to navigate to new URL: ", navURL);
            e.preventDefault();
            electron_1.shell.openExternal(navURL)
                .catch(err => log.error("Cloud open external URL", err, url));
        });
        log.info("Loading URL: " + url);
        browserWindow.loadURL(url)
            .catch(err => log.error("Cloud not load URL ", err, url));
        return new Promise(resolve => {
            browserWindow.once('ready-to-show', () => {
                browserWindow.webContents.setZoomFactor(1.0);
                browserWindow.show();
                resolve(browserWindow);
            });
        });
    }
    static computeXY() {
        const offset = 35;
        const focusedWindow = electron_1.BrowserWindow.getFocusedWindow();
        if (focusedWindow) {
            const position = focusedWindow.getPosition();
            let x = position[0];
            let y = position[1];
            x += offset;
            y += offset;
            return { x, y };
        }
        return undefined;
    }
}
exports.MainAppBrowserWindowFactory = MainAppBrowserWindowFactory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbkFwcEJyb3dzZXJXaW5kb3dGYWN0b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWFpbkFwcEJyb3dzZXJXaW5kb3dGYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQThGO0FBQzlGLDJEQUFzRDtBQUN0RCw0RUFBdUU7QUFDdkUsMkNBQXNDO0FBRXRDLE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFNLEtBQUssR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDO0FBQ3hCLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxHQUFHLENBQUM7QUFDMUIsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDO0FBRTNCLE1BQU0sV0FBVyxHQUFHLDZCQUFhLENBQUMsMEJBQTBCLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUk1RSxRQUFBLFFBQVEsR0FBRyw2QkFBYSxDQUFDLDBCQUEwQixDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRWxFLFFBQUEsc0JBQXNCLEdBQTZDLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDMUYsZUFBZSxFQUFFLE1BQU07SUFDdkIsS0FBSyxFQUFFLEtBQUssR0FBRyxjQUFjO0lBQzdCLE1BQU0sRUFBRSxNQUFNO0lBQ2QsSUFBSSxFQUFFLEtBQUs7SUFJWCxJQUFJLEVBQUUsZ0JBQVE7SUFDZCxjQUFjLEVBQUU7UUFJWixlQUFlLEVBQUUsSUFBSTtRQVNyQixlQUFlLEVBQUUsT0FBTztRQU14QixXQUFXLEVBQUUsS0FBSztRQUVsQixRQUFRLEVBQUUsSUFBSTtRQU9kLFNBQVMsRUFBRSxtQkFBbUI7S0FFakM7Q0FFSixDQUFDLENBQUM7QUFFSCxNQUFhLDJCQUEyQjtJQUU3QixNQUFNLENBQUMsWUFBWSxDQUFDLHVCQUFpRSw4QkFBc0IsRUFDdkYsR0FBRyxHQUFHLFdBQVc7UUFFeEMsb0JBQW9CLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsb0JBQW9C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Q0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRXZELElBQUksYUFBYSxFQUFFO1lBQ2YsTUFBTSxRQUFRLEdBQUcsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzdDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQixJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFcEIsQ0FBQyxJQUFJLE1BQU0sQ0FBQztZQUNaLENBQUMsSUFBSSxNQUFNLENBQUM7WUFFWixPQUFPLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBQyxDQUFDO1NBRWpCO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFFckIsQ0FBQztDQUVKO0FBdkpELGtFQXVKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QnJvd3NlcldpbmRvdywgbmF0aXZlSW1hZ2UsIHNoZWxsLCBEb3dubG9hZEl0ZW0sIFdlYkNvbnRlbnRzLCBzY3JlZW59IGZyb20gXCJlbGVjdHJvblwiO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvbG9nZ2VyL0xvZ2dlcic7XG5pbXBvcnQge1Jlc291cmNlUGF0aHN9IGZyb20gJy4uLy4uL2VsZWN0cm9uL3dlYnJlc291cmNlL1Jlc291cmNlUGF0aHMnO1xuaW1wb3J0IHtBdXRoSG9zdHN9IGZyb20gXCIuL0F1dGhIb3N0c1wiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmNvbnN0IFdJRFRIID0gOTAwICogMS4yOyAvLyAxMzAwIGlzIGxpa2UgODAlIG9mIHVzZXJzXG5jb25zdCBIRUlHSFQgPSAxMTAwICogMS4yO1xuY29uc3QgU0lERUJBUl9CVUZGRVIgPSAxMDA7XG5cbmNvbnN0IERFRkFVTFRfVVJMID0gUmVzb3VyY2VQYXRocy5yZXNvdXJjZVVSTEZyb21SZWxhdGl2ZVVSTCgnLi9hcHBzL2hvbWUvZGVmYXVsdC5odG1sJyk7XG5cbi8vIFRPRE86IGZpbGVzIGluIHRoZSByb290IGFyZSBhbHdheXMga2VwdCBpbiB0aGUgcGFja2FnZSB3ZSBjYW4ganVzdCBsb2FkXG4vLyB0aGlzIGFzIGEgbmF0aXZlX2ltYWdlIGRpcmVjdGx5LlxuZXhwb3J0IGNvbnN0IEFQUF9JQ09OID0gUmVzb3VyY2VQYXRocy5yZXNvdXJjZVVSTEZyb21SZWxhdGl2ZVVSTCgnLi9pY29uLnBuZycpO1xuXG5leHBvcnQgY29uc3QgQlJPV1NFUl9XSU5ET1dfT1BUSU9OUzogRWxlY3Ryb24uQnJvd3NlcldpbmRvd0NvbnN0cnVjdG9yT3B0aW9ucyA9IE9iamVjdC5mcmVlemUoe1xuICAgIGJhY2tncm91bmRDb2xvcjogJyNGRkYnLFxuICAgIHdpZHRoOiBXSURUSCArIFNJREVCQVJfQlVGRkVSLFxuICAgIGhlaWdodDogSEVJR0hULFxuICAgIHNob3c6IGZhbHNlLFxuICAgIC8vIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvYnJvd3Nlci13aW5kb3cjbmV3LWJyb3dzZXJ3aW5kb3dvcHRpb25zXG5cbiAgICAvLyBUT0RPOiB0aGUgQXBwSWNvbiBDQU4gYmUgYSBmaWxlIFVSTFxuICAgIGljb246IEFQUF9JQ09OLFxuICAgIHdlYlByZWZlcmVuY2VzOiB7XG4gICAgICAgIC8vIFRPRE86XG4gICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9lbGVjdHJvbi9lbGVjdHJvbi9wdWxsLzc5NFxuICAgICAgICAvL1xuICAgICAgICBub2RlSW50ZWdyYXRpb246IHRydWUsXG5cbiAgICAgICAgLy8gTk9URTogdGhlc2UgbXVzdCBiZSBkaXNhYmxlZCBiZWNhdXNlIHRoZXkgYnJlYWsgcGRmLmpzLiAgSXQgbXVzdCBiZVxuICAgICAgICAvLyBzb21lIGNoYW5nZSB0byByZXF1aXJlKCkgZnJvbSB0aGVpciB3b3JrZXJzLiAgU28gbWF5YmUgSSBqdXN0IGNhbid0XG4gICAgICAgIC8vIHVzZSB3b3JrZXJzIGZvciBub3cuXG4gICAgICAgIC8vIG5vZGVJbnRlZ3JhdGlvbkluV29ya2VyOiB0cnVlLFxuICAgICAgICAvL1xuICAgICAgICAvLyBzYW5kYm94OiBmYWxzZSxcblxuICAgICAgICBkZWZhdWx0RW5jb2Rpbmc6ICdVVEYtOCcsXG5cbiAgICAgICAgLy8gV2UgYXJlIGRpc2FibGluZyB3ZWIgc2VjdXJpdHkgbm93IGFzIGEgd29yayBhcm91bmQgZm9yIENPUlMgaXNzdWVzXG4gICAgICAgIC8vIHdoZW4gbG9hZGluZyBmb250cy4gIE9uY2Ugd2UgcmVzb2x2ZSB0aGlzIHdlIGNhbiBlbmFibGUgd2ViU2VjdXJpdHlcbiAgICAgICAgLy8gYWdhaW4uICBXZSBjYW4gY29tcGxldGVseSByZW1vdmUgdGhpcyBvbmNlIHdlIG1pZ3JhdGUgdG8gYSBjb21wbGV0ZVxuICAgICAgICAvLyBzb2x1dGlvbiBmb3IgUEhaIGZpbGVzIGJlaW5nIHN0b3JlZCBpbiB0aGUgYnJvd3Nlci5cbiAgICAgICAgd2ViU2VjdXJpdHk6IGZhbHNlLFxuXG4gICAgICAgIHdlYmF1ZGlvOiB0cnVlLFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBVc2UgYSBwZXJzaXN0ZW50IGNvb2tpZSBzZXNzaW9uIGJldHdlZW4gcmVzdGFydHMuICBUaGlzIGlzIHVzZWQgc29cbiAgICAgICAgICogdGhhdCB3ZSBrZWVwIHVzZXIgY29va2llcyBpbmNsdWRpbmcgR29vZ2xlIEFuYWx5dGljcyBjb29raWVzLlxuICAgICAgICAgKi9cbiAgICAgICAgLy9cbiAgICAgICAgcGFydGl0aW9uOiAncGVyc2lzdDpwb2xhci1hcHAnXG5cbiAgICB9XG5cbn0pO1xuXG5leHBvcnQgY2xhc3MgTWFpbkFwcEJyb3dzZXJXaW5kb3dGYWN0b3J5IHtcblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlV2luZG93KGJyb3dzZXJXaW5kb3dPcHRpb25zOiBFbGVjdHJvbi5Ccm93c2VyV2luZG93Q29uc3RydWN0b3JPcHRpb25zID0gQlJPV1NFUl9XSU5ET1dfT1BUSU9OUyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSBERUZBVUxUX1VSTCk6IFByb21pc2U8QnJvd3NlcldpbmRvdz4ge1xuXG4gICAgICAgIGJyb3dzZXJXaW5kb3dPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgYnJvd3NlcldpbmRvd09wdGlvbnMpO1xuXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5jb21wdXRlWFkoKTtcblxuICAgICAgICBpZiAocG9zaXRpb24pIHtcbiAgICAgICAgICAgIC8vIGFkZCBzb21lIG9mZnNldCB0byB0aGlzIHdpbmRvdyBzbyB0aGF0IHRoZSBwcmV2aW91cyB3aW5kb3cgYW5kXG4gICAgICAgICAgICAvLyB0aGUgY3VycmVudCBvbmUgZG9uJ3QgbGluZSB1cCBwZXJmZWN0bHkgb3IgZWxzZSBpdCBzZWVtcyBsaWtlXG4gICAgICAgICAgICAvLyBub3RoaW5nIGhhcHBlbmVkIG9yIHRoYXQgdGhlIG5ldyB3aW5kb3cgcmVwbGFjZWQgdGhlIG9sZCBvbmUuXG4gICAgICAgICAgICBicm93c2VyV2luZG93T3B0aW9ucy54ID0gcG9zaXRpb24ueDtcbiAgICAgICAgICAgIGJyb3dzZXJXaW5kb3dPcHRpb25zLnkgPSBwb3NpdGlvbi55O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGlzcGxheSA9IHNjcmVlbi5nZXRQcmltYXJ5RGlzcGxheSgpO1xuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSBtaW5IZWlnaHQsIG1heEhlaWdodCwgd2lkdGgsIGFuZCBoZWlnaHQgYXJlIE5PVCBsYXJnZXJcbiAgICAgICAgLy8gdGhhbiB0aGUgY3VycmVudCBzY3JlZW4gZGltZW5zaW9ucy5cblxuICAgICAgICBpbnRlcmZhY2UgRGltZW5zaW9uTWFwcGluZyB7XG4gICAgICAgICAgICByZWFkb25seSBvcmlnaW5hbDogJ21pbldpZHRoJyB8ICdtaW5IZWlnaHQnIHwgJ3dpZHRoJyB8ICdoZWlnaHQnO1xuICAgICAgICAgICAgcmVhZG9ubHkgZGltZW5zaW9uOiAnd2lkdGgnIHwgJ2hlaWdodCc7XG4gICAgICAgICAgICByZWFkb25seSBkZWZhdWx0VmFsdWU/OiBudW1iZXI7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBNSU5fRkFDVE9SID0gMC40O1xuXG4gICAgICAgIGNvbnN0IGRpbWVuc2lvbk1hcHBpbmdzOiBEaW1lbnNpb25NYXBwaW5nW10gPSBbXG5cbiAgICAgICAgICAgIHtvcmlnaW5hbDogJ21pbkhlaWdodCcsIGRpbWVuc2lvbjogJ2hlaWdodCcsIGRlZmF1bHRWYWx1ZTogZGlzcGxheS5zaXplLndpZHRoICogTUlOX0ZBQ1RPUn0sXG4gICAgICAgICAgICB7b3JpZ2luYWw6ICdtaW5XaWR0aCcsIGRpbWVuc2lvbjogJ3dpZHRoJywgZGVmYXVsdFZhbHVlOiBkaXNwbGF5LnNpemUuaGVpZ2h0ICogTUlOX0ZBQ1RPUn0sXG5cbiAgICAgICAgICAgIHtvcmlnaW5hbDogJ2hlaWdodCcsIGRpbWVuc2lvbjogJ2hlaWdodCd9LFxuICAgICAgICAgICAge29yaWdpbmFsOiAnd2lkdGgnLCBkaW1lbnNpb246ICd3aWR0aCd9XG5cbiAgICAgICAgXTtcblxuICAgICAgICBmb3IgKGNvbnN0IGRpbWVuc2lvbk1hcHBpbmcgb2YgZGltZW5zaW9uTWFwcGluZ3MpIHtcblxuICAgICAgICAgICAgY29uc3QgY3VycmVudCA9IGJyb3dzZXJXaW5kb3dPcHRpb25zW2RpbWVuc2lvbk1hcHBpbmcub3JpZ2luYWxdISB8fCBkaW1lbnNpb25NYXBwaW5nLmRlZmF1bHRWYWx1ZSE7XG4gICAgICAgICAgICBjb25zdCBtYXggPSBkaXNwbGF5LnNpemVbZGltZW5zaW9uTWFwcGluZy5kaW1lbnNpb25dO1xuXG4gICAgICAgICAgICBicm93c2VyV2luZG93T3B0aW9uc1tkaW1lbnNpb25NYXBwaW5nLm9yaWdpbmFsXVxuICAgICAgICAgICAgICAgID0gTWF0aC5taW4oY3VycmVudCwgbWF4KTtcblxuICAgICAgICB9XG5cbiAgICAgICAgLy8gbG9nLm5vdGljZShcIkNyZWF0aW5nIGJyb3dzZXIgd2luZG93IHdpdGggb3B0aW9uczogXCIsIGJyb3dzZXJXaW5kb3dPcHRpb25zKTtcblxuICAgICAgICAvLyBDcmVhdGUgdGhlIGJyb3dzZXIgd2luZG93LlxuICAgICAgICBjb25zdCBicm93c2VyV2luZG93ID0gbmV3IEJyb3dzZXJXaW5kb3coYnJvd3NlcldpbmRvd09wdGlvbnMpO1xuXG4gICAgICAgIGJyb3dzZXJXaW5kb3cub24oJ2Nsb3NlJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgICBpZiAoYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cykge1xuXG4gICAgICAgICAgICAgICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5jbGVhckhpc3RvcnkoKTtcbiAgICAgICAgICAgICAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLnNlc3Npb24uY2xlYXJDYWNoZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJXaW5kb3cuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5vbignbmV3LXdpbmRvdycsIChlLCB1cmwpID0+IHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHNoZWxsLm9wZW5FeHRlcm5hbCh1cmwpXG4gICAgICAgICAgICAgICAgLmNhdGNoKGVyciA9PiBsb2cuZXJyb3IoXCJDbG91ZCBvcGVuIGV4dGVybmFsIFVSTFwiLCBlcnIsIHVybCkpO1xuICAgICAgICB9KTtcblxuICAgICAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLm9uKCd3aWxsLW5hdmlnYXRlJywgKGUsIG5hdlVSTCkgPT4ge1xuXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIGEgYml0IG9mIGEgaGFjayBhbmQgdGhlc2UgVVJMcyBzaG91bGRuJ3QgYmUgaGFyZFxuICAgICAgICAgICAgLy8gY29kZWQgaGVyZS4gIFdlIGNhbiByZWZhY3RvciB0aGlzIGluIHRoZSBmdXR1cmUgdGhvdWdoLlxuXG4gICAgICAgICAgICBjb25zdCBwYXJzZWRVUkwgPSBuZXcgVVJMKG5hdlVSTCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGhvc3QgPSBwYXJzZWRVUkwuaG9zdG5hbWU7XG5cbiAgICAgICAgICAgIGNvbnN0IGFsbG93ZWRIb3N0cyA9IEF1dGhIb3N0cy5nZXQoKTtcblxuICAgICAgICAgICAgaWYgKGhvc3QgPT09IFwibG9jYWxob3N0XCIpIHtcbiAgICAgICAgICAgICAgICBsb2cuaW5mbyhcIkFsd2F5cyBhbGxvd2luZyBsb2NhbGhvc3QgVVJMXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG5hdlVSTC5zdGFydHNXaXRoKFwiaHR0cHM6Ly9cIikgJiYgYWxsb3dlZEhvc3RzLmluY2x1ZGVzKGhvc3QpKSB7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJBbGxvd2luZyBVUkwgZm9yIGF1dGhlbnRpY2F0aW9uOiBcIiArIG5hdlVSTCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsb2cuaW5mbyhcIkF0dGVtcHQgdG8gbmF2aWdhdGUgdG8gbmV3IFVSTDogXCIsIG5hdlVSTCk7XG4gICAgICAgICAgICAvLyByZXF1aXJlZCB0byBmb3JjZSB0aGUgVVJMcyBjbGlja2VkIHRvIG9wZW4gaW4gYSBuZXcgYnJvd3Nlci4gIFRoZVxuICAgICAgICAgICAgLy8gdXNlciBwcm9iYWJseSAvIGNlcnRhaW5seSB3YW50cyB0byB1c2UgdGhlaXIgbWFpbiBicm93c2VyLlxuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgc2hlbGwub3BlbkV4dGVybmFsKG5hdlVSTClcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IGxvZy5lcnJvcihcIkNsb3VkIG9wZW4gZXh0ZXJuYWwgVVJMXCIsIGVyciwgdXJsKSk7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbG9nLmluZm8oXCJMb2FkaW5nIFVSTDogXCIgKyB1cmwpO1xuICAgICAgICBicm93c2VyV2luZG93LmxvYWRVUkwodXJsKVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiBsb2cuZXJyb3IoXCJDbG91ZCBub3QgbG9hZCBVUkwgXCIsIGVyciwgdXJsKSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEJyb3dzZXJXaW5kb3c+KHJlc29sdmUgPT4ge1xuXG4gICAgICAgICAgICBicm93c2VyV2luZG93Lm9uY2UoJ3JlYWR5LXRvLXNob3cnLCAoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBBcyBvZiBFbGVjdHJvbiAzLjAgYmV0YTggdGhlcmUgYXBwZWFycyB0byBiZSBhIGJ1ZyB3aGVyZVxuICAgICAgICAgICAgICAgIC8vIGl0IHBlcnNpc3RzIHRlaCB6b29tIGZhY3RvciBiZXR3ZWVuIHJlc3RhcnRzIGFuZCByZXN0b3Jlc1xuICAgICAgICAgICAgICAgIC8vIHRoZSB6b29tIGZhY3RvciBmb3IgdGhlIHVzZXIgYnV0IHRoaXMgY2FuIGJyZWFrIC8gY29uZnVzZVxuICAgICAgICAgICAgICAgIC8vIFBIWiBsb2FkaW5nIHNvIHdlIGFsd2F5cyB3YW50IHRoZW0gdG8gc3RhcnQgYXQgMS4wXG4gICAgICAgICAgICAgICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5zZXRab29tRmFjdG9yKDEuMCk7XG5cbiAgICAgICAgICAgICAgICBicm93c2VyV2luZG93LnNob3coKTtcblxuICAgICAgICAgICAgICAgIHJlc29sdmUoYnJvd3NlcldpbmRvdyk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY29tcHV0ZVhZKCk6IFBvc2l0aW9uIHwgdW5kZWZpbmVkIHtcblxuICAgICAgICBjb25zdCBvZmZzZXQgPSAzNTtcblxuICAgICAgICBjb25zdCBmb2N1c2VkV2luZG93ID0gQnJvd3NlcldpbmRvdy5nZXRGb2N1c2VkV2luZG93KCk7XG5cbiAgICAgICAgaWYgKGZvY3VzZWRXaW5kb3cpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gZm9jdXNlZFdpbmRvdy5nZXRQb3NpdGlvbigpO1xuICAgICAgICAgICAgbGV0IHggPSBwb3NpdGlvblswXTtcbiAgICAgICAgICAgIGxldCB5ID0gcG9zaXRpb25bMV07XG5cbiAgICAgICAgICAgIHggKz0gb2Zmc2V0O1xuICAgICAgICAgICAgeSArPSBvZmZzZXQ7XG5cbiAgICAgICAgICAgIHJldHVybiB7eCwgeX07XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG5cbiAgICB9XG5cbn1cblxuaW50ZXJmYWNlIFBvc2l0aW9uIHtcbiAgICB4OiBudW1iZXI7XG4gICAgeTogbnVtYmVyO1xufVxuXG4iXX0=