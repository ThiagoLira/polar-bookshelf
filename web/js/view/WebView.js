"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const View_1 = require("./View");
const DocFormatFactory_1 = require("../docformat/DocFormatFactory");
const DocMetaDescriber_1 = require("../metadata/DocMetaDescriber");
const Functions_1 = require("polar-shared/src/util/Functions");
const Logger_1 = require("polar-shared/src/logger/Logger");
const ReadingProgressResume_1 = require("./ReadingProgressResume");
const RendererAnalytics_1 = require("../ga/RendererAnalytics");
const log = Logger_1.Logger.create();
class WebView extends View_1.View {
    constructor(model, prefsProvider) {
        super(model);
        this.prefsProvider = prefsProvider;
        this.docFormat = DocFormatFactory_1.DocFormatFactory.getInstance();
    }
    start() {
        this.model.registerListenerForDocumentLoaded(event => this.onDocumentLoaded(event));
        this.createTimer();
        return this;
    }
    createTimer() {
        const documentLoadTimer = RendererAnalytics_1.RendererAnalytics.createTimer('document', 'loaded');
        this.model.registerListenerForDocumentLoaded(event => documentLoadTimer.stop());
    }
    updateProgress() {
        const perc = this.computeProgress(this.model.docMeta);
        log.info("Percentage is now: " + perc);
        const headerElement = document.querySelector("#polar-header");
        if (headerElement) {
            headerElement.style.display = 'block';
        }
        const progressElement = document.querySelector("#polar-progress progress");
        progressElement.value = perc;
        const description = DocMetaDescriber_1.DocMetaDescriber.describe(this.model.docMeta);
        const docOverview = document.querySelector("#polar-doc-overview");
        if (docOverview) {
            docOverview.textContent = description;
        }
    }
    computeProgress(docMeta) {
        let total = 0;
        Functions_1.forDict(docMeta.pageMetas, (key, pageMeta) => {
            Functions_1.forDict(pageMeta.pagemarks, (column, pagemark) => {
                total += pagemark.percentage;
            });
        });
        const perc = total / (docMeta.docInfo.nrPages * 100);
        return perc;
    }
    onDocumentLoaded(event) {
        const datastorePrefs = this.prefsProvider.get();
        const autoResume = datastorePrefs.prefs.isMarked('settings-auto-resume', true);
        const docMeta = event.docMeta;
        log.info("WebView.onDocumentLoaded: ", docMeta);
        this.updateProgress();
        this.handleProgressDoubleClick(docMeta);
        if (autoResume) {
            ReadingProgressResume_1.ReadingProgressResume.resume(docMeta);
        }
    }
    handleProgressDoubleClick(docMeta) {
        document.querySelector("#polar-header").addEventListener('dblclick', () => {
            ReadingProgressResume_1.ReadingProgressResume.resume(docMeta);
        });
    }
}
exports.WebView = WebView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViVmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIldlYlZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxpQ0FBNEI7QUFDNUIsb0VBQStEO0FBRS9ELG1FQUE4RDtBQUM5RCwrREFBd0Q7QUFFeEQsMkRBQXNEO0FBRXRELG1FQUE4RDtBQUM5RCwrREFBMEQ7QUFHMUQsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQWEsT0FBUSxTQUFRLFdBQUk7SUFTN0IsWUFBWSxLQUFZLEVBQUUsYUFBNEI7UUFDbEQsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWIsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFDbkMsSUFBSSxDQUFDLFNBQVMsR0FBRyxtQ0FBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUVwRCxDQUFDO0lBRU0sS0FBSztRQUVSLElBQUksQ0FBQyxLQUFLLENBQUMsaUNBQWlDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUVwRixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbkIsT0FBTyxJQUFJLENBQUM7SUFFaEIsQ0FBQztJQUVPLFdBQVc7UUFDZixNQUFNLGlCQUFpQixHQUFHLHFDQUFpQixDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDOUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUtNLGNBQWM7UUFLakIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXRELEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFdkMsTUFBTSxhQUFhLEdBQWlCLFFBQVEsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFNUUsSUFBSSxhQUFhLEVBQUU7WUFDZixhQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7U0FDekM7UUFFRCxNQUFNLGVBQWUsR0FBeUIsUUFBUSxDQUFDLGFBQWEsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBRWpHLGVBQWUsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBSTdCLE1BQU0sV0FBVyxHQUFHLG1DQUFnQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWxFLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUVsRSxJQUFJLFdBQVcsRUFBRTtZQUNiLFdBQVcsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1NBQ3pDO0lBRUwsQ0FBQztJQUtPLGVBQWUsQ0FBQyxPQUFpQjtRQUlyQyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFFZCxtQkFBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLEVBQUU7WUFFekMsbUJBQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxFQUFFO2dCQUU3QyxLQUFLLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQztZQUVqQyxDQUFDLENBQUMsQ0FBQztRQUVQLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLEdBQUcsS0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFFckQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUtPLGdCQUFnQixDQUFDLEtBQTBCO1FBRS9DLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDaEQsTUFBTSxVQUFVLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFL0UsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUU5QixHQUFHLENBQUMsSUFBSSxDQUFDLDRCQUE0QixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRWhELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMseUJBQXlCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFeEMsSUFBSSxVQUFVLEVBQUU7WUFDWiw2Q0FBcUIsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDekM7SUFFTCxDQUFDO0lBRU8seUJBQXlCLENBQUMsT0FBaUI7UUFFL0MsUUFBUSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO1lBRXZFLDZDQUFxQixDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUxQyxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7Q0FFSjtBQXpIRCwwQkF5SEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RvY3VtZW50TG9hZGVkRXZlbnQsIE1vZGVsfSBmcm9tICcuLi9tb2RlbC9Nb2RlbCc7XG5pbXBvcnQge1ZpZXd9IGZyb20gJy4vVmlldyc7XG5pbXBvcnQge0RvY0Zvcm1hdEZhY3Rvcnl9IGZyb20gJy4uL2RvY2Zvcm1hdC9Eb2NGb3JtYXRGYWN0b3J5JztcbmltcG9ydCB7RG9jRm9ybWF0fSBmcm9tICcuLi9kb2Nmb3JtYXQvRG9jRm9ybWF0JztcbmltcG9ydCB7RG9jTWV0YURlc2NyaWJlcn0gZnJvbSAnLi4vbWV0YWRhdGEvRG9jTWV0YURlc2NyaWJlcic7XG5pbXBvcnQge2ZvckRpY3R9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC9GdW5jdGlvbnMnO1xuaW1wb3J0IHtEb2NNZXRhfSBmcm9tICcuLi9tZXRhZGF0YS9Eb2NNZXRhJztcbmltcG9ydCB7TG9nZ2VyfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtQcmVmc1Byb3ZpZGVyfSBmcm9tICcuLi9kYXRhc3RvcmUvRGF0YXN0b3JlJztcbmltcG9ydCB7UmVhZGluZ1Byb2dyZXNzUmVzdW1lfSBmcm9tICcuL1JlYWRpbmdQcm9ncmVzc1Jlc3VtZSc7XG5pbXBvcnQge1JlbmRlcmVyQW5hbHl0aWNzfSBmcm9tICcuLi9nYS9SZW5kZXJlckFuYWx5dGljcyc7XG5pbXBvcnQge0lEb2NNZXRhfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JRG9jTWV0YVwiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbmV4cG9ydCBjbGFzcyBXZWJWaWV3IGV4dGVuZHMgVmlldyB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGRvY0Zvcm1hdDogRG9jRm9ybWF0O1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmVmc1Byb3ZpZGVyOiBQcmVmc1Byb3ZpZGVyO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihtb2RlbDogTW9kZWwsIHByZWZzUHJvdmlkZXI6IFByZWZzUHJvdmlkZXIpIHtcbiAgICAgICAgc3VwZXIobW9kZWwpO1xuXG4gICAgICAgIHRoaXMucHJlZnNQcm92aWRlciA9IHByZWZzUHJvdmlkZXI7XG4gICAgICAgIHRoaXMuZG9jRm9ybWF0ID0gRG9jRm9ybWF0RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXJ0KCkge1xuXG4gICAgICAgIHRoaXMubW9kZWwucmVnaXN0ZXJMaXN0ZW5lckZvckRvY3VtZW50TG9hZGVkKGV2ZW50ID0+IHRoaXMub25Eb2N1bWVudExvYWRlZChldmVudCkpO1xuXG4gICAgICAgIHRoaXMuY3JlYXRlVGltZXIoKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcblxuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlVGltZXIoKSB7XG4gICAgICAgIGNvbnN0IGRvY3VtZW50TG9hZFRpbWVyID0gUmVuZGVyZXJBbmFseXRpY3MuY3JlYXRlVGltZXIoJ2RvY3VtZW50JywgJ2xvYWRlZCcpO1xuICAgICAgICB0aGlzLm1vZGVsLnJlZ2lzdGVyTGlzdGVuZXJGb3JEb2N1bWVudExvYWRlZChldmVudCA9PiBkb2N1bWVudExvYWRUaW1lci5zdG9wKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXByZWNhdGVkIE1vdmVkIHRvIHBhZ2VtYXJrLlByb2dyZXNzVmlldy4uLiByZW1vdmUgdGhpcyBjb2RlLlxuICAgICAqL1xuICAgIHB1YmxpYyB1cGRhdGVQcm9ncmVzcygpIHtcblxuICAgICAgICAvLyBUT0RPOiB0aGlzIHNob3VsZCBsaXN0ZW4gZGlyZWN0bHkgdG8gdGhlIG1vZGVsIGFuZCB0aGUgcGFnZW1hcmtzXG4gICAgICAgIC8vIHRoZW1zZWx2ZXMuXG5cbiAgICAgICAgY29uc3QgcGVyYyA9IHRoaXMuY29tcHV0ZVByb2dyZXNzKHRoaXMubW9kZWwuZG9jTWV0YSk7XG5cbiAgICAgICAgbG9nLmluZm8oXCJQZXJjZW50YWdlIGlzIG5vdzogXCIgKyBwZXJjKTtcblxuICAgICAgICBjb25zdCBoZWFkZXJFbGVtZW50ID0gPEhUTUxFbGVtZW50PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3BvbGFyLWhlYWRlclwiKTtcblxuICAgICAgICBpZiAoaGVhZGVyRWxlbWVudCkge1xuICAgICAgICAgICAgaGVhZGVyRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb2dyZXNzRWxlbWVudCA9IDxIVE1MUHJvZ3Jlc3NFbGVtZW50PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3BvbGFyLXByb2dyZXNzIHByb2dyZXNzXCIpO1xuXG4gICAgICAgIHByb2dyZXNzRWxlbWVudC52YWx1ZSA9IHBlcmM7XG5cbiAgICAgICAgLy8gbm93IHVwZGF0ZSB0aGUgZGVzY3JpcHRpb24gb2YgdGhlIGRvYyBhdCB0aGUgYm90dG9tLlxuXG4gICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gRG9jTWV0YURlc2NyaWJlci5kZXNjcmliZSh0aGlzLm1vZGVsLmRvY01ldGEpO1xuXG4gICAgICAgIGNvbnN0IGRvY092ZXJ2aWV3ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiNwb2xhci1kb2Mtb3ZlcnZpZXdcIik7XG5cbiAgICAgICAgaWYgKGRvY092ZXJ2aWV3KSB7XG4gICAgICAgICAgICBkb2NPdmVydmlldy50ZXh0Q29udGVudCA9IGRlc2NyaXB0aW9uO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAZGVwcmVjYXRlZCBNb3ZlZCB0byBwYWdlbWFyay5Qcm9ncmVzc1ZpZXcuLi4gcmVtb3ZlIHRoaXMgY29kZS5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNvbXB1dGVQcm9ncmVzcyhkb2NNZXRhOiBJRG9jTWV0YSkge1xuXG4gICAgICAgIC8vIEkgdGhpbmsgdGhpcyBpcyBhbiBpc3N1ZSBvZiBiZWluZyBhc3luYyBtYXliZWw/XG5cbiAgICAgICAgbGV0IHRvdGFsID0gMDtcblxuICAgICAgICBmb3JEaWN0KGRvY01ldGEucGFnZU1ldGFzLCAoa2V5LCBwYWdlTWV0YSkgPT4ge1xuXG4gICAgICAgICAgICBmb3JEaWN0KHBhZ2VNZXRhLnBhZ2VtYXJrcywgKGNvbHVtbiwgcGFnZW1hcmspID0+IHtcblxuICAgICAgICAgICAgICAgIHRvdGFsICs9IHBhZ2VtYXJrLnBlcmNlbnRhZ2U7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHBlcmMgPSB0b3RhbCAvIChkb2NNZXRhLmRvY0luZm8ubnJQYWdlcyAqIDEwMCk7XG5cbiAgICAgICAgcmV0dXJuIHBlcmM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0dXAgYSBkb2N1bWVudCBvbmNlIHdlIGRldGVjdCB0aGF0IGEgbmV3IG9uZSBoYXMgYmVlbiBsb2FkZWQuXG4gICAgICovXG4gICAgcHJpdmF0ZSBvbkRvY3VtZW50TG9hZGVkKGV2ZW50OiBEb2N1bWVudExvYWRlZEV2ZW50KSB7XG5cbiAgICAgICAgY29uc3QgZGF0YXN0b3JlUHJlZnMgPSB0aGlzLnByZWZzUHJvdmlkZXIuZ2V0KCk7XG4gICAgICAgIGNvbnN0IGF1dG9SZXN1bWUgPSBkYXRhc3RvcmVQcmVmcy5wcmVmcy5pc01hcmtlZCgnc2V0dGluZ3MtYXV0by1yZXN1bWUnLCB0cnVlKTtcblxuICAgICAgICBjb25zdCBkb2NNZXRhID0gZXZlbnQuZG9jTWV0YTtcblxuICAgICAgICBsb2cuaW5mbyhcIldlYlZpZXcub25Eb2N1bWVudExvYWRlZDogXCIsIGRvY01ldGEpO1xuXG4gICAgICAgIHRoaXMudXBkYXRlUHJvZ3Jlc3MoKTtcbiAgICAgICAgdGhpcy5oYW5kbGVQcm9ncmVzc0RvdWJsZUNsaWNrKGRvY01ldGEpO1xuXG4gICAgICAgIGlmIChhdXRvUmVzdW1lKSB7XG4gICAgICAgICAgICBSZWFkaW5nUHJvZ3Jlc3NSZXN1bWUucmVzdW1lKGRvY01ldGEpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVByb2dyZXNzRG91YmxlQ2xpY2soZG9jTWV0YTogSURvY01ldGEpIHtcblxuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3BvbGFyLWhlYWRlclwiKSEuYWRkRXZlbnRMaXN0ZW5lcignZGJsY2xpY2snLCAoKSA9PiB7XG5cbiAgICAgICAgICAgIFJlYWRpbmdQcm9ncmVzc1Jlc3VtZS5yZXN1bWUoZG9jTWV0YSk7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbn1cblxuXG4iXX0=