"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Logger_1 = require("polar-shared/src/logger/Logger");
const BaseWebRequestsListener_1 = require("./BaseWebRequestsListener");
const RequestState_1 = require("./RequestState");
const ProgressCalculator_1 = require("../util/ProgressCalculator");
const log = Logger_1.Logger.create();
class PendingWebRequestsListener extends BaseWebRequestsListener_1.BaseWebRequestsListener {
    constructor() {
        super();
        this.pendingRequests = {};
        this.eventListeners = [];
        this.requestState = new RequestState_1.RequestState();
        this.startedRequests = {};
        this.finishedRequests = {};
    }
    onWebRequestEvent(event) {
        setTimeout(() => {
            this.processWebRequestEvent(event);
        }, 0);
    }
    processWebRequestEvent(event) {
        const { name, details, callback } = event;
        let pendingChange = null;
        if (name === "onBeforeRequest") {
            this.pendingRequests[details.id] = details;
            this.startedRequests[details.id] = {
                event: name,
                id: details.id,
                url: details.url
            };
            pendingChange = "INCREMENTED";
            this.requestState.markStarted(details.id, details.url, name);
        }
        if (name === "onCompleted" ||
            name === "onErrorOccurred" ||
            name === "onBeforeRedirect" ||
            name === "onAuthRequired") {
            delete this.pendingRequests[details.id];
            this.finishedRequests[details.id] = {
                event: name,
                id: details.id,
                url: details.url
            };
            pendingChange = "DECREMENTED";
            this.requestState.markFinished(details.id, details.url, name);
        }
        const started = Object.keys(this.startedRequests).length;
        const finished = Object.keys(this.finishedRequests).length;
        const pending = started - finished;
        if (pendingChange) {
            log.info(`Pending state ${pendingChange} for request id=${details.id} to ${pending} on ${name} for URL: ${details.url}`);
        }
        const progress = ProgressCalculator_1.ProgressCalculator.calculate(finished, started);
        if (pending < 5) {
            log.debug("The following pending requests remain: \n", this.pendingRequests);
        }
        if (pending < 0) {
            const msg = `Pending request count is negative: ${pending} (started=${started}, finished=${finished})`;
            log.warn(msg);
        }
        log.debug(`Pending requests on ${name}: `, {
            pending,
            started,
            finished,
            progress
        });
        this.dispatchEventListeners({
            name,
            details,
            pending,
            started,
            finished,
            progress
        });
        if (callback) {
            callback({ cancel: false });
        }
    }
    addEventListener(eventListener) {
        this.eventListeners.push(eventListener);
    }
    dispatchEventListeners(event) {
        this.eventListeners.forEach(eventListener => {
            eventListener(event);
        });
    }
}
exports.PendingWebRequestsListener = PendingWebRequestsListener;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGVuZGluZ1dlYlJlcXVlc3RzTGlzdGVuZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQZW5kaW5nV2ViUmVxdWVzdHNMaXN0ZW5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDJEQUFzRDtBQUN0RCx1RUFBa0U7QUFDbEUsaURBQTRDO0FBQzVDLG1FQUE4RDtBQUU5RCxNQUFNLEdBQUcsR0FBRyxlQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFNNUIsTUFBYSwwQkFBMkIsU0FBUSxpREFBdUI7SUFxQm5FO1FBRUksS0FBSyxFQUFFLENBQUM7UUFsQkosb0JBQWUsR0FBd0IsRUFBRSxDQUFDO1FBSzFDLG1CQUFjLEdBQWlDLEVBQUUsQ0FBQztRQUtsRCxpQkFBWSxHQUFHLElBQUksMkJBQVksRUFBRSxDQUFDO1FBRWxDLG9CQUFlLEdBQXdCLEVBQUUsQ0FBQztRQUUxQyxxQkFBZ0IsR0FBd0IsRUFBRSxDQUFDO0lBT25ELENBQUM7SUFNTSxpQkFBaUIsQ0FBQyxLQUE0QjtRQUVqRCxVQUFVLENBQUMsR0FBRyxFQUFFO1lBRVosSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXZDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVWLENBQUM7SUFFTSxzQkFBc0IsQ0FBQyxLQUE0QjtRQUl0RCxNQUFNLEVBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUMsR0FBRyxLQUFLLENBQUM7UUFzQnhDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQztRQVN6QixJQUFJLElBQUksS0FBSyxpQkFBaUIsRUFBRTtZQUc1QixJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUM7WUFFM0MsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUc7Z0JBRS9CLEtBQUssRUFBRSxJQUFJO2dCQUNYLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRTtn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ZXN0RXZlbnQsIElXZWJSZXF1ZXN0RGV0YWlsc30gZnJvbSAnLi9XZWJSZXF1ZXN0UmVhY3Rvcic7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCB7QmFzZVdlYlJlcXVlc3RzTGlzdGVuZXJ9IGZyb20gJy4vQmFzZVdlYlJlcXVlc3RzTGlzdGVuZXInO1xuaW1wb3J0IHtSZXF1ZXN0U3RhdGV9IGZyb20gJy4vUmVxdWVzdFN0YXRlJztcbmltcG9ydCB7UHJvZ3Jlc3NDYWxjdWxhdG9yfSBmcm9tICcuLi91dGlsL1Byb2dyZXNzQ2FsY3VsYXRvcic7XG5cbmNvbnN0IGxvZyA9IExvZ2dlci5jcmVhdGUoKTtcblxuLyoqXG4gKiBUcmFja3MgdGhlIG51bWJlciBvZiBwZW5kaW5nIHJlcXVlc3RzLlxuICpcbiAqL1xuZXhwb3J0IGNsYXNzIFBlbmRpbmdXZWJSZXF1ZXN0c0xpc3RlbmVyIGV4dGVuZHMgQmFzZVdlYlJlcXVlc3RzTGlzdGVuZXIge1xuXG4gICAgLyoqXG4gICAgICogVGhlIGFjdHVhbCBldmVudHMgd2UndmUgc2VlbiBmb3IgdHJhY2tpbmcgcHVycG9zZXMuXG4gICAgICovXG4gICAgcHJpdmF0ZSBwZW5kaW5nUmVxdWVzdHM6IHtbaWQ6IG51bWJlcl06IGFueX0gPSB7fTtcblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyZWQgZXZlbnQgbGlzdGVuZXJzIHRoYXQgd2Ugd291bGQgbmVlZCB0byBkaXNwYXRjaC5cbiAgICAgKi9cbiAgICBwcml2YXRlIGV2ZW50TGlzdGVuZXJzOiBQZW5kaW5nV2ViUmVxdWVzdHNDYWxsYmFja1tdID0gW107XG5cbiAgICAvKipcbiAgICAgKiBLZWVwcyB0cmFjayBvZiBtZXRhZGF0YSBmb3IgZWFjaCByZXF1ZXN0IHRvIGhlbHAgZGV0ZWN0IGVycm9ycy5cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlcXVlc3RTdGF0ZSA9IG5ldyBSZXF1ZXN0U3RhdGUoKTtcblxuICAgIHByaXZhdGUgc3RhcnRlZFJlcXVlc3RzOiB7W2lkOiBudW1iZXJdOiBhbnl9ID0ge307XG5cbiAgICBwcml2YXRlIGZpbmlzaGVkUmVxdWVzdHM6IHtbaWQ6IG51bWJlcl06IGFueX0gPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuXG4gICAgICAgIHN1cGVyKCk7XG5cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxlZCB3aGVuIHdlIHJlY2VpdmUgYW4gZXZlbnQuICBBbGwgdGhlIGV2ZW50cyBnaXZlIHVzIGEgJ2RldGFpbHMnXG4gICAgICogb2JqZWN0IGFib3V0IHRoZSByZXF1ZXN0LlxuICAgICAqL1xuICAgIHB1YmxpYyBvbldlYlJlcXVlc3RFdmVudChldmVudDogSU5hbWVkV2ViUmVxdWVzdEV2ZW50KSB7XG5cbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1dlYlJlcXVlc3RFdmVudChldmVudCk7XG5cbiAgICAgICAgfSwgMCk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgcHJvY2Vzc1dlYlJlcXVlc3RFdmVudChldmVudDogSU5hbWVkV2ViUmVxdWVzdEV2ZW50KSB7XG5cbiAgICAgICAgLy8gY29uc29sZS5sb2coYGV2ZW50IGRhdGE6ICR7ZXZlbnQubmFtZX1cXHQke2V2ZW50LmRldGFpbHMuaWR9XFx0JHtldmVudC5kZXRhaWxzLnVybH1cXHQke2V2ZW50LmRldGFpbHMucmVzb3VyY2VUeXBlfVxcdCR7ZXZlbnQuZGV0YWlscy53ZWJDb250ZW50c0lkfWApO1xuXG4gICAgICAgIGNvbnN0IHtuYW1lLCBkZXRhaWxzLCBjYWxsYmFja30gPSBldmVudDtcblxuICAgICAgICAvLyBXQVJOSU5HOiB0aGlzIGNvZGUgYmVoYXZlcyBWRVJZIHN0cmFuZ2VseSBhbmQgd2UgRE8gTk9UIHJlY2VpdmUgZXZlbnRzXG4gICAgICAgIC8vIGluIHRoZSBwcm9wZXIgb3JkZXIgZm9yIHNvbWUgcmVhc29uLiAgSSB3b3VsZCBleHBlY3QgdG8gcmVjZWl2ZSB0aGVtXG4gICAgICAgIC8vIGluIHRoZSBsb2dpY2FsIG9yZGVyIGRldGFpbGVkIGhlcmU6XG4gICAgICAgIC8vXG4gICAgICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLmNocm9tZS5jb20vZXh0ZW5zaW9ucy93ZWJSZXF1ZXN0XG4gICAgICAgIC8vXG4gICAgICAgIC8vIGJ1dCB3ZSBhY3R1YWxseSByZWNlaXZlIHRoZW0gb3V0IG9mIG9yZGVyLlxuICAgICAgICAvL1xuICAgICAgICAvLyB0aGlzIG1lYW5zIHRoYXQgdGhlIHBlbmRpbmcgcmVxdWVzdCBjb3VudCBjYW4gZ28gdG8gbmVnYXRpdmUgdW50aWxcbiAgICAgICAgLy8gaXQgZ29lcyBwb3NpdGl2ZS4gSSBzdXNwZWN0IHRoYXQgdGhleSdyZSB1c2luZyBzb21lIHNvcnQgb2YgbXVsdGktY29yZVxuICAgICAgICAvLyBvciB1bmZhaXIgcXVldWUgc3lzdGVtIHRoYXQgcmUtb3JkZXJzIHRoZSBldmVudHMgYmVmb3JlIEkgc2VlIGl0IG9yXG4gICAgICAgIC8vIHRoaXMgY29kZSBpcyBleGVjdXRpbmcgYWNyb3NzIG11bHRpcGxlIHRocmVhZHMgb24gbXVsdGlwbGUgY29yZXMgYW5kXG4gICAgICAgIC8vIHRoZSBkYXRhIGlzIGJlaW5nIGhhbmRsZWQgYmFsYW5jZWQgYWNyb3NzIGNvcmVzIHdoaWNoIGlzIHdoeSB3ZSBzZWVcbiAgICAgICAgLy8gb3JkZXJpbmcgaXNzdWVzLlxuICAgICAgICAvL1xuICAgICAgICAvLyBJJ3ZlIGFkZGVkIHNvbWUgbG9nZ2luZyB0byB0aGUgY29kZSBzbyB3ZSBjYW4gdHJhY2UgdGhpcyBidXQgaXQnc1xuICAgICAgICAvLyByYXRoZXIgZGlmZmljdWx0IHRvIGRlYWwgd2l0aCBiZWNhdXNlIGEgcmVhbCBidXQgY291bGQgaGFwcGVuXG4gICAgICAgIC8vIGFyb3VuZCBkcm9wcGVkIG1lc3NhZ2VzIGJ1dCB3ZSB3b3VsZG4ndCBub3RpY2UgdGhhdCB3aGVyZSBuZWdhdGl2ZVxuICAgICAgICAvLyBjb3VudHMgY291bGQgY2F0Y2ggaXQuXG5cbiAgICAgICAgbGV0IHBlbmRpbmdDaGFuZ2UgPSBudWxsO1xuXG5cbiAgICAgICAgLy8gV0FSTjogSSBkb24ndCB0aGluayBpbmNyZW1lbnQgKyBkZWNyZW1lbnQgd29yayBoZXJlIGFzIEkgc3VzcGVjdFxuICAgICAgICAvLyBtdWx0aXBsZSB0aHJlYWRzIGFyZSBjYWxsaW5nIHVzIHNvIHdlJ3JlIGhhdmluZyB0byBrZWVwIHJlcXVlc3RzXG4gICAgICAgIC8vIGluIG1hcHMgd2hpY2ggd2FzdGVzIGEgYml0IG1vcmUgbWVtb3J5LiBJIHN1c3BlY3Qgd2UgaGF2ZSBvbmUgdGhyZWFkXG4gICAgICAgIC8vIHBlciBpZnJhbWUuICBFaXRoZXIgd2F5IHVzaW5nIGRpY3Rpb25hcmllcyBhdm9pZGVkIGEgLTEgcGVuZGluZ1xuICAgICAgICAvLyBjb3VudC5cblxuICAgICAgICBpZiAobmFtZSA9PT0gXCJvbkJlZm9yZVJlcXVlc3RcIikge1xuICAgICAgICAgICAgLy8gYWZ0ZXIgdGhpcyByZXF1ZXN0IHRoZSBwZW5kaW5nIHdpbGwgYmUgaW5jcmVtZW50ZWQuXG5cbiAgICAgICAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzW2RldGFpbHMuaWRdID0gZGV0YWlscztcblxuICAgICAgICAgICAgdGhpcy5zdGFydGVkUmVxdWVzdHNbZGV0YWlscy5pZF0gPSB7XG4gICAgICAgICAgICAgICAgLy8gdGhlIGV2ZW50IHVzZWQgdG8gbWFyayB0aGUgcmVxdWVzdCBzdGFydGVkXG4gICAgICAgICAgICAgICAgZXZlbnQ6IG5hbWUsXG4gICAgICAgICAgICAgICAgaWQ6IGRldGFpbHMuaWQsXG4gICAgICAgICAgICAgICAgdXJsOiBkZXRhaWxzLnVybFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcGVuZGluZ0NoYW5nZSA9IFwiSU5DUkVNRU5URURcIjtcblxuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0U3RhdGUubWFya1N0YXJ0ZWQoZGV0YWlscy5pZCwgZGV0YWlscy51cmwsIG5hbWUpO1xuXG4gICAgICAgIH1cblxuXG4gICAgICAgIC8vIE5PVEUgb25FcnJvck9jY3VycmVkIGlzIGEgZmFpbCB0aHJvdWdoIGZvciBtYW55IG9mIHRoZXNlIEkgdGhpbmsuXG4gICAgICAgIGlmIChuYW1lID09PSBcIm9uQ29tcGxldGVkXCIgfHxcbiAgICAgICAgICAgIG5hbWUgPT09IFwib25FcnJvck9jY3VycmVkXCIgfHxcbiAgICAgICAgICAgIG5hbWUgPT09IFwib25CZWZvcmVSZWRpcmVjdFwiIHx8XG4gICAgICAgICAgICBuYW1lID09PSBcIm9uQXV0aFJlcXVpcmVkXCIpIHtcblxuICAgICAgICAgICAgLy8gdGhpcyByZXF1ZXN0IGhhcyBhbHJlYWR5IGNvbXBsZXRlZCBzbyBpcyBub3QgY29uc2lkZXJlZCBhZ2FpbnN0XG4gICAgICAgICAgICAvLyBwZW5kaW5nIGFueSBsb25nZXJcblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMucGVuZGluZ1JlcXVlc3RzW2RldGFpbHMuaWRdO1xuXG4gICAgICAgICAgICB0aGlzLmZpbmlzaGVkUmVxdWVzdHNbZGV0YWlscy5pZF0gPSB7XG4gICAgICAgICAgICAgICAgLy8gdGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRoYXQgd2UgdXNlZCB0byBtYXJrIGZpbmlzaGVkLlxuICAgICAgICAgICAgICAgIGV2ZW50OiBuYW1lLFxuICAgICAgICAgICAgICAgIGlkOiBkZXRhaWxzLmlkLFxuICAgICAgICAgICAgICAgIHVybDogZGV0YWlscy51cmxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHBlbmRpbmdDaGFuZ2UgPSBcIkRFQ1JFTUVOVEVEXCI7XG5cbiAgICAgICAgICAgIHRoaXMucmVxdWVzdFN0YXRlLm1hcmtGaW5pc2hlZChkZXRhaWxzLmlkLCBkZXRhaWxzLnVybCwgbmFtZSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUaGUgdG90YWwgbnVtYmVyIG9mIHJlcXVlc3RzIHRoYXQgaGF2ZSBiZWVuIHN0YXJ0ZWQuXG4gICAgICAgICAqXG4gICAgICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBzdGFydGVkID0gT2JqZWN0LmtleXModGhpcy5zdGFydGVkUmVxdWVzdHMpLmxlbmd0aDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogVGhlIHRvdGFsIG51bWJlciBvZiBmaW5pc2hlZCByZXF1ZXN0cyAoZWl0aGVyIGNvbXBsZXRlZCwgb3IgZmFpbGVkKVxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgZmluaXNoZWQgPSBPYmplY3Qua2V5cyh0aGlzLmZpbmlzaGVkUmVxdWVzdHMpLmxlbmd0aDtcblxuICAgICAgICAvKipcbiAgICAgICAgICogVGhlIG51bWJlciBvZiBwZW5kaW5nIHJlcXVlc3RzIHRoYXQgaGF2ZSBub3QgeWV0IGZpbmlzaGVkLlxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgcGVuZGluZyA9IHN0YXJ0ZWQgLSBmaW5pc2hlZDtcblxuICAgICAgICBpZiAocGVuZGluZ0NoYW5nZSkge1xuICAgICAgICAgICAgbG9nLmluZm8oYFBlbmRpbmcgc3RhdGUgJHtwZW5kaW5nQ2hhbmdlfSBmb3IgcmVxdWVzdCBpZD0ke2RldGFpbHMuaWR9IHRvICR7cGVuZGluZ30gb24gJHtuYW1lfSBmb3IgVVJMOiAke2RldGFpbHMudXJsfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSBjdXJyZW50IHByb2dyZXNzIGZvciB0aGUgcGFnZSBmcm9tIDAgdG8gMTAwLlxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBQcm9ncmVzc0NhbGN1bGF0b3IuY2FsY3VsYXRlKGZpbmlzaGVkLCBzdGFydGVkKTtcblxuICAgICAgICBpZiAocGVuZGluZyA8IDUpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIlRoZSBmb2xsb3dpbmcgcGVuZGluZyByZXF1ZXN0cyByZW1haW46IFxcblwiLCB0aGlzLnBlbmRpbmdSZXF1ZXN0cyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGVuZGluZyA8IDApIHtcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGBQZW5kaW5nIHJlcXVlc3QgY291bnQgaXMgbmVnYXRpdmU6ICR7cGVuZGluZ30gKHN0YXJ0ZWQ9JHtzdGFydGVkfSwgZmluaXNoZWQ9JHtmaW5pc2hlZH0pYDtcbiAgICAgICAgICAgIGxvZy53YXJuKG1zZyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBUT0RPOiB3ZSByZW1vdmVkIGxvZ2dpbmcgdGhlIGZ1bGwgZGV0YWlscyBvYmplY3QgYmVjYXVzZSB0aGVcbiAgICAgICAgLy8gdXBsb2FkRGF0YSB3YXMganVzdCB0b28gbXVjaCBjb250ZW50LlxuXG4gICAgICAgIGxvZy5kZWJ1ZyhgUGVuZGluZyByZXF1ZXN0cyBvbiAke25hbWV9OiBgLCB7XG4gICAgICAgICAgICBwZW5kaW5nLFxuICAgICAgICAgICAgc3RhcnRlZCxcbiAgICAgICAgICAgIGZpbmlzaGVkLFxuICAgICAgICAgICAgcHJvZ3Jlc3NcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50TGlzdGVuZXJzKHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICBkZXRhaWxzLFxuICAgICAgICAgICAgcGVuZGluZyxcbiAgICAgICAgICAgIHN0YXJ0ZWQsXG4gICAgICAgICAgICBmaW5pc2hlZCxcbiAgICAgICAgICAgIHByb2dyZXNzXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgLy8gdGhlIGNhbGxiYWNrIGFsd2F5cyBoYXMgdG8gYmUgdXNlZCBvciB0aGUgcmVxdWVzdHMgd2lsbCBiZVxuICAgICAgICAgICAgLy8gY2FuY2VsbGVkLlxuICAgICAgICAgICAgY2FsbGJhY2soe2NhbmNlbDogZmFsc2V9KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZXZlbnRMaXN0ZW5lciB7RnVuY3Rpb259XG4gICAgICovXG4gICAgcHVibGljIGFkZEV2ZW50TGlzdGVuZXIoZXZlbnRMaXN0ZW5lcjogUGVuZGluZ1dlYlJlcXVlc3RzQ2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5ldmVudExpc3RlbmVycy5wdXNoKGV2ZW50TGlzdGVuZXIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkaXNwYXRjaEV2ZW50TGlzdGVuZXJzKGV2ZW50OiBQZW5kaW5nV2ViUmVxdWVzdHNFdmVudCkge1xuICAgICAgICB0aGlzLmV2ZW50TGlzdGVuZXJzLmZvckVhY2goZXZlbnRMaXN0ZW5lciA9PiB7XG4gICAgICAgICAgICBldmVudExpc3RlbmVyKGV2ZW50KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG59XG5cbmV4cG9ydCB0eXBlIFBlbmRpbmdXZWJSZXF1ZXN0c0NhbGxiYWNrID0gKGV2ZW50OiBQZW5kaW5nV2ViUmVxdWVzdHNFdmVudCkgPT4gdm9pZDtcblxuZXhwb3J0IGludGVyZmFjZSBQZW5kaW5nV2ViUmVxdWVzdHNFdmVudCB7XG5cbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgZGV0YWlsczogSVdlYlJlcXVlc3REZXRhaWxzO1xuICAgIHJlYWRvbmx5IHBlbmRpbmc6IG51bWJlcjtcbiAgICByZWFkb25seSBzdGFydGVkOiBudW1iZXI7XG4gICAgcmVhZG9ubHkgZmluaXNoZWQ6IG51bWJlcjtcbiAgICByZWFkb25seSBwcm9ncmVzczogbnVtYmVyO1xuXG59XG4iXX0=