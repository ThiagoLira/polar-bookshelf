"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Reactor_1 = require("../reactor/Reactor");
class WebRequestReactor {
    constructor(webRequest) {
        this.started = false;
        this.webRequest = webRequest;
        this.reactor = new Reactor_1.Reactor();
        this.started = false;
    }
    start() {
        this.webRequest.onBeforeRedirect(this.handleBeforeRedirect.bind(this));
        this.webRequest.onBeforeRequest(this.handleBeforeRequest.bind(this));
        this.webRequest.onBeforeSendHeaders(this.handleBeforeSendHeaders.bind(this));
        this.webRequest.onCompleted(this.handleCompleted.bind(this));
        this.webRequest.onErrorOccurred(this.handleErrorOccurred.bind(this));
        this.webRequest.onResponseStarted(this.handleResponseStarted.bind(this));
        this.webRequest.onSendHeaders(this.handleSendHeaders.bind(this));
        const eventNames = [
            "onBeforeRedirect",
            "onBeforeRequest",
            "onBeforeSendHeaders",
            "onCompleted",
            "onErrorOccurred",
            "onResponseStarted",
            "onSendHeaders",
        ];
        eventNames.forEach((eventName) => {
            this.reactor.registerEvent(eventName);
        });
        this.started = true;
    }
    stop() {
        this.started = false;
        this.webRequest.onBeforeRedirect(null);
        this.webRequest.onBeforeRequest(null);
        this.webRequest.onBeforeSendHeaders(null);
        this.webRequest.onCompleted(null);
        this.webRequest.onErrorOccurred(null);
        this.webRequest.onResponseStarted(null);
        this.webRequest.onSendHeaders(null);
    }
    register(callback) {
        Preconditions_1.Preconditions.assertNotNull(callback, "callback");
        if (!this.started) {
            throw new Error("Not started!");
        }
        this.reactor.eventNames().forEach((eventName) => {
            this.reactor.addEventListener(eventName, callback);
        });
    }
    handleBeforeRequest(details, callback) {
        this.handleEvent({
            name: 'onBeforeRequest',
            details,
            callback,
        });
    }
    handleBeforeSendHeaders(details, callback) {
        this.handleEvent({
            name: 'onBeforeSendHeaders',
            details,
            callback,
        });
    }
    handleBeforeRedirect(details) {
        this.handleEvent({
            name: 'onBeforeRedirect',
            details,
        });
    }
    handleCompleted(details) {
        this.handleEvent({
            name: 'onCompleted',
            details,
        });
    }
    handleErrorOccurred(details) {
        this.handleEvent({
            name: 'onErrorOccurred',
            details,
        });
    }
    handleResponseStarted(details) {
        this.handleEvent({
            name: 'onResponseStarted',
            details,
        });
    }
    handleSendHeaders(details) {
        this.handleEvent({
            name: 'onSendHeaders',
            details,
        });
    }
    handleEvent(event, callback) {
        if (!this.started) {
            if (callback) {
                callback({ cancel: false });
            }
            return;
        }
        this.reactor.dispatchEvent(event.name, event);
    }
}
exports.WebRequestReactor = WebRequestReactor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViUmVxdWVzdFJlYWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJXZWJSZXF1ZXN0UmVhY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGtFQUE2RDtBQUM3RCxnREFBMkM7QUFVM0MsTUFBYSxpQkFBaUI7SUFRMUIsWUFBWSxVQUFzQjtRQUYzQixZQUFPLEdBQUcsS0FBSyxDQUFDO1FBR25CLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxpQkFBTyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDekIsQ0FBQztJQUtNLEtBQUs7UUFFUixJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDekUsSUFBSSxDQUFDLFVBQVUsQ0FB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QUFDLFdBQVcsQ0FBQztZQUNiLElBQUksRUFBRSxlQUFlO1lBQ3JCLE9BQU87U0FDVixDQUFDLENBQUM7SUFFUCxDQUFDO0lBRU8sV0FBVyxDQUFDLEtBQTRCLEVBQUUsUUFBZ0Q7UUFFOUYsSUFBSSxDQUFFLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFFaEIsSUFBSSxRQUFRLEVBQUU7Z0JBQ1YsUUFBUSxDQUFDLEVBQUMsTUFBTSxFQUFFLEtBQUssRUFBQyxDQUFDLENBQUM7YUFDN0I7WUFFRCxPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRWxELENBQUM7Q0FFSjtBQWxLRCw4Q0FrS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1dlYlJlcXVlc3R9IGZyb20gJ2VsZWN0cm9uJztcbmltcG9ydCB7UHJlY29uZGl0aW9uc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zJztcbmltcG9ydCB7UmVhY3Rvcn0gZnJvbSAnLi4vcmVhY3Rvci9SZWFjdG9yJztcbmltcG9ydCBPbkJlZm9yZVJlZGlyZWN0RGV0YWlscyA9IEVsZWN0cm9uLk9uQmVmb3JlUmVkaXJlY3REZXRhaWxzO1xuaW1wb3J0IE9uQmVmb3JlUmVxdWVzdERldGFpbHMgPSBFbGVjdHJvbi5PbkJlZm9yZVJlcXVlc3REZXRhaWxzO1xuaW1wb3J0IE9uQ29tcGxldGVkRGV0YWlscyA9IEVsZWN0cm9uLk9uQ29tcGxldGVkRGV0YWlscztcbmltcG9ydCBPbkVycm9yT2NjdXJyZWREZXRhaWxzID0gRWxlY3Ryb24uT25FcnJvck9jY3VycmVkRGV0YWlscztcbmltcG9ydCBPblJlc3BvbnNlU3RhcnRlZERldGFpbHMgPSBFbGVjdHJvbi5PblJlc3BvbnNlU3RhcnRlZERldGFpbHM7XG5pbXBvcnQgT25TZW5kSGVhZGVyc0RldGFpbHMgPSBFbGVjdHJvbi5PblNlbmRIZWFkZXJzRGV0YWlscztcbmltcG9ydCBPbkJlZm9yZVNlbmRIZWFkZXJzRGV0YWlscyA9IEVsZWN0cm9uLk9uQmVmb3JlU2VuZEhlYWRlcnNEZXRhaWxzO1xuXG5cbmV4cG9ydCBjbGFzcyBXZWJSZXF1ZXN0UmVhY3RvciB7XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgd2ViUmVxdWVzdDogV2ViUmVxdWVzdDtcblxuICAgIHB1YmxpYyByZWFkb25seSByZWFjdG9yOiBSZWFjdG9yPElOYW1lZFdlYlJlcXVlc3RFdmVudD47XG5cbiAgICBwdWJsaWMgc3RhcnRlZCA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3Iod2ViUmVxdWVzdDogV2ViUmVxdWVzdCkge1xuICAgICAgICB0aGlzLndlYlJlcXVlc3QgPSB3ZWJSZXF1ZXN0O1xuICAgICAgICB0aGlzLnJlYWN0b3IgPSBuZXcgUmVhY3RvcigpO1xuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCaW5kIGVhY2ggd2ViUmVxdWVzdCBldmVudCB0byBnbyBpbnRvIHRoZSByZWFjdG9yLlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGFydCgpIHtcblxuICAgICAgICB0aGlzLndlYlJlcXVlc3Qub25CZWZvcmVSZWRpcmVjdCh0aGlzLmhhbmRsZUJlZm9yZVJlZGlyZWN0LmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLndlYlJlcXVlc3Qub25CZWZvcmVSZXF1ZXN0KHRoaXMuaGFuZGxlQmVmb3JlUmVxdWVzdC5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy53ZWJSZXF1ZXN0Lm9uQmVmb3JlU2VuZEhlYWRlcnModGhpcy5oYW5kbGVCZWZvcmVTZW5kSGVhZGVycy5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy53ZWJSZXF1ZXN0Lm9uQ29tcGxldGVkKHRoaXMuaGFuZGxlQ29tcGxldGVkLmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLndlYlJlcXVlc3Qub25FcnJvck9jY3VycmVkKHRoaXMuaGFuZGxlRXJyb3JPY2N1cnJlZC5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy53ZWJSZXF1ZXN0Lm9uUmVzcG9uc2VTdGFydGVkKHRoaXMuaGFuZGxlUmVzcG9uc2VTdGFydGVkLmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLndlYlJlcXVlc3Qub25TZW5kSGVhZGVycyh0aGlzLmhhbmRsZVNlbmRIZWFkZXJzLmJpbmQodGhpcykpO1xuXG4gICAgICAgIC8vIFRPRE86IHRoaXMgaXMgYSBiaXQgdWdseSB0byBkdXBsaWNhdGUgdGhpcyBidXQgaXQgbWlnaHQgYmUgcG9zc2libGVcbiAgICAgICAgLy8gdG8gcmVmYWN0b3IgaW4gdGhlIGZ1dHVyZSB0byBtYWtlIGl0IGEgYml0IGNsZWFuZXIuXG5cbiAgICAgICAgY29uc3QgZXZlbnROYW1lcyA9IFtcbiAgICAgICAgICAgIFwib25CZWZvcmVSZWRpcmVjdFwiLFxuICAgICAgICAgICAgXCJvbkJlZm9yZVJlcXVlc3RcIixcbiAgICAgICAgICAgIFwib25CZWZvcmVTZW5kSGVhZGVyc1wiLFxuICAgICAgICAgICAgXCJvbkNvbXBsZXRlZFwiLFxuICAgICAgICAgICAgXCJvbkVycm9yT2NjdXJyZWRcIixcbiAgICAgICAgICAgIFwib25SZXNwb25zZVN0YXJ0ZWRcIixcbiAgICAgICAgICAgIFwib25TZW5kSGVhZGVyc1wiLFxuICAgICAgICBdO1xuXG4gICAgICAgIGV2ZW50TmFtZXMuZm9yRWFjaCgoZXZlbnROYW1lKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWN0b3IucmVnaXN0ZXJFdmVudChldmVudE5hbWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0b3AoKSB7XG5cbiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy53ZWJSZXF1ZXN0Lm9uQmVmb3JlUmVkaXJlY3QobnVsbCEpO1xuICAgICAgICB0aGlzLndlYlJlcXVlc3Qub25CZWZvcmVSZXF1ZXN0KG51bGwhKTtcbiAgICAgICAgdGhpcy53ZWJSZXF1ZXN0Lm9uQmVmb3JlU2VuZEhlYWRlcnMobnVsbCEpO1xuICAgICAgICB0aGlzLndlYlJlcXVlc3Qub25Db21wbGV0ZWQobnVsbCEpO1xuICAgICAgICB0aGlzLndlYlJlcXVlc3Qub25FcnJvck9jY3VycmVkKG51bGwhKTtcbiAgICAgICAgdGhpcy53ZWJSZXF1ZXN0Lm9uUmVzcG9uc2VTdGFydGVkKG51bGwhKTtcbiAgICAgICAgdGhpcy53ZWJSZXF1ZXN0Lm9uU2VuZEhlYWRlcnMobnVsbCEpO1xuXG5cbiAgICAgICAgLy8gVE9ETzogY29uc2lkZXIgY2xlYXJpbmcgdGhlIHJlYWN0b3IgdG9vLlxuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgcmVnaXN0ZXIoY2FsbGJhY2s6IElSZWdpc3RlckNhbGxiYWNrKSB7XG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnROb3ROdWxsKGNhbGxiYWNrLCBcImNhbGxiYWNrXCIpO1xuXG4gICAgICAgIGlmICghIHRoaXMuc3RhcnRlZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IHN0YXJ0ZWQhXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZWFjdG9yLmV2ZW50TmFtZXMoKS5mb3JFYWNoKChldmVudE5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhY3Rvci5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlQmVmb3JlUmVxdWVzdChkZXRhaWxzOiBPbkJlZm9yZVJlcXVlc3REZXRhaWxzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogKHJlc3BvbnNlOiBFbGVjdHJvbi5SZXNwb25zZSkgPT4gdm9pZCk6IHZvaWQge1xuXG4gICAgICAgIHRoaXMuaGFuZGxlRXZlbnQoe1xuICAgICAgICAgICAgbmFtZTogJ29uQmVmb3JlUmVxdWVzdCcsXG4gICAgICAgICAgICBkZXRhaWxzLFxuICAgICAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVCZWZvcmVTZW5kSGVhZGVycyhkZXRhaWxzOiBPbkJlZm9yZVNlbmRIZWFkZXJzRGV0YWlscyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAocmVzcG9uc2U6IEVsZWN0cm9uLlJlc3BvbnNlKSA9PiB2b2lkKTogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5oYW5kbGVFdmVudCh7XG4gICAgICAgICAgICBuYW1lOiAnb25CZWZvcmVTZW5kSGVhZGVycycsXG4gICAgICAgICAgICBkZXRhaWxzLFxuICAgICAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVCZWZvcmVSZWRpcmVjdChkZXRhaWxzOiBPbkJlZm9yZVJlZGlyZWN0RGV0YWlscyk6IHZvaWQge1xuXG4gICAgICAgIHRoaXMuaGFuZGxlRXZlbnQoe1xuICAgICAgICAgICAgbmFtZTogJ29uQmVmb3JlUmVkaXJlY3QnLFxuICAgICAgICAgICAgZGV0YWlscyxcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUNvbXBsZXRlZChkZXRhaWxzOiBPbkNvbXBsZXRlZERldGFpbHMpOiB2b2lkIHtcblxuICAgICAgICB0aGlzLmhhbmRsZUV2ZW50KHtcbiAgICAgICAgICAgIG5hbWU6ICdvbkNvbXBsZXRlZCcsXG4gICAgICAgICAgICBkZXRhaWxzLFxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRXJyb3JPY2N1cnJlZChkZXRhaWxzOiBPbkVycm9yT2NjdXJyZWREZXRhaWxzKTogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5oYW5kbGVFdmVudCh7XG4gICAgICAgICAgICBuYW1lOiAnb25FcnJvck9jY3VycmVkJyxcbiAgICAgICAgICAgIGRldGFpbHMsXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVSZXNwb25zZVN0YXJ0ZWQoZGV0YWlsczogT25SZXNwb25zZVN0YXJ0ZWREZXRhaWxzKTogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5oYW5kbGVFdmVudCh7XG4gICAgICAgICAgICBuYW1lOiAnb25SZXNwb25zZVN0YXJ0ZWQnLFxuICAgICAgICAgICAgZGV0YWlscyxcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICAgcHJpdmF0ZSBoYW5kbGVTZW5kSGVhZGVycyhkZXRhaWxzOiBPblNlbmRIZWFkZXJzRGV0YWlscyk6IHZvaWQge1xuXG4gICAgICAgIHRoaXMuaGFuZGxlRXZlbnQoe1xuICAgICAgICAgICAgbmFtZTogJ29uU2VuZEhlYWRlcnMnLFxuICAgICAgICAgICAgZGV0YWlscyxcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUV2ZW50KGV2ZW50OiBJTmFtZWRXZWJSZXF1ZXN0RXZlbnQsIGNhbGxiYWNrPzogKHJlc3BvbnNlOiBFbGVjdHJvbi5SZXNwb25zZSkgPT4gdm9pZCkge1xuXG4gICAgICAgIGlmICghIHRoaXMuc3RhcnRlZCkge1xuXG4gICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayh7Y2FuY2VsOiBmYWxzZX0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnJlYWN0b3IuZGlzcGF0Y2hFdmVudChldmVudC5uYW1lLCBldmVudCk7XG5cbiAgICB9XG5cbn1cblxuZXhwb3J0IHR5cGUgSVJlZ2lzdGVyQ2FsbGJhY2sgPSAoZXZlbnQ6IElOYW1lZFdlYlJlcXVlc3RFdmVudCkgPT4gdm9pZDtcblxuZXhwb3J0IGludGVyZmFjZSBJTmFtZWRXZWJSZXF1ZXN0RXZlbnQge1xuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICAgIHJlYWRvbmx5IGRldGFpbHM6IElXZWJSZXF1ZXN0RGV0YWlscztcblxuICAgIHJlYWRvbmx5IGNhbGxiYWNrPzogKHJlc3BvbnNlOiBFbGVjdHJvbi5SZXNwb25zZSkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJV2ViUmVxdWVzdERldGFpbHMge1xuXG4gICAgcmVhZG9ubHkgaWQ6IG51bWJlcjtcbiAgICByZWFkb25seSB1cmw6IHN0cmluZztcbiAgICByZWFkb25seSBtZXRob2Q6IHN0cmluZztcbiAgICByZWFkb25seSB3ZWJDb250ZW50c0lkPzogbnVtYmVyO1xuICAgIHJlYWRvbmx5IHJlc291cmNlVHlwZTogc3RyaW5nO1xuXG59XG4iXX0=