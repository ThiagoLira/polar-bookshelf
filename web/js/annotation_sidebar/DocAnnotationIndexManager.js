"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DocAnnotations_1 = require("./DocAnnotations");
const AreaHighlightModel_1 = require("../highlights/area/model/AreaHighlightModel");
const TextHighlightModel_1 = require("../highlights/text/model/TextHighlightModel");
const CommentModel_1 = require("./CommentModel");
const FlashcardModel_1 = require("./FlashcardModel");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const MutationType_1 = require("../proxies/MutationType");
const Logger_1 = require("polar-shared/src/logger/Logger");
const log = Logger_1.Logger.create();
class DocAnnotationIndexManager {
    constructor(docFileResolver, docAnnotationIndex, onUpdated) {
        this.docFileResolver = docFileResolver;
        this.docAnnotationIndex = docAnnotationIndex;
        this.onUpdated = onUpdated;
        this.registering = false;
    }
    registerListenerForDocMeta(docMeta, opts = {}) {
        const { docFileResolver } = this;
        this.registering = true;
        new AreaHighlightModel_1.AreaHighlightModel().registerListener(docMeta, annotationEvent => {
            const handleConversion = () => {
                const converter = (annotationValue) => {
                    return DocAnnotations_1.DocAnnotations.createFromAreaHighlight(docFileResolver, docMeta, annotationValue, annotationEvent.pageMeta);
                };
                const docAnnotation = this.convertAnnotation(annotationEvent.value, converter);
                this.handleAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, docAnnotation);
            };
            handleConversion();
        }, opts);
        new TextHighlightModel_1.TextHighlightModel().registerListener(docMeta, annotationEvent => {
            const docAnnotation = this.convertAnnotation(annotationEvent.value, annotationValue => DocAnnotations_1.DocAnnotations.createFromTextHighlight(docMeta, annotationValue, annotationEvent.pageMeta));
            this.handleAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, docAnnotation);
        }, opts);
        new CommentModel_1.CommentModel().registerListener(docMeta, annotationEvent => {
            const comment = annotationEvent.value || annotationEvent.previousValue;
            const childDocAnnotation = DocAnnotations_1.DocAnnotations.createFromComment(docMeta, comment, annotationEvent.pageMeta);
            this.handleChildAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, childDocAnnotation);
        }, opts);
        new FlashcardModel_1.FlashcardModel().registerListener(docMeta, annotationEvent => {
            const flashcard = annotationEvent.value || annotationEvent.previousValue;
            const childDocAnnotation = DocAnnotations_1.DocAnnotations.createFromFlashcard(docMeta, flashcard, annotationEvent.pageMeta);
            this.handleChildAnnotationEvent(annotationEvent.id, annotationEvent.traceEvent.mutationType, childDocAnnotation);
        }, opts);
        this.registering = false;
        this.fireUpdated();
    }
    convertAnnotation(value, converter) {
        if (!Preconditions_1.isPresent(value)) {
            return undefined;
        }
        return converter(value);
    }
    handleChildAnnotationEvent(id, mutationType, childDocAnnotation) {
        if (!childDocAnnotation.ref) {
            log.warn("Annotation hidden from sidebar: ", childDocAnnotation);
            return;
        }
        if (mutationType === MutationType_1.MutationType.DELETE) {
            this.deleteDocAnnotation(id);
        }
        else {
            this.addDocAnnotation(childDocAnnotation);
        }
    }
    handleAnnotationEvent(id, mutationType, docAnnotation) {
        if (mutationType === MutationType_1.MutationType.DELETE) {
            this.deleteDocAnnotation(id);
        }
        else {
            this.addDocAnnotation(docAnnotation);
        }
    }
    deleteDocAnnotation(id) {
        this.docAnnotationIndex.delete(id);
        this.fireUpdated();
    }
    addDocAnnotation(docAnnotation) {
        this.docAnnotationIndex.put(docAnnotation);
        this.fireUpdated();
    }
    fireUpdated() {
        const annotations = this.docAnnotationIndex.getDocAnnotationsSorted();
        if (!this.registering) {
            this.onUpdated(annotations);
        }
    }
}
exports.DocAnnotationIndexManager = DocAnnotationIndexManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRG9jQW5ub3RhdGlvbkluZGV4TWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkRvY0Fubm90YXRpb25JbmRleE1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxxREFBZ0Q7QUFFaEQsb0ZBQStFO0FBRS9FLG9GQUErRTtBQUMvRSxpREFBNEM7QUFFNUMscURBQWdEO0FBRWhELGtFQUF5RDtBQUN6RCwwREFBcUQ7QUFDckQsMkRBQXNEO0FBS3RELE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUs1QixNQUFhLHlCQUF5QjtJQUlsQyxZQUFvQixlQUFnQyxFQUNoQyxrQkFBc0MsRUFDdEMsU0FBcUU7UUFGckUsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsY0FBUyxHQUFULFNBQVMsQ0FBNEQ7UUFKakYsZ0JBQVcsR0FBWSxLQUFLLENBQUM7SUFNckMsQ0FBQztJQUVNLDBCQUEwQixDQUFDLE9BQWlCLEVBQUUsT0FBa0IsRUFBRTtRQUVyRSxNQUFNLEVBQUMsZUFBZSxFQUFDLEdBQUcsSUFBSSxDQUFDO1FBRS9CLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBRXhCLElBQUksdUNBQWtCLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsZUFBZSxDQUFDLEVBQUU7WUFFakUsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLEVBQUU7Z0JBRTFCLE1BQU0sU0FBUyxHQUFHLENBQUMsZUFBOEIsRUFBRSxFQUFFO29CQUVqRCxPQUFPLCtCQUFjLENBQUMsdUJBQXVCLENBQUMsZUFBZSxFQUNmLE9BQU8sRUFDUCxlQUFlLEVBQ2YsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUM1RSxDQUFDLENBQUM7Z0JBRUYsTUFBTSxhQUFhLEdBQ2YsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsU0FB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SSxZQUFZLEtBQUssMkJBQVksQ0FBQyxNQUFNLEVBQUU7WUFDdEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ2hDO2FBQU07WUFDSCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYyxDQUFDLENBQUM7U0FDekM7SUFFTCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsRUFBWTtRQUNwQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsYUFBNkI7UUFDbEQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVPLFdBQVc7UUFFZixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUV0RSxJQUFJLENBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNwQixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQy9CO0lBRUwsQ0FBQztDQUNKO0FBaEpELDhEQWdKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGVmYXVsdERvY0Fubm90YXRpb24sIElEb2NBbm5vdGF0aW9ufSBmcm9tIFwiLi9Eb2NBbm5vdGF0aW9uXCI7XG5pbXBvcnQge0RvY0Fubm90YXRpb25JbmRleCwgSURTdHJpbmd9IGZyb20gXCIuL0RvY0Fubm90YXRpb25JbmRleFwiO1xuaW1wb3J0IHtEb2NBbm5vdGF0aW9uc30gZnJvbSBcIi4vRG9jQW5ub3RhdGlvbnNcIjtcbmltcG9ydCB7RG9jTWV0YX0gZnJvbSBcIi4uL21ldGFkYXRhL0RvY01ldGFcIjtcbmltcG9ydCB7QXJlYUhpZ2hsaWdodE1vZGVsfSBmcm9tIFwiLi4vaGlnaGxpZ2h0cy9hcmVhL21vZGVsL0FyZWFIaWdobGlnaHRNb2RlbFwiO1xuaW1wb3J0IHtBcmVhSGlnaGxpZ2h0fSBmcm9tIFwiLi4vbWV0YWRhdGEvQXJlYUhpZ2hsaWdodFwiO1xuaW1wb3J0IHtUZXh0SGlnaGxpZ2h0TW9kZWx9IGZyb20gXCIuLi9oaWdobGlnaHRzL3RleHQvbW9kZWwvVGV4dEhpZ2hsaWdodE1vZGVsXCI7XG5pbXBvcnQge0NvbW1lbnRNb2RlbH0gZnJvbSBcIi4vQ29tbWVudE1vZGVsXCI7XG5pbXBvcnQge0NvbW1lbnR9IGZyb20gXCIuLi9tZXRhZGF0YS9Db21tZW50XCI7XG5pbXBvcnQge0ZsYXNoY2FyZE1vZGVsfSBmcm9tIFwiLi9GbGFzaGNhcmRNb2RlbFwiO1xuaW1wb3J0IHtGbGFzaGNhcmR9IGZyb20gXCIuLi9tZXRhZGF0YS9GbGFzaGNhcmRcIjtcbmltcG9ydCB7aXNQcmVzZW50fSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL1ByZWNvbmRpdGlvbnMnO1xuaW1wb3J0IHtNdXRhdGlvblR5cGV9IGZyb20gXCIuLi9wcm94aWVzL011dGF0aW9uVHlwZVwiO1xuaW1wb3J0IHtMb2dnZXJ9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL2xvZ2dlci9Mb2dnZXJcIjtcbmltcG9ydCB7RG9jRmlsZVJlc29sdmVyfSBmcm9tIFwiLi4vZGF0YXN0b3JlL0RvY0ZpbGVSZXNvbHZlcnNcIjtcbmltcG9ydCB7SURvY01ldGF9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lEb2NNZXRhXCI7XG5pbXBvcnQge01vZGVsT3B0c30gZnJvbSBcIi4uL21ldGFkYXRhL1BhZ2VNZXRhc1wiO1xuXG5jb25zdCBsb2cgPSBMb2dnZXIuY3JlYXRlKCk7XG5cbi8qKlxuICogSGFuZGxlcyB1cGRhdGluZyB0aGUgRG9jQW5ub3RhdGlvbkluZGV4IHdoZW4gd2UgcmVjZWl2ZSBuZXcgdXBkYXRlcyB0byBEb2NNZXRhLlxuICovXG5leHBvcnQgY2xhc3MgRG9jQW5ub3RhdGlvbkluZGV4TWFuYWdlciB7XG5cbiAgICBwcml2YXRlIHJlZ2lzdGVyaW5nOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRvY0ZpbGVSZXNvbHZlcjogRG9jRmlsZVJlc29sdmVyLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZG9jQW5ub3RhdGlvbkluZGV4OiBEb2NBbm5vdGF0aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBvblVwZGF0ZWQ6IChhbm5vdGF0aW9uczogUmVhZG9ubHlBcnJheTxEZWZhdWx0RG9jQW5ub3RhdGlvbj4pID0+IHZvaWQpIHtcblxuICAgIH1cblxuICAgIHB1YmxpYyByZWdpc3Rlckxpc3RlbmVyRm9yRG9jTWV0YShkb2NNZXRhOiBJRG9jTWV0YSwgb3B0czogTW9kZWxPcHRzID0ge30pIHtcblxuICAgICAgICBjb25zdCB7ZG9jRmlsZVJlc29sdmVyfSA9IHRoaXM7XG5cbiAgICAgICAgdGhpcy5yZWdpc3RlcmluZyA9IHRydWU7XG5cbiAgICAgICAgbmV3IEFyZWFIaWdobGlnaHRNb2RlbCgpLnJlZ2lzdGVyTGlzdGVuZXIoZG9jTWV0YSwgYW5ub3RhdGlvbkV2ZW50ID0+IHtcblxuICAgICAgICAgICAgY29uc3QgaGFuZGxlQ29udmVyc2lvbiA9ICgpID0+IHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IChhbm5vdGF0aW9uVmFsdWU6IEFyZWFIaWdobGlnaHQpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gRG9jQW5ub3RhdGlvbnMuY3JlYXRlRnJvbUFyZWFIaWdobGlnaHQoZG9jRmlsZVJlc29sdmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jTWV0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25WYWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25FdmVudC5wYWdlTWV0YSk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGRvY0Fubm90YXRpb24gPVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnZlcnRBbm5vdGF0aW9uKGFubm90YXRpb25FdmVudC52YWx1ZSwgY29udmVydGVyKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uRXZlbnQudHJhY2VFdmVudC5tdXRhdGlvblR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jQW5ub3RhdGlvbik7XG5cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGhhbmRsZUNvbnZlcnNpb24oKTtcblxuICAgICAgICB9LCBvcHRzKTtcblxuICAgICAgICBuZXcgVGV4dEhpZ2hsaWdodE1vZGVsKCkucmVnaXN0ZXJMaXN0ZW5lcihkb2NNZXRhLCBhbm5vdGF0aW9uRXZlbnQgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBkb2NBbm5vdGF0aW9uID1cbiAgICAgICAgICAgICAgICB0aGlzLmNvbnZlcnRBbm5vdGF0aW9uKGFubm90YXRpb25FdmVudC52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvblZhbHVlID0+IERvY0Fubm90YXRpb25zLmNyZWF0ZUZyb21UZXh0SGlnaGxpZ2h0KGRvY01ldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uRXZlbnQucGFnZU1ldGEpKTtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25FdmVudC50cmFjZUV2ZW50Lm11dGF0aW9uVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY0Fubm90YXRpb24pO1xuXG4gICAgICAgIH0sIG9wdHMpO1xuXG4gICAgICAgIG5ldyBDb21tZW50TW9kZWwoKS5yZWdpc3Rlckxpc3RlbmVyKGRvY01ldGEsIGFubm90YXRpb25FdmVudCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnQ6IENvbW1lbnQgPSBhbm5vdGF0aW9uRXZlbnQudmFsdWUgfHwgYW5ub3RhdGlvbkV2ZW50LnByZXZpb3VzVmFsdWU7XG4gICAgICAgICAgICBjb25zdCBjaGlsZERvY0Fubm90YXRpb24gPSBEb2NBbm5vdGF0aW9ucy5jcmVhdGVGcm9tQ29tbWVudChkb2NNZXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tbWVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25FdmVudC5wYWdlTWV0YSk7XG5cbiAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2hpbGRBbm5vdGF0aW9uRXZlbnQoYW5ub3RhdGlvbkV2ZW50LmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uRXZlbnQudHJhY2VFdmVudC5tdXRhdGlvblR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkRG9jQW5ub3RhdGlvbik7XG5cbiAgICAgICAgfSwgb3B0cyk7XG5cbiAgICAgICAgbmV3IEZsYXNoY2FyZE1vZGVsKCkucmVnaXN0ZXJMaXN0ZW5lcihkb2NNZXRhLCBhbm5vdGF0aW9uRXZlbnQgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBmbGFzaGNhcmQ6IEZsYXNoY2FyZCA9IGFubm90YXRpb25FdmVudC52YWx1ZSB8fCBhbm5vdGF0aW9uRXZlbnQucHJldmlvdXNWYWx1ZTtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkRG9jQW5ub3RhdGlvbiA9IERvY0Fubm90YXRpb25zLmNyZWF0ZUZyb21GbGFzaGNhcmQoZG9jTWV0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2hjYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uRXZlbnQucGFnZU1ldGEpO1xuXG4gICAgICAgICAgICB0aGlzLmhhbmRsZUNoaWxkQW5ub3RhdGlvbkV2ZW50KGFubm90YXRpb25FdmVudC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvbkV2ZW50LnRyYWNlRXZlbnQubXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZERvY0Fubm90YXRpb24pO1xuXG4gICAgICAgIH0sIG9wdHMpO1xuXG4gICAgICAgIHRoaXMucmVnaXN0ZXJpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5maXJlVXBkYXRlZCgpO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb252ZXJ0QW5ub3RhdGlvbjxUPih2YWx1ZTogYW55IHwgdW5kZWZpbmVkIHwgbnVsbCwgY29udmVydGVyOiAoaW5wdXQ6IGFueSkgPT4gVCkge1xuXG4gICAgICAgIGlmICghIGlzUHJlc2VudCh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY29udmVydGVyKHZhbHVlKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlQ2hpbGRBbm5vdGF0aW9uRXZlbnQoaWQ6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11dGF0aW9uVHlwZTogTXV0YXRpb25UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGREb2NBbm5vdGF0aW9uOiBJRG9jQW5ub3RhdGlvbikge1xuXG4gICAgICAgIGlmICghIGNoaWxkRG9jQW5ub3RhdGlvbi5yZWYpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgaXMgYW4gb2xkIGFubm90YXRpb24uICBXZSBjYW4ndCBzaG93IGl0IGluIHRoZSBzaWRlYmFyIHlldC5cbiAgICAgICAgICAgIGxvZy53YXJuKFwiQW5ub3RhdGlvbiBoaWRkZW4gZnJvbSBzaWRlYmFyOiBcIiwgY2hpbGREb2NBbm5vdGF0aW9uKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtdXRhdGlvblR5cGUgPT09IE11dGF0aW9uVHlwZS5ERUxFVEUpIHtcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlRG9jQW5ub3RhdGlvbihpZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFkZERvY0Fubm90YXRpb24oY2hpbGREb2NBbm5vdGF0aW9uKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVBbm5vdGF0aW9uRXZlbnQoaWQ6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdXRhdGlvblR5cGU6IE11dGF0aW9uVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2NBbm5vdGF0aW9uOiBJRG9jQW5ub3RhdGlvbiB8IHVuZGVmaW5lZCkge1xuXG4gICAgICAgIGlmIChtdXRhdGlvblR5cGUgPT09IE11dGF0aW9uVHlwZS5ERUxFVEUpIHtcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlRG9jQW5ub3RhdGlvbihpZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFkZERvY0Fubm90YXRpb24oZG9jQW5ub3RhdGlvbiEpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGRlbGV0ZURvY0Fubm90YXRpb24oaWQ6IElEU3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZG9jQW5ub3RhdGlvbkluZGV4LmRlbGV0ZShpZCk7XG4gICAgICAgIHRoaXMuZmlyZVVwZGF0ZWQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZERvY0Fubm90YXRpb24oZG9jQW5ub3RhdGlvbjogSURvY0Fubm90YXRpb24pIHtcbiAgICAgICAgdGhpcy5kb2NBbm5vdGF0aW9uSW5kZXgucHV0KGRvY0Fubm90YXRpb24pO1xuICAgICAgICB0aGlzLmZpcmVVcGRhdGVkKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaXJlVXBkYXRlZCgpIHtcblxuICAgICAgICBjb25zdCBhbm5vdGF0aW9ucyA9IHRoaXMuZG9jQW5ub3RhdGlvbkluZGV4LmdldERvY0Fubm90YXRpb25zU29ydGVkKCk7XG5cbiAgICAgICAgaWYoICEgdGhpcy5yZWdpc3RlcmluZykge1xuICAgICAgICAgICAgdGhpcy5vblVwZGF0ZWQoYW5ub3RhdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICB9XG59XG4iXX0=