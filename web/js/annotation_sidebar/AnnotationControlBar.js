"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const React = __importStar(require("react"));
const AnnotationSidebars_1 = require("./AnnotationSidebars");
const AnnotationDropdown_1 = require("./AnnotationDropdown");
const AnnotationType_1 = require("polar-shared/src/metadata/AnnotationType");
const reactstrap_1 = require("reactstrap");
const RendererAnalytics_1 = require("../ga/RendererAnalytics");
const CommentIcon_1 = require("../ui/standard_icons/CommentIcon");
const FlashcardIcon_1 = require("../ui/standard_icons/FlashcardIcon");
const CreateComment_1 = require("./child_annotations/comments/CreateComment");
const CommentActions_1 = require("./child_annotations/comments/CommentActions");
const CreateFlashcard_1 = require("./child_annotations/flashcards/CreateFlashcard");
const FlashcardActions_1 = require("./child_annotations/flashcards/FlashcardActions");
const ColorSelector_1 = require("../ui/colors/ColorSelector");
const TextHighlights_1 = require("../metadata/TextHighlights");
const AreaHighlights_1 = require("../metadata/AreaHighlights");
const DocAnnotationMoment_1 = require("./DocAnnotationMoment");
const DocAuthor_1 = require("./DocAuthor");
const NullCollapse_1 = require("../ui/null_collapse/NullCollapse");
const EditTextHighlight_1 = require("./child_annotations/comments/EditTextHighlight");
const EditIcon_1 = require("../ui/standard_icons/EditIcon");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Styles = {
    button: {
        marginTop: 'auto',
        marginBottom: 'auto',
        color: 'red !important',
        fontSize: '15px'
    },
    barBody: {
        display: 'flex'
    },
    barChild: {
        marginTop: 'auto',
        marginBottom: 'auto',
    }
};
class AnnotationControlBar extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.onCommentCreated = this.onCommentCreated.bind(this);
        this.onColor = this.onColor.bind(this);
        this.onTextHighlightReset = this.onTextHighlightReset.bind(this);
        this.onTextHighlightEdited = this.onTextHighlightEdited.bind(this);
        this.state = {
            activeInputComponent: 'none'
        };
    }
    render() {
        const { annotation } = this.props;
        const ChangeTextHighlightButton = () => {
            if (this.props.annotation.annotationType !== AnnotationType_1.AnnotationType.TEXT_HIGHLIGHT) {
                return null;
            }
            return React.createElement(reactstrap_1.Button, { className: "text-muted p-1", title: "Edit text highlight", size: "sm", color: "light", style: Styles.button, disabled: !this.props.doc.mutable, onClick: () => this.toggleActiveInputComponent('text-highlight') },
                React.createElement(EditIcon_1.EditIcon, null));
        };
        const CreateCommentButton = () => {
            return React.createElement(reactstrap_1.Button, { className: "text-muted p-1", title: "Create comment", size: "sm", color: "light", style: Styles.button, disabled: !this.props.doc.mutable, onClick: () => this.toggleActiveInputComponent('comment') },
                React.createElement(CommentIcon_1.CommentIcon, null));
        };
        const CreateFlashcardButton = () => {
            return React.createElement(reactstrap_1.Button, { className: "ml-1 text-muted p-1", title: "Create flashcard", style: Styles.button, size: "sm", color: "light", disabled: !this.props.doc.mutable, onClick: () => this.toggleActiveInputComponent('flashcard') },
                React.createElement(FlashcardIcon_1.FlashcardIcon, null));
        };
        return (React.createElement("div", { style: { userSelect: 'none' }, className: "annotation-control-bar mb-3" },
            React.createElement("div", { style: Styles.barBody, className: "flexbar annotation-buttons border-bottom pt-0 pb-0" },
                React.createElement(DocAuthor_1.DocAuthor, { author: annotation.author }),
                React.createElement("div", { style: Styles.barChild, className: "text-muted annotation-context-link" },
                    React.createElement("a", { href: "#", onClick: () => this.onJumpToContext(annotation) },
                        React.createElement(DocAnnotationMoment_1.DocAnnotationMoment, { created: annotation.created }))),
                React.createElement("div", { style: Styles.barChild, className: "flexbar-right muted-color" },
                    React.createElement(ChangeTextHighlightButton, null),
                    React.createElement(CreateCommentButton, null),
                    React.createElement(CreateFlashcardButton, null),
                    React.createElement(NullCollapse_1.NullCollapse, { open: !annotation.immutable },
                        React.createElement(ColorSelector_1.ColorSelector, { className: "mt-auto mb-auto muted-color-target-bg", size: '16px', color: this.props.annotation.color || 'yellow', onSelected: color => this.onColor(color) })),
                    React.createElement("div", { className: "ml-1" },
                        React.createElement(AnnotationDropdown_1.AnnotationDropdown, { id: 'annotation-dropdown-' + annotation.id, disabled: this.props.annotation.immutable, annotation: annotation, onDelete: () => this.onDelete(annotation), onCreateComment: () => this.toggleActiveInputComponent('comment'), onCreateFlashcard: () => this.toggleActiveInputComponent('flashcard'), onJumpToContext: () => this.onJumpToContext(annotation) })))),
            React.createElement(EditTextHighlight_1.EditTextHighlight, { id: annotation.id, hidden: this.props.annotation.annotationType !== AnnotationType_1.AnnotationType.TEXT_HIGHLIGHT, active: this.state.activeInputComponent === 'text-highlight', html: this.props.annotation.html || "", onReset: () => this.onTextHighlightReset(), onChanged: text => this.onTextHighlightEdited(text), onCancel: () => this.toggleActiveInputComponent('none') }),
            React.createElement(CreateComment_1.CreateComment, { id: annotation.id, active: this.state.activeInputComponent === 'comment', onCancel: () => this.toggleActiveInputComponent('none'), onComment: (html) => this.onCommentCreated(html) }),
            React.createElement(CreateFlashcard_1.CreateFlashcard, { id: annotation.id, active: this.state.activeInputComponent === 'flashcard', defaultValue: this.props.annotation.html, onCancel: () => this.toggleActiveInputComponent('none'), onFlashcardCreated: (type, fields) => this.onFlashcardCreated(type, fields) })));
    }
    onTextHighlightReset() {
        const { annotation, doc } = this.props;
        setTimeout(() => {
            TextHighlights_1.TextHighlights.resetRevisedText(doc.docMeta, annotation.pageMeta, annotation.id);
            this.toggleActiveInputComponent('none');
        }, 1);
    }
    onTextHighlightEdited(text) {
        const { annotation, doc } = this.props;
        setTimeout(() => {
            TextHighlights_1.TextHighlights.setRevisedText(doc.docMeta, annotation.pageMeta, annotation.id, text);
            this.toggleActiveInputComponent('none');
        }, 1);
    }
    onColor(color) {
        setTimeout(() => {
            const { annotation } = this.props;
            if (annotation.annotationType === AnnotationType_1.AnnotationType.TEXT_HIGHLIGHT) {
                TextHighlights_1.TextHighlights.update(annotation.id, annotation.docMeta, annotation.pageMeta, { color });
            }
            if (annotation.annotationType === AnnotationType_1.AnnotationType.AREA_HIGHLIGHT) {
                AreaHighlights_1.AreaHighlights.update(annotation.id, annotation.docMeta, annotation.pageMeta, { color });
            }
        }, 1);
    }
    onDelete(annotation) {
        Preconditions_1.Preconditions.assertPresent(annotation);
        switch (annotation.annotationType) {
            case AnnotationType_1.AnnotationType.TEXT_HIGHLIGHT:
                delete annotation.pageMeta.textHighlights[annotation.id];
                break;
            case AnnotationType_1.AnnotationType.AREA_HIGHLIGHT:
                delete annotation.pageMeta.areaHighlights[annotation.id];
                break;
            default:
                break;
        }
    }
    onJumpToContext(annotation) {
        AnnotationSidebars_1.AnnotationSidebars.scrollToAnnotation(annotation.id, annotation.pageNum);
    }
    toggleActiveInputComponent(activeInputComponent) {
        this.setState({
            activeInputComponent: this.state.activeInputComponent === activeInputComponent ? 'none' : activeInputComponent
        });
    }
    onCommentCreated(html, existingComment) {
        RendererAnalytics_1.RendererAnalytics.event({ category: 'annotations', action: 'comment-created' });
        CommentActions_1.CommentActions.create(this.props.doc.docMeta, this.props.annotation, html);
        this.setState({
            activeInputComponent: 'none'
        });
    }
    onFlashcardCreated(type, fields) {
        RendererAnalytics_1.RendererAnalytics.event({ category: 'annotations', action: 'flashcard-created' });
        FlashcardActions_1.FlashcardActions.create(this.props.annotation, type, fields);
        this.setState({
            activeInputComponent: 'none'
        });
    }
}
exports.AnnotationControlBar = AnnotationControlBar;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQW5ub3RhdGlvbkNvbnRyb2xCYXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBbm5vdGF0aW9uQ29udHJvbEJhci50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsNkNBQStCO0FBRS9CLDZEQUF3RDtBQUV4RCw2REFBd0Q7QUFDeEQsNkVBQXdFO0FBQ3hFLDJDQUFrQztBQUNsQywrREFBMEQ7QUFDMUQsa0VBQTZEO0FBQzdELHNFQUFpRTtBQUlqRSw4RUFBeUU7QUFDekUsZ0ZBQTJFO0FBQzNFLG9GQUErRTtBQUMvRSxzRkFBaUY7QUFFakYsOERBQXlEO0FBQ3pELCtEQUEwRDtBQUMxRCwrREFBMEQ7QUFDMUQsK0RBQTBEO0FBQzFELDJDQUFzQztBQUN0QyxtRUFBOEQ7QUFFOUQsc0ZBQWlGO0FBQ2pGLDREQUF1RDtBQUN2RCxrRUFBNkQ7QUFFN0QsTUFBTSxNQUFNLEdBQWM7SUFFdEIsTUFBTSxFQUFFO1FBQ0osU0FBUyxFQUFFLE1BQU07UUFDakIsWUFBWSxFQUFFLE1BQU07UUFDcEIsS0FBSyxFQUFFLGdCQUFnQjtRQUN2QixRQUFRLEVBQUUsTUFBTTtLQUluQjtJQUVELE9BQU8sRUFBRTtRQUNMLE9BQU8sRUFBRSxNQUFNO0tBQ2xCO0lBRUQsUUFBUSxFQUFFO1FBQ04sU0FBUyxFQUFFLE1BQU07UUFDakIsWUFBWSxFQUFFLE1BQU07S0FDdkI7Q0FFSixDQUFDO0FBRUYsTUFBYSxvQkFBcUIsU0FBUSxLQUFLLENBQUMsU0FBeUI7SUFFckUsWUFBWSxLQUFhLEVBQUUsT0FBWTtRQUNuQyxLQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXRCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFF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QUMsQ0FBQyxDQUFDO1FBVTlFLCtCQUFjLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUUzRSxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQ1Ysb0JBQW9CLEVBQUUsTUFBTTtTQUMvQixDQUFDLENBQUM7SUFFUCxDQUFDO0lBRU8sa0JBQWtCLENBQUMsSUFBbUIsRUFBRSxNQUF3QztRQUVwRixxQ0FBaUIsQ0FBQyxLQUFLLENBQUMsRUFBQyxRQUFRLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxtQkFBbUIsRUFBQyxDQUFDLENBQUM7UUFFaEYsbUNBQWdCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUU3RCxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQ1Ysb0JBQW9CLEVBQUUsTUFBTTtTQUMvQixDQUFDLENBQUM7SUFFUCxDQUFDO0NBRUo7QUE3T0Qsb0RBNk9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtEb2NBbm5vdGF0aW9ufSBmcm9tICcuL0RvY0Fubm90YXRpb24nO1xuaW1wb3J0IHtBbm5vdGF0aW9uU2lkZWJhcnN9IGZyb20gJy4vQW5ub3RhdGlvblNpZGViYXJzJztcbmltcG9ydCB7SVN0eWxlTWFwfSBmcm9tICcuLi9yZWFjdC9JU3R5bGVNYXAnO1xuaW1wb3J0IHtBbm5vdGF0aW9uRHJvcGRvd259IGZyb20gJy4vQW5ub3RhdGlvbkRyb3Bkb3duJztcbmltcG9ydCB7QW5ub3RhdGlvblR5cGV9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvQW5ub3RhdGlvblR5cGUnO1xuaW1wb3J0IHtCdXR0b259IGZyb20gJ3JlYWN0c3RyYXAnO1xuaW1wb3J0IHtSZW5kZXJlckFuYWx5dGljc30gZnJvbSAnLi4vZ2EvUmVuZGVyZXJBbmFseXRpY3MnO1xuaW1wb3J0IHtDb21tZW50SWNvbn0gZnJvbSAnLi4vdWkvc3RhbmRhcmRfaWNvbnMvQ29tbWVudEljb24nO1xuaW1wb3J0IHtGbGFzaGNhcmRJY29ufSBmcm9tICcuLi91aS9zdGFuZGFyZF9pY29ucy9GbGFzaGNhcmRJY29uJztcbmltcG9ydCB7Rmxhc2hjYXJkVHlwZX0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9GbGFzaGNhcmRUeXBlJztcbmltcG9ydCB7Q2xvemVGaWVsZHMsIEZyb250QW5kQmFja0ZpZWxkc30gZnJvbSAnLi9jaGlsZF9hbm5vdGF0aW9ucy9mbGFzaGNhcmRzL2ZsYXNoY2FyZF9pbnB1dC9GbGFzaGNhcmRJbnB1dHMnO1xuaW1wb3J0IHtDb21tZW50fSBmcm9tIFwiLi4vbWV0YWRhdGEvQ29tbWVudFwiO1xuaW1wb3J0IHtDcmVhdGVDb21tZW50fSBmcm9tIFwiLi9jaGlsZF9hbm5vdGF0aW9ucy9jb21tZW50cy9DcmVhdGVDb21tZW50XCI7XG5pbXBvcnQge0NvbW1lbnRBY3Rpb25zfSBmcm9tIFwiLi9jaGlsZF9hbm5vdGF0aW9ucy9jb21tZW50cy9Db21tZW50QWN0aW9uc1wiO1xuaW1wb3J0IHtDcmVhdGVGbGFzaGNhcmR9IGZyb20gJy4vY2hpbGRfYW5ub3RhdGlvbnMvZmxhc2hjYXJkcy9DcmVhdGVGbGFzaGNhcmQnO1xuaW1wb3J0IHtGbGFzaGNhcmRBY3Rpb25zfSBmcm9tICcuL2NoaWxkX2Fubm90YXRpb25zL2ZsYXNoY2FyZHMvRmxhc2hjYXJkQWN0aW9ucyc7XG5pbXBvcnQge0RvY30gZnJvbSAnLi4vbWV0YWRhdGEvRG9jJztcbmltcG9ydCB7Q29sb3JTZWxlY3Rvcn0gZnJvbSAnLi4vdWkvY29sb3JzL0NvbG9yU2VsZWN0b3InO1xuaW1wb3J0IHtUZXh0SGlnaGxpZ2h0c30gZnJvbSAnLi4vbWV0YWRhdGEvVGV4dEhpZ2hsaWdodHMnO1xuaW1wb3J0IHtBcmVhSGlnaGxpZ2h0c30gZnJvbSAnLi4vbWV0YWRhdGEvQXJlYUhpZ2hsaWdodHMnO1xuaW1wb3J0IHtEb2NBbm5vdGF0aW9uTW9tZW50fSBmcm9tIFwiLi9Eb2NBbm5vdGF0aW9uTW9tZW50XCI7XG5pbXBvcnQge0RvY0F1dGhvcn0gZnJvbSBcIi4vRG9jQXV0aG9yXCI7XG5pbXBvcnQge051bGxDb2xsYXBzZX0gZnJvbSBcIi4uL3VpL251bGxfY29sbGFwc2UvTnVsbENvbGxhcHNlXCI7XG5pbXBvcnQge0hpZ2hsaWdodENvbG9yfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JQmFzZUhpZ2hsaWdodFwiO1xuaW1wb3J0IHtFZGl0VGV4dEhpZ2hsaWdodH0gZnJvbSBcIi4vY2hpbGRfYW5ub3RhdGlvbnMvY29tbWVudHMvRWRpdFRleHRIaWdobGlnaHRcIjtcbmltcG9ydCB7RWRpdEljb259IGZyb20gXCIuLi91aS9zdGFuZGFyZF9pY29ucy9FZGl0SWNvblwiO1xuaW1wb3J0IHtQcmVjb25kaXRpb25zfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9QcmVjb25kaXRpb25zXCI7XG5cbmNvbnN0IFN0eWxlczogSVN0eWxlTWFwID0ge1xuXG4gICAgYnV0dG9uOiB7XG4gICAgICAgIG1hcmdpblRvcDogJ2F1dG8nLFxuICAgICAgICBtYXJnaW5Cb3R0b206ICdhdXRvJyxcbiAgICAgICAgY29sb3I6ICdyZWQgIWltcG9ydGFudCcsXG4gICAgICAgIGZvbnRTaXplOiAnMTVweCdcblxuICAgICAgICAvLyBtaW5XaWR0aDogJzM1MHB4JyxcbiAgICAgICAgLy8gd2lkdGg6ICczNTBweCdcbiAgICB9LFxuXG4gICAgYmFyQm9keToge1xuICAgICAgICBkaXNwbGF5OiAnZmxleCdcbiAgICB9LFxuXG4gICAgYmFyQ2hpbGQ6IHtcbiAgICAgICAgbWFyZ2luVG9wOiAnYXV0bycsXG4gICAgICAgIG1hcmdpbkJvdHRvbTogJ2F1dG8nLFxuICAgIH1cblxufTtcblxuZXhwb3J0IGNsYXNzIEFubm90YXRpb25Db250cm9sQmFyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzLCBjb250ZXh0OiBhbnkpIHtcbiAgICAgICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgICAgIHRoaXMub25Db21tZW50Q3JlYXRlZCA9IHRoaXMub25Db21tZW50Q3JlYXRlZC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uQ29sb3IgPSB0aGlzLm9uQ29sb3IuYmluZCh0aGlzKTtcblxuICAgICAgICB0aGlzLm9uVGV4dEhpZ2hsaWdodFJlc2V0ID0gdGhpcy5vblRleHRIaWdobGlnaHRSZXNldC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uVGV4dEhpZ2hsaWdodEVkaXRlZCA9IHRoaXMub25UZXh0SGlnaGxpZ2h0RWRpdGVkLmJpbmQodGhpcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIGFjdGl2ZUlucHV0Q29tcG9uZW50OiAnbm9uZSdcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgYW5ub3RhdGlvbiB9ID0gdGhpcy5wcm9wcztcblxuICAgICAgICBjb25zdCBDaGFuZ2VUZXh0SGlnaGxpZ2h0QnV0dG9uID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5hbm5vdGF0aW9uLmFubm90YXRpb25UeXBlICE9PSBBbm5vdGF0aW9uVHlwZS5URVhUX0hJR0hMSUdIVCkge1xuICAgICAgICAgICAgICAgIC8vIHRoaXMgc2hvdWxkIG9ubHkgYmUgYWRkZWQgb24gdGV4dCBoaWdobGlnaHRzLlxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gPEJ1dHRvbiBjbGFzc05hbWU9XCJ0ZXh0LW11dGVkIHAtMVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT1cIkVkaXQgdGV4dCBoaWdobGlnaHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT1cInNtXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPVwibGlnaHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU9e1N0eWxlcy5idXR0b259XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17ISB0aGlzLnByb3BzLmRvYy5tdXRhYmxlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gdGhpcy50b2dnbGVBY3RpdmVJbnB1dENvbXBvbmVudCgndGV4dC1oaWdobGlnaHQnKX0+XG5cbiAgICAgICAgICAgICAgICA8RWRpdEljb24vPlxuXG4gICAgICAgICAgICA8L0J1dHRvbj47XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgQ3JlYXRlQ29tbWVudEJ1dHRvbiA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiA8QnV0dG9uIGNsYXNzTmFtZT1cInRleHQtbXV0ZWQgcC0xXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlPVwiQ3JlYXRlIGNvbW1lbnRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT1cInNtXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPVwibGlnaHRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU9e1N0eWxlcy5idXR0b259XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17ISB0aGlzLnByb3BzLmRvYy5tdXRhYmxlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gdGhpcy50b2dnbGVBY3RpdmVJbnB1dENvbXBvbmVudCgnY29tbWVudCcpfT5cblxuICAgICAgICAgICAgICAgIDxDb21tZW50SWNvbi8+XG5cbiAgICAgICAgICAgIDwvQnV0dG9uPjtcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBDcmVhdGVGbGFzaGNhcmRCdXR0b24gPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gPEJ1dHRvbiBjbGFzc05hbWU9XCJtbC0xIHRleHQtbXV0ZWQgcC0xXCJcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU9XCJDcmVhdGUgZmxhc2hjYXJkXCJcbiAgICAgICAgICAgICAgICAgICAgc3R5bGU9e1N0eWxlcy5idXR0b259XG4gICAgICAgICAgICAgICAgICAgIHNpemU9XCJzbVwiXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yPVwibGlnaHRcIlxuICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZD17ISB0aGlzLnByb3BzLmRvYy5tdXRhYmxlfVxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB0aGlzLnRvZ2dsZUFjdGl2ZUlucHV0Q29tcG9uZW50KCdmbGFzaGNhcmQnKX0+XG5cbiAgICAgICAgICAgICAgICA8Rmxhc2hjYXJkSWNvbi8+XG5cbiAgICAgICAgICAgIDwvQnV0dG9uPjtcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gKFxuXG4gICAgICAgICAgICA8ZGl2IHN0eWxlPXt7dXNlclNlbGVjdDogJ25vbmUnfX1cbiAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwiYW5ub3RhdGlvbi1jb250cm9sLWJhciBtYi0zXCI+XG5cbiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPXtTdHlsZXMuYmFyQm9keX1cbiAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cImZsZXhiYXIgYW5ub3RhdGlvbi1idXR0b25zIGJvcmRlci1ib3R0b20gcHQtMCBwYi0wXCI+XG5cbiAgICAgICAgICAgICAgICAgICAgPERvY0F1dGhvciBhdXRob3I9e2Fubm90YXRpb24uYXV0aG9yfS8+XG5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT17U3R5bGVzLmJhckNoaWxkfVxuICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cInRleHQtbXV0ZWQgYW5ub3RhdGlvbi1jb250ZXh0LWxpbmtcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsvKlRPRE86IG1ha2UgdGhpcyBpbnRvIGl0cyBvd24gY29tcG9uZW50Li4uICovfVxuICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj1cIiNcIiBvbkNsaWNrPXsoKSA9PiB0aGlzLm9uSnVtcFRvQ29udGV4dChhbm5vdGF0aW9uKX0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPERvY0Fubm90YXRpb25Nb21lbnQgY3JlYXRlZD17YW5ub3RhdGlvbi5jcmVhdGVkfS8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2E+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9e1N0eWxlcy5iYXJDaGlsZH1cbiAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJmbGV4YmFyLXJpZ2h0IG11dGVkLWNvbG9yXCI+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsvKlRPRE86IG1ha2UgdGhlc2UgYSBidXR0b24gd2l0aCBhICdsaWdodCcgY29sb3IgYW5kIHNpemUgb2YgJ3NtJyovfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8Q2hhbmdlVGV4dEhpZ2hsaWdodEJ1dHRvbi8+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxDcmVhdGVDb21tZW50QnV0dG9uLz5cblxuICAgICAgICAgICAgICAgICAgICAgICAgPENyZWF0ZUZsYXNoY2FyZEJ1dHRvbi8+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxOdWxsQ29sbGFwc2Ugb3Blbj17IWFubm90YXRpb24uaW1tdXRhYmxlfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Q29sb3JTZWxlY3RvciBjbGFzc05hbWU9XCJtdC1hdXRvIG1iLWF1dG8gbXV0ZWQtY29sb3ItdGFyZ2V0LWJnXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPScxNnB4J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPXt0aGlzLnByb3BzLmFubm90YXRpb24uY29sb3IgfHwgJ3llbGxvdyd9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25TZWxlY3RlZD17Y29sb3IgPT4gdGhpcy5vbkNvbG9yKGNvbG9yKX0vPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9OdWxsQ29sbGFwc2U+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibWwtMVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxBbm5vdGF0aW9uRHJvcGRvd24gaWQ9eydhbm5vdGF0aW9uLWRyb3Bkb3duLScgKyBhbm5vdGF0aW9uLmlkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e3RoaXMucHJvcHMuYW5ub3RhdGlvbi5pbW11dGFibGV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uPXthbm5vdGF0aW9ufVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25EZWxldGU9eygpID0+IHRoaXMub25EZWxldGUoYW5ub3RhdGlvbil9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNyZWF0ZUNvbW1lbnQ9eygpID0+IHRoaXMudG9nZ2xlQWN0aXZlSW5wdXRDb21wb25lbnQoJ2NvbW1lbnQnKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ3JlYXRlRmxhc2hjYXJkPXsoKSA9PiB0aGlzLnRvZ2dsZUFjdGl2ZUlucHV0Q29tcG9uZW50KCdmbGFzaGNhcmQnKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uSnVtcFRvQ29udGV4dD17KCkgPT4gdGhpcy5vbkp1bXBUb0NvbnRleHQoYW5ub3RhdGlvbil9Lz5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgICAgICA8RWRpdFRleHRIaWdobGlnaHQgaWQ9e2Fubm90YXRpb24uaWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGRlbj17dGhpcy5wcm9wcy5hbm5vdGF0aW9uLmFubm90YXRpb25UeXBlICE9PSBBbm5vdGF0aW9uVHlwZS5URVhUX0hJR0hMSUdIVH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlPXt0aGlzLnN0YXRlLmFjdGl2ZUlucHV0Q29tcG9uZW50ID09PSAndGV4dC1oaWdobGlnaHQnfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sPXt0aGlzLnByb3BzLmFubm90YXRpb24uaHRtbCB8fCBcIlwifVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblJlc2V0PXsoKSA9PiB0aGlzLm9uVGV4dEhpZ2hsaWdodFJlc2V0KCl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlZD17dGV4dCA9PiB0aGlzLm9uVGV4dEhpZ2hsaWdodEVkaXRlZCh0ZXh0KX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DYW5jZWw9eygpID0+IHRoaXMudG9nZ2xlQWN0aXZlSW5wdXRDb21wb25lbnQoJ25vbmUnKX0vPlxuXG4gICAgICAgICAgICAgICAgPENyZWF0ZUNvbW1lbnQgaWQ9e2Fubm90YXRpb24uaWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlPXt0aGlzLnN0YXRlLmFjdGl2ZUlucHV0Q29tcG9uZW50ID09PSAnY29tbWVudCd9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DYW5jZWw9eygpID0+IHRoaXMudG9nZ2xlQWN0aXZlSW5wdXRDb21wb25lbnQoJ25vbmUnKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNvbW1lbnQ9eyhodG1sKSA9PiB0aGlzLm9uQ29tbWVudENyZWF0ZWQoaHRtbCl9Lz5cblxuICAgICAgICAgICAgICAgIDxDcmVhdGVGbGFzaGNhcmQgaWQ9e2Fubm90YXRpb24uaWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmU9e3RoaXMuc3RhdGUuYWN0aXZlSW5wdXRDb21wb25lbnQgPT09ICdmbGFzaGNhcmQnfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlPXt0aGlzLnByb3BzLmFubm90YXRpb24uaHRtbH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2FuY2VsPXsoKSA9PiB0aGlzLnRvZ2dsZUFjdGl2ZUlucHV0Q29tcG9uZW50KCdub25lJyl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkZsYXNoY2FyZENyZWF0ZWQ9eyh0eXBlLCBmaWVsZHMpID0+IHRoaXMub25GbGFzaGNhcmRDcmVhdGVkKHR5cGUsIGZpZWxkcyl9Lz5cblxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uVGV4dEhpZ2hsaWdodFJlc2V0KCkge1xuICAgICAgICBjb25zdCB7YW5ub3RhdGlvbiwgZG9jfSA9IHRoaXMucHJvcHM7XG5cbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBUZXh0SGlnaGxpZ2h0cy5yZXNldFJldmlzZWRUZXh0KGRvYy5kb2NNZXRhLCBhbm5vdGF0aW9uLnBhZ2VNZXRhLCBhbm5vdGF0aW9uLmlkKTtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlQWN0aXZlSW5wdXRDb21wb25lbnQoJ25vbmUnKTtcbiAgICAgICAgfSwgMSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblRleHRIaWdobGlnaHRFZGl0ZWQodGV4dDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHthbm5vdGF0aW9uLCBkb2N9ID0gdGhpcy5wcm9wcztcblxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIFRleHRIaWdobGlnaHRzLnNldFJldmlzZWRUZXh0KGRvYy5kb2NNZXRhLCBhbm5vdGF0aW9uLnBhZ2VNZXRhLCBhbm5vdGF0aW9uLmlkLCB0ZXh0KTtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlQWN0aXZlSW5wdXRDb21wb25lbnQoJ25vbmUnKTtcbiAgICAgICAgfSwgMSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ29sb3IoY29sb3I6IEhpZ2hsaWdodENvbG9yKSB7XG5cbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHthbm5vdGF0aW9ufSA9IHRoaXMucHJvcHM7XG5cbiAgICAgICAgICAgIGlmIChhbm5vdGF0aW9uLmFubm90YXRpb25UeXBlID09PSBBbm5vdGF0aW9uVHlwZS5URVhUX0hJR0hMSUdIVCkge1xuICAgICAgICAgICAgICAgIFRleHRIaWdobGlnaHRzLnVwZGF0ZShhbm5vdGF0aW9uLmlkLCBhbm5vdGF0aW9uLmRvY01ldGEsIGFubm90YXRpb24ucGFnZU1ldGEsIHtjb2xvcn0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYW5ub3RhdGlvbi5hbm5vdGF0aW9uVHlwZSA9PT0gQW5ub3RhdGlvblR5cGUuQVJFQV9ISUdITElHSFQpIHtcbiAgICAgICAgICAgICAgICBBcmVhSGlnaGxpZ2h0cy51cGRhdGUoYW5ub3RhdGlvbi5pZCwgYW5ub3RhdGlvbi5kb2NNZXRhLCBhbm5vdGF0aW9uLnBhZ2VNZXRhLCB7Y29sb3J9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9LCAxKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRGVsZXRlKGFubm90YXRpb246IERvY0Fubm90YXRpb24pIHtcblxuICAgICAgICBQcmVjb25kaXRpb25zLmFzc2VydFByZXNlbnQoYW5ub3RhdGlvbik7XG5cbiAgICAgICAgc3dpdGNoIChhbm5vdGF0aW9uLmFubm90YXRpb25UeXBlKSB7XG4gICAgICAgICAgICBjYXNlIEFubm90YXRpb25UeXBlLlRFWFRfSElHSExJR0hUOlxuICAgICAgICAgICAgICAgIGRlbGV0ZSBhbm5vdGF0aW9uLnBhZ2VNZXRhLnRleHRIaWdobGlnaHRzW2Fubm90YXRpb24uaWRdO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5BUkVBX0hJR0hMSUdIVDpcbiAgICAgICAgICAgICAgICBkZWxldGUgYW5ub3RhdGlvbi5wYWdlTWV0YS5hcmVhSGlnaGxpZ2h0c1thbm5vdGF0aW9uLmlkXTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgb25KdW1wVG9Db250ZXh0KGFubm90YXRpb246IERvY0Fubm90YXRpb24pIHtcbiAgICAgICAgQW5ub3RhdGlvblNpZGViYXJzLnNjcm9sbFRvQW5ub3RhdGlvbihhbm5vdGF0aW9uLmlkLCBhbm5vdGF0aW9uLnBhZ2VOdW0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgdG9nZ2xlQWN0aXZlSW5wdXRDb21wb25lbnQoYWN0aXZlSW5wdXRDb21wb25lbnQ6IEFjdGl2ZUlucHV0Q29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgYWN0aXZlSW5wdXRDb21wb25lbnQ6IHRoaXMuc3RhdGUuYWN0aXZlSW5wdXRDb21wb25lbnQgPT09IGFjdGl2ZUlucHV0Q29tcG9uZW50ID8gJ25vbmUnIDogYWN0aXZlSW5wdXRDb21wb25lbnRcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkNvbW1lbnRDcmVhdGVkKGh0bWw6IHN0cmluZywgZXhpc3RpbmdDb21tZW50PzogQ29tbWVudCkge1xuXG4gICAgICAgIFJlbmRlcmVyQW5hbHl0aWNzLmV2ZW50KHtjYXRlZ29yeTogJ2Fubm90YXRpb25zJywgYWN0aW9uOiAnY29tbWVudC1jcmVhdGVkJ30pO1xuXG4gICAgICAgIC8vIHNhbml0aXplIHRoZSBIVE1MIGZpcnN0IHRvIHByZXZlbnQgYnJlYWtpbmcgdGhlIERPTSBhbmQgb3RoZXJcbiAgICAgICAgLy8gcHJvYmxlbWF0aWMgaXNzdWVzIHdpdGggSFRNTC4gIFJpZ2h0IG5vdyB3ZSBkb24ndCBoYW5kbGUgYW55IHR5cGUgb2ZcbiAgICAgICAgLy8gWFNTIHRob3VnaFxuXG4gICAgICAgIC8vIFRPRE86IHJpZ2h0IG5vdyBpdCBzZWVtcyB0byBzdHJpcCBpbXBvcnRhbnQgQ1NTIHN0eWxlcyBhbmQgZGF0YSBVUkxzXG4gICAgICAgIC8vIHdoaWNoIEkgbmVlZCB0byBmaXggaW4gdGhlIEhUTUwgc2FuaXRpemVyLlxuICAgICAgICAvLyBodG1sID0gSFRNTFNhbml0aXplci5zYW5pdGl6ZShodG1sKTtcblxuICAgICAgICBDb21tZW50QWN0aW9ucy5jcmVhdGUodGhpcy5wcm9wcy5kb2MuZG9jTWV0YSwgdGhpcy5wcm9wcy5hbm5vdGF0aW9uLCBodG1sKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGFjdGl2ZUlucHV0Q29tcG9uZW50OiAnbm9uZSdcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRmxhc2hjYXJkQ3JlYXRlZCh0eXBlOiBGbGFzaGNhcmRUeXBlLCBmaWVsZHM6IEZyb250QW5kQmFja0ZpZWxkcyB8IENsb3plRmllbGRzKSB7XG5cbiAgICAgICAgUmVuZGVyZXJBbmFseXRpY3MuZXZlbnQoe2NhdGVnb3J5OiAnYW5ub3RhdGlvbnMnLCBhY3Rpb246ICdmbGFzaGNhcmQtY3JlYXRlZCd9KTtcblxuICAgICAgICBGbGFzaGNhcmRBY3Rpb25zLmNyZWF0ZSh0aGlzLnByb3BzLmFubm90YXRpb24sIHR5cGUsIGZpZWxkcyk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBhY3RpdmVJbnB1dENvbXBvbmVudDogJ25vbmUnXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG59XG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgICByZWFkb25seSBkb2M6IERvYztcbiAgICByZWFkb25seSBhbm5vdGF0aW9uOiBEb2NBbm5vdGF0aW9uO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBhY3RpdmVJbnB1dENvbXBvbmVudDogQWN0aXZlSW5wdXRDb21wb25lbnQ7XG59XG5cbnR5cGUgQWN0aXZlSW5wdXRDb21wb25lbnQgPSAnbm9uZScgfCAnY29tbWVudCcgfCAnZmxhc2hjYXJkJyB8ICd0ZXh0LWhpZ2hsaWdodCc7XG4iXX0=