"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const React = __importStar(require("react"));
const Logger_1 = require("polar-shared/src/logger/Logger");
const Button_1 = __importDefault(require("reactstrap/lib/Button"));
const FlashcardType_1 = require("polar-shared/src/metadata/FlashcardType");
const FlashcardButtons_1 = require("./FlashcardButtons");
const FlashcardTypeSelector_1 = require("./FlashcardTypeSelector");
const RichTextArea_1 = require("../../../RichTextArea");
const FlashcardInputs_1 = require("./FlashcardInputs");
const reactstrap_1 = require("reactstrap");
const Ranges_1 = require("../../../../highlights/text/selection/Ranges");
const FlashcardStyles_1 = require("./FlashcardStyles");
const log = Logger_1.Logger.create();
class FlashcardInputForCloze extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.flashcardType = FlashcardType_1.FlashcardType.CLOZE;
        this.fields = { text: "" };
        this.counter = 1;
        this.onCreate = this.onCreate.bind(this);
        this.state = {
            iter: 0,
        };
        this.fields = this.toFields();
    }
    render() {
        const { id } = this.props;
        const fields = this.toFields();
        return (React.createElement("div", { id: "annotation-flashcard-box", className: "mt-1" },
            React.createElement(RichTextArea_1.RichTextArea, { id: `text-${this.props.id}`, value: fields.text, defaultValue: this.props.defaultValue, autofocus: true, onKeyDown: event => this.onKeyDown(event), onRichTextMutator: richTextMutator => this.richTextMutator = richTextMutator, onChange: (html) => this.fields.text = html }),
            React.createElement("div", { style: FlashcardStyles_1.FlashcardStyles.BottomBar },
                React.createElement("div", { style: FlashcardStyles_1.FlashcardStyles.BottomBarItem },
                    React.createElement(FlashcardTypeSelector_1.FlashcardTypeSelector, { flashcardType: this.flashcardType, onChangeFlashcardType: flashcardType => this.props.onFlashcardChangeType(flashcardType) })),
                React.createElement("div", { style: FlashcardStyles_1.FlashcardStyles.BottomBarItem, className: "ml-1" },
                    React.createElement(Button_1.default, { id: `button-${this.props.id}`, color: "light", size: "md", onClick: () => this.onClozeDelete(), className: "ml-1 p-1 border" }, "[\u2026]"),
                    React.createElement(reactstrap_1.UncontrolledTooltip, { placement: "bottom", delay: { show: 750, hide: 0 }, target: `button-${this.props.id}` },
                        "Create cloze deletion for text ",
                        React.createElement("span", { className: "text-muted" }, "Control+Shift+C"))),
                React.createElement("div", { style: FlashcardStyles_1.FlashcardStyles.BottomBarItemRight, className: "text-right" },
                    React.createElement(FlashcardButtons_1.FlashcardButtons, { cancelButton: this.props.cancelButton, existingFlashcard: this.props.existingFlashcard, onCreate: () => this.onCreate() })))));
    }
    toFields() {
        const text = FlashcardInputs_1.FlashcardInputs.fieldToString('text', this.props.existingFlashcard);
        return { text };
    }
    onClozeDelete() {
        const sel = window.getSelection();
        if (!sel) {
            return;
        }
        const range = sel.getRangeAt(0);
        const textNodes = Ranges_1.Ranges.getTextNodes(range);
        if (textNodes.length === 0) {
            return;
        }
        const c = this.counter++;
        const prefix = document.createTextNode(`{{c${c}::`);
        const suffix = document.createTextNode('}}');
        const firstNode = textNodes[0];
        const lastNode = textNodes[textNodes.length - 1];
        firstNode.parentNode.insertBefore(prefix, firstNode);
        lastNode.parentNode.insertBefore(suffix, lastNode.nextSibling);
        sel.removeAllRanges();
        this.fields.text = this.richTextMutator.currentValue();
    }
    onKeyDown(event) {
        if (this.isKeyboardControlShiftC(event)) {
            this.onClozeDelete();
        }
        if (event.getModifierState("Control") && event.key === "Enter") {
            this.onCreate();
        }
    }
    isKeyboardControlShiftC(event) {
        return event.getModifierState("Control") &&
            event.getModifierState("Shift") &&
            event.key === "C";
    }
    onCreate() {
        if (this.props.onFlashcard) {
            this.props.onFlashcard(this.flashcardType, this.fields);
        }
        this.setState({
            iter: this.state.iter + 1
        });
    }
}
exports.FlashcardInputForCloze = FlashcardInputForCloze;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmxhc2hjYXJkSW5wdXRGb3JDbG96ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkZsYXNoY2FyZElucHV0Rm9yQ2xvemUudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDZDQUErQjtBQUMvQiwyREFBc0Q7QUFDdEQsbUVBQTJDO0FBQzNDLDJFQUFzRTtBQUN0RSx5REFBb0Q7QUFDcEQsbUVBQThEO0FBQzlELHdEQUFtRDtBQUduRCx1REFBa0Q7QUFDbEQsMkNBQStDO0FBQy9DLHlFQUFvRTtBQUVwRSx1REFBa0Q7QUFFbEQsTUFBTSxHQUFHLEdBQUcsZUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQWEsc0JBQXVCLFNBQVEsS0FBSyxDQUFDLFNBQXlCO0lBVXZFLFlBQVksS0FBYSxFQUFFLE9BQVk7UUFDbkMsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQVRULGtCQUFhLEdBQWtCLDZCQUFhLENBQUMsS0FBSyxDQUFDO1FBRTVELFdBQU0sR0FBZ0IsRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFDLENBQUM7UUFJakMsWUFBTyxHQUFXLENBQUMsQ0FBQztRQUt4QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXpDLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDVCxJQUFJLEVBQUUsQ0FBQztTQUNWLENBQUM7UUFFRixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUVsQyxDQUFDO0lBRU0sTUFBTTtRQUVULE1BQU0sRUFBRSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRTFCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUUvQixPQUFPLENBRUgsNkJBQUssRUFBRSxFQUFDLDBCQUEwQixFQUFDLFNBQVMsRUFBQyxNQUFNO1lB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QWEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDM0Q7UUFJRCxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQ1YsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUM7U0FDNUIsQ0FBQyxDQUFDO0lBRVAsQ0FBQztDQWlCSjtBQWxMRCx3REFrTEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9sb2dnZXIvTG9nZ2VyJztcbmltcG9ydCBCdXR0b24gZnJvbSAncmVhY3RzdHJhcC9saWIvQnV0dG9uJztcbmltcG9ydCB7Rmxhc2hjYXJkVHlwZX0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9GbGFzaGNhcmRUeXBlJztcbmltcG9ydCB7Rmxhc2hjYXJkQnV0dG9uc30gZnJvbSAnLi9GbGFzaGNhcmRCdXR0b25zJztcbmltcG9ydCB7Rmxhc2hjYXJkVHlwZVNlbGVjdG9yfSBmcm9tICcuL0ZsYXNoY2FyZFR5cGVTZWxlY3Rvcic7XG5pbXBvcnQge1JpY2hUZXh0QXJlYX0gZnJvbSAnLi4vLi4vLi4vUmljaFRleHRBcmVhJztcbmltcG9ydCB7UmljaFRleHRNdXRhdG9yfSBmcm9tICcuLi8uLi8uLi8uLi9hcHBzL2NhcmRfY3JlYXRvci9lbGVtZW50cy9zY2hlbWFmb3JtL1JpY2hUZXh0TXV0YXRvcic7XG5pbXBvcnQge0Nsb3plRmllbGRzLCBGbGFzaGNhcmRJbnB1dEZpZWxkc1R5cGV9IGZyb20gJy4vRmxhc2hjYXJkSW5wdXRzJztcbmltcG9ydCB7Rmxhc2hjYXJkSW5wdXRzfSBmcm9tICcuL0ZsYXNoY2FyZElucHV0cyc7XG5pbXBvcnQge1VuY29udHJvbGxlZFRvb2x0aXB9IGZyb20gJ3JlYWN0c3RyYXAnO1xuaW1wb3J0IHtSYW5nZXN9IGZyb20gJy4uLy4uLy4uLy4uL2hpZ2hsaWdodHMvdGV4dC9zZWxlY3Rpb24vUmFuZ2VzJztcbmltcG9ydCB7Rmxhc2hjYXJkfSBmcm9tICcuLi8uLi8uLi8uLi9tZXRhZGF0YS9GbGFzaGNhcmQnO1xuaW1wb3J0IHtGbGFzaGNhcmRTdHlsZXN9IGZyb20gJy4vRmxhc2hjYXJkU3R5bGVzJztcblxuY29uc3QgbG9nID0gTG9nZ2VyLmNyZWF0ZSgpO1xuXG5leHBvcnQgY2xhc3MgRmxhc2hjYXJkSW5wdXRGb3JDbG96ZSBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBmbGFzaGNhcmRUeXBlOiBGbGFzaGNhcmRUeXBlID0gRmxhc2hjYXJkVHlwZS5DTE9aRTtcblxuICAgIHByaXZhdGUgZmllbGRzOiBDbG96ZUZpZWxkcyA9IHt0ZXh0OiBcIlwifTtcblxuICAgIHByaXZhdGUgcmljaFRleHRNdXRhdG9yPzogUmljaFRleHRNdXRhdG9yO1xuXG4gICAgcHJpdmF0ZSBjb3VudGVyOiBudW1iZXIgPSAxO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IElQcm9wcywgY29udGV4dDogYW55KSB7XG4gICAgICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KTtcblxuICAgICAgICB0aGlzLm9uQ3JlYXRlID0gdGhpcy5vbkNyZWF0ZS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBpdGVyOiAwLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuZmllbGRzID0gdGhpcy50b0ZpZWxkcygpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlcigpIHtcblxuICAgICAgICBjb25zdCB7IGlkIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgICAgIGNvbnN0IGZpZWxkcyA9IHRoaXMudG9GaWVsZHMoKTtcblxuICAgICAgICByZXR1cm4gKFxuXG4gICAgICAgICAgICA8ZGl2IGlkPVwiYW5ub3RhdGlvbi1mbGFzaGNhcmQtYm94XCIgY2xhc3NOYW1lPVwibXQtMVwiPlxuXG4gICAgICAgICAgICAgICAgPFJpY2hUZXh0QXJlYSBpZD17YHRleHQtJHt0aGlzLnByb3BzLmlkfWB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17ZmllbGRzLnRleHR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0VmFsdWU9e3RoaXMucHJvcHMuZGVmYXVsdFZhbHVlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0b2ZvY3VzPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25LZXlEb3duPXtldmVudCA9PiB0aGlzLm9uS2V5RG93bihldmVudCl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblJpY2hUZXh0TXV0YXRvcj17cmljaFRleHRNdXRhdG9yID0+IHRoaXMucmljaFRleHRNdXRhdG9yID0gcmljaFRleHRNdXRhdG9yfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9eyhodG1sKSA9PiB0aGlzLmZpZWxkcy50ZXh0ID0gaHRtbH0vPlxuXG4gICAgICAgICAgICAgICAgey8qLSBxdW90ZSBhbm5vdGF0aW9uIC4uLiB0byBjb3B5IHRoZSBhbm5vdGF0aW9uIHRleHQuKi99XG5cbiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPXtGbGFzaGNhcmRTdHlsZXMuQm90dG9tQmFyfT5cblxuICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPXtGbGFzaGNhcmRTdHlsZXMuQm90dG9tQmFySXRlbX0+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxGbGFzaGNhcmRUeXBlU2VsZWN0b3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFzaGNhcmRUeXBlPXt0aGlzLmZsYXNoY2FyZFR5cGV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2VGbGFzaGNhcmRUeXBlPXtmbGFzaGNhcmRUeXBlID0+IHRoaXMucHJvcHMub25GbGFzaGNhcmRDaGFuZ2VUeXBlKGZsYXNoY2FyZFR5cGUpfS8+XG5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT17Rmxhc2hjYXJkU3R5bGVzLkJvdHRvbUJhckl0ZW19IGNsYXNzTmFtZT1cIm1sLTFcIj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgPEJ1dHRvbiBpZD17YGJ1dHRvbi0ke3RoaXMucHJvcHMuaWR9YH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9XCJsaWdodFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9XCJtZFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHRoaXMub25DbG96ZURlbGV0ZSgpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJtbC0xIHAtMSBib3JkZXJcIj5b4oCmXTwvQnV0dG9uPlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8VW5jb250cm9sbGVkVG9vbHRpcCBwbGFjZW1lbnQ9XCJib3R0b21cIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXk9e3tzaG93OiA3NTAsIGhpZGU6IDB9fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0PXtgYnV0dG9uLSR7dGhpcy5wcm9wcy5pZH1gfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcmVhdGUgY2xvemUgZGVsZXRpb24gZm9yIHRleHQgPHNwYW4gY2xhc3NOYW1lPVwidGV4dC1tdXRlZFwiPkNvbnRyb2wrU2hpZnQrQzwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvVW5jb250cm9sbGVkVG9vbHRpcD5cblxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cblxuXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9e0ZsYXNoY2FyZFN0eWxlcy5Cb3R0b21CYXJJdGVtUmlnaHR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwidGV4dC1yaWdodFwiPlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8Rmxhc2hjYXJkQnV0dG9ucyBjYW5jZWxCdXR0b249e3RoaXMucHJvcHMuY2FuY2VsQnV0dG9ufVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdGbGFzaGNhcmQ9e3RoaXMucHJvcHMuZXhpc3RpbmdGbGFzaGNhcmR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNyZWF0ZT17KCkgPT4gdGhpcy5vbkNyZWF0ZSgpfS8+XG5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgdG9GaWVsZHMoKTogQ2xvemVGaWVsZHMge1xuXG4gICAgICAgIGNvbnN0IHRleHQgPSBGbGFzaGNhcmRJbnB1dHMuZmllbGRUb1N0cmluZygndGV4dCcsIHRoaXMucHJvcHMuZXhpc3RpbmdGbGFzaGNhcmQpO1xuXG4gICAgICAgIHJldHVybiB7dGV4dH07XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2xvemVEZWxldGUoKTogdm9pZCB7XG5cbiAgICAgICAgLy8gVE9ETzogZG9uJ3QgdXNlIHRoZSB0b3AgbGV2ZWwgd2luZG93IGJ1dCBnZXQgaXQgZnJvbSB0aGUgcHJvcGVyXG4gICAgICAgIC8vIGV2ZW50XG4gICAgICAgIGNvbnN0IHNlbCA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcblxuICAgICAgICBpZiAoIXNlbCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmFuZ2UgPSBzZWwuZ2V0UmFuZ2VBdCgwKTtcblxuICAgICAgICBjb25zdCB0ZXh0Tm9kZXMgPSBSYW5nZXMuZ2V0VGV4dE5vZGVzKHJhbmdlKTtcblxuICAgICAgICBpZiAodGV4dE5vZGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYyA9IHRoaXMuY291bnRlcisrO1xuXG4gICAgICAgIGNvbnN0IHByZWZpeCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGB7e2Mke2N9OjpgKTtcbiAgICAgICAgY29uc3Qgc3VmZml4ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ319Jyk7XG5cbiAgICAgICAgY29uc3QgZmlyc3ROb2RlID0gdGV4dE5vZGVzWzBdO1xuICAgICAgICBjb25zdCBsYXN0Tm9kZSA9IHRleHROb2Rlc1t0ZXh0Tm9kZXMubGVuZ3RoIC0gMV07XG5cbiAgICAgICAgZmlyc3ROb2RlLnBhcmVudE5vZGUhLmluc2VydEJlZm9yZShwcmVmaXgsIGZpcnN0Tm9kZSk7XG4gICAgICAgIGxhc3ROb2RlLnBhcmVudE5vZGUhLmluc2VydEJlZm9yZShzdWZmaXgsIGxhc3ROb2RlLm5leHRTaWJsaW5nKTtcblxuICAgICAgICBzZWwucmVtb3ZlQWxsUmFuZ2VzKCk7XG5cbiAgICAgICAgdGhpcy5maWVsZHMudGV4dCA9IHRoaXMucmljaFRleHRNdXRhdG9yIS5jdXJyZW50VmFsdWUoKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgb25LZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNLZXlib2FyZENvbnRyb2xTaGlmdEMoZXZlbnQpKSB7XG4gICAgICAgICAgICB0aGlzLm9uQ2xvemVEZWxldGUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChldmVudC5nZXRNb2RpZmllclN0YXRlKFwiQ29udHJvbFwiKSAmJiBldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICAgICAgdGhpcy5vbkNyZWF0ZSgpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGlzS2V5Ym9hcmRDb250cm9sU2hpZnRDKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG5cbiAgICAgICAgcmV0dXJuIGV2ZW50LmdldE1vZGlmaWVyU3RhdGUoXCJDb250cm9sXCIpICYmXG4gICAgICAgICAgICAgICBldmVudC5nZXRNb2RpZmllclN0YXRlKFwiU2hpZnRcIikgJiZcbiAgICAgICAgICAgICAgIGV2ZW50LmtleSA9PT0gXCJDXCI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkNyZWF0ZSgpOiB2b2lkIHtcblxuICAgICAgICBpZiAodGhpcy5wcm9wcy5vbkZsYXNoY2FyZCkge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZsYXNoY2FyZCh0aGlzLmZsYXNoY2FyZFR5cGUsIHRoaXMuZmllbGRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoaXMucmVzZXQoKTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGl0ZXI6IHRoaXMuc3RhdGUuaXRlciArIDFcbiAgICAgICAgfSk7XG5cbiAgICB9XG4gICAgLy9cbiAgICAvLyBwcml2YXRlIG9uQ2FuY2VsKCk6IHZvaWQge1xuICAgIC8vXG4gICAgLy8gICAgIGlmICh0aGlzLnByb3BzLm9uQ2FuY2VsKSB7XG4gICAgLy8gICAgICAgICB0aGlzLnByb3BzLm9uQ2FuY2VsKCk7XG4gICAgLy8gICAgIH1cbiAgICAvL1xuICAgIC8vICAgICB0aGlzLnJlc2V0KCk7XG4gICAgLy9cbiAgICAvLyB9XG4gICAgLy9cbiAgICAvLyBwcml2YXRlIHJlc2V0KCk6IHZvaWQge1xuICAgIC8vICAgICB0aGlzLmZpZWxkcyA9IHt0ZXh0OiBcIlwifTtcbiAgICAvLyB9XG5cblxufVxuXG5pbnRlcmZhY2UgSVByb3BzIHtcblxuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgICByZWFkb25seSBvbkZsYXNoY2FyZDogKGZsYXNoY2FyZFR5cGU6IEZsYXNoY2FyZFR5cGUsIGZpZWxkczogUmVhZG9ubHk8Rmxhc2hjYXJkSW5wdXRGaWVsZHNUeXBlPikgPT4gdm9pZDtcblxuICAgIHJlYWRvbmx5IG9uRmxhc2hjYXJkQ2hhbmdlVHlwZTogKGZsYXNoY2FyZFR5cGU6IEZsYXNoY2FyZFR5cGUpID0+IHZvaWQ7XG5cbiAgICByZWFkb25seSBjYW5jZWxCdXR0b246IEpTWC5FbGVtZW50O1xuXG4gICAgcmVhZG9ubHkgZXhpc3RpbmdGbGFzaGNhcmQ/OiBGbGFzaGNhcmQ7XG5cbiAgICByZWFkb25seSBkZWZhdWx0VmFsdWU/OiBzdHJpbmc7XG5cbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgcmVhZG9ubHkgaXRlcjogbnVtYmVyO1xufVxuXG5cbiJdfQ==