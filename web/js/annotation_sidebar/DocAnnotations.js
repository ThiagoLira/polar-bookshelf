"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const AnnotationType_1 = require("polar-shared/src/metadata/AnnotationType");
const Optional_1 = require("polar-shared/src/util/ts/Optional");
const Flashcards_1 = require("../metadata/Flashcards");
const ObjectIDs_1 = require("../util/ObjectIDs");
const Images_1 = require("../metadata/Images");
const Providers_1 = require("polar-shared/src/util/Providers");
const AnnotationTexts_1 = require("polar-shared/src/metadata/AnnotationTexts");
const HighlightColor_1 = require("polar-shared/src/metadata/HighlightColor");
class DocAnnotations {
    static isImmutable(author) {
        if (author && author.guest) {
            return true;
        }
        return false;
    }
    static getAnnotationsForPage(docFileResolver, docAnnotationIndex, docMeta) {
        return __awaiter(this, void 0, void 0, function* () {
            const result = [];
            const pageMetas = Object.values(docMeta.pageMetas);
            for (const pageMeta of pageMetas) {
                const areaHighlights = yield this.getAreaHighlights(docFileResolver, docMeta, pageMeta);
                const textHighlights = this.getTextHighlights(docMeta, pageMeta);
                result.push(...textHighlights);
                result.push(...areaHighlights);
            }
            return result;
        });
    }
    static createFromFlashcard(docMeta, flashcard, pageMeta) {
        const iTextConverter = ITextConverters.create(AnnotationType_1.AnnotationType.FLASHCARD, flashcard);
        const init = this.createInit(docMeta);
        return Object.assign(Object.assign(Object.assign(Object.assign({}, init), { oid: ObjectIDs_1.ObjectIDs.create(), id: flashcard.id, guid: flashcard.guid, fingerprint: docMeta.docInfo.fingerprint, docInfo: docMeta.docInfo }), iTextConverter), { fields: Flashcards_1.Flashcards.convertFieldsToMap(flashcard.fields), pageNum: pageMeta.pageInfo.num, position: {
                x: 0,
                y: 0
            }, created: flashcard.created, docMeta,
            pageMeta, ref: flashcard.ref, original: flashcard, author: flashcard.author, immutable: this.isImmutable(flashcard.author), color: undefined, img: undefined });
    }
    static createFromComment(docMeta, comment, pageMeta) {
        const iTextConverter = ITextConverters.create(AnnotationType_1.AnnotationType.COMMENT, comment);
        const init = this.createInit(docMeta);
        return Object.assign(Object.assign(Object.assign(Object.assign({}, init), { oid: ObjectIDs_1.ObjectIDs.create(), id: comment.id, guid: comment.guid, fingerprint: docMeta.docInfo.fingerprint, docInfo: docMeta.docInfo }), iTextConverter), { pageNum: pageMeta.pageInfo.num, position: {
                x: 0,
                y: 0
            }, created: comment.created, docMeta,
            pageMeta, ref: comment.ref, original: comment, author: comment.author, immutable: this.isImmutable(comment.author), color: undefined, img: undefined });
    }
    static createFromAreaHighlight(docFileResolver, docMeta, areaHighlight, pageMeta) {
        const createPosition = () => {
            if (areaHighlight.position) {
                return Object.assign({}, areaHighlight.position);
            }
            return {
                x: this.firstRect(areaHighlight).map(current => current.left).getOrElse(0),
                y: this.firstRect(areaHighlight).map(current => current.top).getOrElse(0),
            };
        };
        const img = Providers_1.Providers.memoize(() => Images_1.Images.toImg(docFileResolver, areaHighlight.image));
        const position = createPosition();
        const init = this.createInit(docMeta);
        return Object.assign(Object.assign({}, init), { oid: ObjectIDs_1.ObjectIDs.create(), id: areaHighlight.id, guid: areaHighlight.guid, fingerprint: docMeta.docInfo.fingerprint, docInfo: docMeta.docInfo, annotationType: AnnotationType_1.AnnotationType.AREA_HIGHLIGHT, get img() {
                return img();
            }, text: undefined, html: undefined, pageNum: pageMeta.pageInfo.num, position, color: HighlightColor_1.HighlightColors.withDefaultColor(areaHighlight.color), created: areaHighlight.created, docMeta,
            pageMeta, original: areaHighlight, author: areaHighlight.author, immutable: this.isImmutable(areaHighlight.author) });
    }
    static createFromTextHighlight(docMeta, textHighlight, pageMeta) {
        const iTextConverter = ITextConverters.create(AnnotationType_1.AnnotationType.TEXT_HIGHLIGHT, textHighlight);
        const init = this.createInit(docMeta);
        return Object.assign(Object.assign(Object.assign(Object.assign({}, init), { oid: ObjectIDs_1.ObjectIDs.create(), id: textHighlight.id, guid: textHighlight.guid, fingerprint: docMeta.docInfo.fingerprint, docInfo: docMeta.docInfo }), iTextConverter), { pageNum: pageMeta.pageInfo.num, position: {
                x: this.firstRect(textHighlight).map(current => current.left).getOrElse(0),
                y: this.firstRect(textHighlight).map(current => current.top).getOrElse(0),
            }, color: HighlightColor_1.HighlightColors.withDefaultColor(textHighlight.color), created: textHighlight.created, docMeta,
            pageMeta, original: textHighlight, author: textHighlight.author, immutable: this.isImmutable(textHighlight.author), img: undefined });
    }
    static getTextHighlights(docMeta, pageMeta) {
        return Object.values(pageMeta.textHighlights).map(textHighlight => {
            return this.createFromTextHighlight(docMeta, textHighlight, pageMeta);
        });
    }
    static getAreaHighlights(docFileResolver, docMeta, pageMeta) {
        return __awaiter(this, void 0, void 0, function* () {
            const result = [];
            const areaHighlights = Object.values(pageMeta.areaHighlights);
            for (const areaHighlight of areaHighlights) {
                const docAnnotation = yield this.createFromAreaHighlight(docFileResolver, docMeta, areaHighlight, pageMeta);
                result.push(docAnnotation);
            }
            return result;
        });
    }
    static createInit(docMeta) {
        return {
            tags: docMeta.docInfo.tags || {},
        };
    }
    static firstRect(highlight) {
        return Optional_1.Optional.of(highlight)
            .map(current => current.rects)
            .map(current => current[0]);
    }
}
exports.DocAnnotations = DocAnnotations;
class ITextConverters {
    static create(annotationType, annotation) {
        const toText = Providers_1.Providers.memoize(() => AnnotationTexts_1.AnnotationTexts.toText(annotationType, annotation));
        const toHTML = Providers_1.Providers.memoize(() => AnnotationTexts_1.AnnotationTexts.toHTML(annotationType, annotation));
        return {
            annotationType,
            get text() {
                return toText();
            },
            get html() {
                return toHTML();
            },
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRG9jQW5ub3RhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJEb2NBbm5vdGF0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLDZFQUF3RTtBQUV4RSxnRUFBMkQ7QUFFM0QsdURBQWtEO0FBRWxELGlEQUE0QztBQUM1QywrQ0FBMEM7QUFXMUMsK0RBQTBEO0FBQzFELCtFQUEwRTtBQUcxRSw2RUFBeUU7QUFHekUsTUFBYSxjQUFjO0lBRWYsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFnQjtRQUV2QyxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFO1lBQ3hCLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUVqQixDQUFDO0lBRU0sTUFBTSxDQUFPLHFCQUFxQixDQUFDLGVBQWdDLEVBQ2hDLGtCQUFzQyxFQUN0QyxPQUFpQjs7WUFFdkQsTUFBTSxNQUFNLEdBQXFCLEVBQUUsQ0FBQztZQUVwQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVuRCxLQUFLLE1BQU0sUUFBUSxJQUFJLFNBQVMsRUFBRTtnQkFFOUIsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDeEYsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFFakUsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsQ0FBQyxDQUFDO2dCQUMvQixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsY0FBYyxDQUFDLENBQUM7YUFFbEM7WUFFRCxPQUFPLE1BQU0sQ0FBQztRQUVsQixDQUFDO0tBQUE7SUFFTSxNQUFNLENBQUMsbUJBQW1CLENBQUMsT0FBaUIsRUFDakIsU0FBcUIsRUFDckIsUUFBbUI7UUFFakQsTUFBTSxjQUFjLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQywrQkFBYyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUVuRixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXRDLG1FQUNPLElBQUksS0FDUCxHQUFHLEVBQUUscUJBQVMsQ0FBQyxNQUFNLEVBQUUsRUFDdkIsRUFBRSxFQUFFLFNBQVMsQ0FBQyxFQUFFLEVBQ2hCLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSSxFQUNwQixXQUFXLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQ3hDLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxLQUNyQixjQUFjLEtBQ2pCLE1BQU0sRUFBRSx1QkFBVSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFDdkQsT0FBTyxFQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUU5QixRQUFRLEVBQUU7Z0JBQ04sQ0FBQyxFQUFFLENBQUM7Z0JBQ0osQ0FBQyxFQUFFLENBQUM7YUFDUCxFQUNELE9BQU8sRUFBRSxTQUFTLENBQUMsT0FBTyxFQUMxQixPQUFPO1lBQ1AsUUFBUSxFQUNSLEdBQUcsRUFBRSxTQUFTLENBQUMsR0FBRyxFQUNsQixRQUFRLEVBQUUsU0FBUyxFQUNuQixNQUFNLEVBQUUsU0FBUyxDQUFDLE1BQU0sRUFDeEIsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUM3QyxLQUFLLEVBQUUsU0FBUyxFQUNoQixHQUFHLEVBQUUsU0FBUyxJQUNoQjtJQUVOLENBQUM7SUFFTSxNQUFNLENBQUMsaUJBQWlCLENBQUMsT0FBaUIsRUFDakIsT0FBaUIsRUFDakIsUUFBbUI7UUFFL0MsTUFBTSxjQUFjLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQywrQkFBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUUvRSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXRDLG1FQUNPLElBQUksS0FDUCxHQUFHLEVBQUUscUJBQVMsQ0FBQyxNQUFNLEVBQUUsRUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQ2QsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQ2xCLFdBQVcsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFDeEMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPLEtBQ3JCLGNBQWMsS0FDakIsT0FBTyxFQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUU5QixRQUFRLEVBQUU7Z0JBQ04sQ0FBQyxFQUFFLENBQUM7Z0JBQ0osQ0FBQyxFQUFFLENBQUM7YUFDUCxFQUNELE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxFQUN4QixPQUFPO1lBQ1AsUUFBUSxFQUNSLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUNoQixRQUFRLEVBQUUsT0FBTyxFQUNqQixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFDdEIsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUMzQyxLQUFLLEVBQUUsU0FBUyxFQUNoQixHQUFHLEVBQUUsU0FBUyxJQUNoQjtJQUVOLENBQUM7SUFFTSxNQUFNLENBQUMsdUJBQXVCLENBQUMsZUFBZ0MsRUFDaEMsT0FBaUIsRUFDakIsYUFBNkIsRUFDN0IsUUFBbUI7UUFFckQsTUFBTSxjQUFjLEdBQUcsR0FBVSxFQUFFO1lBRS9CLElBQUksYUFBYSxDQUFDLFFBQVEsRUFBRTtnQkFDeEIseUJBQVcsYUFBYSxDQUFDLFFBQVEsRUFBRTthQUN0QztZQUVELE9BQU87Z0JBQ0gsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQzFFLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2FBQzVFLENBQUM7UUFFTixDQUFDLENBQUM7UUFFRixNQUFNLEdBQUcsR0FBRyxxQkFBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxlQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUV4RixNQUFNLFFBQVEsR0FBRyxjQUFjLEVBQUUsQ0FBQztRQUVsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXRDLHVDQUNPLElBQUksS0FDUCxHQUFHLEVBQUUscUJBQVMsQ0FBQyxNQUFNLEVBQUUsRUFDdkIsRUFBRSxFQUFFLGFBQWEsQ0FBQyxFQUFFLEVBQ3BCLElBQUksRUFBRSxhQUFhLENBQUMsSUFBSSxFQUN4QixXQUFXLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQ3hDLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxFQUN4QixjQUFjLEVBQUUsK0JBQWMsQ0FBQyxjQUFjLEVBQzdDLElBQUksR0FBRztnQkFDSCxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2pCLENBQUMsRUFDRCxJQUFJLEVBQUUsU0FBUyxFQUNmLElBQUksRUFBRSxTQUFTLEVBQ2YsT0FBTyxFQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUM5QixRQUFRLEVBQ1IsS0FBSyxFQUFFLGdDQUFlLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxFQUM1RCxPQUFPLEVBQUUsYUFBYSxDQUFDLE9BQU8sRUFDOUIsT0FBTztZQUNQLFFBQVEsRUFDUixRQUFRLEVBQUUsYUFBYSxFQUN2QixNQUFNLEVBQUUsYUFBYSxDQUFDLE1BQU0sRUFDNUIsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUNuRDtJQUVOLENBQUM7SUFFTSxNQUFNLENBQUMsdUJBQXVCLENBQUMsT0FBaUIsRUFDakIsYUFBNkIsRUFDN0IsUUFBbUI7UUFFckQsTUFBTSxjQUFjLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQywrQkFBYyxDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUU1RixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXRDLG1FQUNPLElBQUksS0FDUCxHQUFHLEVBQUUscUJBQVMsQ0FBQyxNQUFNLEVBQUUsRUFDdkIsRUFBRSxFQUFFLGFBQWEsQ0FBQyxFQUFFLEVBQ3BCLElBQUksRUFBRSxhQUFhLENBQUMsSUFBSSxFQUN4QixXQUFXLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQ3hDLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxLQUNyQixjQUFjLEtBQ2pCLE9BQU8sRUFBRSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFDOUIsUUFBUSxFQUFFO2dCQUNOLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUMxRSxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzthQUM1RSxFQUNELEtBQUssRUFBRSxnQ0FBZSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFDNUQsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPLEVBQzlCLE9BQU87WUFDUCxRQUFRLEVBQ1IsUUFBUSxFQUFFLGFBQWEsRUFDdkIsTUFBTSxFQUFFLGFBQWEsQ0FBQyxNQUFNLEVBQzVCLFNBQVMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFDakQsR0FBRyxFQUFFLFNBQVMsSUFDaEI7SUFFTixDQUFDO0lBRU8sTUFBTSxDQUFDLGlCQUFpQixDQUFDLE9BQWlCLEVBQUUsUUFBbUI7UUFFbkUsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDOUQsT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMxRSxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFFTyxNQUFNLENBQU8saUJBQWlCLENBQUMsZUFBZ0MsRUFDaEMsT0FBaUIsRUFDakIsUUFBbUI7O1lBRXRELE1BQU0sTUFBTSxHQUFxQixFQUFFLENBQUM7WUFFcEMsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFOUQsS0FBSyxNQUFNLGFBQWEsSUFBSSxjQUFjLEVBQUU7Z0JBRXhDLE1BQU0sYUFBYSxHQUNmLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLGVBQWUsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUUxRixNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2FBRTlCO1lBRUQsT0FBTyxNQUFNLENBQUM7UUFFbEIsQ0FBQztLQUFBO0lBRU8sTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFpQjtRQUV2QyxPQUFPO1lBQ0gsSUFBSSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUU7U0FDbkMsQ0FBQztJQUVOLENBQUM7SUFFTyxNQUFNLENBQUMsU0FBUyxDQUFDLFNBQXlCO1FBQzlDLE9BQU8sbUJBQVEsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDO2FBQ3hCLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7YUFDN0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEMsQ0FBQztDQUVKO0FBdk9ELHdDQXVPQztBQVNELE1BQU0sZUFBZTtJQUVWLE1BQU0sQ0FBQyxNQUFNLENBQUMsY0FBOEIsRUFDOUIsVUFBbUU7UUFFcEYsTUFBTSxNQUFNLEdBQUcscUJBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsaUNBQWUsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDM0YsTUFBTSxNQUFNLEdBQUcscUJBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsaUNBQWUsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFFM0YsT0FBTztZQUNILGNBQWM7WUFDZCxJQUFJLElBQUk7Z0JBQ0osT0FBTyxNQUFNLEVBQUUsQ0FBQztZQUNwQixDQUFDO1lBQ0QsSUFBSSxJQUFJO2dCQUNKLE9BQU8sTUFBTSxFQUFFLENBQUM7WUFDcEIsQ0FBQztTQUNKLENBQUM7SUFFTixDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Fubm90YXRpb25UeXBlfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0Fubm90YXRpb25UeXBlJztcbmltcG9ydCB7SURvY0Fubm90YXRpb259IGZyb20gJy4vRG9jQW5ub3RhdGlvbic7XG5pbXBvcnQge09wdGlvbmFsfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvdHMvT3B0aW9uYWwnO1xuaW1wb3J0IHtGbGFzaGNhcmR9IGZyb20gJy4uL21ldGFkYXRhL0ZsYXNoY2FyZCc7XG5pbXBvcnQge0ZsYXNoY2FyZHN9IGZyb20gJy4uL21ldGFkYXRhL0ZsYXNoY2FyZHMnO1xuaW1wb3J0IHtQb2ludH0gZnJvbSAnLi4vUG9pbnQnO1xuaW1wb3J0IHtPYmplY3RJRHN9IGZyb20gJy4uL3V0aWwvT2JqZWN0SURzJztcbmltcG9ydCB7SW1hZ2VzfSBmcm9tICcuLi9tZXRhZGF0YS9JbWFnZXMnO1xuaW1wb3J0IHtEb2NBbm5vdGF0aW9uSW5kZXh9IGZyb20gXCIuL0RvY0Fubm90YXRpb25JbmRleFwiO1xuaW1wb3J0IHtEb2NGaWxlUmVzb2x2ZXJ9IGZyb20gXCIuLi9kYXRhc3RvcmUvRG9jRmlsZVJlc29sdmVyc1wiO1xuaW1wb3J0IHtJUGFnZU1ldGF9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lQYWdlTWV0YVwiO1xuaW1wb3J0IHtJQmFzZUhpZ2hsaWdodH0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSUJhc2VIaWdobGlnaHRcIjtcbmltcG9ydCB7SURvY01ldGF9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lEb2NNZXRhXCI7XG5pbXBvcnQge0lDb21tZW50fSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JQ29tbWVudFwiO1xuaW1wb3J0IHtJVGV4dEhpZ2hsaWdodH0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSVRleHRIaWdobGlnaHRcIjtcbmltcG9ydCB7SUFyZWFIaWdobGlnaHR9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lBcmVhSGlnaGxpZ2h0XCI7XG5pbXBvcnQge0lBdXRob3J9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lBdXRob3JcIjtcbmltcG9ydCB7SVJlY3R9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC9yZWN0cy9JUmVjdCc7XG5pbXBvcnQge1Byb3ZpZGVyc30gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdXRpbC9Qcm92aWRlcnNcIjtcbmltcG9ydCB7QW5ub3RhdGlvblRleHRzfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9Bbm5vdGF0aW9uVGV4dHNcIjtcbmltcG9ydCB7UGxhaW5UZXh0U3RyfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy91dGlsL1N0cmluZ3NcIjtcbmltcG9ydCB7SUZsYXNoY2FyZH0gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSUZsYXNoY2FyZFwiO1xuaW1wb3J0IHtIaWdobGlnaHRDb2xvcnN9IGZyb20gXCJwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0hpZ2hsaWdodENvbG9yXCI7XG5pbXBvcnQge1RhZ30gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdGFncy9UYWdzXCI7XG5cbmV4cG9ydCBjbGFzcyBEb2NBbm5vdGF0aW9ucyB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBpc0ltbXV0YWJsZShhdXRob3I/OiBJQXV0aG9yKSB7XG5cbiAgICAgICAgaWYgKGF1dGhvciAmJiBhdXRob3IuZ3Vlc3QpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBnZXRBbm5vdGF0aW9uc0ZvclBhZ2UoZG9jRmlsZVJlc29sdmVyOiBEb2NGaWxlUmVzb2x2ZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jQW5ub3RhdGlvbkluZGV4OiBEb2NBbm5vdGF0aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jTWV0YTogSURvY01ldGEpOiBQcm9taXNlPElEb2NBbm5vdGF0aW9uW10+IHtcblxuICAgICAgICBjb25zdCByZXN1bHQ6IElEb2NBbm5vdGF0aW9uW10gPSBbXTtcblxuICAgICAgICBjb25zdCBwYWdlTWV0YXMgPSBPYmplY3QudmFsdWVzKGRvY01ldGEucGFnZU1ldGFzKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHBhZ2VNZXRhIG9mIHBhZ2VNZXRhcykge1xuXG4gICAgICAgICAgICBjb25zdCBhcmVhSGlnaGxpZ2h0cyA9IGF3YWl0IHRoaXMuZ2V0QXJlYUhpZ2hsaWdodHMoZG9jRmlsZVJlc29sdmVyLCBkb2NNZXRhLCBwYWdlTWV0YSk7XG4gICAgICAgICAgICBjb25zdCB0ZXh0SGlnaGxpZ2h0cyA9IHRoaXMuZ2V0VGV4dEhpZ2hsaWdodHMoZG9jTWV0YSwgcGFnZU1ldGEpO1xuXG4gICAgICAgICAgICByZXN1bHQucHVzaCguLi50ZXh0SGlnaGxpZ2h0cyk7XG4gICAgICAgICAgICByZXN1bHQucHVzaCguLi5hcmVhSGlnaGxpZ2h0cyk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZUZyb21GbGFzaGNhcmQoZG9jTWV0YTogSURvY01ldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoY2FyZDogSUZsYXNoY2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZU1ldGE6IElQYWdlTWV0YSk6IElEb2NBbm5vdGF0aW9uIHtcblxuICAgICAgICBjb25zdCBpVGV4dENvbnZlcnRlciA9IElUZXh0Q29udmVydGVycy5jcmVhdGUoQW5ub3RhdGlvblR5cGUuRkxBU0hDQVJELCBmbGFzaGNhcmQpO1xuXG4gICAgICAgIGNvbnN0IGluaXQgPSB0aGlzLmNyZWF0ZUluaXQoZG9jTWV0YSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLmluaXQsXG4gICAgICAgICAgICBvaWQ6IE9iamVjdElEcy5jcmVhdGUoKSxcbiAgICAgICAgICAgIGlkOiBmbGFzaGNhcmQuaWQsXG4gICAgICAgICAgICBndWlkOiBmbGFzaGNhcmQuZ3VpZCxcbiAgICAgICAgICAgIGZpbmdlcnByaW50OiBkb2NNZXRhLmRvY0luZm8uZmluZ2VycHJpbnQsXG4gICAgICAgICAgICBkb2NJbmZvOiBkb2NNZXRhLmRvY0luZm8sXG4gICAgICAgICAgICAuLi5pVGV4dENvbnZlcnRlcixcbiAgICAgICAgICAgIGZpZWxkczogRmxhc2hjYXJkcy5jb252ZXJ0RmllbGRzVG9NYXAoZmxhc2hjYXJkLmZpZWxkcyksXG4gICAgICAgICAgICBwYWdlTnVtOiBwYWdlTWV0YS5wYWdlSW5mby5udW0sXG4gICAgICAgICAgICAvLyBpcnJlbGV2YW50IG9uIGNvbW1lbnRzXG4gICAgICAgICAgICBwb3NpdGlvbjoge1xuICAgICAgICAgICAgICAgIHg6IDAsXG4gICAgICAgICAgICAgICAgeTogMFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNyZWF0ZWQ6IGZsYXNoY2FyZC5jcmVhdGVkLFxuICAgICAgICAgICAgZG9jTWV0YSxcbiAgICAgICAgICAgIHBhZ2VNZXRhLFxuICAgICAgICAgICAgcmVmOiBmbGFzaGNhcmQucmVmLFxuICAgICAgICAgICAgb3JpZ2luYWw6IGZsYXNoY2FyZCxcbiAgICAgICAgICAgIGF1dGhvcjogZmxhc2hjYXJkLmF1dGhvcixcbiAgICAgICAgICAgIGltbXV0YWJsZTogdGhpcy5pc0ltbXV0YWJsZShmbGFzaGNhcmQuYXV0aG9yKSxcbiAgICAgICAgICAgIGNvbG9yOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBpbWc6IHVuZGVmaW5lZFxuICAgICAgICB9O1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGVGcm9tQ29tbWVudChkb2NNZXRhOiBJRG9jTWV0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1lbnQ6IElDb21tZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZU1ldGE6IElQYWdlTWV0YSk6IElEb2NBbm5vdGF0aW9uIHtcblxuICAgICAgICBjb25zdCBpVGV4dENvbnZlcnRlciA9IElUZXh0Q29udmVydGVycy5jcmVhdGUoQW5ub3RhdGlvblR5cGUuQ09NTUVOVCwgY29tbWVudCk7XG5cbiAgICAgICAgY29uc3QgaW5pdCA9IHRoaXMuY3JlYXRlSW5pdChkb2NNZXRhKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uaW5pdCxcbiAgICAgICAgICAgIG9pZDogT2JqZWN0SURzLmNyZWF0ZSgpLFxuICAgICAgICAgICAgaWQ6IGNvbW1lbnQuaWQsXG4gICAgICAgICAgICBndWlkOiBjb21tZW50Lmd1aWQsXG4gICAgICAgICAgICBmaW5nZXJwcmludDogZG9jTWV0YS5kb2NJbmZvLmZpbmdlcnByaW50LFxuICAgICAgICAgICAgZG9jSW5mbzogZG9jTWV0YS5kb2NJbmZvLFxuICAgICAgICAgICAgLi4uaVRleHRDb252ZXJ0ZXIsXG4gICAgICAgICAgICBwYWdlTnVtOiBwYWdlTWV0YS5wYWdlSW5mby5udW0sXG4gICAgICAgICAgICAvLyBpcnJlbGV2YW50IG9uIGNvbW1lbnRzXG4gICAgICAgICAgICBwb3NpdGlvbjoge1xuICAgICAgICAgICAgICAgIHg6IDAsXG4gICAgICAgICAgICAgICAgeTogMFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNyZWF0ZWQ6IGNvbW1lbnQuY3JlYXRlZCxcbiAgICAgICAgICAgIGRvY01ldGEsXG4gICAgICAgICAgICBwYWdlTWV0YSxcbiAgICAgICAgICAgIHJlZjogY29tbWVudC5yZWYsXG4gICAgICAgICAgICBvcmlnaW5hbDogY29tbWVudCxcbiAgICAgICAgICAgIGF1dGhvcjogY29tbWVudC5hdXRob3IsXG4gICAgICAgICAgICBpbW11dGFibGU6IHRoaXMuaXNJbW11dGFibGUoY29tbWVudC5hdXRob3IpLFxuICAgICAgICAgICAgY29sb3I6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGltZzogdW5kZWZpbmVkXG4gICAgICAgIH07XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZUZyb21BcmVhSGlnaGxpZ2h0KGRvY0ZpbGVSZXNvbHZlcjogRG9jRmlsZVJlc29sdmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jTWV0YTogSURvY01ldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmVhSGlnaGxpZ2h0OiBJQXJlYUhpZ2hsaWdodCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VNZXRhOiBJUGFnZU1ldGEpOiBJRG9jQW5ub3RhdGlvbiB7XG5cbiAgICAgICAgY29uc3QgY3JlYXRlUG9zaXRpb24gPSAoKTogUG9pbnQgPT4ge1xuXG4gICAgICAgICAgICBpZiAoYXJlYUhpZ2hsaWdodC5wb3NpdGlvbikge1xuICAgICAgICAgICAgICAgIHJldHVybiB7Li4uYXJlYUhpZ2hsaWdodC5wb3NpdGlvbn07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgeDogdGhpcy5maXJzdFJlY3QoYXJlYUhpZ2hsaWdodCkubWFwKGN1cnJlbnQgPT4gY3VycmVudC5sZWZ0KS5nZXRPckVsc2UoMCksXG4gICAgICAgICAgICAgICAgeTogdGhpcy5maXJzdFJlY3QoYXJlYUhpZ2hsaWdodCkubWFwKGN1cnJlbnQgPT4gY3VycmVudC50b3ApLmdldE9yRWxzZSgwKSxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBpbWcgPSBQcm92aWRlcnMubWVtb2l6ZSgoKSA9PiBJbWFnZXMudG9JbWcoZG9jRmlsZVJlc29sdmVyLCBhcmVhSGlnaGxpZ2h0LmltYWdlKSk7XG5cbiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBjcmVhdGVQb3NpdGlvbigpO1xuXG4gICAgICAgIGNvbnN0IGluaXQgPSB0aGlzLmNyZWF0ZUluaXQoZG9jTWV0YSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLmluaXQsXG4gICAgICAgICAgICBvaWQ6IE9iamVjdElEcy5jcmVhdGUoKSxcbiAgICAgICAgICAgIGlkOiBhcmVhSGlnaGxpZ2h0LmlkLFxuICAgICAgICAgICAgZ3VpZDogYXJlYUhpZ2hsaWdodC5ndWlkLFxuICAgICAgICAgICAgZmluZ2VycHJpbnQ6IGRvY01ldGEuZG9jSW5mby5maW5nZXJwcmludCxcbiAgICAgICAgICAgIGRvY0luZm86IGRvY01ldGEuZG9jSW5mbyxcbiAgICAgICAgICAgIGFubm90YXRpb25UeXBlOiBBbm5vdGF0aW9uVHlwZS5BUkVBX0hJR0hMSUdIVCxcbiAgICAgICAgICAgIGdldCBpbWcoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGltZygpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRleHQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGh0bWw6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHBhZ2VOdW06IHBhZ2VNZXRhLnBhZ2VJbmZvLm51bSxcbiAgICAgICAgICAgIHBvc2l0aW9uLFxuICAgICAgICAgICAgY29sb3I6IEhpZ2hsaWdodENvbG9ycy53aXRoRGVmYXVsdENvbG9yKGFyZWFIaWdobGlnaHQuY29sb3IpLFxuICAgICAgICAgICAgY3JlYXRlZDogYXJlYUhpZ2hsaWdodC5jcmVhdGVkLFxuICAgICAgICAgICAgZG9jTWV0YSxcbiAgICAgICAgICAgIHBhZ2VNZXRhLFxuICAgICAgICAgICAgb3JpZ2luYWw6IGFyZWFIaWdobGlnaHQsXG4gICAgICAgICAgICBhdXRob3I6IGFyZWFIaWdobGlnaHQuYXV0aG9yLFxuICAgICAgICAgICAgaW1tdXRhYmxlOiB0aGlzLmlzSW1tdXRhYmxlKGFyZWFIaWdobGlnaHQuYXV0aG9yKSxcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlRnJvbVRleHRIaWdobGlnaHQoZG9jTWV0YTogSURvY01ldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0SGlnaGxpZ2h0OiBJVGV4dEhpZ2hsaWdodCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VNZXRhOiBJUGFnZU1ldGEpOiBJRG9jQW5ub3RhdGlvbiB7XG5cbiAgICAgICAgY29uc3QgaVRleHRDb252ZXJ0ZXIgPSBJVGV4dENvbnZlcnRlcnMuY3JlYXRlKEFubm90YXRpb25UeXBlLlRFWFRfSElHSExJR0hULCB0ZXh0SGlnaGxpZ2h0KTtcblxuICAgICAgICBjb25zdCBpbml0ID0gdGhpcy5jcmVhdGVJbml0KGRvY01ldGEpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5pbml0LFxuICAgICAgICAgICAgb2lkOiBPYmplY3RJRHMuY3JlYXRlKCksXG4gICAgICAgICAgICBpZDogdGV4dEhpZ2hsaWdodC5pZCxcbiAgICAgICAgICAgIGd1aWQ6IHRleHRIaWdobGlnaHQuZ3VpZCxcbiAgICAgICAgICAgIGZpbmdlcnByaW50OiBkb2NNZXRhLmRvY0luZm8uZmluZ2VycHJpbnQsXG4gICAgICAgICAgICBkb2NJbmZvOiBkb2NNZXRhLmRvY0luZm8sXG4gICAgICAgICAgICAuLi5pVGV4dENvbnZlcnRlcixcbiAgICAgICAgICAgIHBhZ2VOdW06IHBhZ2VNZXRhLnBhZ2VJbmZvLm51bSxcbiAgICAgICAgICAgIHBvc2l0aW9uOiB7XG4gICAgICAgICAgICAgICAgeDogdGhpcy5maXJzdFJlY3QodGV4dEhpZ2hsaWdodCkubWFwKGN1cnJlbnQgPT4gY3VycmVudC5sZWZ0KS5nZXRPckVsc2UoMCksXG4gICAgICAgICAgICAgICAgeTogdGhpcy5maXJzdFJlY3QodGV4dEhpZ2hsaWdodCkubWFwKGN1cnJlbnQgPT4gY3VycmVudC50b3ApLmdldE9yRWxzZSgwKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb2xvcjogSGlnaGxpZ2h0Q29sb3JzLndpdGhEZWZhdWx0Q29sb3IodGV4dEhpZ2hsaWdodC5jb2xvciksXG4gICAgICAgICAgICBjcmVhdGVkOiB0ZXh0SGlnaGxpZ2h0LmNyZWF0ZWQsXG4gICAgICAgICAgICBkb2NNZXRhLFxuICAgICAgICAgICAgcGFnZU1ldGEsXG4gICAgICAgICAgICBvcmlnaW5hbDogdGV4dEhpZ2hsaWdodCxcbiAgICAgICAgICAgIGF1dGhvcjogdGV4dEhpZ2hsaWdodC5hdXRob3IsXG4gICAgICAgICAgICBpbW11dGFibGU6IHRoaXMuaXNJbW11dGFibGUodGV4dEhpZ2hsaWdodC5hdXRob3IpLFxuICAgICAgICAgICAgaW1nOiB1bmRlZmluZWRcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldFRleHRIaWdobGlnaHRzKGRvY01ldGE6IElEb2NNZXRhLCBwYWdlTWV0YTogSVBhZ2VNZXRhKTogUmVhZG9ubHlBcnJheTxJRG9jQW5ub3RhdGlvbj4ge1xuXG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKHBhZ2VNZXRhLnRleHRIaWdobGlnaHRzKS5tYXAodGV4dEhpZ2hsaWdodCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVGcm9tVGV4dEhpZ2hsaWdodChkb2NNZXRhLCB0ZXh0SGlnaGxpZ2h0LCBwYWdlTWV0YSk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgZ2V0QXJlYUhpZ2hsaWdodHMoZG9jRmlsZVJlc29sdmVyOiBEb2NGaWxlUmVzb2x2ZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jTWV0YTogSURvY01ldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZU1ldGE6IElQYWdlTWV0YSk6IFByb21pc2U8SURvY0Fubm90YXRpb25bXT4ge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogSURvY0Fubm90YXRpb25bXSA9IFtdO1xuXG4gICAgICAgIGNvbnN0IGFyZWFIaWdobGlnaHRzID0gT2JqZWN0LnZhbHVlcyhwYWdlTWV0YS5hcmVhSGlnaGxpZ2h0cyk7XG5cbiAgICAgICAgZm9yIChjb25zdCBhcmVhSGlnaGxpZ2h0IG9mIGFyZWFIaWdobGlnaHRzKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGRvY0Fubm90YXRpb24gPVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY3JlYXRlRnJvbUFyZWFIaWdobGlnaHQoZG9jRmlsZVJlc29sdmVyLCBkb2NNZXRhLCBhcmVhSGlnaGxpZ2h0LCBwYWdlTWV0YSk7XG5cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGRvY0Fubm90YXRpb24pO1xuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlSW5pdChkb2NNZXRhOiBJRG9jTWV0YSk6IERvY0Fubm90YXRpb25Jbml0IHtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGFnczogZG9jTWV0YS5kb2NJbmZvLnRhZ3MgfHwge30sXG4gICAgICAgIH07XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBmaXJzdFJlY3QoaGlnaGxpZ2h0OiBJQmFzZUhpZ2hsaWdodCk6IE9wdGlvbmFsPElSZWN0PiB7XG4gICAgICAgIHJldHVybiBPcHRpb25hbC5vZihoaWdobGlnaHQpXG4gICAgICAgICAgICAubWFwKGN1cnJlbnQgPT4gY3VycmVudC5yZWN0cylcbiAgICAgICAgICAgIC5tYXAoY3VycmVudCA9PiBjdXJyZW50WzBdKTtcbiAgICB9XG5cbn1cblxuLyoqXG4gKiBQcm9wZXJ0aWVzIHByZXNlbnQgaW4gbW9zdCBhbm5vdGF0aW9ucyB0aGF0IHdpbGwgYmUgdXNlZCB0aGUgc2FtZS5cbiAqL1xuaW50ZXJmYWNlIERvY0Fubm90YXRpb25Jbml0IHtcbiAgICByZWFkb25seSB0YWdzOiBSZWFkb25seTx7W2lkOiBzdHJpbmddOiBUYWd9PiB8IHVuZGVmaW5lZDtcbn1cblxuY2xhc3MgSVRleHRDb252ZXJ0ZXJzIHtcblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlKGFubm90YXRpb25UeXBlOiBBbm5vdGF0aW9uVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9uOiBJVGV4dEhpZ2hsaWdodCB8IElBcmVhSGlnaGxpZ2h0IHwgSUNvbW1lbnQgfCBJRmxhc2hjYXJkKTogSVRleHRDb252ZXJ0ZXIge1xuXG4gICAgICAgIGNvbnN0IHRvVGV4dCA9IFByb3ZpZGVycy5tZW1vaXplKCgpID0+IEFubm90YXRpb25UZXh0cy50b1RleHQoYW5ub3RhdGlvblR5cGUsIGFubm90YXRpb24pKTtcbiAgICAgICAgY29uc3QgdG9IVE1MID0gUHJvdmlkZXJzLm1lbW9pemUoKCkgPT4gQW5ub3RhdGlvblRleHRzLnRvSFRNTChhbm5vdGF0aW9uVHlwZSwgYW5ub3RhdGlvbikpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhbm5vdGF0aW9uVHlwZSxcbiAgICAgICAgICAgIGdldCB0ZXh0KCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0b1RleHQoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBnZXQgaHRtbCgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdG9IVE1MKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuXG4gICAgfVxuXG59XG5cbmludGVyZmFjZSBJVGV4dENvbnZlcnRlciB7XG4gICAgcmVhZG9ubHkgYW5ub3RhdGlvblR5cGU6IEFubm90YXRpb25UeXBlO1xuICAgIHJlYWRvbmx5IHRleHQ6IFBsYWluVGV4dFN0ciB8IHVuZGVmaW5lZDtcbiAgICByZWFkb25seSBodG1sOiBQbGFpblRleHRTdHIgfCB1bmRlZmluZWQ7XG59XG4iXX0=