"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const React = __importStar(require("react"));
const Creatable_1 = __importDefault(require("react-select/lib/Creatable"));
const TagOptions_1 = require("./TagOptions");
const Tags_1 = require("polar-shared/src/tags/Tags");
const Logger_1 = require("polar-shared/src/logger/Logger");
const Button_1 = __importDefault(require("reactstrap/lib/Button"));
const Popover_1 = __importDefault(require("reactstrap/lib/Popover"));
const PopoverBody_1 = __importDefault(require("reactstrap/lib/PopoverBody"));
const Toaster_1 = require("../../../web/js/ui/toaster/Toaster");
const IDs_1 = require("../../../web/js/util/IDs");
const Functions_1 = require("polar-shared/src/util/Functions");
const PremiumFeature_1 = require("../../../web/js/ui/premium_feature/PremiumFeature");
const BlackoutBox_1 = require("../../../web/js/ui/util/BlackoutBox");
const log = Logger_1.Logger.create();
const Styles = {
    popover: {
        backgroundColor: 'var(--white)',
        width: '500px !important',
        maxWidth: '9999px !important'
    },
    label: {
        fontWeight: 'bold'
    },
    relatedTags: {
        display: 'flex',
    },
    relatedTagsLabel: {
        marginTop: 'auto',
        marginBottom: 'auto'
    },
    relatedTag: {
        display: 'inline-block',
        backgroundColor: 'var(--grey100)',
        color: 'hsl(0,0%,20%)',
        fontSize: '12px',
        padding: '3px',
        marginTop: 'auto',
        marginBottom: 'auto'
    }
};
class TagInput extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.id = IDs_1.IDs.create("popover-");
        this.select = null;
        this.activate = this.activate.bind(this);
        this.deactivate = this.deactivate.bind(this);
        this.onCancel = this.onCancel.bind(this);
        this.onDone = this.onDone.bind(this);
        this.handleChange = this.handleChange.bind(this);
        this.state = {
            open: false,
            pendingTags: []
        };
    }
    activate() {
        const pendingTags = this.props.existingTags ? this.props.existingTags() : [];
        this.setState({ open: true, pendingTags });
    }
    deactivate() {
        this.setState({ open: false });
    }
    render() {
        const availableTagOptions = TagOptions_1.TagOptions.fromTags(this.props.availableTags);
        const pendingTags = TagOptions_1.TagOptions.fromTags(this.state.pendingTags);
        const computeRelatedTags = () => {
            const input = [...this.state.pendingTags]
                .map(current => current.label);
            return this.props.relatedTags.compute(input).map(current => current.tag);
        };
        const relatedTags = computeRelatedTags();
        const RelatedTagsItems = () => {
            return React.createElement("span", null, relatedTags.map(item => React.createElement(Button_1.default, { className: "mr-1", key: item, style: Styles.relatedTag, color: "light", size: "sm", onClick: () => this.addRelatedTag(item) }, item)));
        };
        const RelatedTagsWidget = () => {
            if (relatedTags.length === 0) {
                return null;
            }
            return React.createElement("div", { style: Styles.relatedTags },
                React.createElement("div", { className: "mr-1", style: Styles.relatedTagsLabel },
                    React.createElement("strong", null, "Related tags: ")),
                React.createElement(RelatedTagsItems, null));
        };
        return (React.createElement("div", { className: "mt-auto mb-auto" },
            React.createElement("i", { id: this.id, onClick: () => this.activate(), className: "fa fa-tag doc-button doc-button-inactive" }),
            React.createElement(Popover_1.default, { placement: "auto", isOpen: this.state.open, target: this.id, fade: false, delay: 0, toggle: () => this.deactivate(), className: "tag-input-popover shadow" },
                React.createElement(PopoverBody_1.default, { style: Styles.popover, className: "shadow rounded" },
                    React.createElement(BlackoutBox_1.BlackoutBox, null,
                        React.createElement("div", { className: "bg-white" },
                            React.createElement("div", { className: "pt-1 pb-1" },
                                React.createElement("strong", null, "Assign tags to document:")),
                            React.createElement(Creatable_1.default, { isMulti: true, isClearable: true, autoFocus: true, onKeyDown: event => this.onKeyDown(event), className: "basic-multi-select", classNamePrefix: "select", onChange: (selectedOptions) => this.handleChange(selectedOptions), value: pendingTags, defaultValue: pendingTags, placeholder: "Create or select tags ...", options: availableTagOptions, ref: ref => this.select = ref }),
                            React.createElement("div", { className: "pt-1" },
                                React.createElement(PremiumFeature_1.PremiumFeature, { required: 'bronze', size: 'sm', feature: "related tags" },
                                    React.createElement(RelatedTagsWidget, null))),
                            React.createElement("div", { className: "mt-1" },
                                React.createElement("div", { style: { display: 'flex' } },
                                    React.createElement("div", { className: "ml-auto" }),
                                    React.createElement(Button_1.default, { color: "secondary", size: "sm", onClick: () => this.onCancel() }, "Cancel"),
                                    React.createElement("div", { className: "ml-1" }),
                                    React.createElement(Button_1.default, { color: "primary", size: "sm", onClick: () => this.onDone() }, "Done")))))))));
    }
    addRelatedTag(label) {
        const tag = {
            id: label,
            label
        };
        const tags = [tag, ...this.state.pendingTags];
        this.handleChange(TagOptions_1.TagOptions.fromTags(tags));
        this.select.focus();
    }
    onCancel() {
        this.setState(Object.assign(Object.assign({}, this.state), { open: false }));
    }
    onDone() {
        this.setState(Object.assign(Object.assign({}, this.state), { open: false }));
        const onChange = this.props.onChange || Functions_1.NULL_FUNCTION;
        onChange(this.state.pendingTags);
    }
    onKeyDown(event) {
        if (event.key === "Escape") {
            this.onCancel();
        }
        if (event.getModifierState("Control") && event.key === "Enter") {
            this.onDone();
        }
    }
    handleChange(selectedOptions) {
        const tags = TagOptions_1.TagOptions.toTags(selectedOptions);
        const validTags = Tags_1.Tags.findValidTags(...tags);
        const invalidTags = Tags_1.Tags.findInvalidTags(...tags);
        if (invalidTags.length !== 0) {
            const invalidTagsStr = invalidTags.map(current => current.label)
                .join(", ");
            Toaster_1.Toaster.warning("Some tags were excluded - spaces and other control characters not supported: " + invalidTagsStr, "Invalid tags");
            log.warn("Some tags were invalid", invalidTags);
        }
        this.setState(Object.assign(Object.assign({}, this.state), { pendingTags: validTags }));
    }
}
exports.TagInput = TagInput;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFnSW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJUYWdJbnB1dC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsNkNBQStCO0FBQy9CLDJFQUF5RDtBQUV6RCw2Q0FBd0M7QUFDeEMscURBQWdEO0FBQ2hELDJEQUFzRDtBQUd0RCxtRUFBMkM7QUFDM0MscUVBQTZDO0FBQzdDLDZFQUFxRDtBQUNyRCxnRUFBMkQ7QUFDM0Qsa0RBQTZDO0FBQzdDLCtEQUE4RDtBQUU5RCxzRkFBaUY7QUFDakYscUVBQWdFO0FBRWhFLE1BQU0sR0FBRyxHQUFHLGVBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUU1QixNQUFNLE1BQU0sR0FBYztJQUV0QixPQUFPLEVBQUU7UUFDTCxlQUFlLEVBQUUsY0FBYztRQUMvQixLQUFLLEVBQUUsa0JBQWtCO1FBQ3pCLFFBQVEsRUFBRSxtQkFBbUI7S0FDaEM7SUFFRCxLQUFLLEVBQUU7UUFDSCxVQUFVLEVBQUUsTUFBTTtLQUNyQjtJQUVELFdBQVcsRUFBRTtRQUNULE9BQU8sRUFBRSxNQUFNO0tBQ2xCO0lBRUQsZ0JBQWdCLEVBQUU7UUFDZCxTQUFTLEVBQUUsTUFBTTtRQUNqQixZQUFZLEVBQUUsTUFBTTtLQUN2QjtJQUVELFVBQVUsRUFBRTtRQUNSLE9BQU8sRUFBRSxjQUFjO1FBQ3ZCLGVBQWUsRUFBRSxnQkFBZ0I7UUFDakMsS0FBSyxFQUFFLGVBQWU7UUFDdEIsUUFBUSxFQUFFLE1BQU07UUFDaEIsT0FBTyxFQUFFLEtBQUs7UUFDZCxTQUFTLEVBQUUsTUFBTTtRQUNqQixZQUFZLEVBQUUsTUFBTTtLQUN2QjtDQUVKLENBQUM7QUFFRixNQUFhLFFBQVMsU0FBUSxLQUFLLENBQUMsU0FBeUI7SUFNekQsWUFBWSxLQUFhLEVBQUUsT0FBWTtRQUNuQyxLQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBTFQsT0FBRSxHQUFHLFNBQUcsQ0FBQyxNQUFNLENBQUMsVUFB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O1lBRXBCLGlCQUFPLENBQUMsT0FBTyxDQUFDLCtFQUErRSxHQUFHLGNBQWMsRUFDaEcsY0FBYyxDQUFDLENBQUM7WUFFaEMsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUVuRDtRQUVELElBQUksQ0FBQyxRQUFRLGlDQUFLLElBQUksQ0FBQyxLQUFLLEtBQUUsV0FBVyxFQUFFLFNBQVMsSUFBRSxDQUFDO0lBRTNELENBQUM7Q0FFSjtBQWhQRCw0QkFnUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgQ3JlYXRhYmxlU2VsZWN0IGZyb20gJ3JlYWN0LXNlbGVjdC9saWIvQ3JlYXRhYmxlJztcbmltcG9ydCB7VGFnT3B0aW9ufSBmcm9tICcuL1RhZ09wdGlvbic7XG5pbXBvcnQge1RhZ09wdGlvbnN9IGZyb20gJy4vVGFnT3B0aW9ucyc7XG5pbXBvcnQge1RhZ3N9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdGFncy9UYWdzJztcbmltcG9ydCB7TG9nZ2VyfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL2xvZ2dlci9Mb2dnZXInO1xuaW1wb3J0IHtJU3R5bGVNYXB9IGZyb20gJy4uLy4uLy4uL3dlYi9qcy9yZWFjdC9JU3R5bGVNYXAnO1xuaW1wb3J0IHtSZWxhdGVkVGFnc30gZnJvbSAnLi4vLi4vLi4vd2ViL2pzL3RhZ3MvcmVsYXRlZC9SZWxhdGVkVGFncyc7XG5pbXBvcnQgQnV0dG9uIGZyb20gJ3JlYWN0c3RyYXAvbGliL0J1dHRvbic7XG5pbXBvcnQgUG9wb3ZlciBmcm9tICdyZWFjdHN0cmFwL2xpYi9Qb3BvdmVyJztcbmltcG9ydCBQb3BvdmVyQm9keSBmcm9tICdyZWFjdHN0cmFwL2xpYi9Qb3BvdmVyQm9keSc7XG5pbXBvcnQge1RvYXN0ZXJ9IGZyb20gJy4uLy4uLy4uL3dlYi9qcy91aS90b2FzdGVyL1RvYXN0ZXInO1xuaW1wb3J0IHtJRHN9IGZyb20gJy4uLy4uLy4uL3dlYi9qcy91dGlsL0lEcyc7XG5pbXBvcnQge05VTExfRlVOQ1RJT059IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdXRpbC9GdW5jdGlvbnMnO1xuaW1wb3J0IHtUYWd9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdGFncy9UYWdzJztcbmltcG9ydCB7UHJlbWl1bUZlYXR1cmV9IGZyb20gXCIuLi8uLi8uLi93ZWIvanMvdWkvcHJlbWl1bV9mZWF0dXJlL1ByZW1pdW1GZWF0dXJlXCI7XG5pbXBvcnQge0JsYWNrb3V0Qm94fSBmcm9tIFwiLi4vLi4vLi4vd2ViL2pzL3VpL3V0aWwvQmxhY2tvdXRCb3hcIjtcblxuY29uc3QgbG9nID0gTG9nZ2VyLmNyZWF0ZSgpO1xuXG5jb25zdCBTdHlsZXM6IElTdHlsZU1hcCA9IHtcblxuICAgIHBvcG92ZXI6IHtcbiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAndmFyKC0td2hpdGUpJyxcbiAgICAgICAgd2lkdGg6ICc1MDBweCAhaW1wb3J0YW50JyxcbiAgICAgICAgbWF4V2lkdGg6ICc5OTk5cHggIWltcG9ydGFudCdcbiAgICB9LFxuXG4gICAgbGFiZWw6IHtcbiAgICAgICAgZm9udFdlaWdodDogJ2JvbGQnXG4gICAgfSxcblxuICAgIHJlbGF0ZWRUYWdzOiB7XG4gICAgICAgIGRpc3BsYXk6ICdmbGV4JyxcbiAgICB9LFxuXG4gICAgcmVsYXRlZFRhZ3NMYWJlbDoge1xuICAgICAgICBtYXJnaW5Ub3A6ICdhdXRvJyxcbiAgICAgICAgbWFyZ2luQm90dG9tOiAnYXV0bydcbiAgICB9LFxuXG4gICAgcmVsYXRlZFRhZzoge1xuICAgICAgICBkaXNwbGF5OiAnaW5saW5lLWJsb2NrJyxcbiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAndmFyKC0tZ3JleTEwMCknLFxuICAgICAgICBjb2xvcjogJ2hzbCgwLDAlLDIwJSknLFxuICAgICAgICBmb250U2l6ZTogJzEycHgnLFxuICAgICAgICBwYWRkaW5nOiAnM3B4JyxcbiAgICAgICAgbWFyZ2luVG9wOiAnYXV0bycsXG4gICAgICAgIG1hcmdpbkJvdHRvbTogJ2F1dG8nXG4gICAgfVxuXG59O1xuXG5leHBvcnQgY2xhc3MgVGFnSW5wdXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgaWQgPSBJRHMuY3JlYXRlKFwicG9wb3Zlci1cIik7XG5cbiAgICBwcml2YXRlIHNlbGVjdDogQ3JlYXRhYmxlU2VsZWN0PFRhZ09wdGlvbj4gfCBudWxsID0gbnVsbDtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMsIGNvbnRleHQ6IGFueSkge1xuICAgICAgICBzdXBlcihwcm9wcywgY29udGV4dCk7XG5cbiAgICAgICAgdGhpcy5hY3RpdmF0ZSA9IHRoaXMuYWN0aXZhdGUuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5kZWFjdGl2YXRlID0gdGhpcy5kZWFjdGl2YXRlLmJpbmQodGhpcyk7XG5cbiAgICAgICAgdGhpcy5vbkNhbmNlbCA9IHRoaXMub25DYW5jZWwuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5vbkRvbmUgPSB0aGlzLm9uRG9uZS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuaGFuZGxlQ2hhbmdlID0gdGhpcy5oYW5kbGVDaGFuZ2UuYmluZCh0aGlzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgb3BlbjogZmFsc2UsXG4gICAgICAgICAgICBwZW5kaW5nVGFnczogW11cbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgYWN0aXZhdGUoKSB7XG5cbiAgICAgICAgY29uc3QgcGVuZGluZ1RhZ3MgPSB0aGlzLnByb3BzLmV4aXN0aW5nVGFncyA/IHRoaXMucHJvcHMuZXhpc3RpbmdUYWdzKCkgOiBbXTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7b3BlbjogdHJ1ZSwgcGVuZGluZ1RhZ3N9KTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgZGVhY3RpdmF0ZSgpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7b3BlbjogZmFsc2V9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuXG4gICAgICAgIGNvbnN0IGF2YWlsYWJsZVRhZ09wdGlvbnMgPSBUYWdPcHRpb25zLmZyb21UYWdzKHRoaXMucHJvcHMuYXZhaWxhYmxlVGFncyk7XG5cbiAgICAgICAgY29uc3QgcGVuZGluZ1RhZ3MgPSBUYWdPcHRpb25zLmZyb21UYWdzKHRoaXMuc3RhdGUucGVuZGluZ1RhZ3MpO1xuXG4gICAgICAgIGNvbnN0IGNvbXB1dGVSZWxhdGVkVGFncyA9ICgpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBbLi4udGhpcy5zdGF0ZS5wZW5kaW5nVGFnc11cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKGN1cnJlbnQgPT4gY3VycmVudC5sYWJlbClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLnJlbGF0ZWRUYWdzLmNvbXB1dGUoaW5wdXQpLm1hcChjdXJyZW50ID0+IGN1cnJlbnQudGFnKTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlbGF0ZWRUYWdzOiBzdHJpbmdbXSA9IGNvbXB1dGVSZWxhdGVkVGFncygpO1xuXG4gICAgICAgIGNvbnN0IFJlbGF0ZWRUYWdzSXRlbXMgPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gPHNwYW4+XG4gICAgICAgICAgICAgICAge3JlbGF0ZWRUYWdzLm1hcChpdGVtID0+XG4gICAgICAgICAgICAgICAgICAgICA8QnV0dG9uIGNsYXNzTmFtZT1cIm1yLTFcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9e2l0ZW19XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPXtTdHlsZXMucmVsYXRlZFRhZ31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9XCJsaWdodFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9XCJzbVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHRoaXMuYWRkUmVsYXRlZFRhZyhpdGVtKX0+e2l0ZW19PC9CdXR0b24+KX1cbiAgICAgICAgICAgIDwvc3Bhbj47XG5cbiAgICAgICAgfTtcblxuXG4gICAgICAgIGNvbnN0IFJlbGF0ZWRUYWdzV2lkZ2V0ID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBpZiAocmVsYXRlZFRhZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiA8ZGl2IHN0eWxlPXtTdHlsZXMucmVsYXRlZFRhZ3N9PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXItMVwiXG4gICAgICAgICAgICAgICAgICAgICBzdHlsZT17U3R5bGVzLnJlbGF0ZWRUYWdzTGFiZWx9PlxuICAgICAgICAgICAgICAgICAgICA8c3Ryb25nPlJlbGF0ZWQgdGFnczogPC9zdHJvbmc+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPFJlbGF0ZWRUYWdzSXRlbXMvPlxuICAgICAgICAgICAgPC9kaXY+O1xuXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIChcblxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJtdC1hdXRvIG1iLWF1dG9cIj5cblxuICAgICAgICAgICAgICAgIDxpIGlkPXt0aGlzLmlkfVxuICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHRoaXMuYWN0aXZhdGUoKX1cbiAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJmYSBmYS10YWcgZG9jLWJ1dHRvbiBkb2MtYnV0dG9uLWluYWN0aXZlXCIvPlxuXG4gICAgICAgICAgICAgICAgPFBvcG92ZXIgcGxhY2VtZW50PVwiYXV0b1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgaXNPcGVuPXt0aGlzLnN0YXRlLm9wZW59XG4gICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0PXt0aGlzLmlkfVxuICAgICAgICAgICAgICAgICAgICAgICAgIGZhZGU9e2ZhbHNlfVxuICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5PXswfVxuICAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZT17KCkgPT4gdGhpcy5kZWFjdGl2YXRlKCl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwidGFnLWlucHV0LXBvcG92ZXIgc2hhZG93XCI+XG5cbiAgICAgICAgICAgICAgICAgICAgPFBvcG92ZXJCb2R5IHN0eWxlPXtTdHlsZXMucG9wb3Zlcn1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cInNoYWRvdyByb3VuZGVkXCI+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsvKlRPRE8gdW5pZnkgdGhpcyB3aXRoIFRhZ0lucHV0V2lkZ2V0Ki99XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxCbGFja291dEJveD5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYmctd2hpdGVcIj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cInB0LTEgcGItMVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHN0cm9uZz5Bc3NpZ24gdGFncyB0byBkb2N1bWVudDo8L3N0cm9uZz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPENyZWF0YWJsZVNlbGVjdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNNdWx0aVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNDbGVhcmFibGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1c1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25LZXlEb3duPXtldmVudCA9PiB0aGlzLm9uS2V5RG93bihldmVudCl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJiYXNpYy1tdWx0aS1zZWxlY3RcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lUHJlZml4PVwic2VsZWN0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXsoc2VsZWN0ZWRPcHRpb25zKSA9PiB0aGlzLmhhbmRsZUNoYW5nZShzZWxlY3RlZE9wdGlvbnMgYXMgVGFnT3B0aW9uW10pfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3BlbmRpbmdUYWdzfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlPXtwZW5kaW5nVGFnc31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwiQ3JlYXRlIG9yIHNlbGVjdCB0YWdzIC4uLlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zPXthdmFpbGFibGVUYWdPcHRpb25zfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmPXtyZWYgPT4gdGhpcy5zZWxlY3QgPSByZWZ9PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvQ3JlYXRhYmxlU2VsZWN0PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwicHQtMVwiPlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8UHJlbWl1bUZlYXR1cmUgcmVxdWlyZWQ9J2Jyb256ZScgc2l6ZT0nc20nIGZlYXR1cmU9XCJyZWxhdGVkIHRhZ3NcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8UmVsYXRlZFRhZ3NXaWRnZXQvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9QcmVtaXVtRmVhdHVyZT5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm10LTFcIj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT17e2Rpc3BsYXk6ICdmbGV4J319PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJtbC1hdXRvXCIvPlxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPEJ1dHRvbiBjb2xvcj1cInNlY29uZGFyeVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPVwic21cIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gdGhpcy5vbkNhbmNlbCgpfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2FuY2VsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9CdXR0b24+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm1sLTFcIi8+XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8QnV0dG9uIGNvbG9yPVwicHJpbWFyeVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPVwic21cIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gdGhpcy5vbkRvbmUoKX0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERvbmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0J1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8L0JsYWNrb3V0Qm94PlxuICAgICAgICAgICAgICAgICAgICA8L1BvcG92ZXJCb2R5PlxuICAgICAgICAgICAgICAgIDwvUG9wb3Zlcj5cblxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgYWRkUmVsYXRlZFRhZyhsYWJlbDogc3RyaW5nKSB7XG5cbiAgICAgICAgY29uc3QgdGFnOiBUYWcgPSB7XG4gICAgICAgICAgICBpZDogbGFiZWwsXG4gICAgICAgICAgICBsYWJlbFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHRhZ3MgPSBbdGFnLCAuLi50aGlzLnN0YXRlLnBlbmRpbmdUYWdzXTtcblxuICAgICAgICB0aGlzLmhhbmRsZUNoYW5nZShUYWdPcHRpb25zLmZyb21UYWdzKHRhZ3MpKTtcblxuICAgICAgICAvLyBuZWVkIG9yIGVsc2UgdGhlIGJ1dHRvbiBoYXMgZm9jdXMgbm93Li4uXG4gICAgICAgIHRoaXMuc2VsZWN0IS5mb2N1cygpO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkNhbmNlbCgpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7Li4udGhpcy5zdGF0ZSwgb3BlbjogZmFsc2V9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRG9uZSgpIHtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHsuLi50aGlzLnN0YXRlLCBvcGVuOiBmYWxzZX0pO1xuXG4gICAgICAgIGNvbnN0IG9uQ2hhbmdlID0gdGhpcy5wcm9wcy5vbkNoYW5nZSB8fCBOVUxMX0ZVTkNUSU9OO1xuXG4gICAgICAgIC8vIGltcG9ydGFudCB0byBhbHdheXMgY2FsbCBvbkNoYW5nZSBldmVuIGlmIHdlIGhhdmUgbm8gdmFsaWRcbiAgICAgICAgLy8gdGFncyBhcyB0aGlzIGlzIGFjY2VwdGFibGUgYW5kIHdlIHdhbnQgdG8gc2F2ZSB0aGVzZSB0b1xuICAgICAgICAvLyBkaXNrLlxuXG4gICAgICAgIG9uQ2hhbmdlKHRoaXMuc3RhdGUucGVuZGluZ1RhZ3MpO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbktleURvd24oZXZlbnQ6IFJlYWN0LktleWJvYXJkRXZlbnQ8SFRNTEVsZW1lbnQ+KSB7XG5cbiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIikge1xuICAgICAgICAgICAgdGhpcy5vbkNhbmNlbCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGV2ZW50LmdldE1vZGlmaWVyU3RhdGUoXCJDb250cm9sXCIpICYmIGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICB0aGlzLm9uRG9uZSgpO1xuICAgIH1cblxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlQ2hhbmdlKHNlbGVjdGVkT3B0aW9uczogUmVhZG9ubHlBcnJheTxUYWdPcHRpb24+KSB7XG5cbiAgICAgICAgY29uc3QgdGFncyA9IFRhZ09wdGlvbnMudG9UYWdzKHNlbGVjdGVkT3B0aW9ucyk7XG5cbiAgICAgICAgY29uc3QgdmFsaWRUYWdzID0gVGFncy5maW5kVmFsaWRUYWdzKC4uLnRhZ3MpO1xuICAgICAgICBjb25zdCBpbnZhbGlkVGFncyA9IFRhZ3MuZmluZEludmFsaWRUYWdzKC4uLnRhZ3MpO1xuXG4gICAgICAgIGlmIChpbnZhbGlkVGFncy5sZW5ndGggIT09IDApIHtcblxuICAgICAgICAgICAgY29uc3QgaW52YWxpZFRhZ3NTdHIgPVxuICAgICAgICAgICAgICAgIGludmFsaWRUYWdzLm1hcChjdXJyZW50ID0+IGN1cnJlbnQubGFiZWwpXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKFwiLCBcIik7XG5cbiAgICAgICAgICAgIFRvYXN0ZXIud2FybmluZyhcIlNvbWUgdGFncyB3ZXJlIGV4Y2x1ZGVkIC0gc3BhY2VzIGFuZCBvdGhlciBjb250cm9sIGNoYXJhY3RlcnMgbm90IHN1cHBvcnRlZDogXCIgKyBpbnZhbGlkVGFnc1N0cixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkludmFsaWQgdGFnc1wiKTtcblxuICAgICAgICAgICAgbG9nLndhcm4oXCJTb21lIHRhZ3Mgd2VyZSBpbnZhbGlkXCIsIGludmFsaWRUYWdzKTtcblxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7Li4udGhpcy5zdGF0ZSwgcGVuZGluZ1RhZ3M6IHZhbGlkVGFnc30pO1xuXG4gICAgfVxuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVByb3BzIHtcblxuICAgIC8qKlxuICAgICAqIFRoZSB0YWdzIHRoYXQgY2FuIGJlIHNlbGVjdGVkLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGF2YWlsYWJsZVRhZ3M6IFJlYWRvbmx5QXJyYXk8VGFnPjtcblxuICAgIC8qKlxuICAgICAqIFRoZSBleGlzdGluZyB0YWdzIG9uIHRoaXMgaXRlbS5cbiAgICAgKi9cbiAgICByZWFkb25seSBleGlzdGluZ1RhZ3M/OiAoKSA9PiBSZWFkb25seUFycmF5PFRhZz47XG5cbiAgICAvKipcbiAgICAgKiBUaGUgcmVsYXRlZFRhZ3MgaW5kZXggd2hpY2ggaXMgdXBkYXRlZCBhcyB0aGUgdXNlciBzZWxlY3RzIG5ldyB0YWdzLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IHJlbGF0ZWRUYWdzOiBSZWxhdGVkVGFncztcblxuICAgIHJlYWRvbmx5IG9uQ2hhbmdlPzogKHZhbHVlczogUmVhZG9ubHlBcnJheTxUYWc+KSA9PiB2b2lkO1xuXG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuXG4gICAgcmVhZG9ubHkgb3BlbjogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIFRoZSB0YWdzIHRoYXQgYXJlIGFjdGl2ZWx5IGJlaW5nIHNlbGVjdGVkIGJ1dCBub3QgeWV0IGFwcGxpZWQuXG4gICAgICovXG4gICAgcmVhZG9ubHkgcGVuZGluZ1RhZ3M6IFJlYWRvbmx5QXJyYXk8VGFnPjtcblxuXG59XG5cbiJdfQ==