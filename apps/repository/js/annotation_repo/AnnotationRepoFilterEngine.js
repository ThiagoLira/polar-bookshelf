"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const RendererAnalytics_1 = require("../../../../web/js/ga/RendererAnalytics");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const RepoDocAnnotations_1 = require("../RepoDocAnnotations");
const AnnotationRepoFiltersHandler_1 = require("./AnnotationRepoFiltersHandler");
const TagMatcher_1 = require("../../../../web/js/tags/TagMatcher");
const Strings_1 = require("polar-shared/src/util/Strings");
const HighlightColor_1 = require("polar-shared/src/metadata/HighlightColor");
class AnnotationRepoFilterEngine {
    constructor(repoAnnotationsProvider, onUpdated) {
        this.repoAnnotationsProvider = repoAnnotationsProvider;
        this.onUpdated = onUpdated;
        this.filters = new AnnotationRepoFiltersHandler_1.DefaultAnnotationRepoFilters();
    }
    onFiltered(filters) {
        this.filters = filters;
        this.doUpdate();
    }
    onProviderUpdated() {
        this.doUpdate();
    }
    doUpdate() {
        const repoAnnotations = this.repoAnnotationsProvider();
        this.onUpdated(this.filter(repoAnnotations));
    }
    filter(repoAnnotations) {
        repoAnnotations = this.doFilterValid(repoAnnotations);
        repoAnnotations = this.doFilterByText(repoAnnotations);
        repoAnnotations = this.doFilterByTags(repoAnnotations);
        repoAnnotations = this.doFilterByColor(repoAnnotations);
        repoAnnotations = this.doFilterByAnnotationTypes(repoAnnotations);
        return repoAnnotations;
    }
    doFilterByColor(repoAnnotations) {
        if (this.filters.colors.length > 0) {
            return repoAnnotations.filter(current => {
                const color = HighlightColor_1.HighlightColors.withDefaultColor(current.color);
                return this.filters.colors.includes(color);
            });
        }
        return repoAnnotations;
    }
    doFilterByAnnotationTypes(repoAnnotations) {
        if (this.filters.annotationTypes.length > 0) {
            return repoAnnotations.filter(current => this.filters.annotationTypes.includes(current.annotationType));
        }
        return repoAnnotations;
    }
    doFilterValid(repoAnnotations) {
        return repoAnnotations.filter(current => RepoDocAnnotations_1.RepoDocAnnotations.isValid(current));
    }
    doFilterByText(repoAnnotations) {
        if (!Strings_1.Strings.empty(this.filters.text)) {
            RendererAnalytics_1.RendererAnalytics.event({ category: 'annotation-view', action: 'filter-by-text' });
            return repoAnnotations
                .filter(current => Preconditions_1.isPresent(current.text))
                .filter(current => current.text.toLowerCase().indexOf(this.filters.text.toLowerCase()) >= 0);
        }
        return repoAnnotations;
    }
    doFilterFlagged(repoAnnotations) {
        if (this.filters.flagged) {
            return repoAnnotations.filter(current => current.docInfo.flagged);
        }
        return repoAnnotations;
    }
    doFilterArchived(repoAnnotations) {
        if (!this.filters.archived) {
            return repoAnnotations.filter(current => !current.docInfo.archived);
        }
        return repoAnnotations;
    }
    doFilterByTags(repoAnnotations) {
        const tags = this.filters.filteredTags.get()
            .filter(current => current.id !== '/');
        const tagMatcherFactory = new TagMatcher_1.TagMatcherFactory(tags);
        if (tags.length === 0) {
            return repoAnnotations;
        }
        return tagMatcherFactory.filter(repoAnnotations, current => Object.values(current.docInfo.tags || {}));
    }
}
exports.AnnotationRepoFilterEngine = AnnotationRepoFilterEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQW5ub3RhdGlvblJlcG9GaWx0ZXJFbmdpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBbm5vdGF0aW9uUmVwb0ZpbHRlckVuZ2luZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtFQUEwRTtBQUMxRSxrRUFBeUQ7QUFFekQsOERBQXlEO0FBQ3pELGlGQUFtRztBQUNuRyxtRUFBcUU7QUFDckUsMkRBQXNEO0FBQ3RELDZFQUF5RTtBQU16RSxNQUFhLDBCQUEwQjtJQUluQyxZQUFvQix1QkFBZ0UsRUFDaEUsU0FBMEI7UUFEMUIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QztRQUNoRSxjQUFTLEdBQVQsU0FBUyxDQUFpQjtRQUh0QyxZQUFPLEdBQTBCLElBQUksMkRBQTRCLEVBQUUsQ0FBQztJQUs1RSxDQUFDO0lBRU0sVUFBVSxDQUFDLE9BQThCO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNwQixDQUFDO0lBTU0saUJBQWlCO1FBQ3BCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNwQixDQUFDO0lBRU8sUUFBUTtRQUNaLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQ3ZELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTyxNQUFNLENBQUMsZUFBOEM7UUFJekQsZUFBZSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDdEQsZUFBZSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7UUFHdkQsZUFBZSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDdkQsZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLENBQUM7UUFD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QUFJLENBQUMsQ0FBQztRQUV0RCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBRW5CLE9BQU8sZUFBZSxDQUFDO1NBQzFCO1FBRUQsT0FBTyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUNmLE9BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRTFGLENBQUM7Q0FFSjtBQTNIRCxnRUEySEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1JlbmRlcmVyQW5hbHl0aWNzfSBmcm9tICcuLi8uLi8uLi8uLi93ZWIvanMvZ2EvUmVuZGVyZXJBbmFseXRpY3MnO1xuaW1wb3J0IHtpc1ByZXNlbnR9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvUHJlY29uZGl0aW9ucyc7XG5pbXBvcnQge1Byb3ZpZGVyfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvUHJvdmlkZXJzJztcbmltcG9ydCB7UmVwb0RvY0Fubm90YXRpb25zfSBmcm9tICcuLi9SZXBvRG9jQW5ub3RhdGlvbnMnO1xuaW1wb3J0IHtBbm5vdGF0aW9uUmVwb0ZpbHRlcnMsIERlZmF1bHRBbm5vdGF0aW9uUmVwb0ZpbHRlcnN9IGZyb20gJy4vQW5ub3RhdGlvblJlcG9GaWx0ZXJzSGFuZGxlcic7XG5pbXBvcnQge1RhZ01hdGNoZXJGYWN0b3J5fSBmcm9tICcuLi8uLi8uLi8uLi93ZWIvanMvdGFncy9UYWdNYXRjaGVyJztcbmltcG9ydCB7U3RyaW5nc30gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvdXRpbC9TdHJpbmdzXCI7XG5pbXBvcnQge0hpZ2hsaWdodENvbG9yc30gZnJvbSBcInBvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSGlnaGxpZ2h0Q29sb3JcIjtcbmltcG9ydCB7SURvY0Fubm90YXRpb259IGZyb20gXCIuLi8uLi8uLi8uLi93ZWIvanMvYW5ub3RhdGlvbl9zaWRlYmFyL0RvY0Fubm90YXRpb25cIjtcblxuLyoqXG4gKiBUaGUgYWN0dWFsIGVuZ2luZSB0aGF0IGFwcGxpZXMgdGhlIGZpbHRlcnMgb25jZSB0aGV5IGFyZSB1cGRhdGVkLlxuICovXG5leHBvcnQgY2xhc3MgQW5ub3RhdGlvblJlcG9GaWx0ZXJFbmdpbmUge1xuXG4gICAgcHJpdmF0ZSBmaWx0ZXJzOiBBbm5vdGF0aW9uUmVwb0ZpbHRlcnMgPSBuZXcgRGVmYXVsdEFubm90YXRpb25SZXBvRmlsdGVycygpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZXBvQW5ub3RhdGlvbnNQcm92aWRlcjogUHJvdmlkZXI8UmVhZG9ubHlBcnJheTxJRG9jQW5ub3RhdGlvbj4+LFxuICAgICAgICAgICAgICAgIHByaXZhdGUgb25VcGRhdGVkOiBVcGRhdGVkQ2FsbGJhY2spIHtcblxuICAgIH1cblxuICAgIHB1YmxpYyBvbkZpbHRlcmVkKGZpbHRlcnM6IEFubm90YXRpb25SZXBvRmlsdGVycykge1xuICAgICAgICB0aGlzLmZpbHRlcnMgPSBmaWx0ZXJzO1xuICAgICAgICB0aGlzLmRvVXBkYXRlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbGVkIHdoZW4gdGhlIGRhdGEgaW4gdGhlIHByb3ZpZGVyIGhhcyBiZWVuIHVwZGF0ZWQgYW5kIHdlIHNob3VsZFxuICAgICAqIHJlLWFwcGx5IHRoZSBmaWx0ZXJzIGFuZCBjYWxsIG9uUmVmZXJzaGVkIGFnYWluLlxuICAgICAqL1xuICAgIHB1YmxpYyBvblByb3ZpZGVyVXBkYXRlZCgpIHtcbiAgICAgICAgdGhpcy5kb1VwZGF0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZG9VcGRhdGUoKSB7XG4gICAgICAgIGNvbnN0IHJlcG9Bbm5vdGF0aW9ucyA9IHRoaXMucmVwb0Fubm90YXRpb25zUHJvdmlkZXIoKTtcbiAgICAgICAgdGhpcy5vblVwZGF0ZWQodGhpcy5maWx0ZXIocmVwb0Fubm90YXRpb25zKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaWx0ZXIocmVwb0Fubm90YXRpb25zOiBSZWFkb25seUFycmF5PElEb2NBbm5vdGF0aW9uPik6IFJlYWRvbmx5QXJyYXk8SURvY0Fubm90YXRpb24+IHtcblxuICAgICAgICAvLyBhbHdheXMgZmlsdGVyIHZhbGlkIHRvIG1ha2Ugc3VyZSBub3RoaW5nIGNvcnJ1cHRzIHRoZSBzdGF0ZS4gIFNvbWVcbiAgICAgICAgLy8gb3RoZXIgYnVnIG1pZ2h0IGluamVjdCBhIHByb2JsZW0gb3RoZXJ3aXNlLlxuICAgICAgICByZXBvQW5ub3RhdGlvbnMgPSB0aGlzLmRvRmlsdGVyVmFsaWQocmVwb0Fubm90YXRpb25zKTtcbiAgICAgICAgcmVwb0Fubm90YXRpb25zID0gdGhpcy5kb0ZpbHRlckJ5VGV4dChyZXBvQW5ub3RhdGlvbnMpO1xuICAgICAgICAvLyByZXBvQW5ub3RhdGlvbnMgPSB0aGlzLmRvRmlsdGVyRmxhZ2dlZChyZXBvQW5ub3RhdGlvbnMpO1xuICAgICAgICAvLyByZXBvQW5ub3RhdGlvbnMgPSB0aGlzLmRvRmlsdGVyQXJjaGl2ZWQocmVwb0Fubm90YXRpb25zKTtcbiAgICAgICAgcmVwb0Fubm90YXRpb25zID0gdGhpcy5kb0ZpbHRlckJ5VGFncyhyZXBvQW5ub3RhdGlvbnMpO1xuICAgICAgICByZXBvQW5ub3RhdGlvbnMgPSB0aGlzLmRvRmlsdGVyQnlDb2xvcihyZXBvQW5ub3RhdGlvbnMpO1xuICAgICAgICByZXBvQW5ub3RhdGlvbnMgPSB0aGlzLmRvRmlsdGVyQnlBbm5vdGF0aW9uVHlwZXMocmVwb0Fubm90YXRpb25zKTtcblxuICAgICAgICByZXR1cm4gcmVwb0Fubm90YXRpb25zO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb0ZpbHRlckJ5Q29sb3IocmVwb0Fubm90YXRpb25zOiBSZWFkb25seUFycmF5PElEb2NBbm5vdGF0aW9uPik6IFJlYWRvbmx5QXJyYXk8SURvY0Fubm90YXRpb24+IHtcblxuICAgICAgICBpZiAodGhpcy5maWx0ZXJzLmNvbG9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVwb0Fubm90YXRpb25zLmZpbHRlcihjdXJyZW50ID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2xvciA9IEhpZ2hsaWdodENvbG9ycy53aXRoRGVmYXVsdENvbG9yKGN1cnJlbnQuY29sb3IpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbHRlcnMuY29sb3JzLmluY2x1ZGVzKGNvbG9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlcG9Bbm5vdGF0aW9ucztcblxuICAgIH1cblxuICAgIHByaXZhdGUgZG9GaWx0ZXJCeUFubm90YXRpb25UeXBlcyhyZXBvQW5ub3RhdGlvbnM6IFJlYWRvbmx5QXJyYXk8SURvY0Fubm90YXRpb24+KTogUmVhZG9ubHlBcnJheTxJRG9jQW5ub3RhdGlvbj4ge1xuXG4gICAgICAgIGlmICh0aGlzLmZpbHRlcnMuYW5ub3RhdGlvblR5cGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiByZXBvQW5ub3RhdGlvbnMuZmlsdGVyKGN1cnJlbnQgPT4gdGhpcy5maWx0ZXJzLmFubm90YXRpb25UeXBlcy5pbmNsdWRlcyhjdXJyZW50LmFubm90YXRpb25UeXBlKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVwb0Fubm90YXRpb25zO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb0ZpbHRlclZhbGlkKHJlcG9Bbm5vdGF0aW9uczogUmVhZG9ubHlBcnJheTxJRG9jQW5ub3RhdGlvbj4pOiBSZWFkb25seUFycmF5PElEb2NBbm5vdGF0aW9uPiB7XG4gICAgICAgIHJldHVybiByZXBvQW5ub3RhdGlvbnMuZmlsdGVyKGN1cnJlbnQgPT4gUmVwb0RvY0Fubm90YXRpb25zLmlzVmFsaWQoY3VycmVudCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZG9GaWx0ZXJCeVRleHQocmVwb0Fubm90YXRpb25zOiBSZWFkb25seUFycmF5PElEb2NBbm5vdGF0aW9uPik6IFJlYWRvbmx5QXJyYXk8SURvY0Fubm90YXRpb24+IHtcblxuICAgICAgICBpZiAoISBTdHJpbmdzLmVtcHR5KHRoaXMuZmlsdGVycy50ZXh0KSkge1xuXG4gICAgICAgICAgICBSZW5kZXJlckFuYWx5dGljcy5ldmVudCh7Y2F0ZWdvcnk6ICdhbm5vdGF0aW9uLXZpZXcnLCBhY3Rpb246ICdmaWx0ZXItYnktdGV4dCd9KTtcblxuICAgICAgICAgICAgcmV0dXJuIHJlcG9Bbm5vdGF0aW9uc1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoY3VycmVudCA9PiBpc1ByZXNlbnQoY3VycmVudC50ZXh0KSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGN1cnJlbnQgPT4gY3VycmVudC50ZXh0IS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGhpcy5maWx0ZXJzLnRleHQudG9Mb3dlckNhc2UoKSkgPj0gMCk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXBvQW5ub3RhdGlvbnM7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGRvRmlsdGVyRmxhZ2dlZChyZXBvQW5ub3RhdGlvbnM6IFJlYWRvbmx5QXJyYXk8SURvY0Fubm90YXRpb24+KTogUmVhZG9ubHlBcnJheTxJRG9jQW5ub3RhdGlvbj4ge1xuXG4gICAgICAgIGlmICh0aGlzLmZpbHRlcnMuZmxhZ2dlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlcG9Bbm5vdGF0aW9ucy5maWx0ZXIoY3VycmVudCA9PiBjdXJyZW50LmRvY0luZm8uZmxhZ2dlZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVwb0Fubm90YXRpb25zO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb0ZpbHRlckFyY2hpdmVkKHJlcG9Bbm5vdGF0aW9uczogUmVhZG9ubHlBcnJheTxJRG9jQW5ub3RhdGlvbj4pOiBSZWFkb25seUFycmF5PElEb2NBbm5vdGF0aW9uPiB7XG5cbiAgICAgICAgaWYgKCEgdGhpcy5maWx0ZXJzLmFyY2hpdmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVwb0Fubm90YXRpb25zLmZpbHRlcihjdXJyZW50ID0+ICFjdXJyZW50LmRvY0luZm8uYXJjaGl2ZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlcG9Bbm5vdGF0aW9ucztcblxuICAgIH1cblxuICAgIHByaXZhdGUgZG9GaWx0ZXJCeVRhZ3MocmVwb0Fubm90YXRpb25zOiBSZWFkb25seUFycmF5PElEb2NBbm5vdGF0aW9uPik6IFJlYWRvbmx5QXJyYXk8SURvY0Fubm90YXRpb24+IHtcblxuICAgICAgICBjb25zdCB0YWdzID0gdGhpcy5maWx0ZXJzLmZpbHRlcmVkVGFncy5nZXQoKVxuICAgICAgICAgICAgLmZpbHRlcihjdXJyZW50ID0+IGN1cnJlbnQuaWQgIT09ICcvJyk7XG5cbiAgICAgICAgY29uc3QgdGFnTWF0Y2hlckZhY3RvcnkgPSBuZXcgVGFnTWF0Y2hlckZhY3RvcnkodGFncyk7XG5cbiAgICAgICAgaWYgKHRhZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAvLyB3ZSdyZSBkb25lIGFzIHRoZXJlIGFyZSBubyB0YWdzLlxuICAgICAgICAgICAgcmV0dXJuIHJlcG9Bbm5vdGF0aW9ucztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0YWdNYXRjaGVyRmFjdG9yeS5maWx0ZXIocmVwb0Fubm90YXRpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPT4gT2JqZWN0LnZhbHVlcyhjdXJyZW50LmRvY0luZm8udGFncyB8fCB7fSkpO1xuXG4gICAgfVxuXG59XG5cbmV4cG9ydCB0eXBlIFVwZGF0ZWRDYWxsYmFjayA9IChyZXBvQW5ub3RhdGlvbnM6IFJlYWRvbmx5QXJyYXk8SURvY0Fubm90YXRpb24+KSA9PiB2b2lkO1xuXG4iXX0=