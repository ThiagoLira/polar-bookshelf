"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const Engine_1 = require("./rules_engine/Engine");
const Engine_2 = require("./rules_engine/Engine");
const ISODateTimeStrings_1 = require("polar-shared/src/metadata/ISODateTimeStrings");
const TimeDurations_1 = require("polar-shared/src/util/TimeDurations");
const LifecycleEvents_1 = require("../../../../web/js/ui/util/LifecycleEvents");
const LifecycleToggle_1 = require("../../../../web/js/ui/util/LifecycleToggle");
const RendererAnalytics_1 = require("../../../../web/js/ga/RendererAnalytics");
const Platforms_1 = require("polar-shared/src/util/Platforms");
const semver = __importStar(require("semver"));
class SplashEngine {
    constructor(facts, eventHandlers, externalEngineState) {
        this.facts = facts;
        this.eventHandlers = eventHandlers;
        this.externalEngineState = externalEngineState;
        const rules = {
            whatsNew: new WhatsNewRule(),
            netPromoter: new NetPromoterRule(),
            suggestions: new SuggestionsRule(),
        };
        this.engine = new Engine_2.Engine(facts, rules, eventHandlers, externalEngineState);
    }
    run() {
        this.engine.run();
    }
    toExternalEngineState() {
        return this.engine.toExternalEngineState();
    }
}
exports.SplashEngine = SplashEngine;
class DefaultSplashEngine extends SplashEngine {
    constructor(facts, eventHandlers) {
        super(facts, eventHandlers, LocalStorageExternalState.get());
    }
    run() {
        super.run();
        const externalState = this.toExternalEngineState();
        LocalStorageExternalState.set(externalState);
    }
}
exports.DefaultSplashEngine = DefaultSplashEngine;
class LocalStorageExternalState {
    static get() {
        const value = localStorage.getItem(this.KEY);
        if (value) {
            return JSON.parse(value);
        }
        else {
            return undefined;
        }
    }
    static set(state) {
        localStorage.setItem(this.KEY, JSON.stringify(state));
    }
}
LocalStorageExternalState.KEY = 'splash-engine-state';
class SuggestionsRule {
    run(facts, eventMap, state) {
        if (!state) {
            state = {};
        }
        const canShow = () => canFireMajorRule(facts, eventMap, eventMap.onSuggestions, 'splash-suggestions-skipped');
        if (canShow()) {
            eventMap.onSuggestions.handler();
        }
        return [facts, state];
    }
}
class NetPromoterRule {
    run(facts, eventMap, state) {
        if (!state) {
            state = {};
        }
        const canShow = () => canFireMajorRule(facts, eventMap, eventMap.onNetPromoter, 'splash-nps-skipped');
        if (canShow()) {
            eventMap.onNetPromoter.handler();
        }
        return [facts, state];
    }
}
class WhatsNewRule {
    run(facts, eventMap, state) {
        const updated = state && semver.lt(state.version, facts.version);
        if (updated) {
            if (Platforms_1.Platforms.isDesktop()) {
                eventMap.onWhatsNew.handler();
            }
        }
        state = { version: facts.version };
        return [facts, state];
    }
}
function canFireMajorRule(facts, eventMap, event, analyticsKey) {
    const hasExistingAgedDatastore = () => {
        return UserFactsUtils.hasExistingAgedDatastore(facts, '3d');
    };
    const hasMinimumTimeSinceLastEvent = () => {
        const lastEventExecution = Engine_1.EventMaps.latestExecution(eventMap);
        return hasMinimumTimeSince(lastEventExecution, '15m');
    };
    const hasMinimumTimeSinceLastRuleFired = () => {
        const epoch = event.lastExecuted;
        return hasMinimumTimeSince(epoch, '7d');
    };
    if (!hasExistingAgedDatastore()) {
        RendererAnalytics_1.RendererAnalytics.event({ category: analyticsKey, action: 'reason-has-existing-aged-datastore' });
        return false;
    }
    if (!hasMinimumTimeSinceLastMajorPrompt(eventMap)) {
        RendererAnalytics_1.RendererAnalytics.event({ category: analyticsKey, action: 'reason-has-minimum-time-since-last-major-prompt' });
        return false;
    }
    if (!hasMinimumTimeSinceLastEvent()) {
        RendererAnalytics_1.RendererAnalytics.event({ category: analyticsKey, action: 'reason-has-minimum-time-since-last-event' });
        return false;
    }
    if (!hasMinimumTimeSinceLastRuleFired()) {
        RendererAnalytics_1.RendererAnalytics.event({ category: analyticsKey, action: 'reason-has-minimum-time-since-last-rule-fired' });
        return false;
    }
    if (!hasTourTerminated()) {
        RendererAnalytics_1.RendererAnalytics.event({ category: analyticsKey, action: 'reason-has-tour-terminated' });
        return false;
    }
    return true;
}
function hasMinimumTimeSinceLastMajorPrompt(eventMap) {
    const events = [eventMap.onNetPromoter, eventMap.onSuggestions];
    for (const event of events) {
        if (!hasMinimumTimeSince(event.lastExecuted, '1d')) {
            return false;
        }
    }
    return true;
}
function hasMinimumTimeSince(epoch, duration, defaultValue = true) {
    if (epoch) {
        const since = ISODateTimeStrings_1.ISODateTimeStrings.parse(epoch);
        return TimeDurations_1.TimeDurations.hasElapsed(since, duration);
    }
    else {
        return defaultValue;
    }
}
function hasTourTerminated() {
    return LifecycleToggle_1.LifecycleToggle.isMarked(LifecycleEvents_1.LifecycleEvents.TOUR_TERMINATED);
}
class UserFactsUtils {
    static hasExistingAgedDatastore(facts, duration) {
        if (facts.datastoreCreated) {
            const since = ISODateTimeStrings_1.ISODateTimeStrings.parse(facts.datastoreCreated);
            if (TimeDurations_1.TimeDurations.hasElapsed(since, duration)) {
                return true;
            }
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3BsYXNoRW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU3BsYXNoRW5naW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUVBLGtEQUFnRDtBQUVoRCxrREFBb0Q7QUFHcEQscUZBQWdGO0FBR2hGLHVFQUFrRTtBQUdsRSxnRkFBMkU7QUFDM0UsZ0ZBQTJFO0FBQzNFLCtFQUEwRTtBQUMxRSwrREFBMEQ7QUFDMUQsK0NBQWlDO0FBRWpDLE1BQWEsWUFBWTtJQUlyQixZQUFvQixLQUFnQixFQUNoQixhQUFrQyxFQUN6QixtQkFBeUU7UUFGbEYsVUFBSyxHQUFMLEtBQUssQ0FBVztRQUNoQixrQkFBYSxHQUFiLGFBQWEsQ0FBcUI7UUFDekIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFzRDtRQUVsRyxNQUFNLEtBQUssR0FBNEM7WUFDbkQsUUFBUSxFQUFFLElBQUksWUFBWSxFQUFFO1lBQzVCLFdBQVcsRUFBRSxJQUFJLGVBQWUsRUFBRTtZQUNsQyxXQUFXLEVBQUUsSUFBSSxlQUFlLEVBQUU7U0FDckMsQ0FBQztRQUVGLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztJQUUvRSxDQUFDO0lBRU0sR0FBRztRQUNOLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVNLHFCQUFxQjtRQUN4QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUMvQyxDQUFDO0NBRUo7QUExQkQsb0NBMEJDO0FBS0QsTUFBYSxtQkFBb0IsU0FBUSxZQUFZO0lBRWpELFlBQVksS0FBZ0IsRUFDaEIsYUFBa0M7UUFFMUMsS0FBSyxDQUFDLEtBQUssRUFBRSxhQUFhLEVBQUUseUJBQXlCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUVqRSxDQUFDO0lBRU0sR0FBRztRQUVO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QUFLLEVBQUUsUUFBUSxDQUFDLEVBQUU7Z0JBQzNDLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7U0FFSjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBRWpCLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXZlbnRIYW5kbGVyc30gZnJvbSAnLi9ydWxlc19lbmdpbmUvRW5naW5lJztcbmltcG9ydCB7RXZlbnRNYXB9IGZyb20gJy4vcnVsZXNfZW5naW5lL0VuZ2luZSc7XG5pbXBvcnQge0V2ZW50TWFwc30gZnJvbSAnLi9ydWxlc19lbmdpbmUvRW5naW5lJztcbmltcG9ydCB7UnVsZU1hcH0gZnJvbSAnLi9ydWxlc19lbmdpbmUvRW5naW5lJztcbmltcG9ydCB7RW5naW5lLCBFdmVudH0gZnJvbSAnLi9ydWxlc19lbmdpbmUvRW5naW5lJztcbmltcG9ydCB7RXh0ZXJuYWxFbmdpbmVTdGF0ZX0gZnJvbSAnLi9ydWxlc19lbmdpbmUvRW5naW5lJztcbmltcG9ydCB7SVNPRGF0ZVRpbWVTdHJpbmd9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvbWV0YWRhdGEvSVNPRGF0ZVRpbWVTdHJpbmdzJztcbmltcG9ydCB7SVNPRGF0ZVRpbWVTdHJpbmdzfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lTT0RhdGVUaW1lU3RyaW5ncyc7XG5pbXBvcnQge1J1bGV9IGZyb20gJy4vcnVsZXNfZW5naW5lL1J1bGUnO1xuaW1wb3J0IHtSdWxlRmFjdFBhaXJ9IGZyb20gJy4vcnVsZXNfZW5naW5lL1J1bGUnO1xuaW1wb3J0IHtUaW1lRHVyYXRpb25zfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvVGltZUR1cmF0aW9ucyc7XG5pbXBvcnQge0R1cmF0aW9uU3RyfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvVGltZUR1cmF0aW9ucyc7XG5pbXBvcnQge0R1cmF0aW9ufSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvVGltZUR1cmF0aW9ucyc7XG5pbXBvcnQge0xpZmVjeWNsZUV2ZW50c30gZnJvbSAnLi4vLi4vLi4vLi4vd2ViL2pzL3VpL3V0aWwvTGlmZWN5Y2xlRXZlbnRzJztcbmltcG9ydCB7TGlmZWN5Y2xlVG9nZ2xlfSBmcm9tICcuLi8uLi8uLi8uLi93ZWIvanMvdWkvdXRpbC9MaWZlY3ljbGVUb2dnbGUnO1xuaW1wb3J0IHtSZW5kZXJlckFuYWx5dGljc30gZnJvbSAnLi4vLi4vLi4vLi4vd2ViL2pzL2dhL1JlbmRlcmVyQW5hbHl0aWNzJztcbmltcG9ydCB7UGxhdGZvcm1zfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy91dGlsL1BsYXRmb3Jtc1wiO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cbmV4cG9ydCBjbGFzcyBTcGxhc2hFbmdpbmUge1xuXG4gICAgcHJpdmF0ZSBlbmdpbmU6IEVuZ2luZTxVc2VyRmFjdHMsIFNwbGFzaEV2ZW50SGFuZGxlcnM+O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmYWN0czogVXNlckZhY3RzLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZXZlbnRIYW5kbGVyczogU3BsYXNoRXZlbnRIYW5kbGVycyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGV4dGVybmFsRW5naW5lU3RhdGU/OiBFeHRlcm5hbEVuZ2luZVN0YXRlPFVzZXJGYWN0cywgU3BsYXNoRXZlbnRIYW5kbGVycz4pIHtcblxuICAgICAgICBjb25zdCBydWxlczogUnVsZU1hcDxVc2VyRmFjdHMsIFNwbGFzaEV2ZW50SGFuZGxlcnM+ID0ge1xuICAgICAgICAgICAgd2hhdHNOZXc6IG5ldyBXaGF0c05ld1J1bGUoKSxcbiAgICAgICAgICAgIG5ldFByb21vdGVyOiBuZXcgTmV0UHJvbW90ZXJSdWxlKCksXG4gICAgICAgICAgICBzdWdnZXN0aW9uczogbmV3IFN1Z2dlc3Rpb25zUnVsZSgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuZW5naW5lID0gbmV3IEVuZ2luZShmYWN0cywgcnVsZXMsIGV2ZW50SGFuZGxlcnMsIGV4dGVybmFsRW5naW5lU3RhdGUpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHJ1bigpIHtcbiAgICAgICAgdGhpcy5lbmdpbmUucnVuKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvRXh0ZXJuYWxFbmdpbmVTdGF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZW5naW5lLnRvRXh0ZXJuYWxFbmdpbmVTdGF0ZSgpO1xuICAgIH1cblxufVxuXG4vKipcbiAqIFNwbGFzaCBlbmdpbmUgdGhhdCBhdXRvbWF0aWNhbGx5IHBlcnNpc3RzIGFuZCByZXN1bWVzIGZyb20gbG9jYWwgc3RvcmFnZS5cbiAqL1xuZXhwb3J0IGNsYXNzIERlZmF1bHRTcGxhc2hFbmdpbmUgZXh0ZW5kcyBTcGxhc2hFbmdpbmUge1xuXG4gICAgY29uc3RydWN0b3IoZmFjdHM6IFVzZXJGYWN0cyxcbiAgICAgICAgICAgICAgICBldmVudEhhbmRsZXJzOiBTcGxhc2hFdmVudEhhbmRsZXJzKSB7XG5cbiAgICAgICAgc3VwZXIoZmFjdHMsIGV2ZW50SGFuZGxlcnMsIExvY2FsU3RvcmFnZUV4dGVybmFsU3RhdGUuZ2V0KCkpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHJ1bigpIHtcblxuICAgICAgICBzdXBlci5ydW4oKTtcblxuICAgICAgICBjb25zdCBleHRlcm5hbFN0YXRlID0gdGhpcy50b0V4dGVybmFsRW5naW5lU3RhdGUoKTtcbiAgICAgICAgTG9jYWxTdG9yYWdlRXh0ZXJuYWxTdGF0ZS5zZXQoZXh0ZXJuYWxTdGF0ZSk7XG5cbiAgICB9XG5cbn1cblxuY2xhc3MgTG9jYWxTdG9yYWdlRXh0ZXJuYWxTdGF0ZSB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBLRVkgPSAnc3BsYXNoLWVuZ2luZS1zdGF0ZSc7XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldCgpOiBFeHRlcm5hbEVuZ2luZVN0YXRlPFVzZXJGYWN0cywgU3BsYXNoRXZlbnRIYW5kbGVycz4gfCB1bmRlZmluZWQge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuS0VZKTtcblxuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgc2V0KHN0YXRlOiBFeHRlcm5hbEVuZ2luZVN0YXRlPFVzZXJGYWN0cywgU3BsYXNoRXZlbnRIYW5kbGVycz4pIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5LRVksIEpTT04uc3RyaW5naWZ5KHN0YXRlKSk7XG4gICAgfVxuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3BsYXNoRXZlbnRIYW5kbGVycyBleHRlbmRzIEV2ZW50SGFuZGxlcnMge1xuICAgIHJlYWRvbmx5IG9uV2hhdHNOZXc6ICgpID0+IHZvaWQ7XG4gICAgcmVhZG9ubHkgb25OZXRQcm9tb3RlcjogKCkgPT4gdm9pZDtcbiAgICByZWFkb25seSBvblN1Z2dlc3Rpb25zOiAoKSA9PiB2b2lkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE11dGFibGVVc2VyRmFjdHMge1xuXG4gICAgLyoqXG4gICAgICogVGhlIHRpbWUgdGhlIGRhdGFzdG9yZSB3YXMgY3JlYXRlZC5cbiAgICAgKi9cbiAgICBkYXRhc3RvcmVDcmVhdGVkOiBJU09EYXRlVGltZVN0cmluZztcblxuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgcnVubmluZyB2ZXJzaW9uLlxuICAgICAqL1xuICAgIHZlcnNpb246IHN0cmluZztcblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFVzZXJGYWN0cyBleHRlbmRzIFJlYWRvbmx5PE11dGFibGVVc2VyRmFjdHM+IHtcblxufVxuXG5pbnRlcmZhY2UgU3VnZ2VzdGlvbnNTdGF0ZSB7XG5cbn1cblxuY2xhc3MgU3VnZ2VzdGlvbnNSdWxlIGltcGxlbWVudHMgUnVsZTxVc2VyRmFjdHMsIFNwbGFzaEV2ZW50SGFuZGxlcnMsIFN1Z2dlc3Rpb25zU3RhdGU+IHtcblxuICAgIHB1YmxpYyBydW4oZmFjdHM6IFJlYWRvbmx5PFVzZXJGYWN0cz4sXG4gICAgICAgICAgICAgICBldmVudE1hcDogRXZlbnRNYXA8U3BsYXNoRXZlbnRIYW5kbGVycz4sXG4gICAgICAgICAgICAgICBzdGF0ZT86IFJlYWRvbmx5PFN1Z2dlc3Rpb25zU3RhdGU+KTogUnVsZUZhY3RQYWlyPFVzZXJGYWN0cywgU3VnZ2VzdGlvbnNTdGF0ZT4ge1xuXG4gICAgICAgIGlmICghIHN0YXRlKSB7XG4gICAgICAgICAgICBzdGF0ZSA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2FuU2hvdyA9XG4gICAgICAgICAgICAoKSA9PiBjYW5GaXJlTWFqb3JSdWxlKGZhY3RzLCBldmVudE1hcCwgZXZlbnRNYXAub25TdWdnZXN0aW9ucywgJ3NwbGFzaC1zdWdnZXN0aW9ucy1za2lwcGVkJyk7XG5cbiAgICAgICAgaWYgKGNhblNob3coKSkge1xuICAgICAgICAgICAgZXZlbnRNYXAub25TdWdnZXN0aW9ucy5oYW5kbGVyKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gW2ZhY3RzLCBzdGF0ZV07XG5cbiAgICB9XG5cbn1cblxuXG5pbnRlcmZhY2UgTmV0UHJvbW90ZXJTdGF0ZSB7XG59XG5cbmNsYXNzIE5ldFByb21vdGVyUnVsZSBpbXBsZW1lbnRzIFJ1bGU8VXNlckZhY3RzLCBTcGxhc2hFdmVudEhhbmRsZXJzLCBOZXRQcm9tb3RlclN0YXRlPiB7XG5cbiAgICBwdWJsaWMgcnVuKGZhY3RzOiBSZWFkb25seTxVc2VyRmFjdHM+LFxuICAgICAgICAgICAgICAgZXZlbnRNYXA6IEV2ZW50TWFwPFNwbGFzaEV2ZW50SGFuZGxlcnM+LFxuICAgICAgICAgICAgICAgc3RhdGU/OiBSZWFkb25seTxOZXRQcm9tb3RlclN0YXRlPik6IFJ1bGVGYWN0UGFpcjxVc2VyRmFjdHMsIE5ldFByb21vdGVyU3RhdGU+IHtcblxuICAgICAgICBpZiAoISBzdGF0ZSkge1xuICAgICAgICAgICAgc3RhdGUgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNhblNob3cgPVxuICAgICAgICAgICAgKCkgPT4gY2FuRmlyZU1ham9yUnVsZShmYWN0cywgZXZlbnRNYXAsIGV2ZW50TWFwLm9uTmV0UHJvbW90ZXIsICdzcGxhc2gtbnBzLXNraXBwZWQnKTtcblxuICAgICAgICBpZiAoY2FuU2hvdygpKSB7XG4gICAgICAgICAgICBldmVudE1hcC5vbk5ldFByb21vdGVyLmhhbmRsZXIoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBbZmFjdHMsIHN0YXRlXTtcblxuICAgIH1cblxufVxuXG5cbmludGVyZmFjZSBXaGF0c05ld1N0YXRlIHtcblxuICAgIHZlcnNpb246IHN0cmluZztcblxufVxuXG5jbGFzcyBXaGF0c05ld1J1bGUgaW1wbGVtZW50cyBSdWxlPFVzZXJGYWN0cywgU3BsYXNoRXZlbnRIYW5kbGVycywgV2hhdHNOZXdTdGF0ZT4ge1xuXG4gICAgcHVibGljIHJ1bihmYWN0czogUmVhZG9ubHk8VXNlckZhY3RzPixcbiAgICAgICAgICAgICAgIGV2ZW50TWFwOiBFdmVudE1hcDxTcGxhc2hFdmVudEhhbmRsZXJzPixcbiAgICAgICAgICAgICAgIHN0YXRlPzogUmVhZG9ubHk8V2hhdHNOZXdTdGF0ZT4pOiBSdWxlRmFjdFBhaXI8VXNlckZhY3RzLCBXaGF0c05ld1N0YXRlPiB7XG5cbiAgICAgICAgY29uc3QgdXBkYXRlZCA9IHN0YXRlICYmIHNlbXZlci5sdChzdGF0ZS52ZXJzaW9uLCBmYWN0cy52ZXJzaW9uKTtcblxuICAgICAgICBpZiAodXBkYXRlZCkge1xuXG4gICAgICAgICAgICBpZiAoUGxhdGZvcm1zLmlzRGVza3RvcCgpKSB7XG4gICAgICAgICAgICAgICAgLy8gb25seSBjYWxsIHRoaXMgb24gZGVza3RvcC4uLlxuICAgICAgICAgICAgICAgIGV2ZW50TWFwLm9uV2hhdHNOZXcuaGFuZGxlcigpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICBzdGF0ZSA9IHt2ZXJzaW9uOiBmYWN0cy52ZXJzaW9ufTtcblxuICAgICAgICByZXR1cm4gW2ZhY3RzLCBzdGF0ZV07XG5cbiAgICB9XG5cbn1cblxuXG4vKipcbiAqXG4gKiBEZXRlcm1pbmVzIGlmIHdlIGNhbiBmaXJlIGEgbWFqb3IgcnVsZS5cbiAqXG4gKiAgLSAzIGRheXMgc2luY2UgdGhlIGRhdGFzdG9yZSBoYXMgYmVlbiBjcmVhdGVkIChhZ2VkKVxuICogIC0gMTUgbWludXRlcyBzaW5jZSBBTlkgcnVsZSBmaXJlZFxuICogIC0gNyBkYXlzIHNpbmNlIHRoaXMgcnVsZSBsYXN0IGZpcmVkLlxuICpcbiAqIEBwYXJhbSBmYWN0cyBUaGUgZmFjdHMgdG8gd29yayB3aXRoXG4gKiBAcGFyYW0gZXZlbnRNYXAgVGhlIGV2ZW50cyB0byBsb29rIGF0IHRoZWlyIGxhc3QgZmlyaW5nIHRpbWVzLlxuICogQHBhcmFtIGV2ZW50IFRoZSBldmVudCBoYW5kbGVyIGZvciB0aGlzIHJ1bGUuXG4gKiBAcGFyYW0gYW5hbHl0aWNzS2V5IFRoZSBrZXkgd2UgdXNlIHRvIGZpcmUgYW5hbHl0aWNzIGZvciB0cmFja2luZy5cbiAqL1xuZnVuY3Rpb24gY2FuRmlyZU1ham9yUnVsZShmYWN0czogUmVhZG9ubHk8VXNlckZhY3RzPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRNYXA6IEV2ZW50TWFwPFNwbGFzaEV2ZW50SGFuZGxlcnM+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogRXZlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGFuYWx5dGljc0tleTogc3RyaW5nKSB7XG5cbiAgICAvLyBQcm9tcHQgZm9yIHN1Z2dlc3Rpb24gaWYgdGhlIHVzZXIgaGFzIGJlZW4gdXNpbmcgcG9sYXIgZm9yIGF0IExFQVNUIHRocmVlXG4gICAgLy8gZGF5cyBhbmQgd2UgYXJlIGF0IGxlYXN0IDE1bSBmcm9tIHRoZSBsYXN0IGV2ZW50LlxuXG4gICAgY29uc3QgaGFzRXhpc3RpbmdBZ2VkRGF0YXN0b3JlID0gKCkgPT4ge1xuICAgICAgICByZXR1cm4gVXNlckZhY3RzVXRpbHMuaGFzRXhpc3RpbmdBZ2VkRGF0YXN0b3JlKGZhY3RzLCAnM2QnKTtcbiAgICB9O1xuXG4gICAgY29uc3QgaGFzTWluaW11bVRpbWVTaW5jZUxhc3RFdmVudCA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgbGFzdEV2ZW50RXhlY3V0aW9uID0gRXZlbnRNYXBzLmxhdGVzdEV4ZWN1dGlvbihldmVudE1hcCk7XG4gICAgICAgIHJldHVybiBoYXNNaW5pbXVtVGltZVNpbmNlKGxhc3RFdmVudEV4ZWN1dGlvbiwgJzE1bScpO1xuICAgIH07XG5cbiAgICBjb25zdCBoYXNNaW5pbXVtVGltZVNpbmNlTGFzdFJ1bGVGaXJlZCA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgZXBvY2ggPSBldmVudC5sYXN0RXhlY3V0ZWQ7XG4gICAgICAgIHJldHVybiBoYXNNaW5pbXVtVGltZVNpbmNlKGVwb2NoLCAnN2QnKTtcbiAgICB9O1xuXG4gICAgaWYgKCEgaGFzRXhpc3RpbmdBZ2VkRGF0YXN0b3JlKCkpIHtcbiAgICAgICAgUmVuZGVyZXJBbmFseXRpY3MuZXZlbnQoe2NhdGVnb3J5OiBhbmFseXRpY3NLZXksIGFjdGlvbjogJ3JlYXNvbi1oYXMtZXhpc3RpbmctYWdlZC1kYXRhc3RvcmUnfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoISBoYXNNaW5pbXVtVGltZVNpbmNlTGFzdE1ham9yUHJvbXB0KGV2ZW50TWFwKSkge1xuICAgICAgICBSZW5kZXJlckFuYWx5dGljcy5ldmVudCh7Y2F0ZWdvcnk6IGFuYWx5dGljc0tleSwgYWN0aW9uOiAncmVhc29uLWhhcy1taW5pbXVtLXRpbWUtc2luY2UtbGFzdC1tYWpvci1wcm9tcHQnfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoISBoYXNNaW5pbXVtVGltZVNpbmNlTGFzdEV2ZW50KCkpIHtcbiAgICAgICAgUmVuZGVyZXJBbmFseXRpY3MuZXZlbnQoe2NhdGVnb3J5OiBhbmFseXRpY3NLZXksIGFjdGlvbjogJ3JlYXNvbi1oYXMtbWluaW11bS10aW1lLXNpbmNlLWxhc3QtZXZlbnQnfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKCEgaGFzTWluaW11bVRpbWVTaW5jZUxhc3RSdWxlRmlyZWQoKSkge1xuICAgICAgICBSZW5kZXJlckFuYWx5dGljcy5ldmVudCh7Y2F0ZWdvcnk6IGFuYWx5dGljc0tleSwgYWN0aW9uOiAncmVhc29uLWhhcy1taW5pbXVtLXRpbWUtc2luY2UtbGFzdC1ydWxlLWZpcmVkJ30pO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKCEgaGFzVG91clRlcm1pbmF0ZWQoKSkge1xuICAgICAgICBSZW5kZXJlckFuYWx5dGljcy5ldmVudCh7Y2F0ZWdvcnk6IGFuYWx5dGljc0tleSwgYWN0aW9uOiAncmVhc29uLWhhcy10b3VyLXRlcm1pbmF0ZWQnfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcblxufVxuXG5mdW5jdGlvbiBoYXNNaW5pbXVtVGltZVNpbmNlTGFzdE1ham9yUHJvbXB0KGV2ZW50TWFwOiBFdmVudE1hcDxTcGxhc2hFdmVudEhhbmRsZXJzPikge1xuXG4gICAgY29uc3QgZXZlbnRzID0gW2V2ZW50TWFwLm9uTmV0UHJvbW90ZXIsIGV2ZW50TWFwLm9uU3VnZ2VzdGlvbnNdO1xuXG4gICAgZm9yIChjb25zdCBldmVudCBvZiBldmVudHMpIHtcbiAgICAgICAgaWYgKCEgaGFzTWluaW11bVRpbWVTaW5jZShldmVudC5sYXN0RXhlY3V0ZWQsICcxZCcpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcblxufVxuXG5mdW5jdGlvbiBoYXNNaW5pbXVtVGltZVNpbmNlKGVwb2NoOiBJU09EYXRlVGltZVN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IER1cmF0aW9uU3RyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0VmFsdWU6IGJvb2xlYW4gPSB0cnVlKSB7XG5cbiAgICBpZiAoZXBvY2gpIHtcblxuICAgICAgICBjb25zdCBzaW5jZSA9IElTT0RhdGVUaW1lU3RyaW5ncy5wYXJzZShlcG9jaCk7XG4gICAgICAgIHJldHVybiBUaW1lRHVyYXRpb25zLmhhc0VsYXBzZWQoc2luY2UsIGR1cmF0aW9uKTtcblxuICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIG91ciBlcG9jaCBoYXNuJ3QgaGFwcGVuZWQgeWV0IHNvIGl0J3Mgb2sgdG8gc2VuZCBvdXQgdGhpcyBtZXNzYWdlLlxuICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xuICAgIH1cblxufVxuXG5mdW5jdGlvbiBoYXNUb3VyVGVybWluYXRlZCgpIHtcbiAgICAvLyBUT0RPOiBJIHRoaW5rIHRoaXMgc2hvdWxkIGJlIGEgZmFjdCBhbmQgd2Ugc2hvdWxkIG5vdCBtZWFzdXJlXG4gICAgLy8gaXQgZGlyZWN0bHkuXG4gICAgcmV0dXJuIExpZmVjeWNsZVRvZ2dsZS5pc01hcmtlZChMaWZlY3ljbGVFdmVudHMuVE9VUl9URVJNSU5BVEVEKTtcbn1cblxuY2xhc3MgVXNlckZhY3RzVXRpbHMge1xuXG4gICAgcHVibGljIHN0YXRpYyBoYXNFeGlzdGluZ0FnZWREYXRhc3RvcmUoZmFjdHM6IFVzZXJGYWN0cywgZHVyYXRpb246IER1cmF0aW9uKSB7XG5cbiAgICAgICAgLy8gZGF0YXN0b3JlIHNob3VsZCBiZSBjcmVhdGVkIGZvciBhdCBsZWFzdCA3IGRheXMuXG5cbiAgICAgICAgaWYgKGZhY3RzLmRhdGFzdG9yZUNyZWF0ZWQpIHtcblxuICAgICAgICAgICAgY29uc3Qgc2luY2UgPSBJU09EYXRlVGltZVN0cmluZ3MucGFyc2UoZmFjdHMuZGF0YXN0b3JlQ3JlYXRlZCk7XG5cbiAgICAgICAgICAgIGlmIChUaW1lRHVyYXRpb25zLmhhc0VsYXBzZWQoc2luY2UsIGR1cmF0aW9uKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICB9XG5cbn1cbiJdfQ==