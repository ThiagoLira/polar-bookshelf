"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ISODateTimeStrings_1 = require("polar-shared/src/metadata/ISODateTimeStrings");
const Preconditions_1 = require("polar-shared/src/Preconditions");
const Reducers_1 = require("polar-shared/src/util/Reducers");
class Engine {
    constructor(facts, rules, eventHandlers, externalEngineState) {
        this.facts = facts;
        this.rules = rules;
        this.eventHandlers = eventHandlers;
        this.externalEngineState = externalEngineState;
        const defaultRuleStates = () => {
            if (externalEngineState) {
                return externalEngineState.ruleStates;
            }
            return {};
        };
        const defaultEventTimes = () => {
            if (externalEngineState) {
                return externalEngineState.eventTimes;
            }
            return {};
        };
        this.engineState = {
            ruleStates: defaultRuleStates(),
        };
        this.eventMap = EventMaps.create(this.eventHandlers, defaultEventTimes());
    }
    run() {
        const { engineState, rules, eventMap } = this;
        const ruleNames = Object.getOwnPropertyNames(this.rules);
        for (const ruleName of ruleNames) {
            const rule = rules[ruleName];
            const state = engineState.ruleStates[ruleName];
            const result = rule.run(this.facts, eventMap, state);
            engineState.ruleStates[ruleName] = result[1];
            this.facts = result[0];
        }
    }
    toExternalEngineState() {
        return Object.assign(Object.assign({}, this.engineState), { eventTimes: EventMaps.toEventTimes(this.eventMap) });
    }
}
exports.Engine = Engine;
class RuleMap {
}
exports.RuleMap = RuleMap;
class EventMaps {
    static create(handlers, eventTimes) {
        const result = {};
        for (const handlerName of Object.keys(handlers)) {
            const handler = handlers[handlerName];
            const lastExecuted = eventTimes[handlerName];
            const event = {
                handler: () => {
                    event.lastExecuted = ISODateTimeStrings_1.ISODateTimeStrings.create();
                    handler();
                },
                lastExecuted
            };
            result[handlerName] = event;
        }
        return result;
    }
    static toEventTimes(eventMap) {
        const result = {};
        for (const eventName of Object.keys(eventMap)) {
            const event = eventMap[eventName];
            result[eventName] = event.lastExecuted;
        }
        return result;
    }
    static toLastExecutedTimes(eventMap) {
        const eventTimes = EventMaps.toEventTimes(eventMap);
        return Object.values(eventTimes)
            .filter(current => Preconditions_1.isPresent(current))
            .map(current => current)
            .sort();
    }
    static earliestExecution(eventMap) {
        const times = [...this.toLastExecutedTimes(eventMap)];
        return times.reduce(Reducers_1.Reducers.FIRST, undefined);
    }
    static latestExecution(eventMap) {
        const times = [...this.toLastExecutedTimes(eventMap)];
        const result = times.reduce(Reducers_1.Reducers.LAST, undefined);
        return result;
    }
}
exports.EventMaps = EventMaps;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRW5naW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEscUZBQWdGO0FBQ2hGLGtFQUF5RDtBQUN6RCw2REFBd0Q7QUFleEQsTUFBYSxNQUFNO0lBYWYsWUFBb0IsS0FBUSxFQUNDLEtBQW9CLEVBQ3BCLGFBQWdCLEVBQ2hCLG1CQUErQztRQUh4RCxVQUFLLEdBQUwsS0FBSyxDQUFHO1FBQ0MsVUFBSyxHQUFMLEtBQUssQ0FBZTtRQUNwQixrQkFBYSxHQUFiLGFBQWEsQ0FBRztRQUNoQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQTRCO1FBRXhFLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxFQUFFO1lBRTNCLElBQUksbUJBQW1CLEVBQUU7Z0JBRXJCLE9BQU8sbUJBQW1CLENBQUMsVUFBVSxDQUFDO2FBQ3pDO1lBRUQsT0FBTyxFQUFFLENBQUM7UUFFZCxDQUFDLENBQUM7UUFFRixNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRTtZQUUzQixJQUFJLG1CQUFtQixFQUFFO2dCQUNyQixPQUFPLG1CQUFtQixDQUFDLFVBQVUsQ0FBQzthQUN6QztZQUVELE9BQU8sRUFBRSxDQUFDO1FBRWQsQ0FBQyxDQUFDO1FBSUYsSUFBSSxDQUFDLFdBQVcsR0FBRztZQUNmLFVBQVUsRUFBRSxpQkFBaUIsRUFBRTtTQUNsQyxDQUFDO1FBRUYsSUFBSSxDQUFDLFFBQVEsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO0lBRTlFLENBQUM7SUFFTSxHQUFHO1FBRU4sTUFBTSxFQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFDLEdBQUcsSUFBSSxDQUFDO1FBRTVDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFekQsS0FBSyxNQUFNLFFBQVEsSUFBSSxTQUFTLEVBQUU7WUFFOUIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTdCLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFL0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUdyRCxXQUFXLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUU3QyxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUUxQjtJQUVMLENBQUM7SUFFTSxxQkFBcUI7UUFFeEIsdUNBQ08sSUFBSSxDQUFDLFdBQVcsS0FDbkIsVUFBVSxFQUFFLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUNuRDtJQUVOLENBQUM7Q0FFSjtBQWpGRCx3QkFpRkM7QUFFRCxNQUFhLE9BQU87Q0FJbkI7QUFKRCwwQkFJQztBQXNERCxNQUFhLFNBQVM7SUFFWCxNQUFNLENBQUMsTUFBTSxDQUEwQixRQUFXLEVBQ1gsVUFBa0M7UUFFNUUsTUFBTSxNQUFNLEdBQTZCLEVBQUUsQ0FBQztRQUU1QyxLQUFLLE1BQU0sV0FBVyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFFN0MsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXRDLE1BQU0sWUFBWSxHQUFrQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFNUUsTUFBTSxLQUFLLEdBQWlCO2dCQUN4QixPQUFPLEVBQUUsR0FBRyxFQUFFO29CQUNWLEtBQUssQ0FBQyxZQUFZLEdBQUcsdUNBQWtCLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ2pELE9BQU8sRUFBRSxDQUFDO2dCQUNkLENBQUM7Z0JBQ0QsWUFBWTthQUNmLENBQUM7WUFFSyxNQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBRXZDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFFbEIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxZQUFZLENBQTBCLFFBQXFCO1FBRXJFLE1BQU0sTUFBTSxHQUErQixFQUFFLENBQUM7UUFFOUMsS0FBSyxNQUFNLFNBQVMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzNDLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMzQixNQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQztTQUNsRDtRQUVELE9BQU8sTUFBTSxDQUFDO0lBRWxCLENBQUM7SUFFTSxNQUFNLENBQUMsbUJBQW1CLENBQTBCLFFBQXFCO1FBRTVFLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFcEQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQzthQUMzQixNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyx5QkFBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3JDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQVEsQ0FBQzthQUN4QixJQUFJLEVBQUUsQ0FBQztJQUVoQixDQUFDO0lBRU0sTUFBTSxDQUFDLGlCQUFpQixDQUEwQixRQUFxQjtRQUUxRSxNQUFNLEtBQUssR0FBOEIsQ0FBQyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2pGLE9BQVEsS0FBSyxDQUFDLE1BQU0sQ0FBQyxtQkFBUSxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQztJQUVwRCxDQUFDO0lBRU0sTUFBTSxDQUFDLGVBQWUsQ0FBMEIsUUFBcUI7UUFFeEUsTUFBTSxLQUFLLEdBQThCLENBQUMsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNqRixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLG1CQUFRLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXRELE9BQU8sTUFBTSxDQUFDO0lBRWxCLENBQUM7Q0FFSjtBQXJFRCw4QkFxRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1J1bGV9IGZyb20gJy4vUnVsZSc7XG5pbXBvcnQge0lTT0RhdGVUaW1lU3RyaW5nfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL21ldGFkYXRhL0lTT0RhdGVUaW1lU3RyaW5ncyc7XG5pbXBvcnQge0lTT0RhdGVUaW1lU3RyaW5nc30gZnJvbSAncG9sYXItc2hhcmVkL3NyYy9tZXRhZGF0YS9JU09EYXRlVGltZVN0cmluZ3MnO1xuaW1wb3J0IHtpc1ByZXNlbnR9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvUHJlY29uZGl0aW9ucyc7XG5pbXBvcnQge1JlZHVjZXJzfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvUmVkdWNlcnMnO1xuXG5cbmV4cG9ydCB0eXBlIEV2ZW50SGFuZGxlciA9ICgpID0+IHZvaWQ7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRIYW5kbGVycyB7XG4gICAgcmVhZG9ubHkgW25hbWU6IHN0cmluZ106IEV2ZW50SGFuZGxlcjtcbn1cblxuLyoqXG4gKiBBbiBlbmdpbmUgdGhhdCBzaG91bGQgcnVuIHdpdGggZmFjdHMgLCBhZ2FpbnN0IHJ1bGVzLCB3aGljaCBjYW4gZW1pdCBldmVudHMuXG4gKlxuICogVGhlIGVuZ2luZSBjYW4gYmUgZXZlbnQgYmFzZWQgb3IgcG9sbCBiYXNlZCBhbmQgaXMgZGVzaWduZWQgdG8gYmUgdmVyeVxuICogZWZmaWNpZW50IHRvIHJ1biBqdXN0IGZyb20gYSBmZXcgdmFyaWFibGVzLlxuICovXG5leHBvcnQgY2xhc3MgRW5naW5lPEYsIEggZXh0ZW5kcyBFdmVudEhhbmRsZXJzPiB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGVuZ2luZVN0YXRlOiBNdXRhYmxlRW5naW5lU3RhdGU8RiwgSD47XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50TWFwOiBNdXRhYmxlRXZlbnRNYXA8SD47XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBmYWN0cyBUaGUgZmFjdHMgZXhwb3NlZCB0byBhbGwgcnVsZXMgaW4gdGhlIGVuZ2luZS5cbiAgICAgKiBAcGFyYW0gcnVsZXMgVGhlIHJ1bGUgbWFwIHdlIHNob3VsZCBleGVjdXRlXG4gICAgICogQHBhcmFtIGV2ZW50SGFuZGxlcnMgVGhlIGV2ZW50IGhhbmRsZXJzIHdlIHNob3VsZCBwYXNzIHRvIHJ1bGVzLlxuICAgICAqIEBwYXJhbSBleHRlcm5hbEVuZ2luZVN0YXRlIFVzZWQgZm9yIHJlc3VtaW5nIGVuZ2luZSBzdGF0ZS5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZhY3RzOiBGLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcmVhZG9ubHkgcnVsZXM6IFJ1bGVNYXA8RiwgSD4sXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByZWFkb25seSBldmVudEhhbmRsZXJzOiBILFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcmVhZG9ubHkgZXh0ZXJuYWxFbmdpbmVTdGF0ZT86IEV4dGVybmFsRW5naW5lU3RhdGU8RiwgSD4pIHtcblxuICAgICAgICBjb25zdCBkZWZhdWx0UnVsZVN0YXRlcyA9ICgpID0+IHtcblxuICAgICAgICAgICAgaWYgKGV4dGVybmFsRW5naW5lU3RhdGUpIHtcbiAgICAgICAgICAgICAgICAvLyB3ZSBoYXZlIHRvIHJlc3RvcmUgZnJvbSBhbiBleHRlcm5hbCBzdGF0ZVxuICAgICAgICAgICAgICAgIHJldHVybiBleHRlcm5hbEVuZ2luZVN0YXRlLnJ1bGVTdGF0ZXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7fTtcblxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGRlZmF1bHRFdmVudFRpbWVzID0gKCkgPT4ge1xuXG4gICAgICAgICAgICBpZiAoZXh0ZXJuYWxFbmdpbmVTdGF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBleHRlcm5hbEVuZ2luZVN0YXRlLmV2ZW50VGltZXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7fTtcblxuICAgICAgICB9O1xuXG5cbiAgICAgICAgLy8gcHJlcGFyZSB0aGUgZGVmYXVsdCBzdGF0ZS5cbiAgICAgICAgdGhpcy5lbmdpbmVTdGF0ZSA9IHtcbiAgICAgICAgICAgIHJ1bGVTdGF0ZXM6IGRlZmF1bHRSdWxlU3RhdGVzKCksXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5ldmVudE1hcCA9IEV2ZW50TWFwcy5jcmVhdGUodGhpcy5ldmVudEhhbmRsZXJzLCBkZWZhdWx0RXZlbnRUaW1lcygpKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBydW4oKSB7XG5cbiAgICAgICAgY29uc3Qge2VuZ2luZVN0YXRlLCBydWxlcywgZXZlbnRNYXB9ID0gdGhpcztcblxuICAgICAgICBjb25zdCBydWxlTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0aGlzLnJ1bGVzKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHJ1bGVOYW1lIG9mIHJ1bGVOYW1lcykge1xuXG4gICAgICAgICAgICBjb25zdCBydWxlID0gcnVsZXNbcnVsZU5hbWVdO1xuXG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IGVuZ2luZVN0YXRlLnJ1bGVTdGF0ZXNbcnVsZU5hbWVdO1xuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBydWxlLnJ1bih0aGlzLmZhY3RzLCBldmVudE1hcCwgc3RhdGUpO1xuXG4gICAgICAgICAgICAvLyBub3cgdXBkYXRlIHRoZSBmYWN0IGFuZCBzdGF0ZSBvZiB0aGlzIG9iamVjdFxuICAgICAgICAgICAgZW5naW5lU3RhdGUucnVsZVN0YXRlc1tydWxlTmFtZV0gPSByZXN1bHRbMV07XG5cbiAgICAgICAgICAgIHRoaXMuZmFjdHMgPSByZXN1bHRbMF07XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIHRvRXh0ZXJuYWxFbmdpbmVTdGF0ZSgpOiBFeHRlcm5hbEVuZ2luZVN0YXRlPEYsIEg+IHtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4udGhpcy5lbmdpbmVTdGF0ZSxcbiAgICAgICAgICAgIGV2ZW50VGltZXM6IEV2ZW50TWFwcy50b0V2ZW50VGltZXModGhpcy5ldmVudE1hcClcbiAgICAgICAgfTtcblxuICAgIH1cblxufVxuXG5leHBvcnQgY2xhc3MgUnVsZU1hcDxGLCBIIGV4dGVuZHMgRXZlbnRIYW5kbGVycz4ge1xuXG4gICAgW25hbWU6IHN0cmluZ106IFJ1bGU8RiwgSCwgYW55PjtcblxufVxuXG5leHBvcnQgdHlwZSBSdWxlS2V5czxGLCBIIGV4dGVuZHMgRXZlbnRIYW5kbGVycz4gPSBrZXlvZiBSdWxlTWFwPEYsIEg+O1xuXG4vKipcbiAqIFByb3ZpZGUgdGhlIG9yZGVyIG9mIHRoZSBydWxlcy4gIFRoaXMgaXMgYSBiaXQgdmVyYm9zZSBidXQgSmF2YXNjcmlwdCBvYmplY3RcbiAqIGtleXMgb3JkZXIgaXNuJ3QgZGVmaW5lZCByZWxpYWJseSBhbmQgSSB3YW50IHRvIG1ha2Ugc3VyZSB3ZSBuZXZlciBoYXZlIGJ1Z3NcbiAqIGhlcmUuXG4gKi9cbmV4cG9ydCB0eXBlIFJ1bGVPcmRlcjxGLCBIIGV4dGVuZHMgRXZlbnRIYW5kbGVycz4gPSBbUnVsZUtleXM8RiwgSD5dO1xuXG5pbnRlcmZhY2UgTXV0YWJsZUVuZ2luZVN0YXRlPEYsIEggZXh0ZW5kcyBFdmVudEhhbmRsZXJzPiB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgc3RhdGVzIG9mIHRoZSBpbmRpdmlkdWFsIHJ1bGVzLlxuICAgICAqL1xuICAgIHJ1bGVTdGF0ZXM6IHtbaWQ6IHN0cmluZ106IGFueX07XG5cbn1cblxuLyoqXG4gKiBUaGUgZW5naW5lIHN0YXRlIGJldHdlZW4gcnVuIHdoaWNoIGJldHdlZW4gZmFjdHMgRiBhbmQgaGFuZGxlcnMgSC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFeHRlcm5hbEVuZ2luZVN0YXRlPEYsIEggZXh0ZW5kcyBFdmVudEhhbmRsZXJzPiBleHRlbmRzIFJlYWRvbmx5PE11dGFibGVFbmdpbmVTdGF0ZTxGLCBIPj4ge1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICByZWFkb25seSBldmVudFRpbWVzOiBQYXJ0aWFsPEV2ZW50VGltZXM8SD4+O1xuXG5cbn1cblxuZXhwb3J0IHR5cGUgTXV0YWJsZUV2ZW50VGltZXM8RSBleHRlbmRzIEV2ZW50SGFuZGxlcnM+ID0ge1xuICAgIFtuYW1lIGluIGtleW9mIEVdOiBJU09EYXRlVGltZVN0cmluZyB8IHVuZGVmaW5lZDtcbn07XG5cbmV4cG9ydCB0eXBlIEV2ZW50VGltZXM8RSBleHRlbmRzIEV2ZW50SGFuZGxlcnM+ID0gUmVhZG9ubHk8TXV0YWJsZUV2ZW50VGltZXM8RT4+O1xuXG5leHBvcnQgaW50ZXJmYWNlIE11dGFibGVFdmVudCB7XG4gICAgaGFuZGxlcjogRXZlbnRIYW5kbGVyO1xuICAgIGxhc3RFeGVjdXRlZDogSVNPRGF0ZVRpbWVTdHJpbmcgfCB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnQgZXh0ZW5kcyBSZWFkb25seTxNdXRhYmxlRXZlbnQ+IHtcblxufVxuXG5leHBvcnQgdHlwZSBNdXRhYmxlRXZlbnRNYXA8RSBleHRlbmRzIEV2ZW50SGFuZGxlcnM+ID0ge1xuICAgIFtuYW1lIGluIGtleW9mIEVdOiBFdmVudDtcbn07XG5cbmV4cG9ydCB0eXBlIEV2ZW50TWFwPEUgZXh0ZW5kcyBFdmVudEhhbmRsZXJzPiA9IFJlYWRvbmx5PE11dGFibGVFdmVudE1hcDxFPj47XG5cbmV4cG9ydCBjbGFzcyBFdmVudE1hcHMge1xuXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGU8RSBleHRlbmRzIEV2ZW50SGFuZGxlcnM+KGhhbmRsZXJzOiBFLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudFRpbWVzOiBQYXJ0aWFsPEV2ZW50VGltZXM8RT4+KTogRXZlbnRNYXA8RT4ge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogTXV0YWJsZUV2ZW50TWFwPEU+ID0gPGFueT4ge307XG5cbiAgICAgICAgZm9yIChjb25zdCBoYW5kbGVyTmFtZSBvZiBPYmplY3Qua2V5cyhoYW5kbGVycykpIHtcblxuICAgICAgICAgICAgY29uc3QgaGFuZGxlciA9IGhhbmRsZXJzW2hhbmRsZXJOYW1lXTtcblxuICAgICAgICAgICAgY29uc3QgbGFzdEV4ZWN1dGVkOiBJU09EYXRlVGltZVN0cmluZyB8IHVuZGVmaW5lZCA9IGV2ZW50VGltZXNbaGFuZGxlck5hbWVdO1xuXG4gICAgICAgICAgICBjb25zdCBldmVudDogTXV0YWJsZUV2ZW50ID0ge1xuICAgICAgICAgICAgICAgIGhhbmRsZXI6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQubGFzdEV4ZWN1dGVkID0gSVNPRGF0ZVRpbWVTdHJpbmdzLmNyZWF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyKCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBsYXN0RXhlY3V0ZWRcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICg8YW55PiByZXN1bHQpW2hhbmRsZXJOYW1lXSA9IGV2ZW50O1xuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyB0b0V2ZW50VGltZXM8RSBleHRlbmRzIEV2ZW50SGFuZGxlcnM+KGV2ZW50TWFwOiBFdmVudE1hcDxFPik6IEV2ZW50VGltZXM8RT4ge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogTXV0YWJsZUV2ZW50VGltZXM8RT4gPSA8YW55PiB7fTtcblxuICAgICAgICBmb3IgKGNvbnN0IGV2ZW50TmFtZSBvZiBPYmplY3Qua2V5cyhldmVudE1hcCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gZXZlbnRNYXBbZXZlbnROYW1lXTtcbiAgICAgICAgICAgICg8YW55PiByZXN1bHQpW2V2ZW50TmFtZV0gPSBldmVudC5sYXN0RXhlY3V0ZWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyB0b0xhc3RFeGVjdXRlZFRpbWVzPEUgZXh0ZW5kcyBFdmVudEhhbmRsZXJzPihldmVudE1hcDogRXZlbnRNYXA8RT4pOiBSZWFkb25seUFycmF5PElTT0RhdGVUaW1lU3RyaW5nPiB7XG5cbiAgICAgICAgY29uc3QgZXZlbnRUaW1lcyA9IEV2ZW50TWFwcy50b0V2ZW50VGltZXMoZXZlbnRNYXApO1xuXG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKGV2ZW50VGltZXMpXG4gICAgICAgICAgICAuZmlsdGVyKGN1cnJlbnQgPT4gaXNQcmVzZW50KGN1cnJlbnQpKVxuICAgICAgICAgICAgLm1hcChjdXJyZW50ID0+IGN1cnJlbnQhKVxuICAgICAgICAgICAgLnNvcnQoKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZWFybGllc3RFeGVjdXRpb248RSBleHRlbmRzIEV2ZW50SGFuZGxlcnM+KGV2ZW50TWFwOiBFdmVudE1hcDxFPik6IElTT0RhdGVUaW1lU3RyaW5nIHwgdW5kZWZpbmVkIHtcblxuICAgICAgICBjb25zdCB0aW1lczogQXJyYXk8c3RyaW5nIHwgdW5kZWZpbmVkPiA9IFsuLi50aGlzLnRvTGFzdEV4ZWN1dGVkVGltZXMoZXZlbnRNYXApXTtcbiAgICAgICAgcmV0dXJuICB0aW1lcy5yZWR1Y2UoUmVkdWNlcnMuRklSU1QsIHVuZGVmaW5lZCk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGxhdGVzdEV4ZWN1dGlvbjxFIGV4dGVuZHMgRXZlbnRIYW5kbGVycz4oZXZlbnRNYXA6IEV2ZW50TWFwPEU+KTogSVNPRGF0ZVRpbWVTdHJpbmcgfCB1bmRlZmluZWQge1xuXG4gICAgICAgIGNvbnN0IHRpbWVzOiBBcnJheTxzdHJpbmcgfCB1bmRlZmluZWQ+ID0gWy4uLnRoaXMudG9MYXN0RXhlY3V0ZWRUaW1lcyhldmVudE1hcCldO1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0aW1lcy5yZWR1Y2UoUmVkdWNlcnMuTEFTVCwgdW5kZWZpbmVkKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG59XG4iXX0=