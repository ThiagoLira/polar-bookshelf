"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const RepoDocInfos_1 = require("../RepoDocInfos");
const RendererAnalytics_1 = require("../../../../web/js/ga/RendererAnalytics");
const FilteredTags_1 = require("../FilteredTags");
const Optional_1 = require("polar-shared/src/util/ts/Optional");
const TagMatcher_1 = require("../../../../web/js/tags/TagMatcher");
const Strings_1 = require("polar-shared/src/util/Strings");
class DocRepoFilters {
    constructor(onRefreshed, repoDocInfosProvider) {
        this.onRefreshed = onRefreshed;
        this.repoDocInfosProvider = repoDocInfosProvider;
        this.filters = {
            flagged: false,
            archived: false,
            title: "",
            filteredTags: new FilteredTags_1.FilteredTags()
        };
    }
    onToggleFlaggedOnly(value) {
        this.filters.flagged = value;
        this.refresh();
    }
    onToggleFilterArchived(value) {
        this.filters.archived = value;
        this.refresh();
    }
    onFilterByTitle(title) {
        this.filters.title = title;
        this.refresh();
    }
    onTagged(tags) {
        const isRootTag = () => {
            return tags.length === 1 && tags[0].id === '/';
        };
        if (isRootTag()) {
            this.filters.filteredTags.set([]);
        }
        else {
            this.filters.filteredTags.set(tags);
        }
        this.refresh();
    }
    refresh() {
        this.onRefreshed(this.filter(this.repoDocInfosProvider()));
    }
    filter(repoDocInfos) {
        repoDocInfos = this.doFilterValid(repoDocInfos);
        repoDocInfos = this.doFilterByTitle(repoDocInfos);
        repoDocInfos = this.doFilterFlagged(repoDocInfos);
        repoDocInfos = this.doFilterArchived(repoDocInfos);
        repoDocInfos = this.doFilterByTags(repoDocInfos);
        return repoDocInfos;
    }
    doFilterValid(repoDocs) {
        return repoDocs.filter(current => RepoDocInfos_1.RepoDocInfos.isValid(current));
    }
    doFilterByTitle(repoDocs) {
        if (!Strings_1.Strings.empty(this.filters.title)) {
            const toSTR = (value) => {
                return Optional_1.Optional.of(value)
                    .getOrElse("")
                    .toLowerCase();
            };
            const searchString = toSTR(this.filters.title);
            return repoDocs.filter(current => {
                const title = toSTR(current.title);
                const filename = toSTR(current.filename);
                return title.includes(searchString) || filename.includes(searchString);
            });
        }
        return repoDocs;
    }
    doFilterFlagged(repoDocs) {
        if (this.filters.flagged) {
            return repoDocs.filter(current => current.flagged);
        }
        return repoDocs;
    }
    doFilterArchived(repoDocs) {
        if (!this.filters.archived) {
            return repoDocs.filter(current => !current.archived);
        }
        return repoDocs;
    }
    doFilterByTags(repoDocs) {
        RendererAnalytics_1.RendererAnalytics.event({ category: 'user', action: 'filter-by-tags' });
        const tags = this.filters.filteredTags.get()
            .filter(current => current.id !== '/');
        const tagMatcherFactory = new TagMatcher_1.TagMatcherFactory(tags);
        if (tags.length === 0) {
            return repoDocs;
        }
        return tagMatcherFactory.filter(repoDocs, current => Object.values(current.docInfo.tags || {}));
    }
}
exports.DocRepoFilters = DocRepoFilters;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRG9jUmVwb0ZpbHRlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJEb2NSZXBvRmlsdGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGtEQUE2QztBQUM3QywrRUFBMEU7QUFDMUUsa0RBQTZDO0FBRTdDLGdFQUEyRDtBQUUzRCxtRUFBcUU7QUFDckUsMkRBQXNEO0FBTXRELE1BQWEsY0FBYztJQUl2QixZQUFvQixXQUE4QixFQUM5QixvQkFBMEQ7UUFEMUQsZ0JBQVcsR0FBWCxXQUFXLENBQW1CO1FBQzlCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0M7UUFFMUUsSUFBSSxDQUFDLE9BQU8sR0FBRztZQUNYLE9BQU8sRUFBRSxLQUFLO1lBQ2QsUUFBUSxFQUFFLEtBQUs7WUFDZixLQUFLLEVBQUUsRUFBRTtZQUNULFlBQVksRUFBRSxJQUFJLDJCQUFZLEVBQUU7U0FDbkMsQ0FBQztJQUVOLENBQUM7SUFFTSxtQkFBbUIsQ0FBQyxLQUFjO1FBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUM3QixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDbkIsQ0FBQztJQUVNLHNCQUFzQixDQUFDLEtBQWM7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQzlCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBRU0sZUFBZSxDQUFDLEtBQWE7UUFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQzNCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBRU0sUUFBUSxDQUFDLElBQVc7UUFFdkIsTUFBTSxTQUFTLEdBQUcsR0FBRyxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxHQUFHLENBQUM7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QU0sRUFBRSxnQkFBZ0IsRUFBQyxDQUFDLENBQUM7UUFFdEUsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFO2FBQ3ZDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssR0FBRyxDQUFDLENBQUM7UUFFM0MsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLDhCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXRELElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFFbkIsT0FBTyxRQUFRLENBQUM7U0FDbkI7UUFFRCxPQUFPLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQ1IsT0FBTyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFFMUYsQ0FBQztDQUVKO0FBeklELHdDQXlJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UmVwb0RvY0luZm99IGZyb20gJy4uL1JlcG9Eb2NJbmZvJztcbmltcG9ydCB7UmVwb0RvY0luZm9zfSBmcm9tICcuLi9SZXBvRG9jSW5mb3MnO1xuaW1wb3J0IHtSZW5kZXJlckFuYWx5dGljc30gZnJvbSAnLi4vLi4vLi4vLi4vd2ViL2pzL2dhL1JlbmRlcmVyQW5hbHl0aWNzJztcbmltcG9ydCB7RmlsdGVyZWRUYWdzfSBmcm9tICcuLi9GaWx0ZXJlZFRhZ3MnO1xuaW1wb3J0IHtQcm92aWRlcn0gZnJvbSAncG9sYXItc2hhcmVkL3NyYy91dGlsL1Byb3ZpZGVycyc7XG5pbXBvcnQge09wdGlvbmFsfSBmcm9tICdwb2xhci1zaGFyZWQvc3JjL3V0aWwvdHMvT3B0aW9uYWwnO1xuaW1wb3J0IHtUYWd9IGZyb20gJ3BvbGFyLXNoYXJlZC9zcmMvdGFncy9UYWdzJztcbmltcG9ydCB7VGFnTWF0Y2hlckZhY3Rvcnl9IGZyb20gJy4uLy4uLy4uLy4uL3dlYi9qcy90YWdzL1RhZ01hdGNoZXInO1xuaW1wb3J0IHtTdHJpbmdzfSBmcm9tIFwicG9sYXItc2hhcmVkL3NyYy91dGlsL1N0cmluZ3NcIjtcblxuLyoqXG4gKiBLZWVwcyB0cmFjayBvZiB0aGUgZG9jIGluZGV4IHNvIHRoYXQgd2UgY2FuIGZpbHRlciBpdCBpbiB0aGUgVUkgYW5kIGhhdmVcbiAqIHRoZSBmaWx0ZXIgZXZlbnRzIHNlbmQgdG8gdGhlIGluZGV4IGFuZCB0aGVuIHVwZGF0ZSBjb21wb25lbnQgc3RhdGUgZGlyZWN0bHkuXG4gKi9cbmV4cG9ydCBjbGFzcyBEb2NSZXBvRmlsdGVycyB7XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgZmlsdGVyczogTXV0YWJsZUZpbHRlcnM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9uUmVmcmVzaGVkOiBSZWZyZXNoZWRDYWxsYmFjayxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJlcG9Eb2NJbmZvc1Byb3ZpZGVyOiBQcm92aWRlcjxSZWFkb25seUFycmF5PFJlcG9Eb2NJbmZvPj4pIHtcblxuICAgICAgICB0aGlzLmZpbHRlcnMgPSB7XG4gICAgICAgICAgICBmbGFnZ2VkOiBmYWxzZSxcbiAgICAgICAgICAgIGFyY2hpdmVkOiBmYWxzZSxcbiAgICAgICAgICAgIHRpdGxlOiBcIlwiLFxuICAgICAgICAgICAgZmlsdGVyZWRUYWdzOiBuZXcgRmlsdGVyZWRUYWdzKClcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBvblRvZ2dsZUZsYWdnZWRPbmx5KHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuZmlsdGVycy5mbGFnZ2VkID0gdmFsdWU7XG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblRvZ2dsZUZpbHRlckFyY2hpdmVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuZmlsdGVycy5hcmNoaXZlZCA9IHZhbHVlO1xuICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25GaWx0ZXJCeVRpdGxlKHRpdGxlOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5maWx0ZXJzLnRpdGxlID0gdGl0bGU7XG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblRhZ2dlZCh0YWdzOiBUYWdbXSkge1xuXG4gICAgICAgIGNvbnN0IGlzUm9vdFRhZyA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0YWdzLmxlbmd0aCA9PT0gMSAmJiB0YWdzWzBdLmlkID09PSAnLyc7XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGlzUm9vdFRhZygpKSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlcnMuZmlsdGVyZWRUYWdzLnNldChbXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlcnMuZmlsdGVyZWRUYWdzLnNldCh0YWdzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWZyZXNoKCkge1xuICAgICAgICB0aGlzLm9uUmVmcmVzaGVkKHRoaXMuZmlsdGVyKHRoaXMucmVwb0RvY0luZm9zUHJvdmlkZXIoKSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZmlsdGVyKHJlcG9Eb2NJbmZvczogUmVhZG9ubHlBcnJheTxSZXBvRG9jSW5mbz4pOiBSZWFkb25seUFycmF5PFJlcG9Eb2NJbmZvPiB7XG5cbiAgICAgICAgLy8gYWx3YXlzIGZpbHRlciB2YWxpZCB0byBtYWtlIHN1cmUgbm90aGluZyBjb3JydXB0cyB0aGUgc3RhdGUuICBTb21lXG4gICAgICAgIC8vIG90aGVyIGJ1ZyBtaWdodCBpbmplY3QgYSBwcm9ibGVtIG90aGVyd2lzZS5cbiAgICAgICAgcmVwb0RvY0luZm9zID0gdGhpcy5kb0ZpbHRlclZhbGlkKHJlcG9Eb2NJbmZvcyk7XG4gICAgICAgIHJlcG9Eb2NJbmZvcyA9IHRoaXMuZG9GaWx0ZXJCeVRpdGxlKHJlcG9Eb2NJbmZvcyk7XG4gICAgICAgIHJlcG9Eb2NJbmZvcyA9IHRoaXMuZG9GaWx0ZXJGbGFnZ2VkKHJlcG9Eb2NJbmZvcyk7XG4gICAgICAgIHJlcG9Eb2NJbmZvcyA9IHRoaXMuZG9GaWx0ZXJBcmNoaXZlZChyZXBvRG9jSW5mb3MpO1xuICAgICAgICByZXBvRG9jSW5mb3MgPSB0aGlzLmRvRmlsdGVyQnlUYWdzKHJlcG9Eb2NJbmZvcyk7XG5cbiAgICAgICAgcmV0dXJuIHJlcG9Eb2NJbmZvcztcblxuICAgIH1cblxuICAgIHByaXZhdGUgZG9GaWx0ZXJWYWxpZChyZXBvRG9jczogUmVhZG9ubHlBcnJheTxSZXBvRG9jSW5mbz4pOiBSZWFkb25seUFycmF5PFJlcG9Eb2NJbmZvPiB7XG4gICAgICAgIHJldHVybiByZXBvRG9jcy5maWx0ZXIoY3VycmVudCA9PiBSZXBvRG9jSW5mb3MuaXNWYWxpZChjdXJyZW50KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb0ZpbHRlckJ5VGl0bGUocmVwb0RvY3M6IFJlYWRvbmx5QXJyYXk8UmVwb0RvY0luZm8+KTogUmVhZG9ubHlBcnJheTxSZXBvRG9jSW5mbz4ge1xuXG4gICAgICAgIGlmICghIFN0cmluZ3MuZW1wdHkodGhpcy5maWx0ZXJzLnRpdGxlKSkge1xuXG4gICAgICAgICAgICAvLyB0aGUgc3RyaW5nIHdlIGFyZSBzZWFyY2hpbmcgZm9yXG4gICAgICAgICAgICBjb25zdCB0b1NUUiA9ICh2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKTogc3RyaW5nID0+IHtcblxuICAgICAgICAgICAgICAgIHJldHVybiBPcHRpb25hbC5vZih2YWx1ZSlcbiAgICAgICAgICAgICAgICAgICAgLmdldE9yRWxzZShcIlwiKVxuICAgICAgICAgICAgICAgICAgICAudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3Qgc2VhcmNoU3RyaW5nID0gdG9TVFIodGhpcy5maWx0ZXJzLnRpdGxlKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJlcG9Eb2NzLmZpbHRlcihjdXJyZW50ID0+IHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gdG9TVFIoY3VycmVudC50aXRsZSk7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZW5hbWUgPSB0b1NUUihjdXJyZW50LmZpbGVuYW1lKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0aXRsZS5pbmNsdWRlcyhzZWFyY2hTdHJpbmcpIHx8IGZpbGVuYW1lLmluY2x1ZGVzKHNlYXJjaFN0cmluZyk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVwb0RvY3M7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGRvRmlsdGVyRmxhZ2dlZChyZXBvRG9jczogUmVhZG9ubHlBcnJheTxSZXBvRG9jSW5mbz4pOiBSZWFkb25seUFycmF5PFJlcG9Eb2NJbmZvPiB7XG5cbiAgICAgICAgaWYgKHRoaXMuZmlsdGVycy5mbGFnZ2VkKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVwb0RvY3MuZmlsdGVyKGN1cnJlbnQgPT4gY3VycmVudC5mbGFnZ2VkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXBvRG9jcztcblxuICAgIH1cblxuICAgIHByaXZhdGUgZG9GaWx0ZXJBcmNoaXZlZChyZXBvRG9jczogUmVhZG9ubHlBcnJheTxSZXBvRG9jSW5mbz4pOiBSZWFkb25seUFycmF5PFJlcG9Eb2NJbmZvPiB7XG5cbiAgICAgICAgaWYgKCEgdGhpcy5maWx0ZXJzLmFyY2hpdmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVwb0RvY3MuZmlsdGVyKGN1cnJlbnQgPT4gIWN1cnJlbnQuYXJjaGl2ZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlcG9Eb2NzO1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb0ZpbHRlckJ5VGFncyhyZXBvRG9jczogUmVhZG9ubHlBcnJheTxSZXBvRG9jSW5mbz4pOiBSZWFkb25seUFycmF5PFJlcG9Eb2NJbmZvPiAge1xuXG4gICAgICAgIFJlbmRlcmVyQW5hbHl0aWNzLmV2ZW50KHtjYXRlZ29yeTogJ3VzZXInLCBhY3Rpb246ICdmaWx0ZXItYnktdGFncyd9KTtcblxuICAgICAgICBjb25zdCB0YWdzID0gdGhpcy5maWx0ZXJzLmZpbHRlcmVkVGFncy5nZXQoKVxuICAgICAgICAgICAgLmZpbHRlcihjdXJyZW50ID0+IGN1cnJlbnQuaWQgIT09ICcvJyk7XG5cbiAgICAgICAgY29uc3QgdGFnTWF0Y2hlckZhY3RvcnkgPSBuZXcgVGFnTWF0Y2hlckZhY3RvcnkodGFncyk7XG5cbiAgICAgICAgaWYgKHRhZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAvLyB3ZSdyZSBkb25lIGFzIHRoZXJlIGFyZSBubyB0YWdzLlxuICAgICAgICAgICAgcmV0dXJuIHJlcG9Eb2NzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRhZ01hdGNoZXJGYWN0b3J5LmZpbHRlcihyZXBvRG9jcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0+IE9iamVjdC52YWx1ZXMoY3VycmVudC5kb2NJbmZvLnRhZ3MgfHwge30pKTtcblxuICAgIH1cblxufVxuXG5pbnRlcmZhY2UgTXV0YWJsZUZpbHRlcnMge1xuXG4gICAgLyoqXG4gICAgICogV2hlbiB0cnVlLCBvbmx5IHNob3cgZmxhZ2dlZCBkb2N1bWVudHMuXG4gICAgICovXG4gICAgZmxhZ2dlZDogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqICBXaGVuIHRydWUsIHNob3cgYm90aCBhcmNoaXZlZCBhbmQgbm9uLWFyY2hpdmVkIGRvY3VtZW50cy5cbiAgICAgKi9cbiAgICBhcmNoaXZlZDogYm9vbGVhbjtcblxuICAgIHRpdGxlOiBzdHJpbmc7XG5cbiAgICBmaWx0ZXJlZFRhZ3M6IEZpbHRlcmVkVGFncztcblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpbHRlcnMgZXh0ZW5kcyBSZWFkb25seTxNdXRhYmxlRmlsdGVycz4ge1xuXG59XG5cbmV4cG9ydCB0eXBlIFJlZnJlc2hlZENhbGxiYWNrID0gKHJlcG9Eb2NJbmZvczogUmVhZG9ubHlBcnJheTxSZXBvRG9jSW5mbz4pID0+IHZvaWQ7XG5cbiJdfQ==